<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
  content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover" />
<title>Decide Engine | Universal Logic OS</title>
<meta name="theme-color" content="#000000" />
<link rel="manifest" href="manifest.json" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>

/* =========================
   BASE
========================= */

body {
  margin: 0;
  background: radial-gradient(circle at top left,#111,#050505);
  color: #fff;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  overflow: hidden;
}

#app-shell {
  height: 100vh;
  width: 100vw;
  display: flex;
  flex-direction: column;
}

.header {
  padding: 20px 30px;
  border-bottom: 1px solid rgba(255,255,255,0.08);
  font-weight: 700;
  letter-spacing: 1px;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(10px);
}

.main-layout {
  flex: 1;
  display: flex;
}

.sidebar {
  width: 240px;
  border-right: 1px solid rgba(255,255,255,0.08);
  background: rgba(0,0,0,0.6);
  padding: 20px;
  display: none;
  flex-direction: column;
  gap: 12px;
}

.sidebar button {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  color: white;
  padding: 12px;
  border-radius: 10px;
  cursor: pointer;
  transition: 0.2s;
}

.sidebar button:hover {
  background: rgba(255,255,255,0.12);
}

.content {
  flex: 1;
  padding: 40px;
  overflow-y: auto;
}

.panel {
  background: rgba(20,20,20,0.85);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 18px;
  padding: 40px;
  max-width: 700px;
  backdrop-filter: blur(20px);
}

.btn {
  background: #ff671f;
  border: none;
  padding: 14px 24px;
  border-radius: 12px;
  font-weight: 700;
  cursor: pointer;
  margin-top: 15px;
  transition: 0.2s;
}

.btn:hover {
  transform: translateY(-2px);
}

.btn-secondary {
  background: rgba(255,255,255,0.08);
  color: white;
}

.toast-msg {
  position: fixed;
  bottom: 60px;
  left: 50%;
  transform: translateX(-50%);
  background: #111;
  padding: 12px 20px;
  border-radius: 40px;
  border: 1px solid #333;
  font-size: 0.8rem;
  opacity: 0;
  transition: opacity 0.3s;
  z-index: 9999;
}

.toast-msg.visible {
  opacity: 1;
}

@media (min-width:1024px){
  .sidebar { display: flex; }
}

</style>
</head>

<body>

<div id="app-shell">
  <div class="header">
    DECIDE ENGINE ‚Äî Universal Logic OS
  </div>

  <div class="main-layout">

    <div class="sidebar">
      <button onclick="renderHome()">Home</button>
      <button onclick="syncDatabase()">Sync DB</button>
      <button onclick="generateDecisionReport()">Export PDF</button>
    </div>

    <div class="content">
      <div id="master-container"></div>
    </div>

  </div>
</div>

<div id="toast" class="toast-msg"></div>

<script>

/* =========================
   CONFIG
========================= */

const BACKEND_URL =
"https://script.google.com/macros/s/AKfycbycz1pVNID7fwlM3ckBsGC_mAjLkMwGoW-UbXHWxdkqdNtYIdeLWfo6EkRef0cHReUO/exec";

/* =========================
   STATE
========================= */

let ENGINE_STATE = {
  currentModule: null,
  activeFilter: null,
  sessionID: "SID-" + Math.random().toString(36).substr(2,4).toUpperCase(),
  winner: null
};

let PHONE_DB = {};
let AUDIO_DB = {};
let LAPTOP_DB = {};

/* =========================
   SERVICE WORKER
========================= */

if ("serviceWorker" in navigator) {
  window.addEventListener("load", async () => {
    try {
      await navigator.serviceWorker.register("./sw.js");
    } catch(e){}
  });
}

/* =========================
   ONLINE/OFFLINE
========================= */

window.addEventListener("offline", () => showToast("YOU ARE OFFLINE"));
window.addEventListener("online", () => {
  showToast("BACK ONLINE");
  syncDatabase();
});

/* =========================
   DATABASE
========================= */

async function syncDatabase(){
  if(!navigator.onLine){
    showToast("OFFLINE MODE");
    return;
  }

  try{
    const r = await fetch(`${BACKEND_URL}?type=local`);
    const d = await r.json();

    PHONE_DB = {};
    AUDIO_DB = {};
    LAPTOP_DB = {};

    d.forEach(p=>{
      if(p.category==="smartphones") PHONE_DB[p.Name]=p;
      if(p.category==="earbuds") AUDIO_DB[p.Name]=p;
      if(p.category==="laptops") LAPTOP_DB[p.Name]=p;
    });

    showToast("SYSTEM LIVE ‚úÖ");
  }catch(e){
    showToast("OFFLINE MODE");
  }
}

/* =========================
   HOME
========================= */

function renderHome(){
  const c = document.getElementById("master-container");
  c.innerHTML = `
    <div class="panel">
      <h1>DECIDE ENGINE</h1>
      <p>Session: ${ENGINE_STATE.sessionID}</p>

      <button class="btn" onclick="selectModule('phone')">üì± Phones</button>
      <button class="btn" onclick="selectModule('audio')">üéß Audio</button>
      <button class="btn" onclick="selectModule('laptop')">üíª Laptop</button>
    </div>
  `;
}

/* =========================
   MODULE FLOW
========================= */

function selectModule(module){
  ENGINE_STATE.currentModule = module;
  ENGINE_STATE.activeFilter = null;

  const c = document.getElementById("master-container");

  c.innerHTML = `
    <div class="panel">
      <h1>Select Priority</h1>

      <button class="btn btn-secondary" onclick="setFilter('performance')">Performance</button>
      <button class="btn btn-secondary" onclick="setFilter('battery')">Battery</button>
      <button class="btn btn-secondary" onclick="setFilter('value')">Value</button>

      <br>
      <button class="btn" onclick="startDecision()">Start Decision ‚Üí</button>
      <button class="btn btn-secondary" onclick="renderHome()">Back</button>
    </div>
  `;
}

function setFilter(filter){
  ENGINE_STATE.activeFilter = filter;
  showToast("Priority: "+filter.toUpperCase());
}

/* =========================
   SCORING ENGINE
========================= */

function startDecision(){

  if(!ENGINE_STATE.activeFilter){
    showToast("Select priority first");
    return;
  }

  let DB;
  if(ENGINE_STATE.currentModule==="phone") DB = PHONE_DB;
  if(ENGINE_STATE.currentModule==="audio") DB = AUDIO_DB;
  if(ENGINE_STATE.currentModule==="laptop") DB = LAPTOP_DB;

  const items = Object.values(DB);
  if(!items.length){
    showToast("No data loaded");
    return;
  }

  const scored = items.map(item=>{
    const scoreData = calculateScore(item);
    return {...item, ...scoreData};
  });

  scored.sort((a,b)=> b.finalScore - a.finalScore || a.price - b.price);

  ENGINE_STATE.winner = scored[0];

  renderResult(ENGINE_STATE.winner);
}

function calculateScore(item){

  const price = Number(item.price)||1;

  const perf = Number(item.performance||item.perf||5);
  const bat  = Number(item.battery||item.bat||5);
  const val  = Number(item.value||item.val||5);

  let wPerf=1, wBat=1, wVal=1;

  if(ENGINE_STATE.activeFilter==="performance") wPerf=2;
  if(ENGINE_STATE.activeFilter==="battery") wBat=2;
  if(ENGINE_STATE.activeFilter==="value") wVal=2;

  const base = (perf*wPerf)+(bat*wBat)+(val*wVal);
  const efficiency = base/price*1000;

  const finalScore = (base*0.7)+(efficiency*0.3);

  return {
    finalScore:Number(finalScore.toFixed(2)),
    breakdown:{perf,bat,val,efficiency:Number(efficiency.toFixed(2))}
  };
}

/* =========================
   RESULT
========================= */

function renderResult(w){
  const c=document.getElementById("master-container");

  c.innerHTML=`
    <div class="panel">
      <h1>üèÜ Verdict</h1>
      <h2>${w.Name}</h2>
      <p>Price: ‚Çπ${w.price}</p>
      <p><strong>Final Score:</strong> ${w.finalScore}</p>

      <hr>

      <p>Performance: ${w.breakdown.perf}</p>
      <p>Battery: ${w.breakdown.bat}</p>
      <p>Value: ${w.breakdown.val}</p>
      <p>Efficiency: ${w.breakdown.efficiency}</p>

      <button class="btn" onclick="generateDecisionReport()">Download PDF</button>
      <button class="btn btn-secondary" onclick="renderHome()">Home</button>
    </div>
  `;
}

/* =========================
   PDF
========================= */

function generateDecisionReport(){
  if(!ENGINE_STATE.winner){
    showToast("No result");
    return;
  }

  const w=ENGINE_STATE.winner;
  const { jsPDF }=window.jspdf;
  const doc=new jsPDF();

  doc.text("DECIDE ENGINE REPORT",20,20);
  doc.text("Session: "+ENGINE_STATE.sessionID,20,30);
  doc.text("Winner: "+w.Name,20,45);
  doc.text("Score: "+w.finalScore,20,55);

  doc.save("decision_report.pdf");
}

/* =========================
   TOAST
========================= */

function showToast(msg){
  const t=document.getElementById("toast");
  t.innerText=msg;
  t.classList.add("visible");
  setTimeout(()=>t.classList.remove("visible"),2000);
}

/* =========================
   BOOT
========================= */

renderHome();
syncDatabase();

</script>

</body>
</html>
