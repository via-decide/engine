<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
<title>Decide Engine</title>
<meta name="theme-color" content="#000000" />
<link rel="manifest" href="manifest.json" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* ================= THEME ================= */

:root{
  --bg-primary:#050505;
  --bg-secondary:rgba(20,20,20,0.85);
  --text-primary:#ffffff;
  --text-muted:#888;
  --glass-border:rgba(255,255,255,0.1);
  --accent:#ff671f;
  --success:#00e676;
}

@media (prefers-color-scheme: light){
  :root{
    --bg-primary:#f4f4f4;
    --bg-secondary:rgba(255,255,255,0.9);
    --text-primary:#111;
    --text-muted:#555;
    --glass-border:rgba(0,0,0,0.08);
  }
}

body{
  margin:0;
  background:var(--bg-primary);
  color:var(--text-primary);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  overflow:hidden;
}

#app{
  height:100vh;
  display:flex;
  flex-direction:column;
}

.header{
  padding:20px;
  font-weight:700;
  letter-spacing:1px;
  border-bottom:1px solid var(--glass-border);
  background:var(--bg-secondary);
}

.main{
  flex:1;
  display:flex;
}

.sidebar{
  width:240px;
  display:none;
  flex-direction:column;
  padding:20px;
  border-right:1px solid var(--glass-border);
  background:var(--bg-secondary);
  gap:12px;
}

.sidebar button{
  background:rgba(255,255,255,0.05);
  border:1px solid var(--glass-border);
  color:var(--text-primary);
  padding:12px;
  border-radius:10px;
  cursor:pointer;
}

.content{
  flex:1;
  padding:40px;
  overflow:auto;
}

.panel{
  background:var(--bg-secondary);
  border:1px solid var(--glass-border);
  border-radius:18px;
  padding:40px;
  max-width:700px;
  backdrop-filter:blur(20px);
}

.btn{
  background:var(--accent);
  border:none;
  padding:14px 22px;
  border-radius:12px;
  font-weight:700;
  cursor:pointer;
  margin-top:12px;
}

.btn-secondary{
  background:rgba(255,255,255,0.08);
  color:var(--text-primary);
}

.toast{
  position:fixed;
  bottom:50px;
  left:50%;
  transform:translateX(-50%);
  background:#111;
  color:var(--success);
  padding:10px 20px;
  border-radius:30px;
  opacity:0;
  transition:0.3s;
}

.toast.show{ opacity:1; }

@media(min-width:1024px){
  .sidebar{ display:flex; }
}

</style>
</head>
<body>

<div id="app">
  <div class="header">DECIDE ENGINE ‚Äî Universal Logic OS</div>
  <div class="main">
    <div class="sidebar">
      <button onclick="renderHome()">Home</button>
      <button onclick="syncProducts()">Sync Products</button>
      <button onclick="exportPDF()">Export PDF</button>
    </div>
    <div class="content">
      <div id="view"></div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>

/* ================= SUPABASE ================= */

const SUPABASE_URL = "https://adzkzeghlgzpbageszqh.supabase.co";
const SUPABASE_KEY = "sb_publishable_SvFpgjJXowEo0JliWh0OVA_6U-8T2VA";
const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================= STATE ================= */

const State = {
  device_id: getDeviceID(),
  session_id: "SID-" + crypto.randomUUID().slice(0,8),
  module:null,
  filter:null,
  winner:null
};

let PRODUCTS = [];

/* ================= DEVICE ID ================= */

function getDeviceID(){
  let id = localStorage.getItem("decide_device_id");
  if(!id){
    id = crypto.randomUUID();
    localStorage.setItem("decide_device_id", id);
  }
  return id;
}

/* ================= ANALYTICS ================= */

async function track(event, payload={}){
  try{
    await db.from("analytics_events").insert({
      device_id: State.device_id,
      session_id: State.session_id,
      event_name:event,
      payload
    });
  }catch(e){}
}

/* ================= PRODUCTS ================= */

async function syncProducts(){
  const { data, error } = await db.from("products").select("*");
  if(error){
    showToast("Offline mode");
    return;
  }
  PRODUCTS = data || [];
  localStorage.setItem("cached_products", JSON.stringify(PRODUCTS));
  showToast("Products synced");
  track("sync_products");
}

/* ================= SCORING ================= */

function calculateScore(item){
  const price = Number(item.price)||1;
  const perf = Number(item.perf)||5;
  const bat  = Number(item.bat)||5;
  const val  = Number(item.cam)||5;

  let weightPerf=1, weightBat=1, weightVal=1;
  if(State.filter==="performance") weightPerf=2;
  if(State.filter==="battery") weightBat=2;
  if(State.filter==="value") weightVal=2;

  const base = perf*weightPerf + bat*weightBat + val*weightVal;
  const efficiency = base/price*1000;
  const finalScore = (base*0.7)+(efficiency*0.3);

  return finalScore;
}

/* ================= UI ================= */

function renderHome(){
  document.getElementById("view").innerHTML = `
    <div class="panel">
      <h1>Choose Module</h1>
      <button class="btn" onclick="chooseModule('smartphones')">üì± Phones</button>
      <button class="btn" onclick="chooseModule('earbuds')">üéß Audio</button>
      <button class="btn" onclick="chooseModule('laptops')">üíª Laptops</button>
    </div>
  `;
  track("view_home");
}

function chooseModule(module){
  State.module = module;
  State.filter = null;
  track("module_selected",{module});
  document.getElementById("view").innerHTML = `
    <div class="panel">
      <h1>Select Priority</h1>
      <button class="btn-secondary btn" onclick="setFilter('performance')">Performance</button>
      <button class="btn-secondary btn" onclick="setFilter('battery')">Battery</button>
      <button class="btn-secondary btn" onclick="setFilter('value')">Value</button>
      <button class="btn" onclick="decide()">Start Decision ‚Üí</button>
    </div>
  `;
}

function setFilter(f){
  State.filter=f;
  showToast("Priority: "+f);
  track("filter_selected",{filter:f});
}

function decide(){
  if(!State.filter){ showToast("Select priority"); return; }

  const list = PRODUCTS.filter(p=>p.category===State.module);
  if(!list.length){ showToast("No data"); return; }

  const scored = list.map(p=>({...p,score:calculateScore(p)}))
                     .sort((a,b)=>b.score-a.score);

  State.winner = scored[0];

  track("verdict_generated",{winner:State.winner.name});

  renderResult();
}

function renderResult(){
  const w = State.winner;
  document.getElementById("view").innerHTML = `
    <div class="panel">
      <h1>üèÜ ${w.name}</h1>
      <p>Price: ‚Çπ${w.price}</p>
      <p><strong>Score:</strong> ${w.score.toFixed(2)}</p>
      <button class="btn" onclick="exportPDF()">Download PDF</button>
      <button class="btn-secondary btn" onclick="renderHome()">Home</button>
    </div>
  `;
}

function exportPDF(){
  if(!State.winner){ showToast("No result"); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("DECIDE ENGINE REPORT",20,20);
  doc.text("Session: "+State.session_id,20,30);
  doc.text("Winner: "+State.winner.name,20,40);
  doc.text("Score: "+State.winner.score.toFixed(2),20,50);
  doc.save("decision_report.pdf");
  track("pdf_exported");
}

/* ================= TOAST ================= */

function showToast(msg){
  const t=document.getElementById("toast");
  t.innerText=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),2000);
}

/* ================= PWA ================= */

if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js");
}

/* ================= INIT ================= */

const cached = localStorage.getItem("cached_products");
if(cached) PRODUCTS = JSON.parse(cached);

renderHome();
syncProducts();

</script>
</body>
</html>
