<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Decide Engine</title>
<meta name="theme-color" content="#000000">
<link rel="manifest" href="manifest.json">

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
--brand-orange:#ff671f;
--brand-dark:#050505;
--glass-surface:rgba(20,20,20,0.9);
--glass-border:rgba(255,255,255,0.12);
--text-main:#fff;
--accent-go:#00e676;
}
body{
margin:0;
background:var(--brand-dark);
color:#fff;
font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
overflow:hidden;
}
#master-container{
height:100vh;
display:flex;
align-items:center;
justify-content:center;
}
.grid{
display:grid;
grid-template-columns:1fr 1fr;
gap:14px;
width:90%;
max-width:600px;
}
.grid button{
padding:20px;
border-radius:18px;
background:var(--glass-surface);
border:1px solid var(--glass-border);
color:#fff;
font-weight:700;
cursor:pointer;
}
.winner{
text-align:center;
}
.btn{
padding:14px;
border-radius:14px;
background:var(--brand-orange);
border:none;
font-weight:800;
cursor:pointer;
width:100%;
}
.toast{
position:fixed;
bottom:40px;
left:50%;
transform:translateX(-50%);
background:#111;
padding:10px 20px;
border-radius:30px;
display:none;
}
.toast.show{display:block;}
</style>
</head>

<body>
<div id="master-container"></div>
<div id="toast" class="toast"></div>

<script>

/* =========================
   SUPABASE CONFIG
========================= */

const SUPABASE_URL = "https://adzkzeghlgzpbageszqh.supabase.co";
const SUPABASE_KEY = "sb_publishable_SvFpgjJXowEo0JliWh0OVA_6U-8T2VA";
const AMZN_TAG = "decideos-21";

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* =========================
   DEVICE ID
========================= */

let DEVICE_ID = localStorage.getItem("decide_device_id");
if(!DEVICE_ID){
DEVICE_ID = crypto.randomUUID();
localStorage.setItem("decide_device_id", DEVICE_ID);
}

let ENGINE_STATE = {
currentDomain:null,
active_filters:[],
sessionID:"SID-"+Math.random().toString(36).substr(2,4).toUpperCase(),
winner:null
};

let ANALYTICS_QUEUE = [];

/* =========================
   ANALYTICS
========================= */

function trackEvent(type,meta={}){
ANALYTICS_QUEUE.push({
device_id:DEVICE_ID,
session_id:ENGINE_STATE.sessionID,
event_type:type,
module:ENGINE_STATE.currentDomain,
product:meta.product||null,
filter:meta.filter||null,
created_at:new Date().toISOString()
});
if(ANALYTICS_QUEUE.length>=10) flushAnalytics();
}

async function flushAnalytics(){
if(!ANALYTICS_QUEUE.length) return;
await supabase.from("analytics_events").insert(ANALYTICS_QUEUE);
ANALYTICS_QUEUE=[];
}

setInterval(flushAnalytics,8000);
window.addEventListener("beforeunload",flushAnalytics);

/* =========================
   DATABASE
========================= */

let DB={};

async function syncDatabase(){
try{
const {data,error}=await supabase.from("products").select("*");
if(error) throw error;
DB=data;
localStorage.setItem("product_cache",JSON.stringify(data));
showToast("SYSTEM LIVE");
}catch(e){
const cache=localStorage.getItem("product_cache");
if(cache){
DB=JSON.parse(cache);
showToast("OFFLINE MODE");
}
}
}

/* =========================
   UI
========================= */

function renderLobby(){
ENGINE_STATE.currentDomain=null;
document.getElementById("master-container").innerHTML=`
<div class="grid">
<button onclick="loadDomain('smartphones')">ðŸ“± Phones</button>
<button onclick="loadDomain('earbuds')">ðŸŽ§ Audio</button>
<button onclick="loadDomain('laptops')">ðŸ’» Laptops</button>
</div>`;
}

function loadDomain(domain){
ENGINE_STATE.currentDomain=domain;
ENGINE_STATE.active_filters=[];
trackEvent("open_module");
renderFilters();
}

function renderFilters(){
document.getElementById("master-container").innerHTML=`
<div class="grid">
<button onclick="setFilter('cam')">Camera</button>
<button onclick="setFilter('gam')">Gaming</button>
<button onclick="setFilter('bat')">Battery</button>
<button onclick="startHunt()">Start Hunt â†’</button>
</div>`;
}

function setFilter(f){
ENGINE_STATE.active_filters.push(f);
trackEvent("select_filter",{filter:f});
showToast("Filter Added");
}

/* =========================
   SCORING ENGINE
========================= */

function calculateVerdict(){
const items=DB.filter(x=>x.category===ENGINE_STATE.currentDomain);
const keys=ENGINE_STATE.active_filters;
const scored=items.map(p=>{
let score=0;
keys.forEach(k=>score+=p[k]||0);
return {...p,score};
});
scored.sort((a,b)=>b.score-a.score||a.price-b.price);
return scored[0];
}

function startHunt(){
if(!ENGINE_STATE.active_filters.length) return showToast("Select filter");
const winner=calculateVerdict();
ENGINE_STATE.winner=winner;
trackEvent("verdict",{product:winner.name});
renderWinner(winner);
}

function renderWinner(w){
const amzn=`https://www.amazon.in/s?k=${encodeURIComponent(w.name)}&tag=${AMZN_TAG}`;
const yt=`https://www.youtube.com/results?search_query=${encodeURIComponent(w.name+" review")}`;
document.getElementById("master-container").innerHTML=`
<div class="winner">
<h1>${w.name}</h1>
<h3>â‚¹${w.price}</h3>
<br>
<button class="btn" onclick="window.open('${amzn}','_blank')">Check Price</button>
<br><br>
<button class="btn" onclick="window.open('${yt}','_blank')">Watch Review</button>
<br><br>
<button class="btn" onclick="generatePDF()">Export PDF</button>
<br><br>
<button class="btn" onclick="renderLobby()">Home</button>
</div>`;
}

/* =========================
   PDF
========================= */

function generatePDF(){
const w=ENGINE_STATE.winner;
if(!w) return;
const {jsPDF}=window.jspdf;
const doc=new jsPDF();
doc.text("DECIDE ENGINE REPORT",20,20);
doc.text("Winner: "+w.name,20,40);
doc.text("Price: â‚¹"+w.price,20,50);
doc.save("report.pdf");
trackEvent("pdf_export",{product:w.name});
}

/* =========================
   TOAST
========================= */

function showToast(msg){
const t=document.getElementById("toast");
t.innerText=msg;
t.classList.add("show");
setTimeout(()=>t.classList.remove("show"),2000);
}

/* =========================
   INIT
========================= */

syncDatabase();
renderLobby();

if("serviceWorker" in navigator){
navigator.serviceWorker.register("sw.js");
}

</script>
</body>
</html>
