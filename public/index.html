
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover" />
  <title>Decide Engine | Universal Logic OS</title>
  <meta name="theme-color" content="#000000" />
  <link rel="manifest" href="manifest.json" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

  <style>
    body {
      margin: 0;
      background: #050505;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      overflow: hidden;
    }

    #master-container {
      height: 100vh;
      width: 100vw;
      position: relative;
    }

    .toast-msg {
      position: fixed;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      background: #111;
      padding: 12px 20px;
      border-radius: 40px;
      border: 1px solid #333;
      font-size: 0.8rem;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 9999;
    }

    .toast-msg.visible {
      opacity: 1;
    }
  </style>
</head>

<body>

<div id="master-container"></div>
<div id="toast" class="toast-msg"></div>

<script>

/* =========================
   CONFIG
========================= */

const BACKEND_URL =
  "https://script.google.com/macros/s/AKfycbycz1pVNID7fwlM3ckBsGC_mAjLkMwGoW-UbXHWxdkqdNtYIdeLWfo6EkRef0cHReUO/exec";

/* =========================
   STATE
========================= */

let ENGINE_STATE = {
  currentDomain: null,
  active_filters: [],
  sessionID: "SID-" + Math.random().toString(36).substr(2, 4).toUpperCase(),
  winner: null
};

let PHONE_DB = {};
let slideElements = [];
let currentIdx = 0;

/* =========================
   PWA INSTALL + SW
========================= */

let deferredPrompt;

window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;
});

async function triggerInstall() {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt = null;
  }
}

/* ---------- PRODUCTION SW REGISTRATION ---------- */

if ("serviceWorker" in navigator) {
  window.addEventListener("load", async () => {
    try {
      const reg = await navigator.serviceWorker.register("./sw.js");

      if (reg.waiting) {
        reg.waiting.postMessage({ type: "SKIP_WAITING" });
      }

      reg.addEventListener("updatefound", () => {
        const newWorker = reg.installing;
        if (!newWorker) return;

        newWorker.addEventListener("statechange", () => {
          if (
            newWorker.state === "installed" &&
            navigator.serviceWorker.controller
          ) {
            showToast("UPDATE AVAILABLE — REFRESH");
          }
        });
      });

      console.log("Service Worker ready");
    } catch (err) {
      console.log("SW registration failed:", err);
    }
  });
}

/* =========================
   ONLINE / OFFLINE EVENTS
========================= */

window.addEventListener("offline", () => {
  showToast("YOU ARE OFFLINE");
});

window.addEventListener("online", () => {
  showToast("BACK ONLINE");
  syncDatabase();
});

/* =========================
   DATABASE SYNC (PATCHED)
========================= */

async function syncDatabase() {

  if (!navigator.onLine) {
    showToast("OFFLINE MODE");
    return;
  }

  try {
    const r = await fetch(`${BACKEND_URL}?type=local`);
    const d = await r.json();

    PHONE_DB = {};
    d.forEach(item => {
      PHONE_DB[item.Name] = item;
    });

    showToast("SYSTEM LIVE ✅");

  } catch (e) {
    console.log(e);
    showToast("OFFLINE MODE");
  }
}

/* =========================
   UI CORE
========================= */

function renderHome() {
  const c = document.getElementById("master-container");
  c.innerHTML = `
    <div style="padding:40px">
      <h1>DECIDE ENGINE</h1>
      <button onclick="syncDatabase()">LOAD PHONES</button>
      <button onclick="generateDecisionReport()">CREATE REPORT</button>
    </div>
  `;
}

function showToast(message) {
  const t = document.getElementById("toast");
  t.innerText = message;
  t.classList.add("visible");
  setTimeout(() => t.classList.remove("visible"), 2000);
}

/* =========================
   PDF REPORT
========================= */

function generateDecisionReport() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(20);
  doc.text("DECIDE ENGINE REPORT", 20, 20);
  doc.text(`Session ID: ${ENGINE_STATE.sessionID}`, 20, 35);

  doc.save(`Audit_${ENGINE_STATE.sessionID}.pdf`);
}

/* =========================
   BOOT
========================= */

renderHome();
syncDatabase();

</script>
</body>
</html>
