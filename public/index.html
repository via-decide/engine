
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Decide Engine v100</title>
<meta name="theme-color" content="#000000">
<link rel="manifest" href="manifest.json">

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
--brand-orange:#ff671f;
--brand-dark:#050505;
--glass:rgba(20,20,20,0.9);
--border:rgba(255,255,255,0.12);
--accent:#00e676;
--font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
}

html,body{
margin:0;
padding:0;
height:100%;
background:var(--brand-dark);
color:#fff;
font-family:var(--font);
overflow:hidden;
}

#master-container{
height:100%;
display:flex;
flex-direction:column;
align-items:center;
justify-content:center;
padding:20px;
}

.grid{
display:grid;
grid-template-columns:1fr 1fr;
gap:15px;
max-width:600px;
width:100%;
}

.btn{
background:var(--glass);
border:1px solid var(--border);
padding:20px;
border-radius:18px;
text-align:center;
font-weight:700;
cursor:pointer;
transition:.2s;
}

.btn:hover{background:rgba(255,255,255,0.08)}

.btn-primary{
background:var(--brand-orange);
color:#000;
border:none;
}

.winner{
text-align:center;
max-width:500px;
}

.toast{
position:fixed;
bottom:40px;
left:50%;
transform:translateX(-50%);
background:#111;
border:1px solid #333;
padding:10px 20px;
border-radius:30px;
font-size:0.8rem;
opacity:0;
transition:.3s;
}
.toast.show{opacity:1}
</style>
</head>
<body>

<div id="master-container"></div>
<div id="toast" class="toast"></div>

<script>
/* ===============================
   SUPABASE CONFIG
================================= */

const SUPABASE_URL = "https://adzkzeghlgzpbageszqh.supabase.co";
const SUPABASE_KEY = "sb_publishable_SvFpgjJXowEo0JliWh0OVA_6U-8T2VA";
const AMZN_TAG = "decideos-21";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ===============================
   DEVICE + SESSION
================================= */

let DEVICE_ID = localStorage.getItem("decide_device_id");
if(!DEVICE_ID){
DEVICE_ID = crypto.randomUUID();
localStorage.setItem("decide_device_id", DEVICE_ID);
}

let ENGINE_STATE = {
currentDomain:null,
active_filters:[],
sessionID:"SID-"+Math.random().toString(36).substr(2,4).toUpperCase(),
winner:null
};

/* ===============================
   ANALYTICS
================================= */

let ANALYTICS_QUEUE=[];

function trackEvent(type,meta={}){
ANALYTICS_QUEUE.push({
device_id:DEVICE_ID,
session_id:ENGINE_STATE.sessionID,
event_type:type,
module:ENGINE_STATE.currentDomain,
product:meta.product||null,
created_at:new Date().toISOString()
});
if(ANALYTICS_QUEUE.length>=10) flushAnalytics();
}

async function flushAnalytics(){
if(!ANALYTICS_QUEUE.length) return;
const payload=[...ANALYTICS_QUEUE];
ANALYTICS_QUEUE=[];
await supabase.from("analytics_events").insert(payload);
}

setInterval(flushAnalytics,8000);
window.addEventListener("beforeunload",flushAnalytics);

/* ===============================
   DATABASE
================================= */

let DB={
smartphones:{},
earbuds:{},
laptops:{}
};

async function syncDatabase(){
try{
const {data,error}=await supabase.from("products").select("*");
if(error) throw error;

DB={smartphones:{},earbuds:{},laptops:{}};

data.forEach(p=>{
DB[p.category][p.name]={
name:p.name,
price:p.price,
attr:{
cam:p.cam||0,
gam:p.gam||0,
bat:p.bat||0,
snd:p.snd||0,
anc:p.anc||0,
mic:p.mic||0,
perf:p.perf||0,
port:p.port||0,
scr:p.scr||0
}
};
});

localStorage.setItem("product_cache",JSON.stringify(data));
showToast("SYSTEM LIVE âœ…");
}
catch(e){
const cache=localStorage.getItem("product_cache");
if(cache){
const data=JSON.parse(cache);
data.forEach(p=>{
DB[p.category][p.name]=p;
});
showToast("OFFLINE MODE");
}
}
}

/* ===============================
   UI
================================= */

function renderLobby(){
const c=document.getElementById("master-container");
c.innerHTML=`
<h1>DECIDE ENGINE v100</h1>
<div class="grid">
<div class="btn" onclick="loadDomain('smartphones')">ðŸ“± PHONES</div>
<div class="btn" onclick="loadDomain('earbuds')">ðŸŽ§ AUDIO</div>
<div class="btn" onclick="loadDomain('laptops')">ðŸ’» LAPTOPS</div>
<div class="btn btn-primary" onclick="syncDatabase()">SYNC DB</div>
</div>
<p style="opacity:.4;margin-top:20px">Session ${ENGINE_STATE.sessionID}</p>
`;
}

function renderFilters(domain){
const c=document.getElementById("master-container");
ENGINE_STATE.currentDomain=domain;
ENGINE_STATE.active_filters=[];
trackEvent("open_module");

const filters={
smartphones:["cam","gam","bat"],
earbuds:["snd","anc","mic"],
laptops:["perf","port","scr"]
};

let buttons=filters[domain].map(f=>`
<div class="btn" onclick="toggleFilter('${f}')">${f.toUpperCase()}</div>
`).join("");

c.innerHTML=`
<h2>${domain.toUpperCase()}</h2>
<div class="grid">${buttons}</div>
<div style="margin-top:20px">
<div class="btn btn-primary" onclick="buildVerdict()">DECIDE â†’</div>
<div class="btn" onclick="renderLobby()" style="margin-top:10px">BACK</div>
</div>
`;
}

function toggleFilter(f){
if(ENGINE_STATE.active_filters.includes(f)){
ENGINE_STATE.active_filters=ENGINE_STATE.active_filters.filter(x=>x!==f);
}else{
ENGINE_STATE.active_filters.push(f);
}
}

/* ===============================
   SCORING
================================= */

function calculateWinner(){
const db=DB[ENGINE_STATE.currentDomain];
if(!db || !Object.keys(db).length) return null;

const products=Object.values(db);

if(!ENGINE_STATE.active_filters.length) return products[0];

let scored=products.map(p=>{
let score=0;
ENGINE_STATE.active_filters.forEach(f=>{
score+=p.attr[f]||0;
});
return {...p,score};
});

scored.sort((a,b)=>b.score-a.score||a.price-b.price);
return scored[0];
}

/* ===============================
   VERDICT
================================= */

function buildVerdict(){
const winner=calculateWinner();
if(!winner){ showToast("NO DATA"); return; }

ENGINE_STATE.winner=winner;
trackEvent("verdict",{product:winner.name});

const amzn=`https://www.amazon.in/s?k=${encodeURIComponent(winner.name)}&tag=${AMZN_TAG}`;
const yt=`https://www.youtube.com/results?search_query=${encodeURIComponent(winner.name+" review")}`;

const c=document.getElementById("master-container");
c.innerHTML=`
<div class="winner">
<h1>${winner.name}</h1>
<h2>â‚¹${winner.price}</h2>
<div style="margin-top:20px">
<div class="btn btn-primary" onclick="window.open('${amzn}','_blank')">CHECK PRICE</div>
<div class="btn" onclick="window.open('${yt}','_blank')" style="margin-top:10px">WATCH REVIEW</div>
<div class="btn" onclick="generatePDF()" style="margin-top:10px">EXPORT PDF</div>
<div class="btn" onclick="renderLobby()" style="margin-top:10px">HOME</div>
</div>
</div>
`;
}

/* ===============================
   PDF
================================= */

function generatePDF(){
const w=ENGINE_STATE.winner;
if(!w) return;

const {jsPDF}=window.jspdf;
const doc=new jsPDF();
doc.setFontSize(20);
doc.text("DECIDE ENGINE REPORT",20,20);
doc.text("Session: "+ENGINE_STATE.sessionID,20,30);
doc.text("Winner: "+w.name,20,50);
doc.text("Price: â‚¹"+w.price,20,60);
doc.save("Audit_"+ENGINE_STATE.sessionID+".pdf");
trackEvent("pdf_export",{product:w.name});
}

/* ===============================
   UTIL
================================= */

function loadDomain(d){ renderFilters(d); }

function showToast(msg){
const t=document.getElementById("toast");
t.innerText=msg;
t.classList.add("show");
setTimeout(()=>t.classList.remove("show"),2000);
}

/* ===============================
   INIT
================================= */

syncDatabase();
renderLobby();
</script>

</body>
</html>
