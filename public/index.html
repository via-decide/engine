<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover" />
<title>Decide Engine | Universal Logic OS</title>
<meta name="theme-color" content="#000000" />
<link rel="manifest" href="manifest.json" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>

/* =========================
   CORE UI SYSTEM
========================= */

:root{
  --bg:#050505;
  --glass:rgba(20,20,20,0.85);
  --border:rgba(255,255,255,0.1);
  --accent:#ff671f;
  --accent-soft:rgba(255,103,31,0.2);
  --green:#00e676;
}

body{
  margin:0;
  background:radial-gradient(circle at top left,#111,#050505);
  color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  overflow:hidden;
}

/* Layout */

#app-shell{height:100vh;display:flex;flex-direction:column;}
.header{
  padding:20px 30px;
  border-bottom:1px solid var(--border);
  font-weight:700;
  background:rgba(0,0,0,0.6);
  backdrop-filter:blur(12px);
}
.main-layout{flex:1;display:flex;}
.sidebar{
  width:260px;
  border-right:1px solid var(--border);
  background:rgba(0,0,0,0.6);
  padding:20px;
  display:none;
  flex-direction:column;
  gap:10px;
}
.sidebar button{
  background:rgba(255,255,255,0.05);
  border:1px solid var(--border);
  color:#fff;
  padding:12px;
  border-radius:10px;
  cursor:pointer;
}
.sidebar button:hover{background:rgba(255,255,255,0.1);}

.content{flex:1;padding:40px;overflow-y:auto;}

.panel{
  background:var(--glass);
  border:1px solid var(--border);
  border-radius:18px;
  padding:40px;
  max-width:800px;
  backdrop-filter:blur(20px);
}

/* Buttons */

.btn{
  background:var(--accent);
  border:none;
  padding:14px 24px;
  border-radius:12px;
  font-weight:700;
  cursor:pointer;
  margin-top:12px;
}
.btn-secondary{
  background:rgba(255,255,255,0.08);
}

/* Ranking Card */

.rank-card{
  border:1px solid var(--border);
  border-radius:14px;
  padding:20px;
  margin-top:15px;
  background:rgba(255,255,255,0.03);
}

/* Toast */

.toast-msg{
  position:fixed;
  bottom:60px;
  left:50%;
  transform:translateX(-50%);
  background:#111;
  padding:12px 20px;
  border-radius:40px;
  border:1px solid #333;
  opacity:0;
  transition:0.3s;
}
.toast-msg.visible{opacity:1;}

@media (min-width:1024px){
  .sidebar{display:flex;}
}

</style>
</head>
<body>

<div id="app-shell">
  <div class="header">DECIDE ENGINE â€” Universal Logic OS</div>

  <div class="main-layout">

    <div class="sidebar">
      <button onclick="renderHome()">Home</button>
      <button onclick="syncDatabase()">Sync DB</button>
      <button onclick="generateDecisionReport()">Export PDF</button>
    </div>

    <div class="content">
      <div id="master-container"></div>
    </div>

  </div>
</div>

<div id="toast" class="toast-msg"></div>

<script>

/* =========================
   CONFIG + STATE
========================= */

const BACKEND_URL="https://script.google.com/macros/s/AKfycbycz1pVNID7fwlM3ckBsGC_mAjLkMwGoW-UbXHWxdkqdNtYIdeLWfo6EkRef0cHReUO/exec";

let ENGINE_STATE={
  module:null,
  filters:[],
  sessionID:"SID-"+Math.random().toString(36).substr(2,4).toUpperCase(),
  ranking:[],
  winner:null
};

let DATABASE={
  phone:{},
  audio:{},
  laptop:{}
};

/* =========================
   DATABASE
========================= */

async function syncDatabase(){
  if(!navigator.onLine){
    showToast("OFFLINE MODE");
    return;
  }

  try{
    const r=await fetch(`${BACKEND_URL}?type=local`);
    const data=await r.json();

    DATABASE={phone:{},audio:{},laptop:{}};

    data.forEach(p=>{
      if(p.category==="smartphones") DATABASE.phone[p.Name]=p;
      if(p.category==="earbuds") DATABASE.audio[p.Name]=p;
      if(p.category==="laptops") DATABASE.laptop[p.Name]=p;
    });

    showToast("SYSTEM LIVE âœ…");
  }catch{
    showToast("OFFLINE MODE");
  }
}

/* =========================
   HOME
========================= */

function renderHome(){
  ENGINE_STATE.filters=[];
  ENGINE_STATE.module=null;
  ENGINE_STATE.ranking=[];

  document.getElementById("master-container").innerHTML=`
    <div class="panel">
      <h1>DECIDE ENGINE</h1>
      <p>Session: ${ENGINE_STATE.sessionID}</p>

      <button class="btn" onclick="selectModule('phone')">ðŸ“± Phones</button>
      <button class="btn" onclick="selectModule('audio')">ðŸŽ§ Audio</button>
      <button class="btn" onclick="selectModule('laptop')">ðŸ’» Laptops</button>
    </div>
  `;
}

/* =========================
   MODULE FLOW
========================= */

function selectModule(m){
  ENGINE_STATE.module=m;
  ENGINE_STATE.filters=[];

  document.getElementById("master-container").innerHTML=`
    <div class="panel">
      <h1>Select Priorities</h1>

      <button class="btn-secondary btn" onclick="toggleFilter('performance')">Performance</button>
      <button class="btn-secondary btn" onclick="toggleFilter('battery')">Battery</button>
      <button class="btn-secondary btn" onclick="toggleFilter('value')">Value</button>

      <br>
      <button class="btn" onclick="startDecision()">Run Engine â†’</button>
      <button class="btn-secondary btn" onclick="renderHome()">Back</button>
    </div>
  `;
}

function toggleFilter(f){
  if(ENGINE_STATE.filters.includes(f)){
    ENGINE_STATE.filters=ENGINE_STATE.filters.filter(x=>x!==f);
  }else{
    ENGINE_STATE.filters.push(f);
  }
  showToast("Active: "+ENGINE_STATE.filters.join(", "));
}

/* =========================
   SCORING ENGINE
========================= */

function startDecision(){

  if(!ENGINE_STATE.filters.length){
    showToast("Select at least one priority");
    return;
  }

  const db=DATABASE[ENGINE_STATE.module];
  const items=Object.values(db);

  if(!items.length){
    showToast("No data loaded");
    return;
  }

  const ranked=items.map(item=>{
    return {...item,...scoreItem(item)};
  });

  ranked.sort((a,b)=>b.finalScore-a.finalScore || a.price-b.price);

  ENGINE_STATE.ranking=ranked.slice(0,3);
  ENGINE_STATE.winner=ENGINE_STATE.ranking[0];

  renderRanking();
}

function scoreItem(item){

  const price=Number(item.price)||1;

  const perf=Number(item.performance||item.perf||5);
  const bat=Number(item.battery||item.bat||5);
  const val=Number(item.value||item.val||5);

  let weight={performance:1,battery:1,value:1};

  ENGINE_STATE.filters.forEach(f=>weight[f]=2);

  const base=(perf*weight.performance)+(bat*weight.battery)+(val*weight.value);

  const efficiency=(base/price)*1000;

  const finalScore=(base*0.7)+(efficiency*0.3);

  return{
    finalScore:Number(finalScore.toFixed(2)),
    breakdown:{perf,bat,val,efficiency:Number(efficiency.toFixed(2))}
  };
}

/* =========================
   RENDER RANKING
========================= */

function renderRanking(){

  let html=`<div class="panel">
  <h1>Top 3 Ranking</h1>`;

  ENGINE_STATE.ranking.forEach((item,i)=>{
    html+=`
      <div class="rank-card">
        <h2>#${i+1} ${item.Name}</h2>
        <p>Score: ${item.finalScore}</p>
        <p>Price: â‚¹${item.price}</p>
      </div>
    `;
  });

  html+=`
    <button class="btn" onclick="generateDecisionReport()">Export PDF</button>
    <button class="btn-secondary btn" onclick="renderHome()">Home</button>
  </div>`;

  document.getElementById("master-container").innerHTML=html;
}

/* =========================
   PDF
========================= */

function generateDecisionReport(){
  if(!ENGINE_STATE.winner){
    showToast("No result");
    return;
  }

  const { jsPDF }=window.jspdf;
  const doc=new jsPDF();

  doc.text("DECIDE ENGINE REPORT",20,20);
  doc.text("Session: "+ENGINE_STATE.sessionID,20,30);

  ENGINE_STATE.ranking.forEach((item,i)=>{
    doc.text(`#${i+1} ${item.Name} - ${item.finalScore}`,20,50+(i*10));
  });

  doc.save("decision_report.pdf");
}

/* =========================
   UTIL
========================= */

function showToast(msg){
  const t=document.getElementById("toast");
  t.innerText=msg;
  t.classList.add("visible");
  setTimeout(()=>t.classList.remove("visible"),2000);
}

/* =========================
   BOOT
========================= */

renderHome();
syncDatabase();

</script>

</body>
</html>
