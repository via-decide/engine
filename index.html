<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Decide - India's Smart Marketplace</title>
<meta name="description" content="India's first commission-free marketplace. Compare products by YOUR priorities. Starting in Gujarat - Gandhidham & Rajkot." />
<meta name="theme-color" content="#ff671f" />

<!-- FAVICON -->
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéØ</text></svg>" />

<!-- Razorpay SDK -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- ‚úÖ QR generator -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
:root{
  --brand-orange:#ff671f;
  --brand-orange-light:#ff8547;
  --bg-primary:#000000;
  --bg-secondary:#0a0a0a;
  --bg-card:#141414;
  --bg-card-hover:#1a1a1a;
  --border:rgba(255,255,255,0.15);
  --border-strong:rgba(255,255,255,0.2);
  --accent:#00e676;
  --ondc-blue:#1e88e5;
  --text-primary:#ffffff;
  --text-secondary:#b3b3b3;
  --text-tertiary:#808080;
  --error:#ff4444;
  --warning:#ffaa00;
  --success:#00e676;
  --font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
  --safe-bottom:env(safe-area-inset-bottom,0px);
  --radius-md:16px;
  --radius-lg:24px;
  --radius-xl:32px;
  --shadow-md:0 4px 16px rgba(0,0,0,0.4);
  --shadow-lg:0 8px 32px rgba(0,0,0,0.5);
}

*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{min-height:100%;background:var(--bg-primary);color:var(--text-primary);font-family:var(--font)}
body{background:linear-gradient(180deg,#000 0%,#0a0a0a 100%)}
button,input,textarea,select{font:inherit;border:none;background:none;outline:none}
button{cursor:pointer;transition:all .2s ease}
a{text-decoration:none;color:inherit;cursor:pointer}
img{max-width:100%;display:block}

#app{min-height:100vh;padding:20px;padding-bottom:calc(80px + var(--safe-bottom))}

::-webkit-scrollbar{width:8px;height:8px}
::-webkit-scrollbar-track{background:var(--bg-secondary)}
::-webkit-scrollbar-thumb{background:var(--border-strong);border-radius:4px}

.demo-note{
  background:rgba(255,255,255,0.04);
  border:1px solid var(--border);
  border-radius:18px;
  padding:14px 16px;
  margin:0 0 16px;
  color:#bbb;
  line-height:1.65;
}
.demo-note b{color:#fff}

.header{
  position:sticky;top:0;z-index:100;
  background:rgba(10,10,10,0.95);
  backdrop-filter:blur(20px);
  border-bottom:1px solid var(--border);
  padding:16px 20px;
  display:flex;align-items:center;justify-content:space-between;gap:16px;
  margin:-20px -20px 20px;
}
.header-badge{
  background:rgba(255,103,31,0.1);
  border:2px solid var(--brand-orange);
  padding:12px 18px;border-radius:12px;
  font-size:.85rem;font-weight:800;letter-spacing:1px;
  color:var(--brand-orange);
  display:flex;align-items:center;gap:10px;flex:1;
}
.brand{
  display:flex;align-items:center;gap:10px;
  font-weight:900;letter-spacing:1px;
  color:var(--brand-orange);
  padding:10px 14px;border-radius:12px;
  border:2px solid var(--brand-orange);
  background:rgba(255,103,31,0.08);
}
.status-dot{
  width:10px;height:10px;background:var(--accent);border-radius:50%;
  box-shadow:0 0 10px var(--accent);animation:pulse 2s infinite;display:inline-block;
}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

.btn{
  background:transparent;border:2px solid rgba(255,255,255,0.3);
  padding:10px 18px;border-radius:50px;font-size:.85rem;
  font-weight:800;color:#fff;
}
.btn:hover{background:rgba(255,255,255,0.1);border-color:rgba(255,255,255,0.5)}

.floating-cart{
  position:fixed;bottom:24px;right:24px;z-index:1000;
  background:var(--brand-orange);color:var(--bg-primary);
  padding:14px 24px;border-radius:999px;
  box-shadow:0 12px 40px rgba(255,103,31,0.4);
  font-weight:700;font-size:0.875rem;
  display:flex;align-items:center;gap:10px;
}
.cart-badge{
  background:var(--bg-primary);color:var(--brand-orange);
  width:24px;height:24px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:0.75rem;font-weight:900;
}

.wrap{max-width:760px;margin:0 auto;width:100%}
.two-col-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:18px}
.left-col,.right-col{display:flex;flex-direction:column;gap:14px}
.col-header{
  text-align:center;font-size:.72rem;font-weight:900;letter-spacing:1.5px;
  color:#888;padding:10px 0;border-bottom:1px solid var(--border);margin-bottom:4px;
}

.card{
  background:rgba(20,20,20,0.6);border:1px solid var(--border);
  border-radius:22px;padding:20px 16px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:10px;cursor:pointer;transition:.2s;min-height:120px;
}
.card:hover{background:rgba(40,40,40,0.8);border-color:rgba(255,255,255,0.3);transform:translateY(-3px)}
.card[aria-disabled="true"]{opacity:.35;cursor:not-allowed;pointer-events:none}

.icon{font-size:2.6rem}
.title{font-size:1rem;font-weight:900;letter-spacing:.5px;text-align:center;line-height:1.2}
.tag{
  font-size:.7rem;font-weight:800;letter-spacing:1.2px;
  padding:4px 10px;border-radius:8px;text-align:center;
}
.tag-live{color:var(--accent);background:rgba(0,230,118,0.15)}
.tag-neutral{color:#888;background:rgba(136,136,136,0.15)}
.tag-soon{color:#FFA726;background:rgba(255,167,38,0.15)}
.tag-beta{color:#4CAF50;background:rgba(76,175,80,0.15)}
.tag-city{color:#42A5F5;background:rgba(66,165,245,0.15)}

.hero{
  text-align:center;padding:48px 20px 32px;
  background:linear-gradient(135deg,rgba(255,103,31,0.08),transparent);
  border-radius:var(--radius-xl);margin-bottom:32px;
  border:1px solid var(--border);
}
.hero-title{
  font-size:2.5rem;font-weight:900;margin-bottom:12px;
  background:linear-gradient(135deg,var(--text-primary),var(--text-secondary));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  letter-spacing:-1px;line-height:1.1;
}
.hero-subtitle{font-size:1.125rem;color:var(--text-secondary);line-height:1.6;max-width:600px;margin:0 auto}

.restaurant-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
  gap:24px;margin-bottom:32px;
}

.restaurant-card{
  background:var(--bg-card);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  overflow:hidden;
  transition:all .25s ease;
  cursor:pointer;
}
.restaurant-card:hover{background:var(--bg-card-hover);border-color:var(--border-strong);transform:translateY(-4px);box-shadow:var(--shadow-lg)}

.restaurant-image{
  width:100%;height:180px;
  background:linear-gradient(135deg,rgba(255,103,31,0.2),rgba(255,103,31,0.05));
  display:flex;align-items:center;justify-content:center;
  font-size:4rem;position:relative;overflow:hidden;
}

.restaurant-info{padding:20px}
.restaurant-name{font-size:1.25rem;font-weight:700;margin-bottom:6px}
.restaurant-meta{display:flex;align-items:center;gap:12px;flex-wrap:wrap;font-size:.875rem;color:var(--text-secondary)}
.meta-item{display:flex;align-items:center;gap:4px}
.rating{background:var(--success);color:var(--bg-primary);padding:2px 8px;border-radius:6px;font-weight:700;font-size:.8125rem}
.restaurant-tags{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.restaurant-footer{padding-top:12px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.view-menu-btn{
  padding:8px 20px;border-radius:999px;
  background:var(--brand-orange);color:var(--bg-primary);
  font-weight:700;font-size:.875rem;
}
.view-menu-btn:hover{background:var(--brand-orange-light);transform:scale(1.03)}

.menu-header{
  background:var(--bg-card);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:24px;margin-bottom:24px;
}
.menu-restaurant-name{font-size:2rem;font-weight:900;margin-bottom:8px}
.menu-restaurant-meta{display:flex;align-items:center;gap:16px;flex-wrap:wrap;color:var(--text-secondary);font-size:.875rem}

.menu-categories{display:flex;gap:12px;overflow-x:auto;padding:8px 0 16px;margin-bottom:24px;scrollbar-width:none}
.menu-categories::-webkit-scrollbar{display:none}
.category-btn{
  padding:10px 24px;border-radius:999px;
  background:var(--bg-card);
  border:1px solid var(--border);
  color:var(--text-secondary);
  font-weight:600;font-size:.875rem;
  white-space:nowrap;flex-shrink:0;
}
.category-btn.active{background:var(--brand-orange);border-color:var(--brand-orange);color:var(--bg-primary)}

.menu-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;margin-bottom:32px}
.menu-item{
  background:var(--bg-card);
  border:1px solid var(--border);
  border-radius:var(--radius-md);
  padding:16px;
  transition:all .2s ease;
  display:flex;flex-direction:column;
}
.menu-item:hover{background:var(--bg-card-hover);border-color:var(--border-strong);transform:translateY(-2px);box-shadow:var(--shadow-md)}
.menu-item-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:8px}
.menu-item-icon{font-size:2.5rem;width:60px;height:60px;display:flex;align-items:center;justify-content:center;background:rgba(255,103,31,0.1);border-radius:12px}
.menu-item-name{font-size:1.125rem;font-weight:700;margin-bottom:4px}
.menu-item-desc{font-size:.875rem;color:var(--text-secondary);margin-bottom:8px;line-height:1.5}
.menu-item-meta{display:flex;align-items:center;gap:12px;font-size:.8125rem;color:var(--text-tertiary);margin-bottom:12px}
.menu-item-footer{display:flex;align-items:center;justify-content:space-between;margin-top:auto;padding-top:12px;border-top:1px solid var(--border)}
.menu-item-price{font-size:1.25rem;font-weight:900}
.add-to-cart-btn{
  padding:8px 20px;border-radius:999px;
  background:var(--brand-orange);color:var(--bg-primary);
  font-weight:700;font-size:.875rem;
  display:flex;align-items:center;gap:6px;
}
.add-to-cart-btn:hover{background:var(--brand-orange-light);transform:scale(1.03)}

.cart-container{max-width:800px;margin:0 auto}
.cart-items,.cart-summary,.payment-section{
  background:var(--bg-card);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:24px;margin-bottom:24px;
}
.cart-title{font-size:1.5rem;font-weight:900;margin-bottom:20px}
.cart-item{
  display:flex;align-items:center;gap:16px;
  padding:16px;border-radius:var(--radius-md);
  background:rgba(255,255,255,0.03);
  margin-bottom:12px;
}
.cart-item:last-child{margin-bottom:0}
.cart-item-name{font-weight:700;margin-bottom:4px}
.cart-item-seller{font-size:.875rem;color:var(--text-secondary)}
.cart-item-price{font-weight:900;color:var(--brand-orange)}
.remove-btn{
  padding:6px 12px;border-radius:8px;
  background:rgba(255,68,68,0.1);
  border:1px solid rgba(255,68,68,0.3);
  color:var(--error);font-size:.8125rem;font-weight:600;
}
.remove-btn:hover{background:rgba(255,68,68,0.2)}

.summary-row{display:flex;justify-content:space-between;padding:12px 0;font-size:.9375rem}
.summary-row.total{padding-top:16px;border-top:1px solid var(--border);font-size:1.25rem;font-weight:900;color:var(--brand-orange)}
.summary-label{color:var(--text-secondary)}
.summary-value{font-weight:700}

.payment-title{font-size:1.25rem;font-weight:900;margin-bottom:20px}
.payment-methods{display:flex;flex-direction:column;gap:12px}
.payment-method{
  padding:20px;border-radius:var(--radius-md);
  background:rgba(255,255,255,0.03);
  border:2px solid var(--border);
  display:flex;align-items:center;gap:16px;
  cursor:pointer;transition:all .2s ease;
}
.payment-method:hover{background:rgba(255,255,255,0.05);border-color:var(--border-strong)}
.payment-method.selected{border-color:var(--brand-orange);background:rgba(255,103,31,0.08)}
.payment-icon{font-size:2rem;width:48px;height:48px;display:flex;align-items:center;justify-content:center;background:rgba(255,103,31,0.1);border-radius:12px}
.payment-info{flex:1}
.payment-name{font-weight:700;margin-bottom:4px}
.payment-desc{font-size:.875rem;color:var(--text-secondary)}
.payment-badge{padding:4px 12px;border-radius:999px;background:var(--success);color:var(--bg-primary);font-size:.75rem;font-weight:700}

.upi-qr-container{
  background:rgba(255,255,255,0.05);
  border:1px solid var(--border-strong);
  border-radius:var(--radius-lg);
  padding:24px;
  text-align:center;
  margin:24px 0;
}
.upi-qr-buttons{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
  margin-top:16px;
}

.action,.secondary{
  padding:16px 32px;border-radius:var(--radius-md);
  font-weight:700;font-size:1rem;
  display:flex;align-items:center;justify-content:center;gap:8px;
  transition:all .2s ease;width:100%;
  text-transform:uppercase;
}
.action{background:var(--brand-orange);color:var(--bg-primary)}
.action:hover{background:var(--brand-orange-light);transform:translateY(-2px);box-shadow:var(--shadow-md)}
.secondary{background:transparent;color:#fff;border:2px solid var(--border)}
.secondary:hover{background:rgba(255,255,255,0.1);border-color:var(--border-strong)}

.success-screen{text-align:center;padding:48px 20px}
.success-icon{
  width:100px;height:100px;border-radius:50%;
  background:var(--success);
  display:flex;align-items:center;justify-content:center;
  margin:0 auto 24px;font-size:3rem;
}
.success-title{font-size:2rem;font-weight:900;margin-bottom:12px;color:var(--success)}
.success-order-id{
  display:inline-flex;align-items:center;gap:8px;
  padding:12px 24px;border-radius:999px;
  background:rgba(0,230,118,0.1);
  border:1px solid rgba(0,230,118,0.3);
  font-weight:700;margin-bottom:32px;
}

.toast{
  position:fixed;bottom:calc(24px + var(--safe-bottom));left:50%;
  transform:translateX(-50%) translateY(100px);
  background:var(--bg-card);
  border:1px solid var(--border-strong);
  padding:16px 24px;border-radius:var(--radius-md);
  box-shadow:0 16px 48px rgba(0,0,0,.6);
  font-weight:600;font-size:.9375rem;
  z-index:2000;opacity:0;
  transition:all .3s cubic-bezier(0.68,-0.55,0.265,1.55);
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.success{border-color:var(--success);color:var(--success)}
.toast.error{border-color:var(--error);color:var(--error)}

.static-page{max-width:860px;margin:0 auto}
.static-hero{
  background:linear-gradient(135deg,rgba(255,103,31,0.10),transparent);
  border:1px solid var(--border);
  border-radius:32px;
  padding:26px 20px;
  box-shadow:var(--shadow-lg);
  margin-bottom:16px;
}
.static-meta{color:var(--text-secondary);font-size:.95rem;line-height:1.6}
.static-card{
  background:rgba(20,20,20,0.65);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:18px;
  margin:12px 0;
}
.static-card h2{font-size:1.15rem;margin:0 0 10px}
.static-card p,.static-card li{color:var(--text-secondary);line-height:1.75}
.static-card ul{padding-left:18px}

.footer{
  text-align:center;margin-top:30px;padding-top:20px;
  border-top:1px solid var(--border);color:#666;font-size:.85rem;
}
.footer a{color:#888;margin:0 10px;text-decoration:none}
.footer a:hover{color:var(--brand-orange)}

@media (max-width:768px){
  .hero-title{font-size:2rem}
  .restaurant-grid{grid-template-columns:1fr}
  .menu-grid{grid-template-columns:1fr}
  .menu-restaurant-name{font-size:1.5rem}
  .floating-cart{bottom:16px;right:16px;padding:12px 20px;font-size:.8125rem}
  .two-col-grid{grid-template-columns:1fr}
  .upi-qr-buttons{grid-template-columns:1fr}
}
</style>
</head>
<body>

<div id="app"></div>
<div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true"></div>

<div id="floatingCart" class="floating-cart" style="display:none">
  <span class="cart-badge" id="cartCount">0</span>
  <span>View Cart</span>
</div>

<script>
(function(){
  "use strict";

  // ======================
  // CONFIG
  // ======================
  const RAZORPAY_KEY = "rzp_test_YOUR_KEY_ID";
  const SUPABASE_URL = "https://zdarsygrpqbbcafrqcjt.supabase.co";
  const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";

  let sbClient = null;
  function initSupabase(){
    try{
      if(typeof window.supabase !== 'undefined' && window.supabase.createClient){
        sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        return sbClient;
      }
    }catch(e){}
    return null;
  }

  // ======================
  // STATE
  // ======================
  const STATE = {
    cart: [],
    orders: [],
    currentRestaurant: null,
    selectedPaymentMethod: 'razorpay',
    filterCategory: 'all',
    domain: null,
    session: "SID-" + Math.random().toString(36).slice(2,6).toUpperCase(),
    filters: [],
    lastEcomCategory: null,
    lastPaymentAmount: null,
    lastTxnRef: null,
    lastUpiLink: null
  };

  // ======================
  // HELPERS
  // ======================
  function $(id){return document.getElementById(id)}
  function esc(s){
    s = String(s == null ? "" : s);
    return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }
  function money(n){return "‚Çπ" + Number(n||0).toLocaleString("en-IN")}
  function safeId(){
    try{ if(window.crypto && crypto.randomUUID) return crypto.randomUUID(); }catch(e){}
    return "dev-" + Math.random().toString(36).slice(2) + "-" + Date.now().toString(36);
  }

  function toast(msg, type = 'success'){
    const t = $("toast");
    if(!t) return;
    t.textContent = String(msg);
    t.className = 'toast ' + type;
    t.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(() => t.classList.remove("show"), 3000);
  }

  function updateFloatingCart(){
    const fc = $("floatingCart");
    const count = STATE.cart.length;
    if(count > 0){
      fc.style.display = 'flex';
      $("cartCount").textContent = count;
    }else{
      fc.style.display = 'none';
    }
  }

  function saveCart(){ try{ localStorage.setItem('decide_cart', JSON.stringify(STATE.cart)); }catch(e){} }
  function loadCart(){
    try{
      const data = JSON.parse(localStorage.getItem('decide_cart') || '[]');
      STATE.cart = Array.isArray(data) ? data : [];
    }catch(e){ STATE.cart = []; }
  }

  function loadOrders(){
    try{
      var x = JSON.parse(localStorage.getItem("order_history") || "[]");
      STATE.orders = Array.isArray(x) ? x : [];
    }catch(e){ STATE.orders = []; }
  }
  function saveOrders(){ try{ localStorage.setItem("order_history", JSON.stringify(STATE.orders)); }catch(e){} }

  function loadUtrIndex(){
    try{
      var x = JSON.parse(localStorage.getItem("utr_index") || "{}");
      return (x && typeof x === "object") ? x : {};
    }catch(e){ return {}; }
  }
  function saveUtrIndex(idx){
    try{ localStorage.setItem("utr_index", JSON.stringify(idx || {})); }catch(e){}
  }

  // ‚úÖ Single totals function
  function calcCartTotals(){
    const subtotal = STATE.cart.reduce((sum, item) => {
      const price = Number(item.price || 0);
      const qty = Number(item.qty || 1);
      return sum + (price * qty);
    }, 0);

    const isFood = (STATE.cart[0] && STATE.cart[0].type === "food");
    const taxRate = isFood ? 0.05 : 0.18;
    const gst = Math.round(subtotal * taxRate);
    const total = Number((subtotal + gst).toFixed(2));
    return { subtotal, gst, total, isFood, taxRate };
  }

  // ======================
  // DATA
  // ======================
  const RESTAURANTS = [
    {
      id: "rajkot-thali-001",
      name: "Unlimited Gujarati Thali",
      type: "Gujarati",
      area: "Race Course Road",
      rating: 4.8,
      prepTime: 25,
      priceForTwo: 300,
      tags: ["veg", "family", "unlimited"],
      icon: "üçõ",
      upiId: "6351537770@yapl",
      upiAccountName: "Dharam Jitendra Daxini",
      whatsapp: "https://wa.me/916351537770",
      menu: [
        {id:"thali-1",name:"Gujarati Thali",price:150,veg:true,desc:"Unlimited thali with sabzis, dal, rice, roti, papad & chaas",prepMins:20,category:"main",icon:"üçõ"},
        {id:"pav-1",name:"Pav Bhaji",price:120,veg:true,desc:"Mumbai style pav bhaji with butter and lemon",prepMins:15,category:"main",icon:"ü•ò"},
        {id:"dhokla-1",name:"Khaman Dhokla",price:60,veg:true,desc:"Soft and fluffy steamed dhokla",prepMins:10,category:"snacks",icon:"üü°"},
        {id:"chaas-1",name:"Masala Chaas",price:25,veg:true,desc:"Fresh buttermilk with spices",prepMins:5,category:"drinks",icon:"ü•§"},
        {id:"fafda-1",name:"Fafda Jalebi",price:80,veg:true,desc:"Crispy fafda with sweet jalebi",prepMins:15,category:"snacks",icon:"ü•®"}
      ]
    }
  ];

  const ECOMMERCE_DATA = [
    {category:"smartphones",name:"iPhone 15 Pro",price:134900,cam:9,gam:9,bat:7,seller:"Apple Store",rating:4.8,stock:50,delivery:"2 days",warranty:"1 year",city:"Gandhidham"},
    {category:"smartphones",name:"Samsung S24 Ultra",price:129999,cam:10,gam:9,bat:8,seller:"Samsung",rating:4.9,stock:40,delivery:"3 days",warranty:"1 year",city:"Gandhidham"},
    {category:"smartphones",name:"OnePlus 12",price:63999,cam:8,gam:9,bat:9,seller:"OnePlus",rating:4.7,stock:110,delivery:"1 day",warranty:"1 year",city:"Gandhidham"},
    {category:"earbuds",name:"AirPods Pro 2",price:24499,snd:9,anc:10,mic:9,seller:"Apple Store",rating:4.8,stock:150,delivery:"1 day",warranty:"1 year",city:"Gandhidham"},
    {category:"earbuds",name:"Sony WF-1000XM5",price:23990,snd:10,anc:10,mic:8,seller:"Sony",rating:4.8,stock:90,delivery:"1 day",warranty:"1 year",city:"Gandhidham"},
    {category:"laptops",name:"MacBook Air M3",price:113900,perf:9,port:7,scr:9,seller:"Apple Store",rating:4.8,stock:55,delivery:"2 days",warranty:"1 year",city:"Gandhidham"},
    {category:"laptops",name:"Dell XPS 13",price:139990,perf:8,port:6,scr:9,seller:"Dell",rating:4.7,stock:40,delivery:"4 days",warranty:"1 year",city:"Gandhidham"}
  ];

  // ecommerce memory
  let DB = { smartphones:{}, earbuds:{}, laptops:{} };
  let RESULTS = [];

  function loadToMemory(arr){
    DB = { smartphones:{}, earbuds:{}, laptops:{} };
    (arr || []).forEach(function(p){
      if(!p || !p.category || !p.name) return;
      if(!DB[p.category]) DB[p.category] = {};
      if(!DB[p.category][p.name]) DB[p.category][p.name] = [];
      DB[p.category][p.name].push({
        name:p.name,
        price:Number(p.price)||0,
        seller:p.seller||"Seller",
        rating:Number(p.rating)||4.0,
        stock:Number(p.stock)||0,
        delivery:p.delivery||"2-5 days",
        warranty:p.warranty||"6 months",
        city:p.city||"",
        attr:{
          cam:Number(p.cam)||0, gam:Number(p.gam)||0, bat:Number(p.bat)||0,
          snd:Number(p.snd)||0, anc:Number(p.anc)||0, mic:Number(p.mic)||0,
          perf:Number(p.perf)||0, port:Number(p.port)||0, scr:Number(p.scr)||0
        }
      });
    });
  }

  // ======================
  // SPA ROUTING (HASH)
  // ======================
  function navigate(path){
    // path like: /, /privacy, /terms, /contact, /cookies
    location.hash = "#" + path;
  }

  function route(){
    const h = (location.hash || "#/").replace(/^#/, "");
    if(h === "/" || h === "") return goHome();
    if(h === "/privacy") return renderPrivacy();
    if(h === "/terms") return renderTerms();
    if(h === "/contact") return renderContact();
    if(h === "/cookies") return renderCookies();
    // unknown => home
    goHome();
  }

  window.addEventListener("hashchange", route);

  // ======================
  // LANDING / HOME
  // ======================
  function isVisited(){ return localStorage.getItem("decide_visited") === "true"; }
  function markVisited(){ localStorage.setItem("decide_visited","true"); }

  function goHome(){
    if(isVisited()) renderLobby();
    else renderLanding();
  }

  function renderLanding(){
    $("app").innerHTML =
      '<div class="wrap" style="text-align:center;padding-top:26px">' +
        '<div class="header" style="margin-bottom:10px">' +
          '<div class="header-badge">DECIDE INDIA <span class="status-dot" aria-hidden="true"></span></div>' +
          '<button class="btn" type="button" data-action="home">HOME</button>' +
        '</div>' +
        '<div class="demo-note">‚ö† <b>Beta Version</b> ‚Äî Currently serving Rajkot. More cities coming soon!</div>' +
        '<h1 style="font-size:3rem;margin:10px 0 10px;color:var(--brand-orange);letter-spacing:2px">DECIDE</h1>' +
        '<div style="font-size:1.05rem;margin-bottom:18px;color:#bbb">India\'s Smart Marketplace (Commission-free)</div>' +
        '<div class="payment-box" style="max-width:760px;margin:0 auto 14px;text-align:left">' +
          '<div style="font-size:1.05rem;font-weight:900;margin-bottom:10px">üéØ What is Decide?</div>' +
          '<div style="color:#ccc;line-height:1.7">' +
            '‚Ä¢ <b>Smart comparison:</b> Compare products by YOUR priorities<br>' +
            '‚Ä¢ <b>Zero commission:</b> No seller commission / no paid rank<br>' +
            '‚Ä¢ <b>Local-first:</b> City-first discovery (starting Gujarat)<br>' +
            '‚Ä¢ <b>Transparent ranking:</b> No algorithm suppression' +
          '</div>' +
        '</div>' +
        '<button class="secondary" type="button" data-action="lobby">SKIP TO APP ‚Üí</button>' +
        '<div class="footer">' +
          '<a data-action="privacy">Privacy</a> ‚Ä¢ ' +
          '<a data-action="terms">Terms</a> ‚Ä¢ ' +
          '<a data-action="contact">Contact</a> ‚Ä¢ ' +
          '<a data-action="cookies">Cookies</a>' +
        '</div>' +
      '</div>';
  }

  function renderLobby(){
    const cartCount = STATE.cart.length;
    $("app").innerHTML =
      '<div class="header">' +
        '<div class="header-badge">DECIDE INDIA <span class="status-dot" aria-hidden="true"></span></div>' +
        '<button class="btn" type="button" data-action="home">HOME</button>' +
      '</div>' +
      '<div class="demo-note">üéâ <b>Now Live in Rajkot!</b> Order food with Razorpay or UPI QR payment.</div>' +
      '<div class="two-col-grid">' +
        '<div class="left-col">' +
          '<div class="col-header">MAIN CATEGORIES</div>' +
          '<div class="card" role="button" tabindex="0" data-action="module" data-module="ecommerce">' +
            '<div class="icon">üõçÔ∏è</div><div class="title">E-COMMERCE</div><div class="tag tag-live">GANDHIDHAM</div>' +
          '</div>' +
          '<div class="card" role="button" tabindex="0" data-action="module" data-module="food">' +
            '<div class="icon">üçΩÔ∏è</div><div class="title">FOOD</div><div class="tag tag-live">RAJKOT ‚Ä¢ UPI</div>' +
          '</div>' +
          '<div class="card" role="button" tabindex="0" data-action="feedback">' +
            '<div class="icon">üí¨</div><div class="title">FEEDBACK CENTER</div><div class="tag tag-beta">OPEN</div>' +
          '</div>' +
        '</div>' +
        '<div class="right-col">' +
          '<div class="col-header">ACTIVE MVP CITIES</div>' +
          '<div class="card" role="button" tabindex="0" data-action="city" data-city="Gandhidham">' +
            '<div class="icon">üèôÔ∏è</div><div class="title">GANDHIDHAM</div><div class="tag tag-city">E-COM LIVE</div>' +
          '</div>' +
          '<div class="card" role="button" tabindex="0" data-action="city" data-city="Rajkot">' +
            '<div class="icon">üèôÔ∏è</div><div class="title">RAJKOT</div><div class="tag tag-city">FOOD LIVE</div>' +
          '</div>' +
        '</div>' +
      '</div>' +
      '<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:16px">' +
        '<div class="card" role="button" tabindex="0" data-action="orders">' +
          '<div class="icon">üì¶</div><div class="title">MY ORDERS</div><div class="tag tag-beta">TRACK</div>' +
        '</div>' +
        '<div class="card" role="button" tabindex="0" data-action="viewCart" aria-disabled="' + (cartCount? "false":"true") + '">' +
          '<div class="icon">üõí</div><div class="title">CART</div><div class="tag tag-neutral">' + cartCount + ' ITEMS</div>' +
        '</div>' +
      '</div>' +
      '<div style="text-align:center;margin-top:18px;color:#888;font-size:.85rem">Session: ' + esc(STATE.session) + '</div>' +
      '<div class="footer">' +
        '<a data-action="privacy">Privacy</a> ‚Ä¢ ' +
        '<a data-action="terms">Terms</a> ‚Ä¢ ' +
        '<a data-action="contact">Contact</a> ‚Ä¢ ' +
        '<a data-action="cookies">Cookies</a>' +
      '</div>';
  }

  // ======================
  // FEEDBACK (local only)
  // ======================
  function renderFeedbackCenter(){
    let list = [];
    try{
      list = JSON.parse(localStorage.getItem("feedback_items") || "[]");
      if(!Array.isArray(list)) list = [];
    }catch(e){ list = []; }

    const itemsHtml = list.slice().reverse().map(function(it){
      return (
        '<div style="background:rgba(20,20,20,0.6);border:1px solid var(--border);border-radius:18px;padding:18px;margin-bottom:12px">' +
          '<div style="font-weight:900">' + esc(it.title || "Feedback") + '</div>' +
          '<div style="color:#888;font-size:.9rem;margin-top:8px;line-height:1.6">' + esc(it.message || "") + '</div>' +
          '<div style="color:#666;font-size:.8rem;margin-top:10px">Saved: ' + esc(new Date(it.ts).toLocaleString("en-IN")) + '</div>' +
        '</div>'
      );
    }).join("");

    $("app").innerHTML =
      '<div class="wrap">' +
        '<div class="hero-title" style="font-size:2rem">Feedback Center</div>' +
        '<div style="color:#bbb;margin:6px 0 14px">Tell your ideas.</div>' +
        '<div class="payment-box">' +
          '<div style="color:#888;font-size:.85rem;margin-bottom:8px">Title</div>' +
          '<input id="fb_title" placeholder="e.g. Add seller rating..." />' +
          '<div style="height:10px"></div>' +
          '<div style="color:#888;font-size:.85rem;margin-bottom:8px">Message</div>' +
          '<textarea id="fb_msg" placeholder="Write your idea..."></textarea>' +
        '</div>' +
        '<button class="action" type="button" data-action="fbSubmit">SUBMIT FEEDBACK</button>' +
        '<button class="secondary" type="button" data-action="home" style="margin-top:10px">‚Üê HOME</button>' +
        '<div style="height:18px"></div>' +
        '<div style="color:#bbb;margin-bottom:10px">Your saved feedback</div>' +
        (itemsHtml || '<div style="color:#888">No feedback yet.</div>') +
      '</div>';
  }

  function fbSubmit(){
    const title = (($("fb_title")||{}).value || "").trim();
    const msg = (($("fb_msg")||{}).value || "").trim();
    if(msg.length < 5){ toast("Write a longer message", "error"); return; }
    try{
      const arr = JSON.parse(localStorage.getItem("feedback_items") || "[]");
      const list = Array.isArray(arr) ? arr : [];
      list.push({ id:safeId(), title:title||"Feedback", message:msg, ts:new Date().toISOString() });
      localStorage.setItem("feedback_items", JSON.stringify(list));
      toast("‚úÖ Saved!");
      renderFeedbackCenter();
    }catch(e){
      toast("Save failed", "error");
    }
  }

  // ======================
  // CITY / ECOMMERCE
  // ======================
  function renderCity(city){
    let cards = '';
    if(city === "Gandhidham"){
      cards += cardLink("üõçÔ∏è","E-COMMERCE","LIVE","tag-live","ecommerce");
    }else if(city === "Rajkot"){
      cards += cardLink("üçΩÔ∏è","FOOD","LIVE","tag-live","food");
    }else{
      toast("City coming soon","error");
      renderLobby();
      return;
    }

    $("app").innerHTML =
      '<div class="wrap">' +
        '<div class="hero-title" style="font-size:2rem">' + esc(city) + '</div>' +
        '<div style="color:#bbb;margin:6px 0 14px">Available modules</div>' +
        cards +
        '<button class="secondary" type="button" data-action="home">‚Üê HOME</button>' +
      '</div>';

    function cardLink(icon,title,status,tagClass,action){
      return (
        '<div class="card" role="button" tabindex="0" data-action="' + esc(action) + '" style="margin-bottom:12px">' +
          '<div class="icon">' + icon + '</div><div class="title">' + esc(title) + '</div><div class="tag ' + tagClass + '">' + esc(status) + '</div>' +
        '</div>'
      );
    }
  }

  function renderEcommerce(){
    STATE.domain = "ecommerce";
    $("app").innerHTML =
      '<div class="wrap">' +
        '<div class="hero-title" style="font-size:2rem">E-COMMERCE</div>' +
        '<div style="color:#bbb;margin:6px 0 14px">Gandhidham MVP ‚Ä¢ Choose category</div>' +
        '<div class="card" role="button" tabindex="0" data-action="category" data-cat="smartphones" style="margin-bottom:12px">' +
          '<div class="icon">üì±</div><div class="title">SMARTPHONES</div><div class="tag tag-live">AVAILABLE</div>' +
        '</div>' +
        '<div class="card" role="button" tabindex="0" data-action="category" data-cat="earbuds" style="margin-bottom:12px">' +
          '<div class="icon">üéß</div><div class="title">AUDIO DEVICES</div><div class="tag tag-live">AVAILABLE</div>' +
        '</div>' +
        '<div class="card" role="button" tabindex="0" data-action="category" data-cat="laptops" style="margin-bottom:12px">' +
          '<div class="icon">üíª</div><div class="title">LAPTOPS</div><div class="tag tag-live">AVAILABLE</div>' +
        '</div>' +
        '<button class="secondary" type="button" data-action="home">‚Üê HOME</button>' +
      '</div>';
  }

  function renderFilters(cat){
    STATE.domain = cat;
    STATE.lastEcomCategory = cat;
    STATE.filters = [];

    const filters = {
      smartphones:["cam","gam","bat"],
      earbuds:["snd","anc","mic"],
      laptops:["perf","port","scr"]
    };
    const labels = {
      cam:"CAMERA",gam:"GAMING",bat:"BATTERY",
      snd:"SOUND",anc:"NOISE",mic:"MIC",
      perf:"POWER",port:"TRAVEL",scr:"SCREEN"
    };

    const btns = (filters[cat] || []).map(function(f){
      return '<div class="card" role="button" tabindex="0" data-action="toggle" data-filter="' + f + '" style="min-height:auto;padding:16px">' +
        '<div class="title">' + labels[f] + '</div>' +
      '</div>';
    }).join("");

    $("app").innerHTML =
      '<div class="wrap">' +
        '<div class="hero-title" style="font-size:2rem">' + esc(cat) + '</div>' +
        '<div style="color:#bbb;margin:6px 0 14px">Pick priorities (tap)</div>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px">' + btns + '</div>' +
        '<button class="action" type="button" data-action="search">FIND BEST DEALS</button>' +
        '<button class="secondary" type="button" data-action="ecommerce" style="margin-top:10px">‚Üê BACK</button>' +
      '</div>';
  }

  function toggleFilter(key, el){
    const i = STATE.filters.indexOf(key);
    if(i >= 0){
      STATE.filters.splice(i, 1);
      el.style.borderColor = "var(--border)";
      el.style.background = "rgba(20,20,20,0.6)";
      toast("Removed","error");
    }else{
      STATE.filters.push(key);
      el.style.borderColor = "var(--brand-orange)";
      el.style.background = "rgba(255,103,31,0.08)";
      toast("Added","success");
    }
  }

  function search(){
    const cat = STATE.domain;
    const db = DB[cat];
    if(!db || !Object.keys(db).length){ toast("No items","error"); return; }

    const all = [];
    Object.keys(db).forEach(function(name){
      (db[name] || []).forEach(function(seller){
        let score = 0;
        if(STATE.filters.length){
          STATE.filters.forEach(function(f){ score += (seller.attr && seller.attr[f]) ? seller.attr[f] : 0; });
        }
        all.push({
          type:"ecommerce",
          name:seller.name,
          price:seller.price,
          seller:seller.seller,
          rating:seller.rating,
          stock:seller.stock,
          delivery:seller.delivery,
          warranty:seller.warranty,
          city:seller.city,
          score:score
        });
      });
    });

    all.sort(function(a,b){
      if(b.score !== a.score) return b.score - a.score;
      return a.price - b.price;
    });

    RESULTS = all.slice(0,10);
    renderMarketplace();
  }

  function renderMarketplace(){
    if(!RESULTS.length){ toast("No results","error"); return; }

    const list = RESULTS.map(function(p, idx){
      const discount = Math.floor(Math.random()*20)+5;
      const original = p.price ? Math.floor(p.price/(1-discount/100)) : p.price;

      return (
        '<div style="background:rgba(20,20,20,0.6);border:1px solid var(--border);border-radius:18px;padding:18px;margin-bottom:12px">' +
          '<div style="display:flex;justify-content:space-between;gap:12px">' +
            '<div>' +
              '<div style="font-size:1.12rem;font-weight:900;margin:0 0 6px">' + esc(p.name) + '</div>' +
              '<div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">' +
                '<span style="background:rgba(30,136,229,0.2);color:var(--ondc-blue);padding:4px 10px;border-radius:8px;font-size:.75rem;font-weight:800">' + esc(p.seller) + '</span>' +
                '<span class="rating">‚≠ê ' + Number(p.rating||0).toFixed(1) + '</span>' +
                '<span style="background:rgba(30,136,229,0.2);color:var(--ondc-blue);padding:4px 10px;border-radius:8px;font-size:.75rem;font-weight:800">' + esc(p.city) + '</span>' +
              '</div>' +
            '</div>' +
            '<div style="text-align:right">' +
              '<div style="font-size:1.6rem;font-weight:900;color:var(--brand-orange)">' + money(p.price) + '</div>' +
              '<div style="font-size:.9rem;color:#888;text-decoration:line-through;margin-top:5px">' + money(original) + '</div>' +
              '<div style="color:var(--accent);font-size:.85rem;font-weight:800;margin-top:5px">' + discount + '% OFF</div>' +
            '</div>' +
          '</div>' +
          '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:14px 0;padding:14px;background:rgba(255,255,255,0.03);border-radius:12px">' +
            '<div><div style="color:#888;font-size:.85rem;margin-bottom:6px">Stock</div><div style="font-weight:900">' + Number(p.stock||0) + ' units</div></div>' +
            '<div><div style="color:#888;font-size:.85rem;margin-bottom:6px">Delivery</div><div style="font-weight:900">' + esc(p.delivery||"") + '</div></div>' +
          '</div>' +
          '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">' +
            '<button class="action" type="button" data-action="buyEcom" data-idx="' + idx + '">BUY NOW</button>' +
            '<button class="secondary" type="button" data-action="addEcom" data-idx="' + idx + '">ADD TO CART</button>' +
          '</div>' +
        '</div>'
      );
    }).join("");

    $("app").innerHTML =
      '<div style="max-width:860px;margin:0 auto;padding:8px 0">' +
        '<div style="text-align:center;margin-bottom:16px">' +
          '<h2 style="margin:0;font-size:1.6rem">BEST DEALS</h2>' +
          '<div style="color:#bbb;margin-top:8px">Comparing ' + RESULTS.length + ' options</div>' +
        '</div>' +
        list +
        '<button class="secondary" type="button" data-action="category" data-cat="' + esc(STATE.lastEcomCategory || "smartphones") + '">‚Üê REFINE</button>' +
        '<button class="secondary" type="button" data-action="home" style="margin-top:10px">‚Üê HOME</button>' +
      '</div>';
  }

  function addEcom(idx){
    const p = RESULTS[idx]; if(!p) return;
    STATE.cart.push({ type:"ecommerce", name:p.name, seller:p.seller, price:Number(p.price)||0, qty:1 });
    saveCart(); updateFloatingCart();
    toast("Added to cart");
  }

  function buyEcom(idx){
    const p = RESULTS[idx]; if(!p) return;
    STATE.cart = [{ type:"ecommerce", name:p.name, seller:p.seller, price:Number(p.price)||0, qty:1 }];
    saveCart(); updateFloatingCart();
    viewCart();
  }

  // ======================
  // FOOD
  // ======================
  function renderFood(){
    STATE.domain = "food";
    const html = `
      <div class="header">
        <div class="header-badge">DECIDE INDIA <span class="status-dot"></span></div>
        <button class="btn" type="button" data-action="home">HOME</button>
      </div>

      <div class="hero">
        <h1 class="hero-title">Order Food in Rajkot</h1>
        <p class="hero-subtitle">Fresh, Fast & Zero Commission. Support your local businesses.</p>
      </div>

      <div class="restaurant-grid">
        ${RESTAURANTS.map(r => `
          <div class="restaurant-card" data-action="restaurant" data-rid="${r.id}" role="button" tabindex="0">
            <div class="restaurant-image"><span>${r.icon}</span></div>
            <div class="restaurant-info">
              <div class="restaurant-name">${esc(r.name)}</div>
              <div class="restaurant-meta">
                <div class="meta-item"><span class="rating">‚≠ê ${r.rating}</span></div>
                <div class="meta-item">‚è±Ô∏è ${r.prepTime} mins</div>
                <div class="meta-item">üìç ${esc(r.area)}</div>
              </div>
              <div class="restaurant-footer">
                <div style="color:#bbb"><b style="color:#fff">${money(r.priceForTwo)}</b> for two</div>
                <button class="view-menu-btn">View Menu ‚Üí</button>
              </div>
            </div>
          </div>
        `).join('')}
      </div>
    `;
    $("app").innerHTML = html;
  }

  function viewRestaurant(id){
    const restaurant = RESTAURANTS.find(r => r.id === id);
    if(!restaurant) return;
    STATE.currentRestaurant = restaurant;

    const categories = ['all', ...new Set(restaurant.menu.map(item => item.category))];

    const html = `
      <div class="header">
        <div class="header-badge">DECIDE INDIA <span class="status-dot"></span></div>
        <button class="btn" type="button" data-action="home">HOME</button>
      </div>

      <div class="menu-header">
        <h1 class="menu-restaurant-name">${esc(restaurant.name)}</h1>
        <div class="menu-restaurant-meta">
          <span>‚≠ê ${restaurant.rating}</span>
          <span>‚Ä¢</span>
          <span>‚è±Ô∏è ${restaurant.prepTime} mins</span>
          <span>‚Ä¢</span>
          <span>üìç ${esc(restaurant.area)}</span>
        </div>
      </div>

      <div class="menu-categories">
        ${categories.map(cat => `
          <button class="category-btn ${STATE.filterCategory === cat ? 'active' : ''}"
                  data-action="filterCategory" data-cat="${cat}">
            ${cat.charAt(0).toUpperCase() + cat.slice(1)}
          </button>
        `).join('')}
      </div>

      <div class="menu-grid" id="menuGrid">
        ${renderMenuItems(restaurant.menu)}
      </div>

      <button class="secondary" data-action="food">‚Üê Back to Restaurants</button>
    `;
    $("app").innerHTML = html;
  }

  function renderMenuItems(items){
    const filtered = STATE.filterCategory === 'all'
      ? items
      : items.filter(item => item.category === STATE.filterCategory);

    return filtered.map(item => `
      <div class="menu-item">
        <div class="menu-item-header">
          <div style="flex:1">
            <div class="menu-item-name">${esc(item.name)}</div>
            <div class="menu-item-desc">${esc(item.desc)}</div>
          </div>
          <div class="menu-item-icon">${item.icon}</div>
        </div>
        <div class="menu-item-meta">
          ${item.veg ? '<span>üü¢ Veg</span>' : '<span>üî¥ Non-veg</span>'}
          <span>‚Ä¢</span>
          <span>‚è±Ô∏è ${item.prepMins} mins</span>
        </div>
        <div class="menu-item-footer">
          <div class="menu-item-price">${money(item.price)}</div>
          <button class="add-to-cart-btn" data-action="addToCart" data-item="${item.id}">
            <span>+</span><span>Add</span>
          </button>
        </div>
      </div>
    `).join('');
  }

  function filterCategory(category){
    STATE.filterCategory = category;
    if(STATE.currentRestaurant){
      const grid = $("menuGrid");
      if(grid) grid.innerHTML = renderMenuItems(STATE.currentRestaurant.menu);
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-cat') === category);
      });
    }
  }

  function addToCart(itemId){
    if(!STATE.currentRestaurant) return;
    const item = STATE.currentRestaurant.menu.find(m => m.id === itemId);
    if(!item) return;

    STATE.cart.push({
      type: "food",
      restaurantId: STATE.currentRestaurant.id,
      restaurantName: STATE.currentRestaurant.name,
      name: item.name,
      price: item.price,
      icon: item.icon,
      upiId: STATE.currentRestaurant.upiId,
      qty: 1
    });

    saveCart(); updateFloatingCart();
    toast('Added to cart!', 'success');
  }

  // ======================
  // CART / PAYMENT
  // ======================
  function removeFromCart(index){
    STATE.cart.splice(index, 1);
    saveCart(); updateFloatingCart();
    if(STATE.cart.length === 0) renderLobby();
    else viewCart();
  }

  function viewCart(){
    if(STATE.cart.length === 0){ renderLobby(); return; }

    const { subtotal, gst: tax, total, isFood } = calcCartTotals();

    const html = `
      <div class="header">
        <div class="header-badge">DECIDE INDIA <span class="status-dot"></span></div>
        <button class="btn" type="button" data-action="home">HOME</button>
      </div>

      <div class="cart-container">
        <div class="cart-items">
          <h2 class="cart-title">Your Cart (${STATE.cart.length} items)</h2>
          ${STATE.cart.map((item, idx) => `
            <div class="cart-item">
              <div style="font-size:2rem">${item.icon || 'üõçÔ∏è'}</div>
              <div style="flex:1">
                <div class="cart-item-name">${esc(item.name)}</div>
                <div class="cart-item-seller">${esc(item.restaurantName || item.seller || '')}</div>
              </div>
              <div class="cart-item-price">${money(Number(item.price||0))}</div>
              <button class="remove-btn" data-action="removeFromCart" data-idx="${idx}">Remove</button>
            </div>
          `).join('')}
        </div>

        <div class="cart-summary">
          <div class="summary-row">
            <span class="summary-label">Subtotal</span>
            <span class="summary-value">${money(subtotal)}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">${isFood ? 'GST (5%)' : 'GST (18%)'}</span>
            <span class="summary-value">${money(tax)}</span>
          </div>
          <div class="summary-row total">
            <span>Total</span>
            <span>${money(total)}</span>
          </div>
        </div>

        ${isFood ? `
          <div class="payment-section">
            <h3 class="payment-title">Payment Method</h3>
            <div class="payment-methods">
              <div class="payment-method ${STATE.selectedPaymentMethod === 'razorpay' ? 'selected' : ''}"
                   data-action="selectPayment" data-method="razorpay" role="button" tabindex="0">
                <div class="payment-icon">üí≥</div>
                <div class="payment-info">
                  <div class="payment-name">Razorpay</div>
                  <div class="payment-desc">UPI, Cards, Wallets & More</div>
                </div>
                <span class="payment-badge">Instant</span>
              </div>

              <div class="payment-method ${STATE.selectedPaymentMethod === 'manual' ? 'selected' : ''}"
                   data-action="selectPayment" data-method="manual" role="button" tabindex="0">
                <div class="payment-icon">üì±</div>
                <div class="payment-info">
                  <div class="payment-name">UPI QR (Direct)</div>
                  <div class="payment-desc">Scan & Pay + Submit UTR</div>
                </div>
                <span class="payment-badge" style="background:#ffaa00">No Fee</span>
              </div>
            </div>
          </div>
        ` : ''}

        <button class="action" data-action="proceedToPayment">
          <span>Pay ${money(total)}</span>
          <span>‚Üí</span>
        </button>
        <button class="secondary" style="margin-top:12px" data-action="${isFood ? 'food' : 'home'}">
          ‚Üê Continue Shopping
        </button>
      </div>
    `;
    $("app").innerHTML = html;
  }

  function selectPayment(method){
    STATE.selectedPaymentMethod = method;
    viewCart();
  }

  function proceedToPayment(){
    const totals = calcCartTotals();
    const finalAmount = totals.total;
    STATE.lastPaymentAmount = finalAmount;

    if(totals.isFood){
      if(STATE.selectedPaymentMethod === 'razorpay') initiateRazorpay(finalAmount);
      else showUPIQRCode(finalAmount);
    }else{
      toast("E-commerce payment demo");
    }
  }

  function initiateRazorpay(amount){
    if(typeof Razorpay === 'undefined'){
      toast('Razorpay not loaded. Please refresh.', 'error');
      return;
    }
    const options = {
      key: RAZORPAY_KEY,
      amount: amount * 100,
      currency: 'INR',
      name: 'Decide - Rajkot Food',
      description: 'Food Order Payment',
      handler: function(response){
        const paymentId = response.razorpay_payment_id;
        completeOrder(paymentId, 'razorpay', amount);
      },
      modal: { ondismiss: function(){ toast('Payment cancelled', 'error'); } }
    };
    try{ new Razorpay(options).open(); }
    catch(e){ toast('Payment failed. Try UPI QR.', 'error'); }
  }

  // ‚úÖ Build UPI link and QR
  function buildUpiLink(restaurant, amount){
    const orderRef = STATE.lastTxnRef || ('TXN' + Date.now().toString(36).toUpperCase());
    STATE.lastTxnRef = orderRef;

    const am = Number(amount || 0).toFixed(2);
    const pa = restaurant.upiId;
    const pn = restaurant.upiAccountName || restaurant.name || "Decide";
    const tn = "Order " + orderRef;
    const tr = orderRef;

    const params = new URLSearchParams({ pa, pn, am, cu: "INR", tn, tr });
    const upiLink = "upi://pay?" + params.toString();
    return { upiLink, orderRef, am, pn };
  }

  function renderUpiQr(upiLink){
    const box = $("qrBox");
    if(!box) return;
    box.innerHTML = "";

    if(typeof QRCode === "undefined"){
      box.innerHTML = '<div style="color:#666">QR library failed to load</div>';
      return;
    }
    new QRCode(box, { text: upiLink, width: 220, height: 220 });
  }

  function showUPIQRCode(amount){
    const restaurant = RESTAURANTS.find(r => r.id === STATE.cart[0]?.restaurantId);
    if(!restaurant){ toast('Restaurant not found', 'error'); return; }

    const built = buildUpiLink(restaurant, amount);
    STATE.lastUpiLink = built.upiLink;

    const html = `
      <div class="header">
        <div class="header-badge">DECIDE INDIA <span class="status-dot"></span></div>
        <button class="btn" type="button" data-action="home">HOME</button>
      </div>

      <div class="cart-container">
        <div class="payment-section" style="text-align:center">
          <div style="font-size:3rem;margin-bottom:16px">üì±</div>
          <h2 class="payment-title">Scan & Pay using any UPI App</h2>

          <div style="font-size:2rem;font-weight:900;color:var(--brand-orange);margin:16px 0">
            ${money(amount)}
          </div>

          <div class="upi-qr-container">
            <div id="qrBox" style="padding:14px;background:#fff;border-radius:16px;display:inline-block"></div>

            <div style="margin:16px 0;padding:16px;background:rgba(255,255,255,0.05);border-radius:12px">
              <div style="font-size:0.875rem;color:var(--text-secondary);margin-bottom:8px">UPI ID</div>
              <div style="font-size:1.125rem;font-weight:700;word-break:break-all">${esc(restaurant.upiId)}</div>
              <div style="margin-top:10px;font-size:0.875rem;color:var(--text-secondary)">
                Ref: <b style="color:#fff">${esc(built.orderRef)}</b>
              </div>
            </div>

            <div class="upi-qr-buttons">
              <button class="secondary" data-action="copyUPI" data-upi="${esc(restaurant.upiId)}">üìã Copy UPI ID</button>
              <button class="secondary" data-action="copyUPILink" data-link="${esc(built.upiLink)}">üîó Copy UPI Link</button>
            </div>
          </div>

          <div style="margin:24px 0;padding:20px;background:rgba(255,170,0,0.1);border:1px solid rgba(255,170,0,0.3);border-radius:16px;text-align:left">
            <div style="font-weight:700;margin-bottom:12px">üìù After Payment:</div>
            <div style="color:var(--text-secondary);font-size:0.875rem;line-height:1.8">
              1. Pay using your UPI app<br>
              2. Note your 12-digit UTR / Reference No.<br>
              3. Submit UTR below
            </div>
          </div>

          <button class="action" style="background:var(--success)" data-action="submitUTRScreen">
            ‚úì I Have Paid ‚Üí Submit UTR
          </button>

          <button class="secondary" style="margin-top:12px" data-action="viewCart">
            ‚Üê Back to Cart
          </button>
        </div>
      </div>
    `;

    $("app").innerHTML = html;
    setTimeout(() => renderUpiQr(STATE.lastUpiLink), 0);
  }

  function copyUPI(upiId){
    if(!upiId) return;
    try{
      navigator.clipboard.writeText(upiId);
      toast('UPI ID copied!', 'success');
    }catch(e){
      toast('Copy failed', 'error');
    }
  }

  function copyUPILink(link){
    if(!link) return;
    try{
      navigator.clipboard.writeText(link);
      toast('UPI link copied!', 'success');
    }catch(e){
      toast('Copy failed', 'error');
    }
  }

  function submitUTRScreen(){
    const amount = Number(STATE.lastPaymentAmount || calcCartTotals().total || 0);

    const html = `
      <div class="header">
        <div class="header-badge">DECIDE INDIA <span class="status-dot"></span></div>
        <button class="btn" type="button" data-action="home">HOME</button>
      </div>

      <div class="cart-container">
        <div class="payment-section">
          <h2 class="payment-title">Submit UTR Number</h2>
          <p style="color:var(--text-secondary);margin-bottom:10px">
            Enter the 12-digit UTR/Transaction ID from your UPI payment
          </p>
          <p style="color:var(--text-secondary);margin-bottom:24px">
            Amount paid: <b style="color:var(--brand-orange)">${money(amount)}</b>
          </p>

          <input type="text"
                 id="utrInput"
                 placeholder="Enter 12-digit UTR"
                 maxlength="12"
                 inputmode="numeric"
                 style="width:100%;padding:16px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,0.05);color:white;font-size:1.125rem;text-align:center;letter-spacing:2px;margin-bottom:24px">

          <button class="action" data-action="confirmUTR">‚úì Submit & Confirm Order</button>
          <button class="secondary" style="margin-top:12px" data-action="showQR">‚Üê Back to QR Code</button>
        </div>
      </div>
    `;
    $("app").innerHTML = html;
    setTimeout(() => $("utrInput") && $("utrInput").focus(), 100);
  }

  function confirmUTR(){
    const utr = ($("utrInput")?.value || '').replace(/\s+/g, '');
    if(!/^\d{12}$/.test(utr)){ toast('UTR must be exactly 12 digits', 'error'); return; }

    const idx = loadUtrIndex();
    if(idx[utr]){ toast('Duplicate UTR detected', 'error'); return; }

    const amount = Number(STATE.lastPaymentAmount || calcCartTotals().total || 0);
    completeOrder(utr, 'manual_upi', amount);
  }

  function completeOrder(paymentId, method, amount){
    const orderId = 'DEC' + Date.now().toString(36).toUpperCase();
    const order = {
      id: orderId,
      items: STATE.cart.slice(),
      amount: amount,
      payment: { id: paymentId, method: method },
      status: 'confirmed',
      timestamp: new Date().toISOString()
    };

    STATE.orders.push(order);
    saveOrders();

    if(method === 'manual_upi'){
      const idx = loadUtrIndex();
      idx[paymentId] = { orderId: orderId, ts: new Date().toISOString() };
      saveUtrIndex(idx);
    }

    const restaurant = RESTAURANTS.find(r => r.id === STATE.cart[0]?.restaurantId);
    if(restaurant?.whatsapp){
      const msg = `New Order: ${orderId}%0AAmount: ‚Çπ${Math.round(amount)}%0APayment: ${method}%0AItems: ${STATE.cart.length}`;
      setTimeout(() => { try{ window.open(restaurant.whatsapp + '?text=' + msg, '_blank'); }catch(e){} }, 500);
    }

    STATE.cart = [];
    saveCart();
    updateFloatingCart();
    STATE.lastPaymentAmount = null;
    STATE.lastTxnRef = null;
    STATE.lastUpiLink = null;

    showSuccess(orderId);
  }

  function showSuccess(orderId){
    $("app").innerHTML = `
      <div class="header">
        <div class="header-badge">DECIDE INDIA <span class="status-dot"></span></div>
        <button class="btn" type="button" data-action="home">HOME</button>
      </div>

      <div class="success-screen">
        <div class="success-icon">‚úì</div>
        <h1 class="success-title">Order Placed!</h1>
        <p style="color:var(--text-secondary);margin-bottom:24px">
          Your order has been confirmed and the restaurant has been notified.
        </p>
        <div class="success-order-id">
          <span>Order ID:</span>
          <span style="color:var(--success)">${esc(orderId)}</span>
        </div>
        <button class="action" data-action="food">Order More Food</button>
        <button class="secondary" style="margin-top:12px" data-action="home">‚Üê Home</button>
      </div>
    `;
    setTimeout(() => toast('üéâ Order confirmed!', 'success'), 500);
  }

  function renderOrders(){
    loadOrders();
    if(!STATE.orders.length){ toast("No orders yet","error"); renderLobby(); return; }

    const list = STATE.orders.slice().reverse().map(function(o){
      return (
        '<div style="background:rgba(20,20,20,0.6);border:1px solid var(--border);border-radius:18px;padding:18px;margin-bottom:12px">' +
          '<div style="display:flex;justify-content:space-between;gap:12px">' +
            '<div>' +
              '<div style="font-weight:900">' + esc(o.id) + '</div>' +
              '<div style="color:#888;font-size:.85rem;margin-top:6px">' + esc(new Date(o.timestamp).toLocaleString("en-IN")) + '</div>' +
            '</div>' +
            '<div style="text-align:right">' +
              '<div style="font-weight:900;color:var(--brand-orange)">' + money(o.amount||0) + '</div>' +
              '<div style="margin-top:6px;font-weight:900;color:var(--accent);font-size:.85rem">' + esc(String(o.status||"").toUpperCase()) + '</div>' +
            '</div>' +
          '</div>' +
        '</div>'
      );
    }).join("");

    $("app").innerHTML =
      '<div class="header">' +
        '<div class="header-badge">DECIDE INDIA <span class="status-dot"></span></div>' +
        '<button class="btn" type="button" data-action="home">HOME</button>' +
      '</div>' +
      '<div class="wrap">' +
        '<div class="hero-title" style="font-size:2rem">MY ORDERS</div>' +
        '<div style="color:#bbb;margin:6px 0 14px">Your order history</div>' +
        list +
        '<button class="secondary" type="button" data-action="home">‚Üê HOME</button>' +
      '</div>';
  }

  // ======================
  // STATIC PAGES (IN-APP)
  // ======================
  function renderPrivacy(){
    $("app").innerHTML = `
      <div class="static-page">
        <div class="header">
          <div class="brand">DECIDE</div>
          <button class="btn" type="button" data-action="home">HOME</button>
        </div>
        <div class="static-hero">
          <h1>Privacy Policy</h1>
          <div class="static-meta">Last updated: <code>February 2026</code></div>
        </div>
        <div class="static-card">
          <h2>Information We Collect</h2>
          <ul>
            <li>Email / phone if provided</li>
            <li>Order metadata</li>
            <li>Device/local storage identifiers</li>
          </ul>
        </div>
        <div class="static-card">
          <h2>Contact</h2>
          <p>Email: <code>privacy@decide.app</code></p>
        </div>
        <div class="footer">
          <a data-action="privacy">Privacy</a> ‚Ä¢ <a data-action="terms">Terms</a> ‚Ä¢
          <a data-action="contact">Contact</a> ‚Ä¢ <a data-action="cookies">Cookies</a>
        </div>
      </div>`;
  }

  function renderTerms(){
    $("app").innerHTML = `
      <div class="static-page">
        <div class="header">
          <div class="brand">DECIDE</div>
          <button class="btn" type="button" data-action="home">HOME</button>
        </div>
        <div class="static-hero">
          <h1>Terms of Service</h1>
          <div class="static-meta">Last updated: <code>February 2026</code></div>
        </div>
        <div class="static-card">
          <h2>Platform Role</h2>
          <p>Decide is a technology intermediary connecting buyers and sellers.</p>
        </div>
        <div class="footer">
          <a data-action="privacy">Privacy</a> ‚Ä¢ <a data-action="terms">Terms</a> ‚Ä¢
          <a data-action="contact">Contact</a> ‚Ä¢ <a data-action="cookies">Cookies</a>
        </div>
      </div>`;
  }

  function renderContact(){
    $("app").innerHTML = `
      <div class="static-page">
        <div class="header">
          <div class="brand">DECIDE</div>
          <button class="btn" type="button" data-action="home">HOME</button>
        </div>
        <div class="static-hero">
          <h1>Contact</h1>
          <div class="static-meta">Support & onboarding.</div>
        </div>
        <div class="static-card">
          <h2>Reach us</h2>
          <p>Support: <code>support@decide.app</code></p>
          <p>Seller onboarding: <code>sellers@decide.app</code></p>
        </div>
        <div class="footer">
          <a data-action="privacy">Privacy</a> ‚Ä¢ <a data-action="terms">Terms</a> ‚Ä¢
          <a data-action="contact">Contact</a> ‚Ä¢ <a data-action="cookies">Cookies</a>
        </div>
      </div>`;
  }

  function renderCookies(){
    $("app").innerHTML = `
      <div class="static-page">
        <div class="header">
          <div class="brand">DECIDE</div>
          <button class="btn" type="button" data-action="home">HOME</button>
        </div>
        <div class="static-hero">
          <h1>Cookie Policy</h1>
          <div class="static-meta">We use local storage for session, cart, and order history.</div>
        </div>
        <div class="static-card">
          <h2>Your Choices</h2>
          <p>You can clear browser storage anytime. Some features may reset.</p>
        </div>
        <div class="footer">
          <a data-action="privacy">Privacy</a> ‚Ä¢ <a data-action="terms">Terms</a> ‚Ä¢
          <a data-action="contact">Contact</a> ‚Ä¢ <a data-action="cookies">Cookies</a>
        </div>
      </div>`;
  }

  // ======================
  // EVENT HANDLER
  // ======================
  function handle(el){
    const action = el.getAttribute("data-action");
    if(!action || action === "disabled") return;
    if(el.getAttribute("aria-disabled") === "true") return;

    // Hash routes for static pages (prevents 404)
    if(action === "privacy"){ navigate("/privacy"); return; }
    if(action === "terms"){ navigate("/terms"); return; }
    if(action === "contact"){ navigate("/contact"); return; }
    if(action === "cookies"){ navigate("/cookies"); return; }

    if(action === "home"){ navigate("/"); return; }
    if(action === "lobby"){ markVisited(); navigate("/"); return; }

    if(action === "module"){
      const mod = el.getAttribute("data-module");
      if(mod === "ecommerce") { renderEcommerce(); return; }
      if(mod === "food") { renderFood(); return; }
      toast("Module coming soon","error");
      return;
    }

    if(action === "city"){ renderCity(el.getAttribute("data-city")); return; }

    if(action === "feedback"){ renderFeedbackCenter(); return; }
    if(action === "fbSubmit"){ fbSubmit(); return; }

    if(action === "ecommerce"){ renderEcommerce(); return; }
    if(action === "category"){ renderFilters(el.getAttribute("data-cat")); return; }
    if(action === "toggle"){ toggleFilter(el.getAttribute("data-filter"), el); return; }
    if(action === "search"){ search(); return; }
    if(action === "addEcom"){ addEcom(Number(el.getAttribute("data-idx"))); return; }
    if(action === "buyEcom"){ buyEcom(Number(el.getAttribute("data-idx"))); return; }

    if(action === "food"){ renderFood(); return; }
    if(action === "restaurant"){ viewRestaurant(el.getAttribute("data-rid")); return; }
    if(action === "filterCategory"){ filterCategory(el.getAttribute("data-cat")); return; }
    if(action === "addToCart"){ addToCart(el.getAttribute("data-item")); return; }

    if(action === "viewCart"){ viewCart(); return; }
    if(action === "removeFromCart"){ removeFromCart(Number(el.getAttribute("data-idx"))); return; }
    if(action === "selectPayment"){ selectPayment(el.getAttribute("data-method")); return; }
    if(action === "proceedToPayment"){ proceedToPayment(); return; }

    if(action === "showQR"){ showUPIQRCode(STATE.lastPaymentAmount || calcCartTotals().total); return; }
    if(action === "copyUPI"){ copyUPI(el.getAttribute("data-upi")); return; }
    if(action === "copyUPILink"){ copyUPILink(el.getAttribute("data-link")); return; }

    if(action === "submitUTRScreen"){ submitUTRScreen(); return; }
    if(action === "confirmUTR"){ confirmUTR(); return; }

    if(action === "orders"){ renderOrders(); return; }
  }

  document.addEventListener("click", function(e){
    const el = e.target.closest("[data-action]");
    if(el) handle(el);
  });

  document.addEventListener("keydown", function(e){
    if(e.key !== "Enter" && e.key !== " ") return;
    const el = e.target.closest("[data-action][role='button']");
    if(!el) return;
    e.preventDefault();
    handle(el);
  });

  // ======================
  // INIT
  // ======================
  function init(){
    sbClient = initSupabase(); // optional
    loadOrders();
    loadCart();
    loadToMemory(ECOMMERCE_DATA);
    updateFloatingCart();

    const fc = $("floatingCart");
    if(fc) fc.addEventListener('click', viewCart);

    // initial route
    route();
  }

  if(document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => setTimeout(init, 50), {once:true});
  } else {
    setTimeout(init, 50);
  }

})();
</script>

</body>
</html>
