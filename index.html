<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Decide</title>
<meta name="theme-color" content="#ff671f">
<link rel="manifest" href="manifest-ondc.json">

<!-- Supabase (optional later) -->
<script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- jsPDF -->
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --brand-orange:#ff671f;
  --border:rgba(255,255,255,0.15);
  --accent:#00e676;
  --ondc-blue:#1e88e5;
  --font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

/* === Fix blue tap highlight / selection glitch === */
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{margin:0;padding:0;min-height:100%;background:#000;color:#fff;font-family:var(--font);-webkit-font-smoothing:antialiased}
button{font:inherit;-webkit-tap-highlight-color:transparent}
button:focus{outline:none}
[role="button"], .card, .filter-btn, .payment-option{ -webkit-tap-highlight-color:transparent; user-select:none; -webkit-user-select:none; }

#app{min-height:100vh;display:flex;flex-direction:column;padding:20px;padding-bottom:calc(80px + var(--safe-bottom))}

/* HEADER */
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:30px;gap:15px}
.header-badge{
  background:rgba(255,103,31,0.1);
  border:2px solid var(--brand-orange);
  padding:12px 24px;border-radius:12px;
  font-size:.85rem;font-weight:800;letter-spacing:1px;
  color:var(--brand-orange);
  display:flex;align-items:center;gap:10px;flex:1;
}
.status-dot{
  width:10px;height:10px;background:var(--accent);border-radius:50%;
  box-shadow:0 0 10px var(--accent);
  animation:pulse 2s infinite;
  display:inline-block; /* important for span */
}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

.btn{
  background:transparent;border:2px solid rgba(255,255,255,0.3);
  padding:12px 30px;border-radius:50px;font-size:.9rem;
  font-weight:800;color:#fff;cursor:pointer;transition:.2s;
}
.btn:hover{background:rgba(255,255,255,0.1);border-color:rgba(255,255,255,0.5)}
.btn:focus-visible,.card:focus-visible,.filter-btn:focus-visible,.payment-option:focus-visible{
  outline:3px solid rgba(255,103,31,.75);outline-offset:3px;
}

/* GRID */
.grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:25px}
.card{
  background:rgba(20,20,20,0.6);border:1px solid var(--border);
  border-radius:24px;padding:30px 20px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:15px;cursor:pointer;transition:.2s;min-height:180px;
}
.card:hover{background:rgba(40,40,40,0.8);border-color:rgba(255,255,255,0.3);transform:translateY(-4px)}
.card[aria-disabled="true"]{opacity:.5;cursor:not-allowed;pointer-events:none}
.icon{font-size:3.5rem}
.title{font-size:1.1rem;font-weight:900;letter-spacing:.5px;text-align:center;margin:0}
.tag{
  font-size:.75rem;font-weight:800;letter-spacing:1.5px;
  padding:4px 12px;border-radius:6px
}
.tag-live{color:var(--accent);background:rgba(0,230,118,0.15)}
.tag-neutral{color:#888;background:rgba(136,136,136,0.15)}
.tag-beta{color:#4CAF50;background:rgba(76,175,80,0.15)}
.tag-links{color:#42A5F5;background:rgba(66,165,245,0.15)}
.tag-food{color:#ffcc80;background:rgba(255,204,128,0.12);border:1px solid rgba(255,204,128,0.25)}

/* Buttons */
.bottom{
  width:100%;background:transparent;border:2px solid rgba(255,255,255,0.2);
  padding:18px;border-radius:20px;font-size:1rem;font-weight:900;color:#fff;
  cursor:pointer;transition:.2s;margin-bottom:20px;
}
.bottom:hover{background:rgba(255,255,255,0.1);border-color:rgba(255,255,255,0.4)}

/* Screens */
.wrap{max-width:700px;margin:0 auto;width:100%}
.h1{font-size:1.8rem;font-weight:900;margin:0 0 20px;text-align:center;text-transform:uppercase}
.p{text-align:center;color:#888;margin:0 0 25px}

/* FILTERS */
.filter-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:25px}
.filter-btn{
  background:rgba(20,20,20,0.6);border:2px solid var(--border);
  padding:25px;border-radius:18px;text-align:center;font-weight:900;font-size:1rem;
  cursor:pointer;transition:.2s;text-transform:uppercase;
}
.filter-btn:hover{background:rgba(40,40,40,0.8);border-color:rgba(255,255,255,0.3)}
.filter-btn.active{background:var(--brand-orange);color:#000;border-color:var(--brand-orange)}

.action{
  background:var(--brand-orange);color:#000;border:none;padding:18px;border-radius:18px;
  font-weight:900;font-size:1rem;cursor:pointer;width:100%;margin-bottom:12px;
  transition:.2s;text-transform:uppercase;
}
.action:hover{background:#ff7d3f;transform:translateY(-2px)}
.secondary{
  background:transparent;color:#fff;border:2px solid var(--border);padding:16px;border-radius:18px;
  font-weight:900;font-size:.95rem;cursor:pointer;width:100%;transition:.2s;text-transform:uppercase;
}
.secondary:hover{background:rgba(255,255,255,0.1);border-color:rgba(255,255,255,0.3)}

/* RESULTS / LIST */
.results{max-width:800px;margin:0 auto;padding:20px 0}
.result{
  background:rgba(20,20,20,0.6);border:1px solid var(--border);
  border-radius:18px;padding:20px;margin-bottom:15px;transition:.2s;
}
.result:hover{background:rgba(30,30,30,0.8);border-color:rgba(255,255,255,0.3)}
.row{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
.name{font-size:1.2rem;font-weight:900;margin:0 0 5px}
.seller{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.badge{background:rgba(30,136,229,0.2);color:var(--ondc-blue);padding:4px 10px;border-radius:6px;font-size:.75rem;font-weight:800}
.rating{color:#FFA726;font-size:.85rem}
.price{text-align:right}
.price-main{font-size:1.8rem;font-weight:900;color:var(--brand-orange)}
.details{
  display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:15px 0;padding:15px;
  background:rgba(255,255,255,0.03);border-radius:12px;
}
.label{color:#888;font-size:.85rem}
.value{font-weight:800;font-size:.9rem}
.actions{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.buy{background:var(--brand-orange);color:#000;border:none;padding:12px;border-radius:12px;font-weight:900;cursor:pointer;transition:.2s}
.buy:hover{background:#ff7d3f;transform:translateY(-2px)}
.add{background:transparent;color:#fff;border:1px solid var(--border);padding:12px;border-radius:12px;font-weight:800;cursor:pointer;transition:.2s}
.add:hover{background:rgba(255,255,255,0.1)}

/* PAYMENT */
.payment-option{
  background:rgba(255,255,255,0.03);border:2px solid var(--border);padding:15px;border-radius:12px;
  display:flex;align-items:center;gap:15px;cursor:pointer;transition:.2s;
}
.payment-option:hover{background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.3)}
.payment-option.selected{border-color:var(--brand-orange);background:rgba(255,103,31,0.1)}

.toast{
  position:fixed;bottom:calc(40px + var(--safe-bottom));left:50%;transform:translateX(-50%);
  background:#111;border:1px solid #333;padding:12px 24px;border-radius:30px;
  font-size:.85rem;opacity:0;transition:opacity .2s;z-index:1000;
}
.toast.show{opacity:1}

/* ===== DEMO LABELS (UI only) ===== */
.demo-pill{
  display:inline-flex;align-items:center;gap:6px;
  padding:4px 10px;border-radius:999px;
  font-size:.7rem;font-weight:900;letter-spacing:1.2px;
  background:rgba(255,213,79,0.12);
  border:1px solid rgba(255,213,79,0.35);
  color:#FFD54F;
  text-transform:uppercase;
  line-height:1; /* keeps it neat */
}
.demo-note{
  text-align:center;
  color:#FFD54F;
  font-weight:900;
  font-size:.78rem;
  letter-spacing:1px;
  margin:-14px 0 18px;
  opacity:.95;
}
.demo-note span{ color:#888; font-weight:800; letter-spacing:0; text-transform:none; }

@media (max-width:600px){
  .grid{gap:15px}
  .card{padding:25px 15px;min-height:160px}
  .icon{font-size:3rem}
  .title{font-size:1rem}
  .details{grid-template-columns:1fr}
  .actions{grid-template-columns:1fr}
}
</style>
</head>

<body>
<div id="app"></div>
<div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true"></div>

<script>
(function(){
  "use strict";

  function $(id){ return document.getElementById(id); }
  function esc(s){
    s = String(s == null ? "" : s);
    return s
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }
  function toast(msg){
    var t = $("toast"); if(!t) return;
    t.textContent = String(msg || "");
    t.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(function(){ t.classList.remove("show"); }, 2200);
  }

  function safeId(){
    try{ if(window.crypto && crypto.randomUUID) return crypto.randomUUID(); }catch(e){}
    return "dev-" + Math.random().toString(36).slice(2) + "-" + Date.now().toString(36);
  }

  var DEVICE_ID = localStorage.getItem("decide_device_id");
  if(!DEVICE_ID){ DEVICE_ID = safeId(); localStorage.setItem("decide_device_id", DEVICE_ID); }

  var STATE = {
    domain: null,
    filters: [],
    cart: [],
    orders: [],
    session: "SID-" + Math.random().toString(36).slice(2,6).toUpperCase(),
    diningCity: "Rajkot",
    selectedRestaurantId: null
  };

  /* ========= DEMO DATA ========= */

  // Electronics (same)
  var SAMPLE = [
    {category:"smartphones",name:"iPhone 15 Pro",price:134900,cam:9,gam:9,bat:7,seller:"Apple Store",rating:4.8,stock:50,delivery:"2 days",warranty:"1 year"},
    {category:"smartphones",name:"iPhone 15 Pro",price:132900,cam:9,gam:9,bat:7,seller:"Flipkart",rating:4.7,stock:120,delivery:"1 day",warranty:"1 year"},
    {category:"smartphones",name:"Samsung S24 Ultra",price:129999,cam:10,gam:9,bat:8,seller:"Samsung",rating:4.9,stock:40,delivery:"3 days",warranty:"1 year"},
    {category:"smartphones",name:"OnePlus 12",price:63999,cam:8,gam:9,bat:9,seller:"Amazon",rating:4.7,stock:110,delivery:"1 day",warranty:"1 year"},
    {category:"earbuds",name:"AirPods Pro 2",price:24499,snd:9,anc:10,mic:9,seller:"Amazon",rating:4.8,stock:150,delivery:"1 day",warranty:"1 year"},
    {category:"earbuds",name:"Sony WF-1000XM5",price:23990,snd:10,anc:10,mic:8,seller:"Flipkart",rating:4.8,stock:90,delivery:"1 day",warranty:"1 year"},
    {category:"earbuds",name:"Nothing Ear 2",price:8999,snd:7,anc:7,mic:7,seller:"Flipkart",rating:4.5,stock:200,delivery:"1 day",warranty:"1 year"},
    {category:"laptops",name:"MacBook Air M3",price:113900,perf:9,port:7,scr:9,seller:"Amazon",rating:4.8,stock:55,delivery:"2 days",warranty:"1 year"},
    {category:"laptops",name:"Dell XPS 13",price:139990,perf:8,port:6,scr:9,seller:"Dell",rating:4.7,stock:40,delivery:"4 days",warranty:"1 year"},
    {category:"laptops",name:"ThinkPad X1 Carbon",price:149999,perf:8,port:8,scr:8,seller:"Lenovo",rating:4.8,stock:25,delivery:"5 days",warranty:"3 years"}
  ];

  // Dining (Rajkot MVP restaurant)
  // IMPORTANT: Replace phone/whatsapp with real numbers when ready.
  var DINING = {
    restaurants: [
      {
        id: "rajkot-thali-001",
        name: "Unlimited Gujarati Thali + Pav Bhaji",
        brand: "Family Restaurant + Cloud Kitchen",
        city: "Rajkot",
        area: "Rajkot",
        geo: { lat: 22.3039, lng: 70.8022 },
        priceHint: 150,
        tags: ["veg","family","value","unlimited"],
        hours: "11:00 AM - 3:30 PM, 7:00 PM - 10:30 PM",
        phone: "+91XXXXXXXXXX",
        whatsapp: "https://wa.me/91XXXXXXXXXX?text=Hi%20I%20want%20to%20order%20Gujarati%20Thali%20(150)%20and%20Pav%20Bhaji",
        menu: [
          { id:"thali-150", name:"Unlimited Gujarati Thali", price:150, veg:true, desc:"Unlimited thali with many varieties.", prepMins:20 },
          { id:"pavbhaji-120", name:"Pav Bhaji", price:120, veg:true, desc:"Butter pav bhaji (cloud kitchen).", prepMins:20 },
          { id:"buttermilk-25", name:"Chaas (Buttermilk)", price:25, veg:true, desc:"Fresh chaas.", prepMins:5 }
        ]
      }
    ]
  };

  /* ========= MEMORY DB (electronics only) ========= */
  var DB = { smartphones:{}, earbuds:{}, laptops:{} };
  var RESULTS = [];
  var payMethod = null;

  function loadToMemory(arr){
    DB = { smartphones:{}, earbuds:{}, laptops:{} };
    (arr || []).forEach(function(p){
      if(!p || !p.category || !p.name) return;
      if(!DB[p.category]) DB[p.category] = {};
      if(!DB[p.category][p.name]) DB[p.category][p.name] = [];
      DB[p.category][p.name].push({
        name:p.name,
        price:Number(p.price)||0,
        seller:p.seller||"Seller",
        rating:Number(p.rating)||4.0,
        stock:Number(p.stock)||0,
        delivery:p.delivery||"2-5 days",
        warranty:p.warranty||"6 months",
        attr:{
          cam:Number(p.cam)||0, gam:Number(p.gam)||0, bat:Number(p.bat)||0,
          snd:Number(p.snd)||0, anc:Number(p.anc)||0, mic:Number(p.mic)||0,
          perf:Number(p.perf)||0, port:Number(p.port)||0, scr:Number(p.scr)||0
        }
      });
    });
  }

  function loadOrders(){
    try{
      var x = JSON.parse(localStorage.getItem("order_history") || "[]");
      STATE.orders = Array.isArray(x) ? x : [];
    }catch(e){ STATE.orders = []; }
  }
  function saveOrders(){
    try{ localStorage.setItem("order_history", JSON.stringify(STATE.orders)); }catch(e){}
  }

  function labelDomain(d){
    if(d==="smartphones") return "PHONES";
    if(d==="earbuds") return "AUDIO";
    if(d==="laptops") return "LAPTOPS";
    if(d==="dining") return "DINING";
    return "DECIDE";
  }

  function money(n){ return "‚Çπ" + Number(n||0).toLocaleString("en-IN"); }

  /* ========= HOME ========= */
  function renderLobby(){
    var app = $("app");
    var cartCount = STATE.cart.length;

    app.innerHTML =
      '<div class="header">' +
        '<div class="header-badge">' +
          'DECIDE <span class="status-dot" aria-hidden="true"></span> <span class="demo-pill">DEMO</span>' +
        '</div>' +
        '<button class="btn" type="button" data-action="home">HOME</button>' +
      '</div>' +
      '<div class="demo-note">DEMO MODE <span>‚Ä¢ ONDC API + AI engine integration in progress</span></div>' +

      '<div class="grid">' +

        '<div class="card" role="button" tabindex="0" data-action="domain" data-domain="dining">' +
          '<div class="icon">üçΩÔ∏è</div><div class="title">DINING</div><div class="tag tag-food">RAJKOT MVP ‚Ä¢ DEMO</div>' +
        '</div>' +

        '<div class="card" role="button" tabindex="0" data-action="domain" data-domain="smartphones">' +
          '<div class="icon">üì±</div><div class="title">PHONES</div><div class="tag tag-live">OPEN ‚Ä¢ DEMO</div>' +
        '</div>' +

        '<div class="card" role="button" tabindex="0" data-action="domain" data-domain="earbuds">' +
          '<div class="icon">üéß</div><div class="title">AUDIO</div><div class="tag tag-live">OPEN ‚Ä¢ DEMO</div>' +
        '</div>' +

        '<div class="card" role="button" tabindex="0" data-action="domain" data-domain="laptops">' +
          '<div class="icon">üíª</div><div class="title">LAPTOPS</div><div class="tag tag-live">OPEN ‚Ä¢ DEMO</div>' +
        '</div>' +

        '<div class="card" role="button" tabindex="0" data-action="orders">' +
          '<div class="icon">üì¶</div><div class="title">ORDERS</div><div class="tag tag-beta">TRACK ‚Ä¢ DEMO</div>' +
        '</div>' +

        '<div class="card" role="button" tabindex="0" data-action="cart" aria-disabled="' + (cartCount? "false":"true") + '">' +
          '<div class="icon">üõí</div><div class="title">CART</div><div class="tag tag-neutral">' + cartCount + ' ITEMS</div>' +
        '</div>' +

      '</div>' +

      '<button class="bottom" type="button" data-action="refresh">REFRESH <span style="opacity:.7">‚Ä¢ DEMO</span></button>';
  }

  /* ========= DINING ========= */

  function listRestaurantsByCity(city){
    var all = DINING.restaurants || [];
    return all.filter(function(r){ return String(r.city||"").toLowerCase() === String(city||"").toLowerCase(); });
  }

  function renderDining(){
    STATE.domain = "dining";
    STATE.selectedRestaurantId = null;

    var city = STATE.diningCity || "Rajkot";
    var list = listRestaurantsByCity(city);

    if(!list.length){
      $("app").innerHTML =
        '<div class="wrap">' +
          '<div class="h1">DINING</div>' +
          '<div class="demo-note">DEMO MODE <span>‚Ä¢ restaurants will expand city-wise</span></div>' +
          '<div class="p">No restaurants in ' + esc(city) + ' yet.</div>' +
          '<button class="secondary" type="button" data-action="home">‚Üê HOME</button>' +
        '</div>';
      return;
    }

    var cards = list.map(function(r){
      return (
        '<div class="result" role="button" tabindex="0" data-action="openRestaurant" data-rid="' + esc(r.id) + '">' +
          '<div class="row">' +
            '<div>' +
              '<div class="name">' + esc(r.name) + '</div>' +
              '<div class="seller">' +
                '<span class="badge">' + esc(r.city) + '</span>' +
                '<span class="rating">‚≠ê 4.8</span>' +
                '<span class="demo-pill">DEMO</span>' +
              '</div>' +
              '<div style="color:#888;margin-top:8px;font-size:.9rem">From ' + money(r.priceHint) + ' ‚Ä¢ ' + esc(r.brand) + '</div>' +
              '<div style="color:#888;margin-top:6px;font-size:.85rem">Hours: ' + esc(r.hours) + '</div>' +
            '</div>' +
            '<div class="price"><div class="price-main">' + money(r.priceHint) + '</div></div>' +
          '</div>' +
        '</div>'
      );
    }).join("");

    $("app").innerHTML =
      '<div class="wrap">' +
        '<div class="h1">DINING</div>' +
        '<div class="demo-note">DEMO MODE <span>‚Ä¢ order flow uses WhatsApp confirmation</span></div>' +
        '<div class="p">Start with Rajkot. Add more restaurants city-wise later.</div>' +

        '<div class="result" style="margin-bottom:15px">' +
          '<div class="label">City</div>' +
          '<div style="display:flex;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap">' +
            '<button class="secondary" type="button" data-action="setCity" data-city="Rajkot" style="width:auto;padding:10px 14px">Rajkot</button>' +
            '<button class="secondary" type="button" data-action="setCity" data-city="Ahmedabad" style="width:auto;padding:10px 14px">Ahmedabad</button>' +
            '<button class="secondary" type="button" data-action="setCity" data-city="Surat" style="width:auto;padding:10px 14px">Surat</button>' +
          '</div>' +
          '<div style="color:#888;margin-top:10px;font-size:.85rem">Selected: <b>' + esc(city) + '</b></div>' +
        '</div>' +

        cards +

        '<button class="secondary" type="button" data-action="home" style="margin-top:10px">‚Üê HOME</button>' +
      '</div>';
  }

  function getRestaurantById(id){
    var list = DINING.restaurants || [];
    for(var i=0;i<list.length;i++){
      if(String(list[i].id) === String(id)) return list[i];
    }
    return null;
  }

  function renderRestaurant(rid){
    var r = getRestaurantById(rid);
    if(!r){ toast("Restaurant not found"); renderDining(); return; }
    STATE.selectedRestaurantId = r.id;

    var menu = (r.menu || []).map(function(it){
      return (
        '<div class="result">' +
          '<div class="row">' +
            '<div>' +
              '<div class="name">' + esc(it.name) + '</div>' +
              '<div style="color:#888;font-size:.9rem;margin-top:6px">' + esc(it.desc || "") + '</div>' +
              '<div style="color:#888;font-size:.85rem;margin-top:6px">Prep: ' + Number(it.prepMins||15) + ' mins ‚Ä¢ ' + (it.veg ? "üü¢ Veg" : "üî¥ Non-veg") + '</div>' +
            '</div>' +
            '<div class="price">' +
              '<div class="price-main">' + money(it.price) + '</div>' +
              '<button class="add" type="button" data-action="addFood" data-item="' + esc(it.id) + '" style="margin-top:10px">ADD</button>' +
            '</div>' +
          '</div>' +
        '</div>'
      );
    }).join("");

    $("app").innerHTML =
      '<div class="wrap">' +
        '<div class="h1">' + esc(r.name) + '</div>' +
        '<div class="demo-note">DEMO MENU <span>‚Ä¢ payment simulates order then opens WhatsApp</span></div>' +
        '<div class="p">' + esc(r.city) + ' ‚Ä¢ ' + esc(r.brand) + '</div>' +

        '<div class="result" style="margin-bottom:15px">' +
          '<div class="label">Hours</div><div class="value">' + esc(r.hours) + '</div>' +
          '<div style="height:10px"></div>' +
          '<div class="label">Tags</div><div class="value">' + esc((r.tags||[]).join(", ")) + '</div>' +
        '</div>' +

        '<div class="h1" style="font-size:1.2rem;margin-bottom:12px">MENU</div>' +
        menu +

        '<button class="action" type="button" data-action="foodCart">GO TO CART ‚Üí</button>' +
        '<button class="secondary" type="button" data-action="dining">‚Üê BACK</button>' +
      '</div>';
  }

  function addFoodItem(itemId){
    var r = getRestaurantById(STATE.selectedRestaurantId);
    if(!r) return toast("Restaurant missing");
    var item = null;
    for(var i=0;i<(r.menu||[]).length;i++){
      if(String(r.menu[i].id) === String(itemId)) { item = r.menu[i]; break; }
    }
    if(!item) return toast("Item missing");

    // store in same cart, tagged as dining
    STATE.cart.push({
      type: "dining",
      restaurantId: r.id,
      seller: r.name,
      name: item.name,
      price: Number(item.price)||0,
      qty: 1
    });
    toast("Added: " + item.name);
  }

  function renderFoodCart(){
    if(!STATE.cart.length){ toast("Cart is empty"); renderLobby(); return; }

    var subtotal = STATE.cart.reduce(function(s,p){ return s + (Number(p.price)||0) * (Number(p.qty)||1); }, 0);
    var gst = Math.floor(subtotal * 0.05);
    var total = subtotal + gst;

    var items = STATE.cart.map(function(it, idx){
      var subtitle = it.type === "dining" ? ("From: " + it.seller) : it.seller;
      return (
        '<div style="display:flex;justify-content:space-between;gap:10px;padding:15px;background:rgba(255,255,255,0.03);border-radius:12px;margin-bottom:10px">' +
          '<div>' +
            '<div style="font-weight:900">' + esc(it.name) + '</div>' +
            '<div style="font-size:0.85rem;color:#888">' + esc(subtitle || "") + '</div>' +
          '</div>' +
          '<div style="text-align:right;min-width:120px">' +
            '<div style="font-weight:900;color:var(--brand-orange)">' + money(it.price) + '</div>' +
            '<button type="button" data-action="remove" data-idx="' + idx + '" style="background:transparent;border:none;color:#ff4444;cursor:pointer;font-size:0.8rem;margin-top:5px">Remove</button>' +
          '</div>' +
        '</div>'
      );
    }).join("");

    $("app").innerHTML =
      '<div class="wrap">' +
        '<div class="h1">CART</div>' +
        '<div class="demo-note">DEMO CHECKOUT <span>‚Ä¢ totals shown for preview only</span></div>' +
        '<div class="result" style="margin-bottom:20px">' +
          '<div style="font-weight:900;margin-bottom:10px">Items (' + STATE.cart.length + ')</div>' +
          items +
        '</div>' +
        '<div class="result">' +
          '<div class="label">Subtotal</div><div class="value">' + money(subtotal) + '</div>' +
          '<div style="height:8px"></div>' +
          '<div class="label">Tax</div><div class="value">' + money(gst) + '</div>' +
          '<div style="height:12px;border-top:1px solid var(--border);margin-top:12px;padding-top:12px"></div>' +
          '<div class="value" style="color:var(--brand-orange);font-size:1.2rem">Pay ' + money(total) + '</div>' +
        '</div>' +
        '<button class="action" type="button" data-action="pay">PAY ‚Üí <span style="opacity:.75">DEMO</span></button>' +
        '<button class="secondary" type="button" data-action="home">‚Üê HOME</button>' +
      '</div>';
  }

  /* ========= ELECTRONICS (unchanged flow) ========= */

  function renderFilters(domain){
    STATE.domain = domain;
    STATE.filters = [];

    var filters = {
      smartphones:["cam","gam","bat"],
      earbuds:["snd","anc","mic"],
      laptops:["perf","port","scr"]
    };
    var labels = {
      cam:"CAMERA",gam:"GAMING",bat:"BATTERY",
      snd:"SOUND",anc:"NOISE",mic:"MIC",
      perf:"POWER",port:"TRAVEL",scr:"SCREEN"
    };

    var btns = (filters[domain] || []).map(function(f){
      return '<div class="filter-btn" role="button" tabindex="0" data-action="toggle" data-filter="' + f + '">' + labels[f] + '</div>';
    }).join("");

    $("app").innerHTML =
      '<div class="wrap">' +
        '<div class="h1">' + labelDomain(domain) + '</div>' +
        '<div class="demo-note">DEMO RESULTS <span>‚Ä¢ recommendations are sample data</span></div>' +
        '<div class="p">Pick what matters most</div>' +
        '<div class="filter-grid">' + btns + '</div>' +
        '<button class="action" type="button" data-action="search">FIND OPTIONS</button>' +
        '<button class="secondary" type="button" data-action="home">‚Üê BACK</button>' +
      '</div>';
  }

  function toggleFilter(key, el){
    var i = STATE.filters.indexOf(key);
    if(i >= 0){ STATE.filters.splice(i, 1); el.classList.remove("active"); }
    else { STATE.filters.push(key); el.classList.add("active"); }
  }

  function search(){
    var domain = STATE.domain;
    var db = DB[domain];
    if(!db || !Object.keys(db).length){ toast("No items yet"); return; }

    var all = [];
    Object.keys(db).forEach(function(name){
      (db[name] || []).forEach(function(seller){
        var score = 0;
        if(STATE.filters.length){
          STATE.filters.forEach(function(f){ score += (seller.attr && seller.attr[f]) ? seller.attr[f] : 0; });
        }
        all.push({ type:"retail", name:seller.name, price:seller.price, seller:seller.seller, rating:seller.rating, stock:seller.stock, delivery:seller.delivery, warranty:seller.warranty, score:score });
      });
    });

    all.sort(function(a,b){
      if(b.score !== a.score) return b.score - a.score;
      return a.price - b.price;
    });

    RESULTS = all.slice(0,10);
    renderMarketplace();
  }

  function renderMarketplace(){
    if(!RESULTS.length){ toast("No results"); renderFilters(STATE.domain); return; }

    var list = RESULTS.map(function(p, idx){
      var discount = Math.floor(Math.random()*20)+5;
      var original = p.price ? Math.floor(p.price/(1-discount/100)) : p.price;
      var stockColor = (p.stock > 50) ? "var(--accent)" : "#FFA726";

      return (
        '<div class="result">' +
          '<div class="row">' +
            '<div>' +
              '<div class="name">' + esc(p.name) + '</div>' +
              '<div class="seller">' +
                '<span class="badge">' + esc(p.seller) + '</span>' +
                '<span class="rating">‚≠ê ' + Number(p.rating||0).toFixed(1) + '</span>' +
                '<span class="demo-pill">DEMO</span>' +
              '</div>' +
            '</div>' +
            '<div class="price">' +
              '<div class="price-main">' + money(p.price) + '</div>' +
              '<div class="price-original">' + money(original) + '</div>' +
              '<div class="discount">' + discount + '% OFF</div>' +
            '</div>' +
          '</div>' +

          '<div class="details">' +
            '<div><div class="label">Availability</div><div class="value" style="color:' + stockColor + '">' + Number(p.stock||0) + ' available</div></div>' +
            '<div><div class="label">Delivery</div><div class="value">' + esc(p.delivery||"") + '</div></div>' +
            '<div><div class="label">Warranty</div><div class="value">' + esc(p.warranty||"") + '</div></div>' +
            '<div><div class="label">Bill</div><div class="value" style="color:var(--accent)">Included ‚úì</div></div>' +
          '</div>' +

          '<div class="actions">' +
            '<button class="buy" type="button" data-action="buy" data-idx="' + idx + '">BUY NOW</button>' +
            '<button class="add" type="button" data-action="add" data-idx="' + idx + '">ADD TO CART</button>' +
          '</div>' +
        '</div>'
      );
    }).join("");

    $("app").innerHTML =
      '<div class="results">' +
        '<div style="text-align:center;margin-bottom:30px">' +
          '<h2 style="margin:0;font-size:1.8rem">' + labelDomain(STATE.domain) + '</h2>' +
          '<div class="demo-note" style="margin:10px 0 0">DEMO MODE <span>‚Ä¢ sample listings only</span></div>' +
          '<p style="color:#888;margin-top:10px">Top picks</p>' +
        '</div>' +
        list +
        '<button class="secondary" type="button" data-action="change" style="margin-top:20px">‚Üê CHANGE</button>' +
        '<button class="secondary" type="button" data-action="home" style="margin-top:10px">‚Üê HOME</button>' +
      '</div>';
  }

  function add(idx){
    var p = RESULTS[idx]; if(!p) return;
    STATE.cart.push({ type:"retail", name:p.name, seller:p.seller, price:Number(p.price)||0, qty:1 });
    toast("Added to cart");
  }

  function buy(idx){
    var p = RESULTS[idx]; if(!p) return;
    STATE.cart = [{ type:"retail", name:p.name, seller:p.seller, price:Number(p.price)||0, qty:1 }];
    renderPayment();
  }

  function remove(idx){
    STATE.cart.splice(idx, 1);
    if(!STATE.cart.length){ toast("Cart cleared"); renderLobby(); return; }
    toast("Removed");
    renderFoodCart();
  }

  function renderPayment(){
    if(!STATE.cart.length){ toast("Cart is empty"); renderLobby(); return; }
    payMethod = null;

    $("app").innerHTML =
      '<div class="wrap">' +
        '<div class="h1">PAYMENT</div>' +
        '<div class="demo-note">DEMO PAYMENT <span>‚Ä¢ no real charges happen</span></div>' +
        '<div class="result" style="margin-bottom:20px">' +
          '<div style="font-weight:900;margin-bottom:12px">Choose</div>' +

          '<div class="payment-option" role="button" tabindex="0" data-action="pm" data-method="upi">' +
            '<div style="font-size:2rem">üì±</div><div><div style="font-weight:900">UPI</div><div style="color:#888;font-size:.85rem">GPay / PhonePe / Paytm</div></div>' +
          '</div>' +

          '<div style="height:10px"></div>' +

          '<div class="payment-option" role="button" tabindex="0" data-action="pm" data-method="card">' +
            '<div style="font-size:2rem">üí≥</div><div><div style="font-weight:900">Card</div><div style="color:#888;font-size:.85rem">Visa / Mastercard / RuPay</div></div>' +
          '</div>' +

          '<div style="height:10px"></div>' +

          '<div class="payment-option" role="button" tabindex="0" data-action="pm" data-method="cod">' +
            '<div style="font-size:2rem">üíµ</div><div><div style="font-weight:900">Cash</div><div style="color:#888;font-size:.85rem">Pay on delivery</div></div>' +
          '</div>' +
        '</div>' +

        '<button class="action" type="button" data-action="place">PLACE ORDER <span style="opacity:.75">‚Ä¢ DEMO</span></button>' +
        '<button class="secondary" type="button" data-action="cart">‚Üê BACK</button>' +
      '</div>';
  }

  function place(){
    if(!payMethod){ toast("Pick payment method"); return; }

    var subtotal = STATE.cart.reduce(function(s,p){ return s + (Number(p.price)||0) * (Number(p.qty)||1); }, 0);
    var taxRate = (STATE.cart[0] && STATE.cart[0].type === "dining") ? 0.05 : 0.18;
    var gst = Math.floor(subtotal * taxRate);
    var total = subtotal + gst;

    var id = "ORD-" + Math.random().toString(36).slice(2,10).toUpperCase();
    var order = {
      id:id,
      items:STATE.cart.slice(),
      subtotal:subtotal,
      tax:gst,
      total:total,
      payment:payMethod,
      status:"confirmed",
      timestamp:new Date().toISOString()
    };

    loadOrders();
    STATE.orders.push(order);
    saveOrders();

    var first = STATE.cart[0];
    if(first && first.type === "dining"){
      var r = getRestaurantById(first.restaurantId);
      if(r && r.whatsapp){
        setTimeout(function(){ try{ window.open(r.whatsapp, "_blank"); }catch(e){} }, 200);
      }
    }

    STATE.cart = [];
    payMethod = null;

    $("app").innerHTML =
      '<div class="wrap" style="text-align:center;margin-top:40px">' +
        '<div class="demo-note">DEMO ORDER <span>‚Ä¢ saved locally on this device</span></div>' +
        '<div style="font-size:5rem;margin-bottom:20px">‚úÖ</div>' +
        '<div class="h1" style="color:var(--accent)">ORDER PLACED</div>' +
        '<div class="p">Order: ' + esc(id) + '</div>' +
        '<button class="action" type="button" data-action="track" data-order="' + esc(id) + '">TRACK</button>' +
        '<button class="secondary" type="button" data-action="pdf" data-order="' + esc(id) + '" style="margin-top:10px">DOWNLOAD PDF <span style="opacity:.7">‚Ä¢ DEMO</span></button>' +
        '<button class="secondary" type="button" data-action="home" style="margin-top:10px">‚Üê HOME</button>' +
      '</div>';
    toast("Done");
  }

  function renderOrders(){
    loadOrders();
    if(!STATE.orders.length){ toast("No orders"); renderLobby(); return; }

    var list = STATE.orders.slice().reverse().map(function(o){
      return (
        '<div class="result" role="button" tabindex="0" data-action="track" data-order="' + esc(o.id) + '" style="cursor:pointer">' +
          '<div class="row">' +
            '<div><div style="font-weight:900;font-size:1.1rem">' + esc(o.id) + '</div><div style="color:#888;font-size:.85rem;margin-top:5px">' +
              new Date(o.timestamp).toLocaleDateString("en-IN") +
            '</div></div>' +
            '<div style="text-align:right">' +
              '<div style="font-weight:900;color:var(--brand-orange)">' + money(o.total||0) + '</div>' +
              '<div style="color:var(--accent);font-size:.85rem;margin-top:5px">' + esc(String(o.status||"").toUpperCase()) + '</div>' +
            '</div>' +
          '</div>' +
          '<div style="margin-top:10px"><span class="demo-pill">DEMO</span></div>' +
        '</div>'
      );
    }).join("");

    $("app").innerHTML =
      '<div class="wrap">' +
        '<div class="h1">ORDERS</div>' +
        '<div class="demo-note">DEMO HISTORY <span>‚Ä¢ stored in localStorage</span></div>' +
        list +
        '<button class="secondary" type="button" data-action="home" style="margin-top:10px">‚Üê HOME</button>' +
      '</div>';
  }

  function renderTracking(orderId){
    $("app").innerHTML =
      '<div class="wrap">' +
        '<div class="h1">TRACKING</div>' +
        '<div class="demo-note">DEMO TRACKING <span>‚Ä¢ timeline is illustrative</span></div>' +
        '<div class="p">' + esc(orderId) + '</div>' +
        '<div class="result">' +
          '<div style="font-weight:900">Confirmed ‚úì</div><div style="color:#888;margin-top:6px">Today</div>' +
          '<div style="height:12px"></div><div style="font-weight:900">Preparing ‚úì</div><div style="color:#888;margin-top:6px">Now</div>' +
          '<div style="height:12px"></div><div style="font-weight:900">Out for delivery ‚è≥</div><div style="color:#888;margin-top:6px">Soon</div>' +
          '<div style="height:12px"></div><div style="font-weight:900">Delivered üì¶</div><div style="color:#888;margin-top:6px">Soon</div>' +
        '</div>' +
        '<button class="secondary" type="button" data-action="orders" style="margin-top:10px">‚Üê BACK</button>' +
        '<button class="secondary" type="button" data-action="home" style="margin-top:10px">‚Üê HOME</button>' +
      '</div>';
  }

  function pdf(orderId){
    try{
      loadOrders();
      var order = null;
      for(var i=0;i<STATE.orders.length;i++){ if(STATE.orders[i].id === orderId){ order = STATE.orders[i]; break; } }
      if(!order){ toast("Order not found"); return; }

      var jspdf = window.jspdf;
      if(!jspdf || !jspdf.jsPDF){ toast("PDF not ready"); return; }

      var doc = new jspdf.jsPDF();
      doc.setFontSize(18);
      doc.text("DECIDE RECEIPT (DEMO)", 14, 18);
      doc.setFontSize(11);
      doc.text("Order: " + order.id, 14, 28);
      doc.text("Date: " + new Date(order.timestamp).toLocaleString("en-IN"), 14, 35);
      doc.text("Payment: " + String(order.payment||"").toUpperCase(), 14, 42);

      var y = 55;
      doc.setFontSize(12);
      doc.text("Items", 14, y);
      y += 8;
      doc.setFontSize(10);

      for(var k=0;k<order.items.length;k++){
        var it = order.items[k];
        var line = (k+1) + ". " + it.name + " (" + (it.seller||"") + ")";
        doc.text(line.substring(0, 80), 14, y);
        doc.text(money(it.price).replace("‚Çπ","Rs "), 170, y, {align:"right"});
        y += 7;
        if(y > 270){ doc.addPage(); y = 20; }
      }

      y += 8;
      doc.setFontSize(11);
      doc.text("Subtotal: " + money(order.subtotal), 14, y); y += 7;
      doc.text("Tax: " + money(order.tax), 14, y); y += 7;
      doc.setFontSize(13);
      doc.text("Total: " + money(order.total), 14, y);

      doc.save("decide-" + order.id + ".pdf");
      toast("PDF saved");
    }catch(e){
      console.error(e);
      toast("PDF failed");
    }
  }

  function renderSettings(){
    $("app").innerHTML =
      '<div class="wrap">' +
        '<div class="h1">SETTINGS</div>' +
        '<div class="demo-note">DEMO APP <span>‚Ä¢ reset clears local demo data</span></div>' +
        '<div class="result"><div style="font-weight:900;margin-bottom:8px">Help</div><div style="color:#888;line-height:1.6">Choose category ‚Üí pick priorities ‚Üí compare ‚Üí buy.</div></div>' +
        '<button class="action" type="button" data-action="reset">RESET APP</button>' +
        '<button class="secondary" type="button" data-action="home">‚Üê BACK</button>' +
      '</div>';
  }

  function reset(){
    if(confirm("Reset app data?")){
      try{ localStorage.removeItem("order_history"); }catch(e){}
      STATE.cart = [];
      STATE.orders = [];
      toast("Reset done");
      renderLobby();
    }
  }

  /* ========= EVENTS ========= */
  function handle(el){
    var action = el.getAttribute("data-action");
    if(!action) return;

    if(el.getAttribute("aria-disabled") === "true") return;

    if(action === "home"){ renderLobby(); return; }

    if(action === "domain"){
      var d = el.getAttribute("data-domain");
      if(d === "dining"){ renderDining(); return; }
      renderFilters(d);
      return;
    }

    if(action === "dining"){ renderDining(); return; }
    if(action === "setCity"){ STATE.diningCity = el.getAttribute("data-city") || "Rajkot"; renderDining(); return; }
    if(action === "openRestaurant"){ renderRestaurant(el.getAttribute("data-rid")); return; }
    if(action === "addFood"){ addFoodItem(el.getAttribute("data-item")); return; }
    if(action === "foodCart"){ renderFoodCart(); return; }

    if(action === "toggle"){ toggleFilter(el.getAttribute("data-filter"), el); return; }
    if(action === "search"){ search(); return; }
    if(action === "change"){ renderFilters(STATE.domain); return; }

    if(action === "add"){ add(Number(el.getAttribute("data-idx"))); return; }
    if(action === "buy"){ buy(Number(el.getAttribute("data-idx"))); return; }

    if(action === "cart"){ renderFoodCart(); return; }
    if(action === "remove"){ remove(Number(el.getAttribute("data-idx"))); return; }

    if(action === "pay"){ renderPayment(); return; }

    if(action === "pm"){
      var method = el.getAttribute("data-method");
      var opts = document.querySelectorAll(".payment-option");
      for(var i=0;i<opts.length;i++) opts[i].classList.remove("selected");
      el.classList.add("selected");
      payMethod = method;
      return;
    }

    if(action === "place"){ place(); return; }
    if(action === "orders"){ renderOrders(); return; }
    if(action === "track"){ renderTracking(el.getAttribute("data-order")); return; }
    if(action === "settings"){ renderSettings(); return; }
    if(action === "reset"){ reset(); return; }
    if(action === "pdf"){ pdf(el.getAttribute("data-order")); return; }

    if(action === "refresh"){ toast("Refresh (demo)"); return; }
  }

  document.addEventListener("click", function(e){
    var el = e.target.closest("[data-action]");
    if(el) handle(el);
  });

  document.addEventListener("keydown", function(e){
    if(e.key !== "Enter" && e.key !== " ") return;
    var el = e.target.closest("[data-action][role='button']");
    if(!el) return;
    e.preventDefault();
    handle(el);
  });

  function init(){
    loadOrders();
    loadToMemory(SAMPLE);
    renderLobby();
  }

  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", init, {once:true});
    setTimeout(function(){ try{ if(!$("app").innerHTML.trim()) init(); }catch(e){} }, 1200);
  }else{
    init();
  }

})();
</script>
</body>
</html>
