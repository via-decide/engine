<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
  <title>viadecide.com | India's Decision Engine</title>
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#04080f" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="decide.engine" />
  <meta name="description" content="India's decision research engine â€” built for the IndiaAI mission." />
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512.png" />

  <!-- PDF libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800;900&family=Space+Mono:wght@400;700&family=Noto+Sans:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">

  <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• VARIABLES */
    :root {
      --saffron: #FF9933;
      --india-green: #138808;
      --chakra-blue: #000080;
      --white: #FFFFFF;
      --brand-bg: #060c16;
      --bg-card: #0d1825;
      --bg-deep: #04080f;
      --text-main: #e8edf5;
      --text-dim: #8fa3bb;
      --accent-go: #00d68f;
      --accent-pulse: #ff9933;
      --accent-blue: #3b82f6;
      --border: rgba(255,255,255,0.08);
      --border-glow: rgba(255,153,51,0.25);
      --font-display: 'Syne', sans-serif;
      --font-mono: 'Space Mono', monospace;
      --font-body: 'Noto Sans', sans-serif;
      --shadow-card: 0 8px 32px rgba(0,0,0,0.45);
      /* sidebar width for desktop */
      --sidebar-w: 280px;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html { scroll-behavior: smooth; height: 100%; }

    body {
      background: var(--bg-deep);
      color: var(--text-main);
      font-family: var(--font-body);
      height: 100%;
      overflow: hidden;  /* body never scrolls â€” only #page-content does */
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOADING SCREEN */
    #loading-screen {
      position: fixed; inset: 0; z-index: 9999;
      background: var(--bg-deep);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      gap: 20px;
      transition: opacity 0.5s ease;
    }
    #loading-screen.fade-out { opacity: 0; pointer-events: none; }
    #loading-screen.hidden { display: none; }
    .loading-logo {
      font-family: var(--font-display); font-weight: 900;
      font-size: clamp(2rem, 6vw, 4rem);
      letter-spacing: -.04em;
    }
    .loading-logo .via { color: var(--saffron); }
    .loading-logo .decide { color: #fff; }
    .loading-logo .dot { color: var(--accent-go); }
    .loading-bar-wrap {
      width: 200px; height: 3px;
      background: rgba(255,255,255,0.1);
      border-radius: 2px; overflow: hidden;
    }
    .loading-bar {
      height: 100%; width: 0%;
      background: linear-gradient(90deg, var(--saffron), var(--accent-go));
      border-radius: 2px;
      animation: loadAnim 1.2s ease forwards;
    }
    @keyframes loadAnim { 0%{width:0%} 60%{width:70%} 100%{width:100%} }
    .loading-sub {
      font-family: var(--font-mono); font-size: .6rem;
      color: var(--text-dim); letter-spacing: 2px; text-transform: uppercase;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TRICOLOR BAR */
    .tricolor-bar {
      position: fixed; top: 0; left: 0; right: 0; height: 3px;
      background: linear-gradient(90deg, #FF9933 33.33%, #FFFFFF 33.33%, #FFFFFF 66.66%, #138808 66.66%);
      z-index: 9000;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• APP LAYOUT */
    #app {
      display: flex;
      min-height: 100vh;
      padding-top: 3px; /* tricolor */
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DESKTOP SIDEBAR */
    #sidebar {
      width: var(--sidebar-w);
      background: linear-gradient(180deg, rgba(6,12,22,0.99), rgba(4,8,15,0.97));
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 3px; left: 0; bottom: 0;
      z-index: 800;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      transition: transform 0.25s cubic-bezier(.2,.8,.2,1);
    }

    /* Mobile: sidebar is hidden off-screen, toggled */
    @media (max-width: 900px) {
      #sidebar {
        transform: translateX(-100%);
        box-shadow: 4px 0 32px rgba(0,0,0,0.5);
        width: min(300px, 85vw);
      }
      #sidebar.open { transform: translateX(0); }
    }

    #sidebar-overlay {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.55);
      z-index: 799;
    }
    @media (max-width: 900px) {
      #sidebar-overlay.open { display: block; }
    }

    .sidebar-header {
      padding: 20px 18px 16px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .sidebar-logo {
      font-family: var(--font-display); font-weight: 900;
      font-size: 1.4rem; letter-spacing: -.04em;
      cursor: pointer; user-select: none;
    }
    .sidebar-logo .via { color: var(--saffron); }
    .sidebar-logo .decide { color: #fff; }
    .sidebar-logo .dot { color: var(--accent-go); }
    .sidebar-tagline {
      font-family: var(--font-mono); font-size: .55rem;
      color: var(--text-dim); letter-spacing: 1.5px;
      text-transform: uppercase; margin-top: 4px;
    }

    .sidebar-nav { padding: 12px 10px; flex: 1; }
    .nav-section-label {
      font-family: var(--font-mono); font-size: .55rem;
      color: #3a4a5c; letter-spacing: 2px; text-transform: uppercase;
      padding: 10px 8px 6px; user-select: none;
    }
    .nav-item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 12px; border-radius: 10px;
      cursor: pointer; transition: all .15s;
      font-family: var(--font-display); font-size: .82rem;
      font-weight: 700; color: var(--text-dim);
      text-decoration: none; user-select: none;
      -webkit-tap-highlight-color: transparent;
      border: 1px solid transparent;
      margin-bottom: 2px;
    }
    .nav-item:hover { background: rgba(255,255,255,.04); color: var(--text-main); }
    .nav-item.active {
      background: rgba(255,153,51,.1);
      border-color: rgba(255,153,51,.25);
      color: var(--saffron);
    }
    .nav-item .nav-icon { font-size: 1rem; flex-shrink: 0; width: 20px; text-align: center; }
    .nav-badge {
      margin-left: auto; font-family: var(--font-mono);
      font-size: .52rem; padding: 3px 7px; border-radius: 99px;
      background: rgba(0,214,143,.1); color: var(--accent-go);
      border: 1px solid rgba(0,214,143,.25);
    }

    .sidebar-footer {
      padding: 14px 16px;
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }
    .sidebar-stats {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 8px; margin-bottom: 12px;
    }
    .sstat {
      background: var(--bg-deep);
      border: 1px solid var(--border);
      border-radius: 8px; padding: 8px;
      text-align: center;
    }
    .sstat-num {
      font-family: var(--font-display); font-weight: 900;
      font-size: 1rem; color: var(--saffron); line-height: 1;
    }
    .sstat-lbl {
      font-family: var(--font-mono); font-size: .5rem;
      color: var(--text-dim); text-transform: uppercase;
      letter-spacing: .8px; margin-top: 2px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN CONTENT AREA */
    #main {
      flex: 1;
      margin-left: var(--sidebar-w);
      height: 100vh;          /* fixed height â€” required for inner scroll */
      display: flex;
      flex-direction: column;
      overflow: hidden;       /* clip so only #page-content scrolls */
      position: relative;
    }
    @media (max-width: 900px) {
      #main { margin-left: 0; }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOPBAR (mobile + desktop) */
    #topbar {
      position: sticky; top: 3px; z-index: 700;
      height: 58px;
      display: flex; align-items: center;
      padding: 0 16px;
      background: rgba(6,12,22,0.95);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(12px);
      gap: 12px;
      flex-shrink: 0;
    }
    #menu-toggle {
      width: 36px; height: 36px;
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 8px; display: none; align-items: center;
      justify-content: center; cursor: pointer; flex-shrink: 0;
      -webkit-tap-highlight-color: transparent;
    }
    @media (max-width: 900px) {
      #menu-toggle { display: flex; }
    }
    #menu-toggle svg { width: 18px; height: 18px; fill: var(--text-dim); }

    .topbar-title {
      font-family: var(--font-display); font-size: .85rem;
      font-weight: 800; color: var(--text-main);
      letter-spacing: .5px; flex: 1;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .topbar-badge {
      font-family: var(--font-mono); font-size: .58rem;
      color: var(--text-dim); background: var(--bg-card);
      padding: 4px 10px; border-radius: 99px;
      border: 1px solid var(--border); flex-shrink: 0;
    }
    .topbar-badge.india { border-color: rgba(255,153,51,.4); color: var(--saffron); }
    .topbar-badge.green { border-color: rgba(0,214,143,.4); color: var(--accent-go); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PAGE CONTENT */
    #page-content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-y: contain;
      padding: 24px 24px 100px;
      /* height is determined by flex â€” parent is fixed 100vh with topbar above */
    }
    @media (max-width: 600px) {
      #page-content { padding: 16px 14px 100px; }
    }
    /* Desktop wider content */
    @media (min-width: 1200px) {
      #page-content { max-width: 900px; }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOAST */
    #toast {
      position: fixed; bottom: 24px; left: 50%;
      transform: translateX(-50%);
      background: var(--bg-card); color: var(--accent-go);
      padding: 10px 22px;
      border: 1px solid rgba(0,214,143,.4);
      border-radius: 99px; font-size: .75rem;
      opacity: 0; pointer-events: none;
      transition: opacity .25s; z-index: 8000;
      font-family: var(--font-mono); letter-spacing: .8px;
      box-shadow: 0 8px 24px rgba(0,0,0,.4);
      white-space: nowrap;
    }
    #toast.visible { opacity: 1; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• COMMON UI COMPONENTS */
    h1 {
      font-family: var(--font-display); font-size: clamp(1.5rem,4vw,2.5rem);
      margin: 0 0 10px; line-height: 1.05;
      letter-spacing: -.03em; color: var(--saffron);
    }
    h2 {
      font-family: var(--font-display); font-size: clamp(1.2rem,3vw,1.8rem);
      margin: 0 0 8px; line-height: 1.1;
      letter-spacing: -.02em; color: var(--text-main);
    }
    .primary-question {
      font-size: .95rem; color: var(--text-dim);
      margin-bottom: 20px; line-height: 1.6;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 14px; padding: 18px;
      margin-bottom: 14px;
      box-shadow: var(--shadow-card);
    }
    .card.glow { border-color: var(--border-glow); }
    .card.green-glow { border-color: rgba(0,214,143,.3); }
    .card.blue-glow { border-color: rgba(59,130,246,.3); }

    .card-title {
      font-family: var(--font-mono); font-size: .62rem;
      color: var(--text-dim); letter-spacing: 1.5px;
      text-transform: uppercase; margin-bottom: 10px;
    }

    .pill-row { display: flex; flex-wrap: wrap; gap: 8px; margin: 12px 0; }
    .pill {
      font-family: var(--font-mono); font-size: .58rem;
      letter-spacing: .8px; padding: 6px 12px;
      border-radius: 99px; text-transform: uppercase;
    }
    .pill-s { background: rgba(255,153,51,.1); border: 1px solid rgba(255,153,51,.35); color: var(--saffron); }
    .pill-g { background: rgba(0,214,143,.1); border: 1px solid rgba(0,214,143,.3); color: var(--accent-go); }
    .pill-b { background: rgba(59,130,246,.1); border: 1px solid rgba(59,130,246,.3); color: #93c5fd; }
    .pill-w { background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.15); color: rgba(255,255,255,.8); }

    /* Buttons */
    .btn {
      display: block; width: 100%;
      background: var(--bg-card); color: var(--text-main);
      border: 1px solid var(--border);
      padding: 13px 16px; border-radius: 10px;
      font-weight: 700; text-align: center; font-size: .82rem;
      cursor: pointer;
      transition: transform .1s ease, box-shadow .15s ease, opacity .15s;
      font-family: var(--font-display); letter-spacing: .5px;
      -webkit-tap-highlight-color: transparent;
      text-decoration: none;
    }
    .btn:active { transform: scale(.98); opacity: .88; }
    .btn-india { background: rgba(255,153,51,.12); border-color: rgba(255,153,51,.45); color: var(--saffron); }
    .btn-india:hover { box-shadow: 0 0 18px rgba(255,153,51,.15); }
    .btn-pro { background: rgba(0,214,143,.1); border-color: rgba(0,214,143,.35); color: var(--accent-go); }
    .btn-pro:hover { box-shadow: 0 0 18px rgba(0,214,143,.15); }
    .btn-policy { background: rgba(59,130,246,.1); border-color: rgba(59,130,246,.35); color: #93c5fd; }
    .btn-muted { background: var(--bg-deep); border-color: var(--border); color: var(--text-dim); }
    .btn-pdf { background: rgba(185,28,28,.15); border-color: rgba(185,28,28,.4); color: #fca5a5; }
    .btn-yt { background: rgba(204,0,0,.15); border-color: rgba(204,0,0,.4); color: #fca5a5; }
    .btn-wa { background: rgba(37,211,102,.15); border-color: rgba(37,211,102,.4); color: #4ade80; }
    .btn-danger { background: rgba(239,68,68,.12); border-color: rgba(239,68,68,.35); color: #f87171; }

    .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
    .btn-grid .btn-full { grid-column: span 2; }
    @media (max-width: 400px) {
      .btn-grid { grid-template-columns: 1fr; }
      .btn-grid .btn-full { grid-column: span 1; }
    }

    /* Form inputs */
    .form-input {
      width: 100%; background: var(--bg-deep);
      border: 1px solid var(--border); color: var(--text-main);
      padding: 12px 14px; border-radius: 10px;
      font-size: .9rem; font-family: var(--font-body);
      outline: none; transition: border-color .2s;
      margin-bottom: 10px;
    }
    .form-input:focus { border-color: rgba(255,153,51,.5); }
    .form-textarea {
      width: 100%; resize: vertical; min-height: 80px;
      background: var(--bg-deep); border: 1px solid var(--border);
      color: var(--text-main); padding: 12px 14px; border-radius: 10px;
      font-size: .88rem; font-family: var(--font-body);
      outline: none; transition: border-color .2s;
      line-height: 1.6;
    }
    .form-textarea:focus { border-color: rgba(255,153,51,.35); }

    /* Source chips */
    .source-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 14px; }
    .source-chip {
      padding: 6px 12px; border: 1px solid var(--border);
      border-radius: 99px; font-size: .62rem; color: var(--text-dim);
      font-family: var(--font-mono); cursor: pointer;
      transition: all .15s; background: var(--bg-deep);
      -webkit-tap-highlight-color: transparent;
    }
    .source-chip.active { background: rgba(0,214,143,.08); color: var(--accent-go); border-color: rgba(0,214,143,.4); }

    /* Stat grid */
    .stats-grid { display: grid; grid-template-columns: repeat(2,1fr); gap: 10px; margin: 14px 0; }
    @media (min-width: 600px) { .stats-grid { grid-template-columns: repeat(4,1fr); } }
    .stat-card {
      background: var(--bg-deep); border: 1px solid var(--border);
      border-radius: 12px; padding: 14px; text-align: center;
    }
    .stat-card .num {
      font-family: var(--font-display); font-weight: 900;
      font-size: 1.5rem; color: var(--saffron); line-height: 1;
    }
    .stat-card .lbl {
      font-family: var(--font-mono); font-size: .55rem;
      color: var(--text-dim); text-transform: uppercase;
      letter-spacing: .8px; margin-top: 4px;
    }

    /* Context top row for node view */
    .context-top { display: flex; gap: 14px; align-items: flex-start; margin-bottom: 14px; }
    .thumb {
      width: 64px; height: 64px; border-radius: 12px;
      background: var(--bg-deep); border: 1px solid var(--border);
      flex: 0 0 64px; overflow: hidden;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.5rem;
    }
    .thumb img { width: 100%; height: 100%; object-fit: cover; }
    .context-meta .kicker {
      font-family: var(--font-mono); font-size: .58rem;
      color: var(--text-dim); letter-spacing: 1px;
      text-transform: uppercase; margin-bottom: 5px;
    }
    .chip-row { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 6px; }
    .chip {
      font-family: var(--font-mono); font-size: .58rem;
      background: var(--bg-deep); color: var(--text-dim);
      padding: 4px 8px; border-radius: 99px; border: 1px solid var(--border);
    }
    .chip.green { border-color: rgba(0,214,143,.3); color: var(--accent-go); }
    .chip.orange { border-color: rgba(255,153,51,.3); color: var(--saffron); }

    /* Summary scroll box */
    .scroll-box {
      max-height: 35vh; overflow-y: auto;
      overscroll-behavior: contain; -webkit-overflow-scrolling: touch;
      background: var(--bg-deep); border: 1px solid var(--border);
      border-radius: 12px; padding: 14px;
      font-size: .9rem; line-height: 1.75;
      color: var(--text-main);
      user-select: text; -webkit-user-select: text;
    }
    .scroll-box .lead { color: #fff; font-weight: 700; margin-bottom: 10px; display: block; }
    .scroll-box p { margin: 0 0 10px; }
    .scroll-box p:last-child { margin: 0; }

    /* Takeaways */
    .takeaways {
      background: var(--bg-deep); border: 1px solid var(--border);
      border-radius: 12px; padding: 12px 16px 12px 12px;
      margin-bottom: 12px;
      user-select: text; -webkit-user-select: text;
    }
    .takeaways ul { margin: 0; padding-left: 18px; }
    .takeaways li { margin: 6px 0; font-size: .9rem; line-height: 1.6; }

    /* Policy banner */
    .policy-banner {
      background: rgba(0,0,128,.1); border: 1px solid rgba(59,130,246,.25);
      border-radius: 10px; padding: 11px 14px; margin-bottom: 12px;
      display: flex; gap: 12px; align-items: flex-start;
      font-size: .83rem; color: var(--text-dim); line-height: 1.6;
    }
    .policy-banner strong { color: #93c5fd; }

    /* Founder letter */
    .founder-letter {
      background: linear-gradient(135deg,rgba(255,153,51,.07),rgba(6,12,22,0),rgba(19,136,8,.05));
      border: 1px solid rgba(255,153,51,.2); border-radius: 16px;
      padding: 20px 18px; margin-bottom: 14px; position: relative;
    }
    .founder-letter::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; background:linear-gradient(90deg,#FF9933,transparent,#138808); border-radius:16px 16px 0 0; }
    .founder-eyebrow {
      font-family: var(--font-mono); font-size: .6rem;
      letter-spacing: 2px; color: var(--saffron); text-transform: uppercase;
      margin-bottom: 10px; display: flex; align-items: center; gap: 8px;
    }
    .founder-eyebrow::after { content:''; flex:1; height:1px; background:rgba(255,153,51,.2); }
    .founder-letter p { font-size: .9rem; color: var(--text-dim); line-height: 1.75; margin: 0 0 10px; }
    .founder-letter p:last-child { margin: 0; }
    .founder-letter strong { color: var(--text-main); font-weight: 600; }

    /* Pulse dot */
    .pulse-dot { display:inline-block;width:7px;height:7px;background:var(--accent-go);border-radius:50%;animation:pulse 2s ease-in-out infinite; }
    @keyframes pulse { 0%,100%{transform:scale(1);opacity:1} 50%{transform:scale(1.4);opacity:.6} }

    /* Nav hint */
    .nav-hint {
      margin-top: 16px; padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,.04);
      font-family: var(--font-mono); font-size: .6rem;
      color: #3a4a5c; display: flex; justify-content: space-between;
    }

    /* Notes panel */
    #notes-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,.5); z-index: 5000;
    }
    #notes-overlay.open { display: block; }
    #notes-panel {
      position: fixed; bottom: 0; left: 50%;
      transform: translate(-50%, 102%);
      width: min(700px, 96vw); height: min(55vh, 480px);
      background: var(--brand-bg);
      border: 1px solid var(--border); border-bottom: none;
      border-top-left-radius: 18px; border-top-right-radius: 18px;
      z-index: 5001; transition: transform .22s cubic-bezier(.2,.8,.2,1);
      display: flex; flex-direction: column;
      box-shadow: 0 -20px 40px rgba(0,0,0,.5);
    }
    #notes-panel.open { transform: translate(-50%, 0); }
    .notes-header {
      padding: 14px 16px; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .notes-header-title { font-family: var(--font-display); font-size: .75rem; color: var(--saffron); font-weight: 700; letter-spacing: 1px; text-transform: uppercase; }
    .notes-body { padding: 14px 16px; flex: 1; overflow-y: auto; }
    .notes-meta { display: flex; justify-content: space-between; font-family: var(--font-mono); font-size: .62rem; color: #3a4a5c; text-transform: uppercase; margin-top: 8px; }

    /* Depth indicator */
    #depth-bar {
      position: fixed; right: 0; top: 3px; bottom: 0;
      width: 3px; z-index: 600;
      background: rgba(255,255,255,.04);
    }
    #depth-fill {
      width: 100%; background: linear-gradient(180deg, var(--saffron), var(--accent-go));
      transition: height .3s ease; border-radius: 2px;
    }

    /* Install button */
    #install-btn {
      display: none; width: 100%;
      margin-top: 8px;
    }

    /* Cuisine/domain selector */
    .domain-btn {
      background: var(--bg-card); border: 1px solid var(--border);
      color: var(--text-dim); padding: 16px 18px; font-size: .9rem;
      font-weight: 700; text-transform: uppercase; border-radius: 12px;
      transition: all .2s; font-family: var(--font-display); letter-spacing: .5px;
      text-align: left; cursor: pointer; width: 100%; display: block;
      margin-bottom: 10px; -webkit-tap-highlight-color: transparent;
    }
    .domain-btn:hover, .domain-btn.selected {
      background: rgba(255,153,51,.1);
      border-color: rgba(255,153,51,.45); color: var(--saffron);
    }

    /* Pro PDF hidden root */
    #pro-ui-root {
      position: fixed; left: -99999px; top: 0;
      width: 794px; background: #060c16;
      color: #fff; font-family: 'Syne', sans-serif; z-index: -1;
    }
    .proui-page { padding: 38px 42px; min-height: 1123px; border-top: 1px solid rgba(255,255,255,.08); position: relative; }
    .proui-page:first-child { border-top: none; }
    .proui-wm { position:absolute;left:0;right:0;bottom:16px;text-align:center;font-size:10px;letter-spacing:.2em;text-transform:uppercase;color:rgba(255,255,255,.2); }
    .proui-title { font-size:32px;font-weight:900;letter-spacing:-.03em;margin:0;color:#FF9933; }
    .proui-subtitle { margin:10px 0 0;color:rgba(255,255,255,.7);line-height:1.5;font-size:14px; }
    .proui-pillrow { display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px; }
    .proui-pill { border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.04);padding:6px 12px;border-radius:99px;font-size:11px;color:rgba(255,255,255,.75); }
    .proui-pill.saffron { border-color:rgba(255,153,51,.4);color:#FF9933; }
    .proui-card { background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.09);border-radius:16px;padding:16px; }
    .proui-h { margin:0 0 8px;font-size:11px;letter-spacing:.14em;text-transform:uppercase;color:rgba(255,255,255,.6); }
    .proui-grid2 { display:grid;grid-template-columns:1fr 1fr;gap:12px; }
    .proui-kv { display:grid;grid-template-columns:1fr auto;gap:8px 10px;font-size:12px; }
    .proui-k { color:rgba(255,255,255,.55); }
    .proui-v { font-weight:800;color:rgba(255,255,255,.9);text-align:right; }
    .proui-list { margin:0;padding-left:18px;color:rgba(255,255,255,.83);line-height:1.6;font-size:12px; }
    .proui-list li { margin:5px 0; }
    .proui-nodeTitle { font-size:20px;font-weight:900;margin:0;color:#FF9933; }
    .proui-small { font-size:12px;color:rgba(255,255,255,.72);line-height:1.6; }
    .proui-tricolor { height:4px;border-radius:2px;margin-bottom:20px;background:linear-gradient(90deg,#FF9933 33.33%,#FFFFFF 33.33%,#FFFFFF 66.66%,#138808 66.66%); }

    /* Animate in */
    @keyframes fadeUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }
    .animate-in { animation: fadeUp .35s ease both; }

    /* Desktop grid layout for some pages */
    @media (min-width: 900px) {
      .desktop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
      .desktop-grid .span-2 { grid-column: span 2; }
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,.1); border-radius: 3px; }
  </style>
</head>
<body>

<!-- Loading Screen -->
<div id="loading-screen">
  <div class="loading-logo">
    <span class="via">via</span><span class="decide">decide</span><span class="dot">.</span><span style="color:rgba(255,255,255,.9)">com</span>
  </div>
  <div class="loading-bar-wrap"><div class="loading-bar"></div></div>
  <div class="loading-sub">India's Decision Engine</div>
</div>

<div class="tricolor-bar"></div>

<!-- App Shell -->
<div id="app">

  <!-- SIDEBAR -->
  <div id="sidebar-overlay" onclick="closeSidebar()"></div>
  <aside id="sidebar" aria-label="Navigation">
    <div class="sidebar-header">
      <div class="sidebar-logo" onclick="navigateTo('home')">
        <span class="via">via</span><span class="decide">decide</span><span class="dot">.</span><span style="color:rgba(255,255,255,.85)">com</span>
      </div>
      <div class="sidebar-tagline">India's Decision Engine</div>
    </div>

    <nav class="sidebar-nav">
      <div class="nav-section-label">Navigation</div>
      <a class="nav-item active" id="nav-home" onclick="navigateTo('home')">
        <span class="nav-icon">ğŸ </span> Home
      </a>
      <a class="nav-item" id="nav-research" onclick="navigateTo('research')">
        <span class="nav-icon">ğŸ”</span> Research
        <span class="nav-badge" id="nav-nodes-badge" style="display:none">0</span>
      </a>
      <a class="nav-item" id="nav-founder" onclick="navigateTo('founder')">
        <span class="nav-icon">âœ‰ï¸</span> Founder Letter
      </a>
      <a class="nav-item" id="nav-policy" onclick="navigateTo('policy')">
        <span class="nav-icon">ğŸ›ï¸</span> IndiaAI Policy
      </a>

      <div class="nav-section-label" style="margin-top:8px">Tools</div>
      <a class="nav-item" id="nav-synthesis" onclick="navigateTo('synthesis')">
        <span class="nav-icon">ğŸ§ </span> Synthesis
      </a>
      <a class="nav-item" id="nav-quiz" onclick="navigateTo('quiz')">
        <span class="nav-icon">ğŸ§©</span> Quiz (Alchemist)
      </a>
      <a class="nav-item" onclick="toggleNotes()">
        <span class="nav-icon">âœ</span> Notes
      </a>

      <div class="nav-section-label" style="margin-top:8px">Projects</div>
      <a class="nav-item" onclick="saveCurrentProjectPrompt()">
        <span class="nav-icon">ğŸ’¾</span> Save Project
      </a>
      <a class="nav-item" onclick="shareCurrentProject()">
        <span class="nav-icon">ğŸ”—</span> Share Link
      </a>
      <a class="nav-item" onclick="openProjectPicker()">
        <span class="nav-icon">ğŸ“‚</span> Load Project
      </a>
      <a class="nav-item" onclick="importShareLinkPrompt()">
        <span class="nav-icon">ğŸ“¥</span> Import Link
      </a>
    </nav>

    <div class="sidebar-footer">
      <div class="sidebar-stats">
        <div class="sstat"><div class="sstat-num" id="sf-nodes">0</div><div class="sstat-lbl">Nodes</div></div>
        <div class="sstat"><div class="sstat-num" id="sf-projects">0</div><div class="sstat-lbl">Projects</div></div>
      </div>
      <button class="btn btn-india" id="install-btn" onclick="triggerAppInstall()">â¬‡ Install App</button>
    </div>
  </aside>

  <!-- MAIN -->
  <div id="main">
    <!-- Topbar -->
    <header id="topbar">
      <button id="menu-toggle" onclick="toggleSidebar()" aria-label="Menu">
        <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
      </button>
      <div class="topbar-title" id="topbar-title">decide.engine</div>
      <div class="topbar-badge india" id="topbar-badge">INDIAAI</div>
    </header>

    <!-- Page Content -->
    <main id="page-content" role="main">
      <!-- Rendered by JS -->
    </main>
  </div>

</div>

<!-- Notes Panel -->
<div id="notes-overlay" onclick="closeNotes()"></div>
<div id="notes-panel" aria-hidden="true">
  <div class="notes-header">
    <div class="notes-header-title">Policy Scratchpad</div>
    <button class="btn btn-muted" style="width:auto;padding:8px 14px;font-size:.72rem" onclick="closeNotes()">CLOSE</button>
  </div>
  <div class="notes-body">
    <textarea id="notes-text" class="form-textarea" style="min-height:200px" placeholder="Capture policy insights, decision options, stakeholder notes..."></textarea>
    <div class="notes-meta">
      <span id="notes-count">0 chars</span>
      <span id="notes-saved">Not saved</span>
    </div>
    <div class="btn-grid" style="margin-top:10px">
      <button class="btn" onclick="saveNotes()">SAVE</button>
      <button class="btn btn-muted" onclick="clearNotes()">CLEAR</button>
    </div>
  </div>
</div>

<!-- Depth bar -->
<div id="depth-bar"><div id="depth-fill" style="height:0%"></div></div>

<!-- Toast -->
<div id="toast"></div>

<!-- Pro PDF root -->
<div id="pro-ui-root" aria-hidden="true"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VIADECIDE.COM â€” Complete App
   Fixes: white screen, responsive layout, routing, PWA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”€â”€ PWA Service Worker
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("/sw.js").catch(() => {});
  });
}

// â”€â”€ PWA Install
let deferredInstallPrompt = null;
window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredInstallPrompt = e;
  const btn = document.getElementById("install-btn");
  if (btn) btn.style.display = "block";
});
window.addEventListener("appinstalled", () => {
  deferredInstallPrompt = null;
  const btn = document.getElementById("install-btn");
  if (btn) btn.style.display = "none";
  showToast("APP INSTALLED");
});
async function triggerAppInstall() {
  if (!deferredInstallPrompt) { showToast("INSTALL NOT AVAILABLE"); return; }
  deferredInstallPrompt.prompt();
  try {
    const { outcome } = await deferredInstallPrompt.userChoice;
    showToast(outcome === "accepted" ? "INSTALLING..." : "CANCELLED");
  } catch(e) { showToast("INSTALL FAILED"); }
  deferredInstallPrompt = null;
  const btn = document.getElementById("install-btn");
  if (btn) btn.style.display = "none";
}

// â”€â”€ Utilities
function escapeHTML(str) {
  return (str ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");
}
function normalizeText(t) { return (t||"").replace(/\s+/g," ").replace(/\u00AD/g,"").trim(); }
function splitSentences(text) {
  const t = normalizeText(text); if (!t) return [];
  return t.split(/(?<=[.!?])\s+(?=[A-Z0-9""\u201C(])/g).map(s=>s.trim()).filter(Boolean);
}
function extractTakeaways(summary, max=4) { return splitSentences(summary).slice(0,max).map(x=>x.replace(/\s+/g," ").trim()); }
function formatSummaryHTML(summary) {
  const sents = splitSentences(summary);
  if (!sents.length) return '<p class="muted">No summary available.</p>';
  const lead = sents[0]; const rest = sents.slice(1); const paras = [];
  for (let i=0;i<rest.length;i+=3) paras.push(rest.slice(i,i+3).join(" "));
  return `<span class="lead">${escapeHTML(lead)}</span>` + paras.map(p=>`<p>${escapeHTML(p)}</p>`).join("");
}
function wordCount(text) { const t=normalizeText(text); if(!t)return 0; return t.split(/\s+/).length; }
function readingTime(words) { return Math.max(1,Math.round(words/180)); }
function nowIST() { return new Date().toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit",timeZone:"Asia/Kolkata"}); }
function uid() { return "p_"+Math.random().toString(16).slice(2)+Date.now().toString(16); }
function sanitizePDF(t) { return normalizeText(t).replace(/[^\x00-\xFF]/g,""); }
function confidenceFor(src) { if(src==="wiki"||src==="travel")return"High"; if(src==="wikibooks")return"Medium"; return"Low"; }

// â”€â”€ Toast
let _toastTimer = null;
function showToast(msg) {
  const el = document.getElementById("toast");
  if (!el) return;
  el.textContent = msg;
  el.classList.add("visible");
  clearTimeout(_toastTimer);
  _toastTimer = setTimeout(() => el.classList.remove("visible"), 2200);
}

// â”€â”€ Sidebar
function toggleSidebar() {
  const s = document.getElementById("sidebar");
  const o = document.getElementById("sidebar-overlay");
  s.classList.toggle("open");
  o.classList.toggle("open");
}
function closeSidebar() {
  document.getElementById("sidebar").classList.remove("open");
  document.getElementById("sidebar-overlay").classList.remove("open");
}

// â”€â”€ Notes
const NOTES_KEY = "decide_notes_v2";
function toggleNotes() { const p=document.getElementById("notes-panel"); p.classList.toggle("open"); document.getElementById("notes-overlay").classList.toggle("open"); if(p.classList.contains("open")){ loadNotes(); updateNotesMeta(); } closeSidebar(); }
function closeNotes() { document.getElementById("notes-panel").classList.remove("open"); document.getElementById("notes-overlay").classList.remove("open"); }
function loadNotes() { try{ const ta=document.getElementById("notes-text"); if(ta){ const s=localStorage.getItem(NOTES_KEY); if(s)ta.value=s; } }catch(e){} }
function saveNotes() { try{ const ta=document.getElementById("notes-text"); if(ta){ localStorage.setItem(NOTES_KEY,ta.value); const el=document.getElementById("notes-saved"); if(el)el.textContent="Saved "+nowIST(); showToast("NOTES SAVED"); updateNotesMeta(); autosaveIfPossible(); } }catch(e){showToast("SAVE FAILED");} }
function clearNotes() { try{ const ta=document.getElementById("notes-text"); if(ta)ta.value=""; localStorage.removeItem(NOTES_KEY); const el=document.getElementById("notes-saved"); if(el)el.textContent="Cleared"; showToast("NOTES CLEARED"); updateNotesMeta(); }catch(e){} }
function updateNotesMeta() { const ta=document.getElementById("notes-text"), c=document.getElementById("notes-count"); if(ta&&c)c.textContent=ta.value.length+" chars"; }
document.addEventListener("input", e => { if(e?.target?.id==="notes-text") updateNotesMeta(); });

// â”€â”€ State
let ENGINE_STATE = { cuisines_detected:[], research_nodes:[], synthesis:null };
let CURRENT_PROJECT = null;
let currentDecisionContext = null;

// â”€â”€ Sidebar stats updater
function updateSidebarStats() {
  const nodes = ENGINE_STATE.research_nodes?.length || 0;
  const sfn = document.getElementById("sf-nodes"); if(sfn) sfn.textContent = nodes;
  const badge = document.getElementById("nav-nodes-badge");
  if(badge){ badge.textContent = nodes; badge.style.display = nodes>0?"inline":"none"; }
  const projects = Object.keys(getProjectsIndex()).length;
  const sfp = document.getElementById("sf-projects"); if(sfp) sfp.textContent = projects;
}
setInterval(updateSidebarStats, 2000);

// â”€â”€ Active nav highlight
function setActiveNav(key) {
  document.querySelectorAll(".nav-item").forEach(el => el.classList.remove("active"));
  const el = document.getElementById("nav-"+key);
  if(el) el.classList.add("active");
}

// â”€â”€ Topbar updater
function setTopbar(title, badge="INDIAAI", badgeClass="india") {
  const t = document.getElementById("topbar-title"); if(t) t.textContent = title;
  const b = document.getElementById("topbar-badge");
  if(b){ b.textContent = badge; b.className = "topbar-badge " + badgeClass; }
}

// â”€â”€ Depth bar
function updateDepth(current, total) {
  const el = document.getElementById("depth-fill");
  if(!el) return;
  const pct = total>1 ? Math.round((current/Math.max(1,total-1))*100) : 0;
  el.style.height = pct + "%";
}

// â”€â”€ Render helpers
function renderPage(htmlContent, title="decide.engine", badge="INDIAAI", badgeClass="india") {
  const pc = document.getElementById("page-content");
  if(!pc) return;
  pc.innerHTML = `<div class="animate-in">${htmlContent}</div>`;
  pc.scrollTop = 0;
  setTopbar(title, badge, badgeClass);
  closeSidebar();
  updateSidebarStats();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WIKI ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WIKI_ENGINE = {
  activeSource: "wiki",
  cache: new Map(),
  sources: {
    wiki:      { name:"WIKIPEDIA",  api:"https://en.wikipedia.org/w/api.php",  icon:"ğŸ“š" },
    travel:    { name:"WIKIVOYAGE", api:"https://en.wikivoyage.org/w/api.php", icon:"ğŸ—ºï¸" },
    wikibooks: { name:"WIKIBOOKS",  api:"https://en.wikibooks.org/w/api.php",  icon:"ğŸ“–" },
    wikinews:  { name:"WIKINEWS",   api:"https://en.wikinews.org/w/api.php",   icon:"ğŸ“°" },
  },
  async search(query, source=this.activeSource) {
    const q = normalizeText(query);
    const ckey = `s_${source}_${q}`;
    if(this.cache.has(ckey)) return this.cache.get(ckey);
    try {
      const api = this.sources[source].api;
      const url = `${api}?origin=*&action=opensearch&search=${encodeURIComponent(q)}&limit=8&format=json`;
      const res = await fetch(url,{signal:AbortSignal.timeout(9000)});
      if(!res.ok) throw new Error("HTTP "+res.status);
      const data = await res.json();
      const results = [];
      if(data&&data[1]) for(let i=0;i<data[1].length;i++) results.push({title:data[1][i],description:(data[2]?.[i]||""),url:(data[3]?.[i]||"")});
      this.cache.set(ckey,results); return results;
    } catch(e) { console.error("Search error:",e); return []; }
  },
  async getContext(title, source=this.activeSource) {
    const t = normalizeText(title);
    const ckey = `c_${source}_${t}`;
    if(this.cache.has(ckey)) return this.cache.get(ckey);
    try {
      const api = this.sources[source].api;
      const url = `${api}?origin=*&action=query&prop=extracts|info|pageimages|categories&titles=${encodeURIComponent(t)}&exintro=1&explaintext=1&inprop=url&piprop=thumbnail&pithumbsize=300&cllimit=10&format=json`;
      const res = await fetch(url,{signal:AbortSignal.timeout(9000)});
      if(!res.ok) throw new Error("HTTP "+res.status);
      const data = await res.json();
      const pages = data?.query?.pages||{};
      const firstKey = Object.keys(pages)[0];
      if(!firstKey||firstKey==="-1") throw new Error("Not found");
      const page = pages[firstKey];
      // Get links
      const linksUrl = `${api}?origin=*&action=query&prop=links&titles=${encodeURIComponent(t)}&pllimit=20&plnamespace=0&format=json`;
      let links = [];
      try {
        const lr = await fetch(linksUrl,{signal:AbortSignal.timeout(6000)});
        const ld = await lr.json();
        const lp = ld?.query?.pages||{};
        const lk = Object.keys(lp)[0];
        links = (lk&&lp[lk]?.links) ? lp[lk].links.map(l=>({name:l.title})) : [];
      } catch(e){}
      const ctx = { title:page.title, summary:page.extract||"No summary.", url:page.fullurl||"", thumbnail:page.thumbnail?.source||null, categories:(page.categories||[]).slice(0,5).map(c=>c.title.replace("Category:","")), links, source, sourceName:this.sources[source].name, confidence:confidenceFor(source) };
      this.cache.set(ckey,ctx); return ctx;
    } catch(e) { console.error("Context error:",e); return null; }
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROJECT PERSISTENCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PROJECTS_KEY = "decideos_projects_v2";
const LAST_PROJECT_KEY = "decideos_last_v2";
const PROJECT_PREFIX = "decideos_proj_";

function getProjectsIndex() { try{return JSON.parse(localStorage.getItem(PROJECTS_KEY)||"{}"); }catch(e){return {};} }
function setProjectsIndex(idx) { localStorage.setItem(PROJECTS_KEY,JSON.stringify(idx)); }
function saveProjectToStorage(p) {
  const idx=getProjectsIndex();
  idx[p.id]={id:p.id,name:p.name,updatedAt:p.updatedAt,createdAt:p.createdAt};
  setProjectsIndex(idx); localStorage.setItem(PROJECT_PREFIX+p.id,JSON.stringify(p));
  localStorage.setItem(LAST_PROJECT_KEY,p.id);
}
function loadProjectFromStorage(id) { try{const r=localStorage.getItem(PROJECT_PREFIX+id);return r?JSON.parse(r):null;}catch(e){return null;} }
function listProjects() { return Object.values(getProjectsIndex()).sort((a,b)=>(b.updatedAt||"").localeCompare(a.updatedAt||"")); }

function serializeProject(p) {
  const json=JSON.stringify(p);
  const b64=btoa(unescape(encodeURIComponent(json)));
  return b64.replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
}
function deserializeProject(payload) {
  let b64=payload.replaceAll("-","+").replaceAll("_","/");
  while(b64.length%4)b64+="=";
  return JSON.parse(decodeURIComponent(escape(atob(b64))));
}

function buildProject() {
  const nodes=ENGINE_STATE.research_nodes||[];
  const syn=ENGINE_STATE.synthesis||null;
  const notes=(document.getElementById("notes-text")?.value||localStorage.getItem(NOTES_KEY)||"");
  if(!nodes.length&&!syn&&!notes) return null;
  return { id:CURRENT_PROJECT?.id||uid(), name:CURRENT_PROJECT?.name||(nodes[0]?.decisionMeta?.decision?`Decision: ${nodes[0].decisionMeta.decision}`:"Decision Research"), createdAt:CURRENT_PROJECT?.createdAt||new Date().toISOString(), updatedAt:new Date().toISOString(), engineState:{research_nodes:nodes,synthesis:syn,notes} };
}
function autosaveIfPossible() {
  if(!CURRENT_PROJECT?.id) return;
  const p=buildProject(); if(!p) return;
  p.id=CURRENT_PROJECT.id; p.name=CURRENT_PROJECT.name||p.name;
  p.createdAt=CURRENT_PROJECT.createdAt||p.createdAt;
  p.updatedAt=new Date().toISOString();
  saveProjectToStorage(p); CURRENT_PROJECT=p;
}
function loadProjectIntoApp(project) {
  CURRENT_PROJECT=project;
  const notes=project?.engineState?.notes||"";
  localStorage.setItem(NOTES_KEY,notes);
  const ta=document.getElementById("notes-text"); if(ta)ta.value=notes;
  ENGINE_STATE.research_nodes=Array.isArray(project?.engineState?.research_nodes)?project.engineState.research_nodes:[];
  ENGINE_STATE.synthesis=project?.engineState?.synthesis||null;
  if(ENGINE_STATE.research_nodes.length) renderResearchDeck(ENGINE_STATE.research_nodes,ENGINE_STATE.synthesis);
  else renderSearch();
  updateSidebarStats();
}
function saveCurrentProjectPrompt() {
  const p=buildProject(); if(!p){showToast("NOTHING TO SAVE");return;}
  const name=window.prompt("Project name:",(CURRENT_PROJECT?.name||p.name||"Decision Research"));
  if(name&&name.trim())p.name=name.trim();
  p.updatedAt=new Date().toISOString();
  if(!p.createdAt)p.createdAt=p.updatedAt;
  saveProjectToStorage(p); CURRENT_PROJECT=p; showToast("PROJECT SAVED"); updateSidebarStats();
}
function shareCurrentProject() {
  const p=buildProject(); if(!p){showToast("NOTHING TO SHARE");return;}
  saveProjectToStorage(p); CURRENT_PROJECT=p;
  const payload=serializeProject(p);
  const url=`${location.origin}${location.pathname}#p=${payload}`;
  if(navigator.clipboard?.writeText){ navigator.clipboard.writeText(url).then(()=>showToast("LINK COPIED")); }
  else{ window.prompt("Copy link:",url); }
}
function openProjectPicker() {
  const projects=listProjects(); if(!projects.length){showToast("NO SAVED PROJECTS");return;}
  const menu=projects.map((p,i)=>`${i+1}. ${p.name} (${(p.updatedAt||"").slice(0,10)})`).join("\n");
  const choice=window.prompt("Load project #:\n"+menu,"1");
  const n=parseInt(choice||"",10); if(!n||n<1||n>projects.length)return;
  const project=loadProjectFromStorage(projects[n-1].id); if(!project){showToast("LOAD FAILED");return;}
  loadProjectIntoApp(project); showToast("PROJECT LOADED");
}
function importShareLinkPrompt() {
  const link=window.prompt("Paste share link or payload:",""); if(!link)return;
  let payload=link.trim();
  const idx=payload.indexOf("#p="); if(idx>=0)payload=payload.slice(idx+3);
  if(payload.startsWith("p="))payload=payload.slice(2);
  try{
    const project=deserializeProject(payload);
    if(!project.id)project.id=uid(); if(!project.name)project.name="Imported";
    project.updatedAt=new Date().toISOString(); if(!project.createdAt)project.createdAt=project.updatedAt;
    saveProjectToStorage(project); loadProjectIntoApp(project); showToast("IMPORTED");
  }catch(e){console.error(e);showToast("INVALID LINK");}
}
function continueLastProject() {
  const id=localStorage.getItem(LAST_PROJECT_KEY); if(!id){showToast("NO LAST PROJECT");return;}
  const project=loadProjectFromStorage(id); if(!project){showToast("LOAD FAILED");return;}
  loadProjectIntoApp(project); showToast("CONTINUED");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXAMPLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const EXAMPLES = [
  { id:"ex_indiaai", name:"IndiaAI: National AI Mission",
    engineState:{
      notes:"Policy node: map each research node to a policy pillar â€” compute access, skilling, datasets, sector adoption, ethics.",
      synthesis:{thesis:"India's National AI Mission anchors on seven pillars: compute infrastructure, foundation models, datasets, skilling, sector adoption, startups, and responsible AI governance.",topTakeaways:["IndiaAI Mission targets sovereign AI infrastructure through the IndiaAI Compute Platform.","10,000+ GPU compute capacity being built for startups, researchers, and government.","India Datasets Platform aims to make high-quality Indian language data publicly accessible.","Responsible AI governance includes safety, ethics, fairness, and accountability frameworks.","FutureSkills Prime and IITs anchor skilling at scale for India's AI workforce."],contradictions:"Tension between data sovereignty and open innovation; compute centralization vs. democratized access.",implications:"Policymakers must align procurement, skilling, and startup enablement simultaneously.",next:"Research: AI Safety Institute India â€¢ IndiaAI Startup Financing â€¢ Digital Public Infrastructure",recommendation:"Frame every decision through: 'Does this scale to Bharat's 1.4 billion?'"},
      research_nodes:[{title:"Artificial intelligence in India",summary:"India has emerged as a global hub for AI development and deployment, driven by its large talent pool, growing startup ecosystem, and government-led initiatives such as the National AI Strategy. The government's IndiaAI Mission, launched in 2024, focuses on building sovereign AI infrastructure including compute, datasets, and application frameworks. India aims to be a global leader in responsible AI with a particular emphasis on inclusive AI for agriculture, healthcare, education, and governance at scale.",url:"https://en.wikipedia.org/wiki/Artificial_intelligence_in_India",thumbnail:null,categories:["AI","India","Policy","Technology"],links:[],source:"wiki",sourceName:"WIKIPEDIA",confidence:"High",decisionMeta:{decision:"Evaluate IndiaAI Mission strategy",time:"2024-2030",stake:"National AI sovereignty",success:"Self-reliant AI ecosystem",options:"Sovereign compute vs cloud dependency"}},{title:"Digital India",summary:"Digital India is a flagship programme of the Government of India that aims to transform India into a digitally empowered society and knowledge economy. It focuses on digital infrastructure as a utility, governance and services on demand, and digital empowerment of citizens. Key pillars include broadband connectivity, mobile connectivity, public internet access, and e-governance.",url:"https://en.wikipedia.org/wiki/Digital_India",thumbnail:null,categories:["Digital","India","Government"],links:[],source:"wiki",sourceName:"WIKIPEDIA",confidence:"High",decisionMeta:{decision:"Evaluate IndiaAI Mission strategy",time:"2024-2030",stake:"National AI sovereignty",success:"Self-reliant AI ecosystem",options:"Sovereign compute vs cloud dependency"}}]
    }
  },
  { id:"ex_stoicism", name:"Stoicism â†’ Decision Discipline",
    engineState:{
      notes:"Use this as a template: connect each node to the same decision context.",
      synthesis:{thesis:"Stoicism is a practical operating system for reducing noise, focusing on controllables, and improving decision quality under uncertainty.",topTakeaways:["Separate controllables vs uncontrollables to reduce wasted effort.","Use negative visualization to stress-test downside scenarios.","Virtue framing improves consistency: act by principle, not mood.","Daily review loops create compounding behavioral change."],contradictions:"Risk: can be misused as emotional suppression vs regulation.",implications:"For founders: define controllables, build pre-mortems, make principles explicit.",next:"Read: Epictetus Enchiridion â€¢ Marcus Aurelius Meditations",recommendation:"If your environment is high-volatility, stoic routines tend to increase consistency."},
      research_nodes:[{title:"Stoicism",summary:"Stoicism is a school of Hellenistic philosophy that teaches the development of self-control and fortitude as a means to overcome destructive emotions. It emphasizes virtue, reason, and living in accordance with nature. Stoics distinguish between what is within our control and what is not.",url:"https://en.wikipedia.org/wiki/Stoicism",thumbnail:null,categories:["Philosophy","Ethics"],links:[],source:"wiki",sourceName:"WIKIPEDIA",confidence:"High",decisionMeta:{decision:"Build discipline system for better decisions",time:"90 days",stake:"Execution consistency",success:"Higher follow-through rate",options:"Stoic routines vs ad-hoc motivation"}}]
    }
  }
];

function openExample(id) {
  const ex=EXAMPLES.find(x=>x.id===id); if(!ex){showToast("NOT FOUND");return;}
  const p={id:uid(),name:ex.name,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),engineState:ex.engineState};
  saveProjectToStorage(p); loadProjectIntoApp(p); showToast("EXAMPLE LOADED");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAGES / ROUTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderHome() {
  setActiveNav("home");
  const hasLast = !!(localStorage.getItem(LAST_PROJECT_KEY) && loadProjectFromStorage(localStorage.getItem(LAST_PROJECT_KEY)));
  const exHtml = EXAMPLES.map(ex=>`<button class="domain-btn" onclick="openExample('${escapeHTML(ex.id)}')">${escapeHTML(ex.name)}</button>`).join("");

  renderPage(`
    <div class="founder-letter">
      <div class="founder-eyebrow"><span class="pulse-dot"></span>India's Decision Research Engine</div>
      <h2 style="font-size:clamp(1.3rem,3vw,1.8rem);margin-bottom:8px">Built for the billion who decide.</h2>
      <p>Policy-grade decision intelligence â€” aligned with the <strong>IndiaAI Mission</strong>. Research any topic, build decision nodes, and export policy-grade briefs.</p>
    </div>

    <div class="pill-row">
      <span class="pill pill-s">ğŸ‡®ğŸ‡³ IndiaAI Aligned</span>
      <span class="pill pill-g">ğŸŒ¿ Open Research</span>
      <span class="pill pill-b">ğŸ“‹ Policy Briefs</span>
      <span class="pill pill-w">ğŸ§  Decision AI</span>
    </div>

    <div class="stats-grid">
      <div class="stat-card"><div class="num">1.4B</div><div class="lbl">Indians Deciding Daily</div></div>
      <div class="stat-card"><div class="num">7</div><div class="lbl">IndiaAI Pillars</div></div>
      <div class="stat-card"><div class="num">10K+</div><div class="lbl">GPU Target</div></div>
      <div class="stat-card"><div class="num">âˆ</div><div class="lbl">Decisions to Support</div></div>
    </div>

    <div class="card">
      <div class="card-title">Quick Start</div>
      <p style="font-size:.88rem;color:var(--text-dim);line-height:1.7;">
        <strong style="color:var(--text-main)">Search</strong> any topic â†’ select result â†’ build research nodes.<br>
        <strong style="color:var(--text-main)">Synthesis</strong> â†’ capture thesis, takeaways, next steps.<br>
        <strong style="color:var(--text-main)">Export</strong> as Research PDF or Decision Brief.<br>
        <strong style="color:var(--text-main)">Share</strong> via link (project embedded in URL).
      </p>
    </div>

    <div class="card">
      <div class="card-title">Load Example</div>
      ${exHtml}
    </div>

    <div class="btn-grid">
      <button class="btn btn-india btn-full" onclick="navigateTo('founder')">FOUNDER LETTER â†’</button>
      <button class="btn btn-policy btn-full" onclick="navigateTo('policy')">INDIAAI POLICY BRIEF â†’</button>
      <button class="btn btn-pro btn-full" onclick="navigateTo('research')">OPEN RESEARCH TOOL</button>
      <button class="btn btn-full ${hasLast?'':'btn-muted'}" onclick="continueLastProject()">CONTINUE LAST PROJECT</button>
      <button class="btn" onclick="importShareLinkPrompt()">IMPORT SHARE LINK</button>
      <button class="btn btn-muted" onclick="openProjectPicker()">LOAD SAVED PROJECT</button>
    </div>
    <div class="nav-hint"><span>â˜° Sidebar navigation</span><span>âœ Notes panel</span></div>
  `, "decide.engine", "INDIAAI", "india");
}

function renderSearch() {
  setActiveNav("research");
  const srcHtml = Object.entries(WIKI_ENGINE.sources).map(([k,s])=>`<div class="source-chip ${WIKI_ENGINE.activeSource===k?'active':''}" onclick="selectSource('${k}')">${s.icon} ${s.name}</div>`).join("");

  renderPage(`
    <h1>Research Tool</h1>
    <p class="primary-question">Search any topic to begin your decision-linked research journey.</p>
    <input id="search-input" class="form-input" type="text" placeholder="e.g. IndiaAI, Stoicism, Food Security, Proteinâ€¦" style="font-size:1rem;padding:14px 16px;" />
    <div class="source-row" id="source-row">${srcHtml}</div>
    <div class="btn-grid">
      <button class="btn btn-india btn-full" onclick="handleSearch()">SEARCH â†’</button>
      <button class="btn btn-muted btn-full" onclick="navigateTo('home')">â† HOME</button>
    </div>
  `, "Decision Research", "SEARCH", "");
  // Allow Enter to search
  setTimeout(() => {
    const inp = document.getElementById("search-input");
    if(inp) { inp.focus(); inp.addEventListener("keydown",e=>{ if(e.key==="Enter") handleSearch(); }); }
  }, 100);
}

function selectSource(key) {
  WIKI_ENGINE.activeSource = key;
  document.querySelectorAll(".source-chip").forEach(el=>el.classList.remove("active"));
  event?.target?.classList?.add("active");
  showToast(WIKI_ENGINE.sources[key].name + " SELECTED");
}

async function handleSearch() {
  const inp = document.getElementById("search-input");
  const q = inp?.value?.trim();
  if(!q) { showToast("TYPE SOMETHING"); return; }
  showToast("SEARCHING...");
  const results = await WIKI_ENGINE.search(q, WIKI_ENGINE.activeSource);
  if(!results||!results.length) { showToast("NO RESULTS"); return; }
  renderResults(q, results);
}

function renderResults(query, results) {
  const src = WIKI_ENGINE.sources[WIKI_ENGINE.activeSource];
  const btnHtml = results.map((r,i)=>`<button class="domain-btn" onclick="openResult('${escapeHTML(r.title)}')">${i+1}. ${escapeHTML(r.title)}</button>`).join("");

  renderPage(`
    <h1>${escapeHTML(query)}</h1>
    <p class="primary-question">Select a node to begin your research journey. Source: <strong style="color:var(--accent-go)">${escapeHTML(src.name)}</strong></p>
    <div>${btnHtml}</div>
    <div class="btn-grid" style="margin-top:14px">
      <button class="btn btn-muted btn-full" onclick="renderSearch()">â† BACK TO SEARCH</button>
    </div>
  `, escapeHTML(query), src.name, "");
}

async function openResult(title) {
  showToast("LOADING...");
  const ctx = await WIKI_ENGINE.getContext(title, WIKI_ENGINE.activeSource);
  if(!ctx) { showToast("FAILED TO LOAD"); return; }
  currentDecisionContext = { title:ctx.title, summary:ctx.summary, url:ctx.url, thumbnail:ctx.thumbnail, categories:ctx.categories||[], links:ctx.links||[], source:ctx.source, sourceName:ctx.sourceName, confidence:ctx.confidence, decisionMeta:{} };
  renderDecisionMeta(currentDecisionContext);
}

function renderDecisionMeta(ctx) {
  renderPage(`
    <h1 style="font-size:1.4rem">Link this node</h1>
    <p class="primary-question">Capture the decision context this research supports. (Optional â€” skip if not needed.)</p>
    <div class="card">
      <div class="card-title">Decision Context</div>
      <input class="form-input" id="meta-decision" placeholder="Decision (e.g. cut sugar, choose phone, AI policy)">
      <input class="form-input" id="meta-time" placeholder="Time horizon (e.g. 90 days, 5 years)">
      <input class="form-input" id="meta-stake" placeholder="Stake (e.g. health, budget, national policy)">
      <input class="form-input" id="meta-success" placeholder="Success metric">
      <input class="form-input" id="meta-options" style="margin-bottom:0" placeholder="Options (e.g. A vs B vs C)">
    </div>
    <div class="btn-grid">
      <button class="btn btn-pro btn-full" onclick="saveDecisionMeta()">SAVE META & RESEARCH</button>
      <button class="btn btn-muted btn-full" onclick="skipDecisionMeta()">SKIP META</button>
    </div>
  `, "Decision Meta", "LINK", "");
}

function saveDecisionMeta() {
  if(!currentDecisionContext) return;
  currentDecisionContext.decisionMeta = {
    decision:document.getElementById("meta-decision")?.value?.trim()||"",
    time:document.getElementById("meta-time")?.value?.trim()||"",
    stake:document.getElementById("meta-stake")?.value?.trim()||"",
    success:document.getElementById("meta-success")?.value?.trim()||"",
    options:document.getElementById("meta-options")?.value?.trim()||"",
  };
  ENGINE_STATE.research_nodes=[currentDecisionContext]; ENGINE_STATE.synthesis=null; currentDecisionContext=null;
  buildAndRenderDeck(ENGINE_STATE.research_nodes[0]); autosaveIfPossible();
}
function skipDecisionMeta() {
  if(!currentDecisionContext) return;
  currentDecisionContext.decisionMeta={decision:"",time:"",stake:"",success:"",options:""};
  ENGINE_STATE.research_nodes=[currentDecisionContext]; ENGINE_STATE.synthesis=null; currentDecisionContext=null;
  buildAndRenderDeck(ENGINE_STATE.research_nodes[0]); autosaveIfPossible();
}

// â”€â”€â”€ Build research deck
let _currentNodeIdx = 0;
let _allNodes = [];

async function buildAndRenderDeck(seedNode) {
  _allNodes = [seedNode]; _currentNodeIdx = 0;
  ENGINE_STATE.research_nodes = _allNodes;
  showNodePage(seedNode, 0, _allNodes);

  // Push URL hash
  history.pushState({route:"node",title:seedNode.title}, "", "#node="+encodeURIComponent(seedNode.title));

  // Load linked nodes in background
  if(seedNode.links?.length) {
    const names = seedNode.links.slice(0,5).map(l=>l.name).filter(Boolean);
    for(const name of names) {
      const ctx = await WIKI_ENGINE.getContext(name, WIKI_ENGINE.activeSource);
      if(!ctx) continue;
      const node = {title:ctx.title,summary:ctx.summary,url:ctx.url,thumbnail:ctx.thumbnail,categories:ctx.categories||[],links:ctx.links||[],source:ctx.source,sourceName:ctx.sourceName,confidence:ctx.confidence,decisionMeta:seedNode.decisionMeta||{}};
      _allNodes.push(node); ENGINE_STATE.research_nodes=[..._allNodes]; autosaveIfPossible();
      // Update nav badge
      updateSidebarStats();
    }
  }
}

function renderResearchDeck(nodes, synthesis) {
  _allNodes=[...nodes]; _currentNodeIdx=0; ENGINE_STATE.research_nodes=_allNodes; ENGINE_STATE.synthesis=synthesis||null;
  if(_allNodes.length>0) showNodePage(_allNodes[0],0,_allNodes);
  updateSidebarStats();
}

function showNodePage(node, idx, all) {
  _currentNodeIdx=idx; setActiveNav("research");
  const words=wordCount(node.summary||""); const rt=readingTime(words);
  const takeaways=extractTakeaways(node.summary||"",4);
  const cats=(node.categories||[]).slice(0,4);
  const total=all.length; updateDepth(idx,total);

  const nodeNavHtml = total>1 ? `
    <div class="btn-grid" style="margin-top:0">
      <button class="btn btn-muted ${idx===0?'':'btn-active'}" onclick="goToNode(${idx-1})" ${idx===0?'disabled style="opacity:.4"':''}>â† PREV NODE</button>
      <button class="btn btn-muted ${idx===total-1?'':'btn-active'}" onclick="goToNode(${idx+1})" ${idx===total-1?'disabled style="opacity:.4"':''}>NEXT NODE â†’</button>
    </div>
    <div style="text-align:center;font-family:var(--font-mono);font-size:.6rem;color:var(--text-dim);padding:6px 0">
      NODE ${idx+1} / ${total}
    </div>
  ` : "";

  const nodeListHtml = total>1 ? `
    <div class="card" style="margin-top:0">
      <div class="card-title">All Nodes (${total})</div>
      ${all.map((n,i)=>`<div onclick="goToNode(${i})" style="padding:8px 10px;border-radius:8px;cursor:pointer;font-size:.82rem;background:${i===idx?'rgba(255,153,51,.1)':'transparent'};color:${i===idx?'var(--saffron)':'var(--text-dim)'};margin-bottom:2px;transition:background .15s">${i+1}. ${escapeHTML(n.title)}</div>`).join("")}
    </div>
  ` : "";

  renderPage(`
    <div class="card glow">
      <div class="context-top">
        <div class="thumb">${node.thumbnail?`<img src="${escapeHTML(node.thumbnail)}" alt="" loading="lazy">`:'ğŸ”'}</div>
        <div class="context-meta" style="flex:1;min-width:0">
          <div class="kicker">Research node Â· <span style="color:var(--accent-go)">${escapeHTML(node.confidence||"High")}</span></div>
          <h1 style="font-size:clamp(1.1rem,3vw,1.7rem);margin-bottom:6px">${escapeHTML(node.title||"")}</h1>
          <div class="chip-row">
            <span class="chip">${words} words</span>
            <span class="chip green">${rt} min</span>
            <span class="chip orange">${escapeHTML(node.sourceName||"LOCAL")}</span>
          </div>
        </div>
      </div>
      <div class="chip-row">${cats.map(c=>`<span class="chip">${escapeHTML(c)}</span>`).join("")}</div>
    </div>

    ${node.decisionMeta?.decision?`<div class="policy-banner"><span style="font-size:1.2rem">ğŸ¯</span><div><strong>Decision:</strong> ${escapeHTML(node.decisionMeta.decision)} Â· <strong>Stake:</strong> ${escapeHTML(node.decisionMeta.stake||"â€”")} Â· <strong>Time:</strong> ${escapeHTML(node.decisionMeta.time||"â€”")}</div></div>`:""}

    <div class="card-title" style="margin:4px 0 8px">Key Takeaways</div>
    <div class="takeaways"><ul>${takeaways.map(t=>`<li>${escapeHTML(t)}</li>`).join("")}</ul></div>

    <div class="card-title" style="margin:4px 0 8px">Summary</div>
    <div class="scroll-box">${formatSummaryHTML(node.summary||"")}</div>

    ${nodeNavHtml}
    ${nodeListHtml}

    <div class="btn-grid" style="margin-top:12px">
      <button class="btn btn-yt" onclick="openYT('${escapeHTML(node.title||"")}')">â–¶ YouTube</button>
      <button class="btn btn-policy" onclick="openWiki('${escapeHTML(node.title||"")}')">Open Wiki</button>
      <button class="btn btn-pdf" onclick="generateResearchPDF()">Research PDF</button>
      <button class="btn btn-pro" onclick="generateDecisionPDF()">Decision PDF</button>
      <button class="btn btn-india btn-full" onclick="navigateTo('synthesis')">SYNTHESIS â†’</button>
      <button class="btn btn-full" onclick="launchQuiz()">QUIZ (ALCHEMIST)</button>
      <button class="btn btn-full" onclick="saveCurrentProjectPrompt()">SAVE PROJECT</button>
      <button class="btn btn-full" onclick="shareCurrentProject()">SHARE LINK</button>
      <button class="btn btn-muted btn-full" onclick="renderSearch()">NEW SEARCH</button>
    </div>
    <div class="nav-hint"><span>Nodes: ${total}</span><span>â˜° Sidebar</span></div>
  `, escapeHTML(node.title||"Node"), escapeHTML(node.sourceName||"LOCAL"), "");
}

function goToNode(idx) {
  if(idx<0||idx>=_allNodes.length) return;
  showNodePage(_allNodes[idx],idx,_allNodes);
  if(_allNodes[idx]?.title) history.replaceState({route:"node",title:_allNodes[idx].title},"","#node="+encodeURIComponent(_allNodes[idx].title));
}

function openYT(topic) { window.open(`https://www.youtube.com/results?search_query=${encodeURIComponent(topic+" explained")}`,"_blank"); }
function openWiki(title) { window.open(`https://en.wikipedia.org/wiki/Special:Search?search=${encodeURIComponent(title)}`,"_blank"); }

// â”€â”€â”€ Synthesis
function renderSynthesis() {
  if(!ENGINE_STATE.research_nodes?.length){showToast("NO NODES YET");return;}
  setActiveNav("synthesis");
  const all=[]; ENGINE_STATE.research_nodes.forEach(n=>all.push(...extractTakeaways(n.summary||"",4)));
  const top=all.slice(0,5); const syn=ENGINE_STATE.synthesis||{};

  renderPage(`
    <h1>Synthesis</h1>
    <p class="primary-question">Capture your thesis, takeaways, and decision implications.</p>
    <div class="card">
      <div class="card-title">Working Thesis</div>
      <textarea class="form-textarea" id="syn-thesis" rows="4">${escapeHTML(syn.thesis||"")}</textarea>
    </div>
    <div class="card">
      <div class="card-title">Top Takeaways (one per line)</div>
      <textarea class="form-textarea" id="syn-top" rows="6">${escapeHTML((syn.topTakeaways||top).join("\n"))}</textarea>
    </div>
    <div class="card">
      <div class="card-title">Contradictions / Open Questions</div>
      <textarea class="form-textarea" id="syn-contradictions" rows="3">${escapeHTML(syn.contradictions||"")}</textarea>
    </div>
    <div class="card">
      <div class="card-title">Decision Implications</div>
      <textarea class="form-textarea" id="syn-implications" rows="3">${escapeHTML(syn.implications||"")}</textarea>
    </div>
    <div class="card">
      <div class="card-title">Next Research Nodes</div>
      <textarea class="form-textarea" id="syn-next" rows="3">${escapeHTML(syn.next||"")}</textarea>
    </div>
    <div class="card">
      <div class="card-title">Recommendation Signals</div>
      <textarea class="form-textarea" id="syn-rec" rows="3">${escapeHTML(syn.recommendation||"")}</textarea>
    </div>
    <div class="btn-grid">
      <button class="btn btn-pro btn-full" onclick="saveSynthesis()">SAVE SYNTHESIS</button>
      <button class="btn btn-pdf" onclick="generateResearchPDF()">Research PDF</button>
      <button class="btn btn-pro" onclick="generateDecisionPDF()">Decision PDF</button>
      <button class="btn btn-muted btn-full" onclick="navigateTo('research')">â† BACK</button>
    </div>
  `, "Synthesis", "EDIT", "");
}
function saveSynthesis() {
  ENGINE_STATE.synthesis={thesis:document.getElementById("syn-thesis")?.value?.trim()||"",topTakeaways:(document.getElementById("syn-top")?.value||"").split("\n").map(s=>s.trim()).filter(Boolean),contradictions:document.getElementById("syn-contradictions")?.value?.trim()||"",implications:document.getElementById("syn-implications")?.value?.trim()||"",next:document.getElementById("syn-next")?.value?.trim()||"",recommendation:document.getElementById("syn-rec")?.value?.trim()||""};
  showToast("SYNTHESIS SAVED"); autosaveIfPossible();
}

// â”€â”€â”€ Founder Letter
function renderFounder() {
  setActiveNav("founder");
  renderPage(`
    <div class="founder-letter">
      <div class="founder-eyebrow"><span class="pulse-dot"></span>To India â€” From the Builder</div>
      <h2 style="font-size:clamp(1.2rem,3vw,1.7rem);margin-bottom:10px">We built this for the billion who decide.</h2>
      <p>Every day, over a billion Indians make decisions that shape their lives â€” choosing a school, a medication, a business, a policy. Most of them make these decisions <strong>without access to structured information, expert analysis, or decision scaffolding</strong>.</p>
      <p>That gap is not a data problem. It is an <strong>intelligence infrastructure problem</strong>.</p>
      <p>decide.engine began as a personal tool. A way to think clearly in a noisy world. To build a decision, research it, synthesize it, and act. But when we looked at what India's AI mission was building toward â€” compute, datasets, skilling, responsible AI â€” we saw something bigger.</p>
      <p>We saw the infrastructure for a new kind of decision-making at scale. <strong>Policy-grade intelligence, accessible to every citizen.</strong></p>
      <p>This is not about replacing human judgment. It is about amplifying it. About giving a farmer in Vidarbha the same structured research process that a policy advisor in South Block uses. About making AI not a product for the elite â€” but a <strong>decision partner for every Indian</strong>.</p>
      <p>IndiaAI's mission is sovereign. Inclusive. Responsible. Ours aligns completely.</p>
      <p>We are building decide.engine as an open, policy-grade decision research layer â€” aligned with IndiaAI's seven pillars, designed for India's languages, and committed to <strong>AI that decides with India, not for India</strong>.</p>
      <p>The decision is yours. The infrastructure is ours to build together.</p>
      <div style="margin-top:14px;padding-top:14px;border-top:1px solid rgba(255,255,255,.06);font-family:var(--font-display);font-size:.82rem;color:var(--text-dim)"><strong style="color:var(--saffron)">â€” The decide.engine team</strong><br><span style="font-size:.76rem">Building for Bharat Â· Aligned with IndiaAI Mission</span></div>
    </div>

    <div class="pill-row">
      <span class="pill pill-s">ğŸ‡®ğŸ‡³ Sovereign AI</span>
      <span class="pill pill-g">â™¿ Inclusive Access</span>
      <span class="pill pill-b">ğŸ”’ Responsible AI</span>
      <span class="pill pill-w">ğŸŒ Multilingual</span>
      <span class="pill pill-s">ğŸ“Š Policy-grade</span>
      <span class="pill pill-g">ğŸŒ¾ Bharat-first</span>
    </div>

    <div class="stats-grid">
      <div class="stat-card"><div class="num">1.4B</div><div class="lbl">Indians Deciding Daily</div></div>
      <div class="stat-card"><div class="num">7</div><div class="lbl">IndiaAI Pillars</div></div>
      <div class="stat-card"><div class="num">10K+</div><div class="lbl">GPU Target</div></div>
      <div class="stat-card"><div class="num">âˆ</div><div class="lbl">Decisions to Support</div></div>
    </div>

    <div class="btn-grid">
      <button class="btn btn-india btn-full" onclick="navigateTo('policy')">VIEW INDIAAI POLICY BRIEF â†’</button>
      <button class="btn btn-pro btn-full" onclick="navigateTo('research')">START RESEARCHING</button>
      <button class="btn btn-muted btn-full" onclick="navigateTo('home')">â† HOME</button>
    </div>
  `, "Founder Letter", "INDIA AI", "india");
  history.pushState({route:"founder"},"","#founder");
}

// â”€â”€â”€ Policy Brief
function renderPolicy() {
  setActiveNav("policy");
  renderPage(`
    <h1>IndiaAI Alignment</h1>
    <p class="primary-question">How decide.engine maps to India's National AI Mission pillars.</p>

    <div class="policy-banner"><span style="font-size:1.3rem">ğŸ›ï¸</span><div><strong>IndiaAI Mission (2024-2030)</strong> â€” India's national strategy to build sovereign AI infrastructure spanning compute, data, skilling, research, and responsible governance.</div></div>

    <div class="card blue-glow">
      <div class="card-title">Pillar 1 â€” IndiaAI Compute Platform</div>
      <p style="font-size:.87rem;color:var(--text-dim);line-height:1.65"><strong style="color:var(--text-main)">Mission:</strong> 10,000+ GPU sovereign compute infrastructure.<br><strong style="color:var(--accent-go)">decide.engine:</strong> Lightweight, browser-native â€” zero GPU dependency for end users.</p>
    </div>
    <div class="card green-glow">
      <div class="card-title">Pillar 2 â€” IndiaAI Datasets Platform</div>
      <p style="font-size:.87rem;color:var(--text-dim);line-height:1.65"><strong style="color:var(--text-main)">Mission:</strong> High-quality, multilingual Indian language datasets.<br><strong style="color:var(--accent-go)">decide.engine:</strong> Designed for multilingual expansion â€” Hindi, Tamil, Bengali, Marathi.</p>
    </div>
    <div class="card glow">
      <div class="card-title">Pillar 3 â€” FutureSkills / AI Skilling</div>
      <p style="font-size:.87rem;color:var(--text-dim);line-height:1.65"><strong style="color:var(--text-main)">Mission:</strong> Train 1 million AI-skilled workers by 2030.<br><strong style="color:var(--accent-go)">decide.engine:</strong> Quiz engine (Alchemist) creates skill-assessment loops from research nodes.</p>
    </div>
    <div class="card blue-glow">
      <div class="card-title">Pillar 4 â€” Responsible AI</div>
      <p style="font-size:.87rem;color:var(--text-dim);line-height:1.65"><strong style="color:var(--text-main)">Mission:</strong> Safety, ethics, fairness, accountability.<br><strong style="color:var(--accent-go)">decide.engine:</strong> All research is source-attributed and confidence-rated. No black-box outputs.</p>
    </div>
    <div class="card green-glow">
      <div class="card-title">Pillar 5 â€” AI for Sector Adoption</div>
      <p style="font-size:.87rem;color:var(--text-dim);line-height:1.65"><strong style="color:var(--text-main)">Mission:</strong> AI in agriculture, health, education, governance.<br><strong style="color:var(--accent-go)">decide.engine:</strong> Decision nodes pre-configured for sector-specific decisions.</p>
    </div>
    <div class="card glow">
      <div class="card-title">Pillar 6 â€” IndiaAI Startup Financing</div>
      <p style="font-size:.87rem;color:var(--text-dim);line-height:1.65"><strong style="color:var(--text-main)">Mission:</strong> â‚¹2000 Cr+ fund for deep-tech AI startups.<br><strong style="color:var(--accent-go)">decide.engine:</strong> Open-source core, startup-ready API layer. PDF exports as pitch artifacts.</p>
    </div>

    <div class="btn-grid">
      <button class="btn btn-india btn-full" onclick="openExample('ex_indiaai')">LOAD INDIAAI EXAMPLE â†’</button>
      <button class="btn btn-pro btn-full" onclick="navigateTo('research')">START RESEARCH</button>
      <button class="btn btn-full" onclick="navigateTo('founder')">â† FOUNDER LETTER</button>
      <button class="btn btn-muted btn-full" onclick="navigateTo('home')">HOME</button>
    </div>
  `, "IndiaAI Policy", "POLICY", "");
  history.pushState({route:"policy"},"","#policy");
}

// â”€â”€â”€ Quiz
const ALCHEMIST_KEY = "ALCHEMIST_INJECTED_DATA";
function launchQuiz() {
  const nodes=ENGINE_STATE.research_nodes||[];
  if(!nodes.length){showToast("NO NODES FOR QUIZ");return;}
  try{
    const payload=buildQuizPayload(nodes,{maxQ:12});
    localStorage.setItem(ALCHEMIST_KEY,JSON.stringify(payload));
    showToast("QUIZ READY"); window.open("alchemist.html","_blank");
  }catch(e){console.error(e);showToast("QUIZ FAILED");}
}
function buildQuizPayload(nodes,{maxQ=12}={}) {
  const list=nodes.slice(0,maxQ); const out=[]; const now=Date.now();
  const titles=list.map(n=>normalizeText(n?.title||"")).filter(Boolean);
  list.forEach((n,i)=>{
    const title=normalizeText(n?.title||`Node ${i+1}`);
    const sents=splitSentences(n?.summary||"");
    const qText=sents[0]||(n?.summary?normalizeText(n.summary).slice(0,140):"");
    const prompt=qText?`Which node matches: "${qText}"`:"Which node is this?";
    const pool=titles.filter(t=>t&&t!==title); for(let j=pool.length-1;j>0;j--){const k=Math.floor(Math.random()*(j+1));[pool[j],pool[k]]=[pool[k],pool[j]];}
    out.push({Question_ID:`R_${now}_${String(i+1).padStart(3,"0")}`,Set_Code:"RESEARCH",Domain:"Decision Research",Subdomain:normalizeText(n?.sourceName||"wiki").toUpperCase(),Difficulty:String(Math.min(5,Math.max(1,Math.round(wordCount(n?.summary||"")/120||2)))),Question_Text:prompt,Correct_Answer:title,Distractor_1:pool[0]||"â€”",Distractor_2:pool[1]||"â€”",Correct_Direction:["UP","RIGHT","LEFT","DOWN"][i%4],Explanation_Short:"Pick the node title that matches the summary snippet.",Explanation_Long:n?.url?`Source: ${n.url}`:"Source: (none)"});
  });
  return out;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PDF EXPORTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function generateResearchPDF() {
  if(!ENGINE_STATE.research_nodes?.length){showToast("NO RESEARCH TO EXPORT");return;}
  showToast("GENERATING PDF...");
  try{
    const {jsPDF}=window.jspdf; const doc=new jsPDF();
    const pw=doc.internal.pageSize.getWidth(),ph=doc.internal.pageSize.getHeight(),mg=18,cw=pw-(2*mg);
    const addFtr=(n,t)=>{doc.setFontSize(7);doc.setTextColor(120,120,120);doc.text(`decide.engine | IndiaAI | Page ${n} of ${t}`,pw/2,ph-8,{align:"center"});doc.setFontSize(6);doc.text(new Date().toLocaleString("en-IN",{dateStyle:"medium",timeStyle:"short",timeZone:"Asia/Kolkata"}),mg,ph-8);};
    const total=ENGINE_STATE.research_nodes.length+1;
    let pg=1;
    doc.setFillColor(255,153,51);doc.rect(0,0,pw/3,5,"F");doc.setFillColor(255,255,255);doc.rect(pw/3,0,pw/3,5,"F");doc.setFillColor(19,136,8);doc.rect((pw/3)*2,0,pw/3,5,"F");
    doc.setFontSize(28);doc.setTextColor(255,153,51);doc.setFont(undefined,"bold");doc.text("RESEARCH JOURNEY",pw/2,55,{align:"center"});
    doc.setFontSize(11);doc.setTextColor(0,180,120);doc.text("decide.engine | India AI Decision Research",pw/2,67,{align:"center"});
    doc.setDrawColor(40,60,90);doc.setLineWidth(0.5);doc.rect(mg,82,cw,36);
    doc.setFontSize(9.5);doc.setTextColor(60,60,60);doc.setFont(undefined,"normal");
    doc.text(`Nodes: ${ENGINE_STATE.research_nodes.length}`,pw/2,94,{align:"center"});doc.text(`Source: ${ENGINE_STATE.research_nodes[0]?.sourceName||"Local"}`,pw/2,102,{align:"center"});doc.text(`Date: ${new Date().toLocaleDateString("en-IN",{timeZone:"Asia/Kolkata"})}`,pw/2,110,{align:"center"});addFtr(pg,total);
    ENGINE_STATE.research_nodes.forEach((node,index)=>{
      doc.addPage();pg++;
      const title=sanitizePDF(node.title||"");const sum=sanitizePDF(node.summary||"");const tks=extractTakeaways(sum,4).map(sanitizePDF);
      doc.setFillColor(255,153,51);doc.rect(0,0,pw/3,4,"F");doc.setFillColor(255,255,255);doc.rect(pw/3,0,pw/3,4,"F");doc.setFillColor(19,136,8);doc.rect((pw/3)*2,0,pw/3,4,"F");
      let y=22;
      doc.setFillColor(0,180,120);doc.circle(mg+7,y+3,7,"F");doc.setFontSize(10);doc.setTextColor(255,255,255);doc.setFont(undefined,"bold");doc.text(String(index+1),mg+7,y+5,{align:"center"});
      doc.setFontSize(16);doc.setTextColor(255,153,51);const tl=doc.splitTextToSize(title,cw-18);doc.text(tl,mg+18,y);y+=tl.length*7+6;
      doc.setFont(undefined,"normal");doc.setFontSize(8);doc.setTextColor(120,120,120);doc.text(`Source: ${node.sourceName||"Local"}`,mg,y);y+=5;
      if(node.categories?.length){const cl=doc.splitTextToSize(sanitizePDF(node.categories.slice(0,4).join(" â€¢ ")),cw);doc.text(cl,mg,y);y+=cl.length*4.5+4;}
      doc.setDrawColor(220,220,220);doc.setLineWidth(0.4);doc.line(mg,y,pw-mg,y);y+=8;
      doc.setFontSize(10);doc.setTextColor(40,40,40);doc.setFont(undefined,"bold");doc.text("Key Takeaways",mg,y);y+=6;doc.setFont(undefined,"normal");doc.setFontSize(9.5);
      tks.forEach(t=>{const ls=doc.splitTextToSize("â€¢ "+t,cw);ls.forEach(l=>{if(y<ph-34){doc.text(l,mg,y);y+=5.6;}});y+=1.5;});
      y+=3;doc.setDrawColor(235,235,235);doc.setLineWidth(0.3);doc.line(mg,y,pw-mg,y);y+=8;
      doc.setFontSize(10);doc.setFont(undefined,"bold");doc.text("Summary",mg,y);y+=6;doc.setFont(undefined,"normal");
      let st=sum;if(st.length>2400){st=st.slice(0,2400);const lp=st.lastIndexOf(".");if(lp>2150)st=st.slice(0,lp+1);}
      const sents=splitSentences(st);const paras=[];if(sents.length){paras.push(sents.slice(0,1).join(" "));for(let i=1;i<sents.length;i+=3)paras.push(sents.slice(i,i+3).join(" "));}else paras.push(st);
      paras.forEach(p=>{const ls=doc.splitTextToSize(p,cw);ls.forEach(l=>{if(y<ph-34){doc.text(l,mg,y);y+=5.6;}});y+=3;});addFtr(pg,total);
    });
    doc.save(`research-journey-india-${new Date().toISOString().slice(0,10)}.pdf`);showToast("PDF DOWNLOADED!");
  }catch(e){console.error("PDF error:",e);showToast("PDF FAILED");}
}

function buildDecisionModel() {
  const nodes=ENGINE_STATE.research_nodes||[],first=nodes[0],syn=ENGINE_STATE.synthesis||{};
  const agg=[];nodes.forEach(n=>agg.push(...extractTakeaways(n.summary||"",4)));
  const s={...syn};const ctx={decision:first?.decisionMeta?.decision||"",time:first?.decisionMeta?.time||"",stake:first?.decisionMeta?.stake||"",success:first?.decisionMeta?.success||"",options:first?.decisionMeta?.options||""};
  if(!s.topTakeaways?.length)s.topTakeaways=agg.slice(0,5);
  if(!s.thesis?.trim())s.thesis=`Decision: ${ctx.decision||"N/A"} | Time: ${ctx.time||"N/A"} | Stake: ${ctx.stake||"N/A"}`;
  if(!s.implications?.trim())s.implications=`Decision: ${ctx.decision||"N/A"} | Metric: ${ctx.success||"N/A"}`;
  if(!s.contradictions?.trim())s.contradictions="None specified";
  if(!s.next?.trim())s.next="N/A";
  if(!s.recommendation?.trim())s.recommendation="No recommendations provided";
  return{meta:{title:(first?.title?first.title.toUpperCase():"DECISION BRIEF"),subtitle:s.thesis||"Decision research synthesis",preparedFor:"decide.engine | India AI Decision Research",date:new Date().toLocaleDateString("en-IN",{timeZone:"Asia/Kolkata"}),wm:"decide.engine Ã— IndiaAI Mission â€¢ Confidential"},ctx,nodes:nodes.map((n,i)=>({idx:i+1,title:n.title||"",sourceName:n.sourceName||"LOCAL",confidence:n.confidence||"High",url:n.url||"",categories:(n.categories||[]).slice(0,6),takeaways:extractTakeaways(n.summary||"",4),summary:n.summary||"",decisionMeta:n.decisionMeta||{}})),synthesis:s};
}
function renderDecisionDocHTML(m) {
  const e=escapeHTML,wm=e(m.meta?.wm||""),ctx=m.ctx||{};
  const cover=`<div class="proui-page"><div class="proui-tricolor"></div><div class="proui-pillrow"><div class="proui-pill saffron">ğŸ‡®ğŸ‡³ IndiaAI</div><div class="proui-pill">${e(m.meta.preparedFor||"")}</div><div class="proui-pill">${e(m.meta.date||"")}</div></div><h1 class="proui-title">${e(m.meta.title||"")}</h1><p class="proui-subtitle">${e(m.meta.subtitle||"")}</p><div class="proui-grid2" style="margin-top:16px"><div class="proui-card"><div class="proui-h">Decision Context</div><div class="proui-kv"><div class="proui-k">Decision</div><div class="proui-v">${e(ctx.decision||"N/A")}</div><div class="proui-k">Time</div><div class="proui-v">${e(ctx.time||"N/A")}</div><div class="proui-k">Stake</div><div class="proui-v">${e(ctx.stake||"N/A")}</div><div class="proui-k">Success</div><div class="proui-v">${e(ctx.success||"N/A")}</div><div class="proui-k">Options</div><div class="proui-v">${e(ctx.options||"N/A")}</div></div></div><div class="proui-card"><div class="proui-h">Snapshot</div><div class="proui-kv"><div class="proui-k">Nodes</div><div class="proui-v">${m.nodes.length}</div><div class="proui-k">Source</div><div class="proui-v">${e(m.nodes[0]?.sourceName||"")}</div><div class="proui-k">Confidence</div><div class="proui-v">${e(m.nodes[0]?.confidence||"")}</div></div></div></div><div style="height:14px"></div><div class="proui-card"><div class="proui-h">Index</div><ul class="proui-list">${m.nodes.map(n=>`<li>#${n.idx} â€” ${e(n.title)}</li>`).join("")}</ul></div><div class="proui-wm">${wm}</div></div>`;
  const nodePages=m.nodes.map(n=>{
    const tks=(n.takeaways||[]).length?(n.takeaways||[]).map(t=>`<li>${e(t)}</li>`).join(""):`<li>No takeaways</li>`;
    const cats=(n.categories||[]).length?`<div style="margin-top:8px" class="proui-small"><strong>Categories:</strong> ${e(n.categories.join(" â€¢ "))}</div>`:"";
    let sum=sanitizePDF(n.summary||"");if(sum.length>2400)sum=sum.slice(0,2400);
    const sents=splitSentences(sum);const lead=sents[0]||sum;const rest=sents.slice(1);const rp=[];for(let i=0;i<rest.length;i+=3)rp.push(rest.slice(i,i+3).join(" "));
    return `<div class="proui-page"><div class="proui-tricolor"></div><div class="proui-card" style="margin-bottom:14px"><div class="proui-h">Node ${n.idx}</div><div class="proui-nodeTitle">${e(n.title)}</div><div class="proui-small" style="margin-top:6px"><strong>Source:</strong> ${e(n.sourceName)} (${e(n.confidence)})</div>${cats}</div><div class="proui-grid2"><div class="proui-card"><div class="proui-h">Key Takeaways</div><ul class="proui-list">${tks}</ul></div><div class="proui-card"><div class="proui-h">Decision Context</div><div class="proui-small"><p style="margin:0 0 6px;font-weight:700;color:#e2e8f0">${e(n.decisionMeta?.decision||"No decision context")}</p><p style="margin:0">Stake: ${e(n.decisionMeta?.stake||"â€”")} | Time: ${e(n.decisionMeta?.time||"â€”")}</p></div></div></div><div style="height:12px"></div><div class="proui-card"><div class="proui-h">Summary</div><div class="proui-small"><p style="margin:0 0 8px;font-weight:700;color:#e2e8f0">${e(lead)}</p>${rp.map(p=>`<p style="margin:0 0 8px">${e(p)}</p>`).join("")}</div></div><div style="height:10px"></div><div class="proui-card"><div class="proui-h">Source URL</div><div class="proui-small">${n.url?e(n.url):"No URL"}</div></div><div class="proui-wm">${wm}</div></div>`;
  }).join("");
  const sy=m.synthesis||{};
  const final=`<div class="proui-page"><div class="proui-tricolor"></div><h2 class="proui-title" style="margin-bottom:12px">Synthesis & Next Steps</h2><div class="proui-card" style="margin-bottom:12px"><div class="proui-h">Working Thesis</div><div class="proui-small">${e(sy.thesis||"No thesis")}</div></div><div class="proui-grid2"><div class="proui-card"><div class="proui-h">Top Takeaways</div><ul class="proui-list">${(sy.topTakeaways||[]).map(t=>`<li>${e(t)}</li>`).join("")}</ul></div><div class="proui-card"><div class="proui-h">Contradictions</div><div class="proui-small">${e(sy.contradictions||"None")}</div></div></div><div style="height:12px"></div><div class="proui-grid2"><div class="proui-card"><div class="proui-h">Decision Implications</div><div class="proui-small">${e(sy.implications||"None")}</div></div><div class="proui-card"><div class="proui-h">Next Research Nodes</div><div class="proui-small">${e(sy.next||"N/A")}</div></div></div><div style="height:12px"></div><div class="proui-card"><div class="proui-h">Recommendation</div><div class="proui-small">${e(sy.recommendation||"")}</div></div><div class="proui-wm">${wm}</div></div>`;
  return `<div style="background:#060c16">${cover}${nodePages}${final}</div>`;
}
async function generateDecisionPDF() {
  if(!ENGINE_STATE.research_nodes?.length){showToast("NO NODES");return;}
  if(!ENGINE_STATE.synthesis){const agg=[];ENGINE_STATE.research_nodes.forEach(n=>agg.push(...extractTakeaways(n.summary||"",4)));ENGINE_STATE.synthesis={thesis:"",topTakeaways:agg.slice(0,5),contradictions:"",implications:"",next:"",recommendation:""};}
  showToast("EXPORTING DECISION PDF...");
  try{
    const m=buildDecisionModel();const root=document.getElementById("pro-ui-root");root.innerHTML=renderDecisionDocHTML(m);
    const fname=`decision-brief-india-${new Date().toISOString().slice(0,10)}.pdf`;
    const opt={margin:0,filename:fname,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:true,backgroundColor:"#060c16"},jsPDF:{unit:"pt",format:"a4",orientation:"portrait"}};
    await html2pdf().set(opt).from(root.firstElementChild).save();showToast("DECISION PDF DOWNLOADED!");
  }catch(e){console.error("Decision PDF error:",e);showToast("DECISION PDF FAILED");}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HASH ROUTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ROUTE_MAP = {
  "home":      ()=>renderHome(),
  "research":  ()=>renderSearch(),
  "search":    ()=>renderSearch(),
  "founder":   ()=>renderFounder(),
  "policy":    ()=>renderPolicy(),
  "synthesis": ()=>renderSynthesis(),
  "quiz":      ()=>launchQuiz(),
};

function resolveHash(hash) {
  if(!hash||hash==="#"||hash==="#/") return null;
  if(hash.startsWith("#p=")) return "__project__";
  if(hash.startsWith("#node=")) return "__node__";
  const key=hash.replace(/^#\/?/,"").toLowerCase().split("?")[0];
  return ROUTE_MAP[key]?key:null;
}

function navigateTo(routeKey) {
  const fn=ROUTE_MAP[routeKey];
  closeSidebar();
  if(fn){ fn(); if(routeKey!=="founder"&&routeKey!=="policy") history.pushState({route:routeKey},"","#"+routeKey); }
  else renderHome();
}

window.addEventListener("popstate",()=>{
  const hash=(location.hash||"").trim();
  const key=resolveHash(hash);
  if(!key){renderHome();return;}
  if(key==="__project__"){handleProjectHash(hash);return;}
  if(key==="__node__"){handleNodeHash(hash);return;}
  const fn=ROUTE_MAP[key]; if(fn)fn(); else renderHome();
});

function handleProjectHash(hash) {
  try{
    const payload=hash.slice(3);const p=deserializeProject(payload);
    if(!p.id)p.id=uid();if(!p.name)p.name="Shared Project";
    p.updatedAt=new Date().toISOString();if(!p.createdAt)p.createdAt=p.updatedAt;
    saveProjectToStorage(p);loadProjectIntoApp(p);showToast("SHARED PROJECT LOADED");
  }catch(e){console.error(e);renderHome();showToast("INVALID SHARE LINK");}
}
async function handleNodeHash(hash) {
  try{
    const rawTitle=decodeURIComponent(hash.slice("#node=".length));
    ENGINE_STATE.cuisines_detected=["research"];ENGINE_STATE.research_nodes=[];ENGINE_STATE.synthesis=null;
    showToast("LOADING NODE...");
    const ctx=await WIKI_ENGINE.getContext(rawTitle,WIKI_ENGINE.activeSource);
    if(!ctx){renderSearch();showToast("NODE NOT FOUND");return;}
    currentDecisionContext={title:ctx.title,summary:ctx.summary,url:ctx.url,thumbnail:ctx.thumbnail,categories:ctx.categories||[],links:ctx.links||[],source:ctx.source,sourceName:ctx.sourceName,confidence:ctx.confidence,decisionMeta:{}};
    ENGINE_STATE.research_nodes=[currentDecisionContext];currentDecisionContext=null;
    buildAndRenderDeck(ENGINE_STATE.research_nodes[0]);
  }catch(e){console.error(e);renderSearch();}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function boot() {
  // Hide loading screen after short delay
  setTimeout(()=>{
    const ls=document.getElementById("loading-screen");
    if(ls){ls.classList.add("fade-out");setTimeout(()=>ls.classList.add("hidden"),600);}
  },1200);

  // Route
  const hash=(location.hash||"").trim();
  const key=resolveHash(hash);
  try{
    if(key==="__project__"){handleProjectHash(hash);return;}
    if(key==="__node__"){handleNodeHash(hash);return;}
    if(key&&ROUTE_MAP[key]){ROUTE_MAP[key]();return;}
    renderHome();
  }catch(e){console.error(e);renderHome();}
}

// Keyboard shortcuts
document.addEventListener("keydown",e=>{
  if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA") return;
  if(e.key==="/"||e.key==="s"){e.preventDefault();navigateTo("research");}
  if(e.key==="Escape"){closeSidebar();closeNotes();}
});

// DOM ready
if(document.readyState==="loading"){ document.addEventListener("DOMContentLoaded",boot); }
else { boot(); }
</script>
</body>
</html>
