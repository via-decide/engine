<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
  <title>viadecide.com | India's Decision Engine</title>

  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#04080f" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="decide.engine" />
  <meta name="description" content="India's decision research engine â€” built for the IndiaAI mission." />
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512.png" />

  <!-- PDF libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800;900&family=Space+Mono:wght@400;700&family=Noto+Sans:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">

  <style>
    :root{
      --saffron:#FF9933; --india-green:#138808; --chakra-blue:#000080; --white:#fff;
      --brand-bg:#060c16; --bg-card:#0d1825; --bg-deep:#04080f;
      --text-main:#e8edf5; --text-dim:#8fa3bb;
      --accent-go:#00d68f; --accent-blue:#3b82f6;
      --border:rgba(255,255,255,0.08); --border-glow:rgba(255,153,51,0.25);
      --font-display:'Syne',sans-serif; --font-mono:'Space Mono',monospace; --font-body:'Noto Sans',sans-serif;
      --shadow-card:0 8px 32px rgba(0,0,0,0.45);
      --sidebar-w:280px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html{scroll-behavior:smooth;height:100%}
    body{background:var(--bg-deep);color:var(--text-main);font-family:var(--font-body);height:100%;overflow:hidden}

    #loading-screen{
      position:fixed;inset:0;z-index:9999;background:var(--bg-deep);
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;
      transition:opacity .5s ease;
    }
    #loading-screen.fade-out{opacity:0;pointer-events:none}
    #loading-screen.hidden{display:none}
    .loading-logo{font-family:var(--font-display);font-weight:900;font-size:clamp(2rem,6vw,4rem);letter-spacing:-.04em}
    .loading-logo .via{color:var(--saffron)} .loading-logo .decide{color:#fff} .loading-logo .dot{color:var(--accent-go)}
    .loading-bar-wrap{width:200px;height:3px;background:rgba(255,255,255,.1);border-radius:2px;overflow:hidden}
    .loading-bar{height:100%;width:0;background:linear-gradient(90deg,var(--saffron),var(--accent-go));animation:loadAnim 1.2s ease forwards}
    @keyframes loadAnim{0%{width:0}60%{width:70%}100%{width:100%}}
    .loading-sub{font-family:var(--font-mono);font-size:.6rem;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase}

    .tricolor-bar{
      position:fixed;top:0;left:0;right:0;height:3px;
      background:linear-gradient(90deg,#FF9933 33.33%,#FFFFFF 33.33%,#FFFFFF 66.66%,#138808 66.66%);
      z-index:9000;
    }

    #app{display:flex;height:100vh;padding-top:3px;overflow:hidden}
    #sidebar{
      width:var(--sidebar-w);
      background:linear-gradient(180deg, rgba(6,12,22,.99), rgba(4,8,15,.97));
      border-right:1px solid var(--border);
      display:flex;flex-direction:column;
      position:fixed;top:3px;left:0;bottom:0;z-index:800;
      overflow-y:auto;-webkit-overflow-scrolling:touch;
      transition:transform .25s cubic-bezier(.2,.8,.2,1);
    }
    @media(max-width:900px){
      #sidebar{transform:translateX(-100%);box-shadow:4px 0 32px rgba(0,0,0,.5);width:min(300px,85vw)}
      #sidebar.open{transform:translateX(0)}
    }
    #sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:799}
    @media(max-width:900px){#sidebar-overlay.open{display:block}}

    .sidebar-header{padding:20px 18px 16px;border-bottom:1px solid var(--border);flex-shrink:0}
    .sidebar-logo{font-family:var(--font-display);font-weight:900;font-size:1.4rem;letter-spacing:-.04em;cursor:pointer;user-select:none}
    .sidebar-logo .via{color:var(--saffron)} .sidebar-logo .decide{color:#fff} .sidebar-logo .dot{color:var(--accent-go)}
    .sidebar-tagline{font-family:var(--font-mono);font-size:.55rem;color:var(--text-dim);letter-spacing:1.5px;text-transform:uppercase;margin-top:4px}

    .sidebar-nav{padding:12px 10px;flex:1}
    .nav-section-label{font-family:var(--font-mono);font-size:.55rem;color:#3a4a5c;letter-spacing:2px;text-transform:uppercase;padding:10px 8px 6px;user-select:none}
    .nav-item{
      display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;cursor:pointer;
      transition:all .15s;font-family:var(--font-display);font-size:.82rem;font-weight:700;color:var(--text-dim);
      text-decoration:none;user-select:none;border:1px solid transparent;margin-bottom:2px;
      -webkit-tap-highlight-color:transparent;
    }
    .nav-item:hover{background:rgba(255,255,255,.04);color:var(--text-main)}
    .nav-item.active{background:rgba(255,153,51,.1);border-color:rgba(255,153,51,.25);color:var(--saffron)}
    .nav-item .nav-icon{font-size:1rem;flex-shrink:0;width:20px;text-align:center}
    .nav-badge{margin-left:auto;font-family:var(--font-mono);font-size:.52rem;padding:3px 7px;border-radius:99px;background:rgba(0,214,143,.1);color:var(--accent-go);border:1px solid rgba(0,214,143,.25)}

    .sidebar-footer{padding:14px 16px;border-top:1px solid var(--border);flex-shrink:0}
    .sidebar-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
    .sstat{background:var(--bg-deep);border:1px solid var(--border);border-radius:8px;padding:8px;text-align:center}
    .sstat-num{font-family:var(--font-display);font-weight:900;font-size:1rem;color:var(--saffron);line-height:1}
    .sstat-lbl{font-family:var(--font-mono);font-size:.5rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:.8px;margin-top:2px}

    #main{flex:1;margin-left:var(--sidebar-w);height:100vh;display:flex;flex-direction:column;overflow:hidden;position:relative}
    @media(max-width:900px){#main{margin-left:0}}

    #topbar{
      position:sticky;top:3px;z-index:700;height:58px;display:flex;align-items:center;gap:12px;
      padding:0 16px;background:rgba(6,12,22,.95);border-bottom:1px solid var(--border);
      backdrop-filter:blur(12px);flex-shrink:0;
    }
    #menu-toggle{
      width:36px;height:36px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;
      display:none;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;
      -webkit-tap-highlight-color:transparent;
    }
    @media(max-width:900px){#menu-toggle{display:flex}}
    #menu-toggle svg{width:18px;height:18px;fill:var(--text-dim)}

    .topbar-title{font-family:var(--font-display);font-size:.85rem;font-weight:800;color:var(--text-main);letter-spacing:.5px;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .topbar-badge{font-family:var(--font-mono);font-size:.58rem;color:var(--text-dim);background:var(--bg-card);padding:4px 10px;border-radius:99px;border:1px solid var(--border);flex-shrink:0}
    .topbar-badge.india{border-color:rgba(255,153,51,.4);color:var(--saffron)}
    .topbar-badge.green{border-color:rgba(0,214,143,.4);color:var(--accent-go)}

    #page-content{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;overscroll-behavior-y:contain;padding:24px 24px 100px}
    @media(max-width:600px){#page-content{padding:16px 14px 100px}}
    @media(min-width:1200px){#page-content{max-width:900px}}

    #toast{
      position:fixed;bottom:24px;left:50%;transform:translateX(-50%);
      background:var(--bg-card);color:var(--accent-go);padding:10px 22px;border:1px solid rgba(0,214,143,.4);
      border-radius:99px;font-size:.75rem;opacity:0;pointer-events:none;transition:opacity .25s;z-index:8000;
      font-family:var(--font-mono);letter-spacing:.8px;box-shadow:0 8px 24px rgba(0,0,0,.4);white-space:nowrap;
    }
    #toast.visible{opacity:1}

    h1{font-family:var(--font-display);font-size:clamp(1.5rem,4vw,2.5rem);margin:0 0 10px;line-height:1.05;letter-spacing:-.03em;color:var(--saffron)}
    h2{font-family:var(--font-display);font-size:clamp(1.2rem,3vw,1.8rem);margin:0 0 8px;line-height:1.1;letter-spacing:-.02em;color:var(--text-main)}
    .primary-question{font-size:.95rem;color:var(--text-dim);margin-bottom:20px;line-height:1.6}

    .card{background:var(--bg-card);border:1px solid var(--border);border-radius:14px;padding:18px;margin-bottom:14px;box-shadow:var(--shadow-card)}
    .card.glow{border-color:var(--border-glow)}
    .card.green-glow{border-color:rgba(0,214,143,.3)}
    .card.blue-glow{border-color:rgba(59,130,246,.3)}
    .card-title{font-family:var(--font-mono);font-size:.62rem;color:var(--text-dim);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:10px}

    .pill-row{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0}
    .pill{font-family:var(--font-mono);font-size:.58rem;letter-spacing:.8px;padding:6px 12px;border-radius:99px;text-transform:uppercase}
    .pill-s{background:rgba(255,153,51,.1);border:1px solid rgba(255,153,51,.35);color:var(--saffron)}
    .pill-g{background:rgba(0,214,143,.1);border:1px solid rgba(0,214,143,.3);color:var(--accent-go)}
    .pill-b{background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.3);color:#93c5fd}
    .pill-w{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.15);color:rgba(255,255,255,.8)}

    .btn{
      display:block;width:100%;background:var(--bg-card);color:var(--text-main);
      border:1px solid var(--border);padding:13px 16px;border-radius:10px;font-weight:700;text-align:center;
      font-size:.82rem;cursor:pointer;transition:transform .1s ease, box-shadow .15s ease, opacity .15s;
      font-family:var(--font-display);letter-spacing:.5px;text-decoration:none;-webkit-tap-highlight-color:transparent;
    }
    .btn:active{transform:scale(.98);opacity:.88}
    .btn-india{background:rgba(255,153,51,.12);border-color:rgba(255,153,51,.45);color:var(--saffron)}
    .btn-pro{background:rgba(0,214,143,.1);border-color:rgba(0,214,143,.35);color:var(--accent-go)}
    .btn-policy{background:rgba(59,130,246,.1);border-color:rgba(59,130,246,.35);color:#93c5fd}
    .btn-muted{background:var(--bg-deep);border-color:var(--border);color:var(--text-dim)}
    .btn-pdf{background:rgba(185,28,28,.15);border-color:rgba(185,28,28,.4);color:#fca5a5}
    .btn-yt{background:rgba(204,0,0,.15);border-color:rgba(204,0,0,.4);color:#fca5a5}

    .btn-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px}
    .btn-grid .btn-full{grid-column:span 2}
    @media(max-width:400px){.btn-grid{grid-template-columns:1fr}.btn-grid .btn-full{grid-column:span 1}}

    .form-input{
      width:100%;background:var(--bg-deep);border:1px solid var(--border);color:var(--text-main);
      padding:12px 14px;border-radius:10px;font-size:.9rem;font-family:var(--font-body);outline:none;transition:border-color .2s;margin-bottom:10px;
    }
    .form-input:focus{border-color:rgba(255,153,51,.5)}
    .form-textarea{
      width:100%;resize:vertical;min-height:80px;background:var(--bg-deep);border:1px solid var(--border);
      color:var(--text-main);padding:12px 14px;border-radius:10px;font-size:.88rem;font-family:var(--font-body);
      outline:none;transition:border-color .2s;line-height:1.6;
    }
    .form-textarea:focus{border-color:rgba(255,153,51,.35)}

    .source-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px}
    .source-chip{
      padding:6px 12px;border:1px solid var(--border);border-radius:99px;font-size:.62rem;color:var(--text-dim);
      font-family:var(--font-mono);cursor:pointer;transition:all .15s;background:var(--bg-deep);-webkit-tap-highlight-color:transparent;
    }
    .source-chip.active{background:rgba(0,214,143,.08);color:var(--accent-go);border-color:rgba(0,214,143,.4)}

    .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin:14px 0}
    @media(min-width:600px){.stats-grid{grid-template-columns:repeat(4,1fr)}}
    .stat-card{background:var(--bg-deep);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center}
    .stat-card .num{font-family:var(--font-display);font-weight:900;font-size:1.5rem;color:var(--saffron);line-height:1}
    .stat-card .lbl{font-family:var(--font-mono);font-size:.55rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:.8px;margin-top:4px}

    .founder-letter{
      background:linear-gradient(135deg,rgba(255,153,51,.07),rgba(6,12,22,0),rgba(19,136,8,.05));
      border:1px solid rgba(255,153,51,.2);border-radius:16px;padding:20px 18px;margin-bottom:14px;position:relative;
    }
    .founder-letter::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,#FF9933,transparent,#138808);border-radius:16px 16px 0 0}
    .founder-eyebrow{font-family:var(--font-mono);font-size:.6rem;letter-spacing:2px;color:var(--saffron);text-transform:uppercase;margin-bottom:10px;display:flex;align-items:center;gap:8px}
    .founder-eyebrow::after{content:'';flex:1;height:1px;background:rgba(255,153,51,.2)}
    .founder-letter p{font-size:.9rem;color:var(--text-dim);line-height:1.75;margin:0 0 10px}
    .founder-letter p:last-child{margin:0}
    .founder-letter strong{color:var(--text-main);font-weight:600}

    .pulse-dot{display:inline-block;width:7px;height:7px;background:var(--accent-go);border-radius:50%;animation:pulse 2s ease-in-out infinite}
    @keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.4);opacity:.6}}

    .nav-hint{margin-top:16px;padding-top:12px;border-top:1px solid rgba(255,255,255,.04);font-family:var(--font-mono);font-size:.6rem;color:#3a4a5c;display:flex;justify-content:space-between}

    #notes-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:5000}
    #notes-overlay.open{display:block}
    #notes-panel{
      position:fixed;bottom:0;left:50%;transform:translate(-50%,102%);
      width:min(700px,96vw);height:min(55vh,480px);
      background:var(--brand-bg);border:1px solid var(--border);border-bottom:none;
      border-top-left-radius:18px;border-top-right-radius:18px;
      z-index:5001;transition:transform .22s cubic-bezier(.2,.8,.2,1);
      display:flex;flex-direction:column;box-shadow:0 -20px 40px rgba(0,0,0,.5);
    }
    #notes-panel.open{transform:translate(-50%,0)}
    .notes-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .notes-header-title{font-family:var(--font-display);font-size:.75rem;color:var(--saffron);font-weight:700;letter-spacing:1px;text-transform:uppercase}
    .notes-body{padding:14px 16px;flex:1;overflow-y:auto}
    .notes-meta{display:flex;justify-content:space-between;font-family:var(--font-mono);font-size:.62rem;color:#3a4a5c;text-transform:uppercase;margin-top:8px}

    #depth-bar{position:fixed;right:0;top:3px;bottom:0;width:3px;z-index:600;background:rgba(255,255,255,.04)}
    #depth-fill{width:100%;background:linear-gradient(180deg,var(--saffron),var(--accent-go));transition:height .3s ease;border-radius:2px}

    #install-btn{display:none;width:100%;margin-top:8px}
    @keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
    .animate-in{animation:fadeUp .35s ease both}

    ::-webkit-scrollbar{width:5px;height:5px}
    ::-webkit-scrollbar-track{background:transparent}
    ::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:3px}
  </style>
</head>

<body>
  <!-- Loading Screen -->
  <div id="loading-screen">
    <div class="loading-logo">
      <span class="via">via</span><span class="decide">decide</span><span class="dot">.</span><span style="color:rgba(255,255,255,.9)">com</span>
    </div>
    <div class="loading-bar-wrap"><div class="loading-bar"></div></div>
    <div class="loading-sub">India's Decision Engine</div>
  </div>

  <div class="tricolor-bar"></div>

  <div id="app">
    <div id="sidebar-overlay" onclick="closeSidebar()"></div>

    <aside id="sidebar" aria-label="Navigation">
      <div class="sidebar-header">
        <div class="sidebar-logo" onclick="navigateTo('home')">
          <span class="via">via</span><span class="decide">decide</span><span class="dot">.</span><span style="color:rgba(255,255,255,.85)">com</span>
        </div>
        <div class="sidebar-tagline">India's Decision Engine</div>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section-label">Navigation</div>
        <a class="nav-item active" id="nav-home" onclick="navigateTo('home')"><span class="nav-icon">ğŸ </span> Home</a>
        <a class="nav-item" id="nav-research" onclick="navigateTo('research')">
          <span class="nav-icon">ğŸ”</span> Research
          <span class="nav-badge" id="nav-nodes-badge" style="display:none">0</span>
        </a>
        <a class="nav-item" id="nav-founder" onclick="navigateTo('founder')"><span class="nav-icon">âœ‰ï¸</span> Founder Letter</a>
        <a class="nav-item" id="nav-policy" onclick="navigateTo('policy')"><span class="nav-icon">ğŸ›ï¸</span> IndiaAI Policy</a>

        <div class="nav-section-label" style="margin-top:8px">Tools</div>
        <a class="nav-item" id="nav-synthesis" onclick="navigateTo('synthesis')"><span class="nav-icon">ğŸ§ </span> Synthesis</a>
        <a class="nav-item" id="nav-quiz" onclick="navigateTo('quiz')"><span class="nav-icon">ğŸ§©</span> Quiz (Alchemist)</a>
        <a class="nav-item" onclick="toggleNotes()"><span class="nav-icon">âœ</span> Notes</a>

        <div class="nav-section-label" style="margin-top:8px">Projects</div>
        <a class="nav-item" onclick="saveCurrentProjectPrompt()"><span class="nav-icon">ğŸ’¾</span> Save Project</a>
        <a class="nav-item" onclick="shareCurrentProject()"><span class="nav-icon">ğŸ”—</span> Share Link</a>
        <a class="nav-item" onclick="openProjectPicker()"><span class="nav-icon">ğŸ“‚</span> Load Project</a>
        <a class="nav-item" onclick="importShareLinkPrompt()"><span class="nav-icon">ğŸ“¥</span> Import Link</a>
      </nav>

      <div class="sidebar-footer">
        <div class="sidebar-stats">
          <div class="sstat"><div class="sstat-num" id="sf-nodes">0</div><div class="sstat-lbl">Nodes</div></div>
          <div class="sstat"><div class="sstat-num" id="sf-projects">0</div><div class="sstat-lbl">Projects</div></div>
        </div>
        <button class="btn btn-india" id="install-btn" onclick="triggerAppInstall()">â¬‡ Install App</button>
      </div>
    </aside>

    <div id="main">
      <header id="topbar">
        <button id="menu-toggle" onclick="toggleSidebar()" aria-label="Menu">
          <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
        </button>
        <div class="topbar-title" id="topbar-title">decide.engine</div>
        <div class="topbar-badge india" id="topbar-badge">INDIAAI</div>
      </header>

      <main id="page-content" role="main"></main>
    </div>
  </div>

  <!-- Notes Panel -->
  <div id="notes-overlay" onclick="closeNotes()"></div>
  <div id="notes-panel" aria-hidden="true">
    <div class="notes-header">
      <div class="notes-header-title">Policy Scratchpad</div>
      <button class="btn btn-muted" style="width:auto;padding:8px 14px;font-size:.72rem" onclick="closeNotes()">CLOSE</button>
    </div>
    <div class="notes-body">
      <textarea id="notes-text" class="form-textarea" style="min-height:200px" placeholder="Capture policy insights, decision options, stakeholder notes..."></textarea>
      <div class="notes-meta">
        <span id="notes-count">0 chars</span>
        <span id="notes-saved">Not saved</span>
      </div>
      <div class="btn-grid" style="margin-top:10px">
        <button class="btn" onclick="saveNotes()">SAVE</button>
        <button class="btn btn-muted" onclick="clearNotes()">CLEAR</button>
      </div>
    </div>
  </div>

  <div id="depth-bar"><div id="depth-fill" style="height:0%"></div></div>
  <div id="toast"></div>

  <!-- Hidden PDF root -->
  <div id="pro-ui-root" aria-hidden="true" style="position:fixed;left:-99999px;top:0;width:794px;background:#060c16;color:#fff;font-family:'Syne',sans-serif;z-index:-1"></div>

  <script>
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // PWA SERVICE WORKER
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", async () => {
        try {
          const reg = await navigator.serviceWorker.register("/sw.js");
          reg.addEventListener("updatefound", () => {
            const nw = reg.installing;
            if (!nw) return;
            nw.addEventListener("statechange", () => {
              if (nw.state === "installed" && navigator.serviceWorker.controller) {
                nw.postMessage({ type: "SKIP_WAITING" });
              }
            });
          });
          console.log("[PWA] SW registered:", reg.scope);
        } catch (err) {
          console.warn("[PWA] SW registration failed:", err);
        }
      });
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // INSTALL BUTTON
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let deferredInstallPrompt = null;

    function _setInstallBtn(visible) {
      const apply = () => {
        const btn = document.getElementById("install-btn");
        if (btn) btn.style.display = visible ? "block" : "none";
      };
      document.readyState === "loading"
        ? document.addEventListener("DOMContentLoaded", apply, { once: true })
        : apply();
    }

    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredInstallPrompt = e;
      _setInstallBtn(true);
    });

    window.addEventListener("appinstalled", () => {
      deferredInstallPrompt = null;
      _setInstallBtn(false);
      showToast("APP INSTALLED âœ“");
    });

    async function triggerAppInstall() {
      if (!deferredInstallPrompt) {
        showToast("Use Chrome/Edge to install");
        return;
      }
      try {
        await deferredInstallPrompt.prompt();
        const { outcome } = await deferredInstallPrompt.userChoice;
        showToast(outcome === "accepted" ? "INSTALLINGâ€¦" : "INSTALL CANCELLED");
      } catch (err) {
        console.error("[PWA] install error:", err);
        showToast("INSTALL FAILED");
      }
      deferredInstallPrompt = null;
      _setInstallBtn(false);
    }

    if (window.matchMedia("(display-mode: standalone)").matches || navigator.standalone) {
      _setInstallBtn(false);
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // UTILITIES
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function escapeHTML(str) {
      return (str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }
    function normalizeText(t) { return (t || "").replace(/\s+/g, " ").replace(/\u00AD/g, "").trim(); }
    function splitSentences(text) {
      const t = normalizeText(text); if (!t) return [];
      return t.split(/(?<=[.!?])\s+(?=[A-Z0-9"\u201C(])/g).map(s => s.trim()).filter(Boolean);
    }
    function extractTakeaways(summary, max = 4) { return splitSentences(summary).slice(0, max); }
    function wordCount(text) { const t = normalizeText(text); return t ? t.split(/\s+/).length : 0; }
    function readingTime(words) { return Math.max(1, Math.round(words / 180)); }
    function nowIST() { return new Date().toLocaleTimeString("en-IN", { hour: "2-digit", minute: "2-digit", timeZone: "Asia/Kolkata" }); }
    function uid() { return "p_" + Math.random().toString(16).slice(2) + Date.now().toString(16); }
    function sanitizePDF(t) { return normalizeText(t).replace(/[^\x00-\xFF]/g, ""); }
    function confidenceFor(src) { return (src === "wiki" || src === "travel") ? "High" : (src === "wikibooks" ? "Medium" : "Low"); }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // TOAST
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let _toastTimer = null;
    function showToast(msg) {
      const el = document.getElementById("toast");
      if (!el) return;
      el.textContent = msg;
      el.classList.add("visible");
      clearTimeout(_toastTimer);
      _toastTimer = setTimeout(() => el.classList.remove("visible"), 2200);
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SIDEBAR + NOTES
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function toggleSidebar() {
      document.getElementById("sidebar").classList.toggle("open");
      document.getElementById("sidebar-overlay").classList.toggle("open");
    }
    function closeSidebar() {
      document.getElementById("sidebar").classList.remove("open");
      document.getElementById("sidebar-overlay").classList.remove("open");
    }

    const NOTES_KEY = "decide_notes_v2";
    function toggleNotes() {
      const p = document.getElementById("notes-panel");
      p.classList.toggle("open");
      document.getElementById("notes-overlay").classList.toggle("open");
      if (p.classList.contains("open")) { loadNotes(); updateNotesMeta(); }
      closeSidebar();
    }
    function closeNotes() {
      document.getElementById("notes-panel").classList.remove("open");
      document.getElementById("notes-overlay").classList.remove("open");
    }
    function loadNotes() {
      try {
        const ta = document.getElementById("notes-text");
        if (ta) ta.value = localStorage.getItem(NOTES_KEY) || "";
      } catch {}
    }
    function saveNotes() {
      try {
        const ta = document.getElementById("notes-text");
        if (!ta) return;
        localStorage.setItem(NOTES_KEY, ta.value);
        const el = document.getElementById("notes-saved");
        if (el) el.textContent = "Saved " + nowIST();
        showToast("NOTES SAVED");
        updateNotesMeta();
        autosaveIfPossible();
      } catch {
        showToast("SAVE FAILED");
      }
    }
    function clearNotes() {
      try {
        const ta = document.getElementById("notes-text");
        if (ta) ta.value = "";
        localStorage.removeItem(NOTES_KEY);
        const el = document.getElementById("notes-saved");
        if (el) el.textContent = "Cleared";
        showToast("NOTES CLEARED");
        updateNotesMeta();
      } catch {}
    }
    function updateNotesMeta() {
      const ta = document.getElementById("notes-text");
      const c = document.getElementById("notes-count");
      if (ta && c) c.textContent = ta.value.length + " chars";
    }
    document.addEventListener("input", (e) => {
      if (e?.target?.id === "notes-text") updateNotesMeta();
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // APP STATE
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let ENGINE_STATE = { research_nodes: [], synthesis: null };
    let CURRENT_PROJECT = null;
    let currentDecisionContext = null;

    function setActiveNav(key) {
      document.querySelectorAll(".nav-item").forEach(el => el.classList.remove("active"));
      const el = document.getElementById("nav-" + key);
      if (el) el.classList.add("active");
    }
    function setTopbar(title, badge = "INDIAAI", badgeClass = "india") {
      const t = document.getElementById("topbar-title"); if (t) t.textContent = title;
      const b = document.getElementById("topbar-badge");
      if (b) { b.textContent = badge; b.className = "topbar-badge " + badgeClass; }
    }
    function updateDepth(current, total) {
      const el = document.getElementById("depth-fill");
      if (!el) return;
      const pct = total > 1 ? Math.round((current / Math.max(1, total - 1)) * 100) : 0;
      el.style.height = pct + "%";
    }
    function renderPage(htmlContent, title = "decide.engine", badge = "INDIAAI", badgeClass = "india") {
      const pc = document.getElementById("page-content");
      if (!pc) return;
      pc.innerHTML = `<div class="animate-in">${htmlContent}</div>`;
      pc.scrollTop = 0;
      setTopbar(title, badge, badgeClass);
      closeSidebar();
      updateSidebarStats();
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // WIKI ENGINE
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const WIKI_ENGINE = {
      activeSource: "wiki",
      cache: new Map(),
      sources: {
        wiki:      { name: "WIKIPEDIA",  api: "https://en.wikipedia.org/w/api.php",  icon: "ğŸ“š" },
        travel:    { name: "WIKIVOYAGE", api: "https://en.wikivoyage.org/w/api.php", icon: "ğŸ—ºï¸" },
        wikibooks: { name: "WIKIBOOKS",  api: "https://en.wikibooks.org/w/api.php",  icon: "ğŸ“–" },
        wikinews:  { name: "WIKINEWS",   api: "https://en.wikinews.org/w/api.php",   icon: "ğŸ“°" },
      },
      async search(query, source = this.activeSource) {
        const q = normalizeText(query);
        const ckey = `s_${source}_${q}`;
        if (this.cache.has(ckey)) return this.cache.get(ckey);
        try {
          const api = this.sources[source].api;
          const url = `${api}?origin=*&action=opensearch&search=${encodeURIComponent(q)}&limit=8&format=json`;
          const res = await fetch(url, { signal: AbortSignal.timeout(9000) });
          if (!res.ok) throw new Error("HTTP " + res.status);
          const data = await res.json();
          const results = [];
          if (data && data[1]) {
            for (let i = 0; i < data[1].length; i++) {
              results.push({ title: data[1][i], description: (data[2]?.[i] || ""), url: (data[3]?.[i] || "") });
            }
          }
          this.cache.set(ckey, results);
          return results;
        } catch (e) {
          console.error("Search error:", e);
          return [];
        }
      },
      async getContext(title, source = this.activeSource) {
        const t = normalizeText(title);
        const ckey = `c_${source}_${t}`;
        if (this.cache.has(ckey)) return this.cache.get(ckey);

        try {
          const api = this.sources[source].api;
          const url = `${api}?origin=*&action=query&prop=extracts|info|pageimages|categories&titles=${encodeURIComponent(t)}&exintro=1&explaintext=1&inprop=url&piprop=thumbnail&pithumbsize=300&cllimit=10&format=json`;
          const res = await fetch(url, { signal: AbortSignal.timeout(9000) });
          if (!res.ok) throw new Error("HTTP " + res.status);
          const data = await res.json();

          const pages = data?.query?.pages || {};
          const firstKey = Object.keys(pages)[0];
          if (!firstKey || firstKey === "-1") throw new Error("Not found");
          const page = pages[firstKey];

          // links
          const linksUrl = `${api}?origin=*&action=query&prop=links&titles=${encodeURIComponent(t)}&pllimit=20&plnamespace=0&format=json`;
          let links = [];
          try {
            const lr = await fetch(linksUrl, { signal: AbortSignal.timeout(6000) });
            const ld = await lr.json();
            const lp = ld?.query?.pages || {};
            const lk = Object.keys(lp)[0];
            links = (lk && lp[lk]?.links) ? lp[lk].links.map(l => ({ name: l.title })) : [];
          } catch {}

          const ctx = {
            title: page.title,
            summary: page.extract || "No summary.",
            url: page.fullurl || "",
            thumbnail: page.thumbnail?.source || null,
            categories: (page.categories || []).slice(0, 5).map(c => c.title.replace("Category:", "")),
            links,
            source,
            sourceName: this.sources[source].name,
            confidence: confidenceFor(source)
          };
          this.cache.set(ckey, ctx);
          return ctx;
        } catch (e) {
          console.error("Context error:", e);
          return null;
        }
      }
    };

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // PROJECT STORAGE
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const PROJECTS_KEY = "decideos_projects_v2";
    const LAST_PROJECT_KEY = "decideos_last_v2";
    const PROJECT_PREFIX = "decideos_proj_";

    function getProjectsIndex() { try { return JSON.parse(localStorage.getItem(PROJECTS_KEY) || "{}"); } catch { return {}; } }
    function setProjectsIndex(idx) { localStorage.setItem(PROJECTS_KEY, JSON.stringify(idx)); }
    function saveProjectToStorage(p) {
      const idx = getProjectsIndex();
      idx[p.id] = { id: p.id, name: p.name, updatedAt: p.updatedAt, createdAt: p.createdAt };
      setProjectsIndex(idx);
      localStorage.setItem(PROJECT_PREFIX + p.id, JSON.stringify(p));
      localStorage.setItem(LAST_PROJECT_KEY, p.id);
    }
    function loadProjectFromStorage(id) { try { const r = localStorage.getItem(PROJECT_PREFIX + id); return r ? JSON.parse(r) : null; } catch { return null; } }
    function listProjects() { return Object.values(getProjectsIndex()).sort((a, b) => (b.updatedAt || "").localeCompare(a.updatedAt || "")); }

    function serializeProject(p) {
      const json = JSON.stringify(p);
      const b64 = btoa(unescape(encodeURIComponent(json)));
      return b64.replaceAll("+", "-").replaceAll("/", "_").replaceAll("=", "");
    }
    function deserializeProject(payload) {
      let b64 = payload.replaceAll("-", "+").replaceAll("_", "/");
      while (b64.length % 4) b64 += "=";
      return JSON.parse(decodeURIComponent(escape(atob(b64))));
    }

    function buildProject() {
      const nodes = ENGINE_STATE.research_nodes || [];
      const syn = ENGINE_STATE.synthesis || null;
      const notes = (document.getElementById("notes-text")?.value || localStorage.getItem(NOTES_KEY) || "");
      if (!nodes.length && !syn && !notes) return null;
      return {
        id: CURRENT_PROJECT?.id || uid(),
        name: CURRENT_PROJECT?.name || (nodes[0]?.decisionMeta?.decision ? `Decision: ${nodes[0].decisionMeta.decision}` : "Decision Research"),
        createdAt: CURRENT_PROJECT?.createdAt || new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        engineState: { research_nodes: nodes, synthesis: syn, notes }
      };
    }
    function autosaveIfPossible() {
      if (!CURRENT_PROJECT?.id) return;
      const p = buildProject(); if (!p) return;
      p.id = CURRENT_PROJECT.id;
      p.name = CURRENT_PROJECT.name || p.name;
      p.createdAt = CURRENT_PROJECT.createdAt || p.createdAt;
      p.updatedAt = new Date().toISOString();
      saveProjectToStorage(p);
      CURRENT_PROJECT = p;
    }
    function loadProjectIntoApp(project) {
      CURRENT_PROJECT = project;
      const notes = project?.engineState?.notes || "";
      localStorage.setItem(NOTES_KEY, notes);
      const ta = document.getElementById("notes-text"); if (ta) ta.value = notes;
      ENGINE_STATE.research_nodes = Array.isArray(project?.engineState?.research_nodes) ? project.engineState.research_nodes : [];
      ENGINE_STATE.synthesis = project?.engineState?.synthesis || null;
      if (ENGINE_STATE.research_nodes.length) renderResearchDeck(ENGINE_STATE.research_nodes, ENGINE_STATE.synthesis);
      else renderSearch();
      updateSidebarStats();
    }
    function saveCurrentProjectPrompt() {
      const p = buildProject(); if (!p) { showToast("NOTHING TO SAVE"); return; }
      const name = window.prompt("Project name:", (CURRENT_PROJECT?.name || p.name || "Decision Research"));
      if (name && name.trim()) p.name = name.trim();
      p.updatedAt = new Date().toISOString();
      if (!p.createdAt) p.createdAt = p.updatedAt;
      saveProjectToStorage(p);
      CURRENT_PROJECT = p;
      showToast("PROJECT SAVED");
      updateSidebarStats();
    }
    function shareCurrentProject() {
      const p = buildProject(); if (!p) { showToast("NOTHING TO SHARE"); return; }
      saveProjectToStorage(p);
      CURRENT_PROJECT = p;
      const payload = serializeProject(p);
      const url = `${location.origin}${location.pathname}#p=${payload}`;
      if (navigator.clipboard?.writeText) navigator.clipboard.writeText(url).then(() => showToast("LINK COPIED"));
      else window.prompt("Copy link:", url);
    }
    function openProjectPicker() {
      const projects = listProjects();
      if (!projects.length) { showToast("NO SAVED PROJECTS"); return; }
      const menu = projects.map((p, i) => `${i + 1}. ${p.name} (${(p.updatedAt || "").slice(0, 10)})`).join("\n");
      const choice = window.prompt("Load project #:\n" + menu, "1");
      const n = parseInt(choice || "", 10);
      if (!n || n < 1 || n > projects.length) return;
      const project = loadProjectFromStorage(projects[n - 1].id);
      if (!project) { showToast("LOAD FAILED"); return; }
      loadProjectIntoApp(project);
      showToast("PROJECT LOADED");
    }
    function importShareLinkPrompt() {
      const link = window.prompt("Paste share link or payload:", "");
      if (!link) return;
      let payload = link.trim();
      const idx = payload.indexOf("#p=");
      if (idx >= 0) payload = payload.slice(idx + 3);
      if (payload.startsWith("p=")) payload = payload.slice(2);
      try {
        const project = deserializeProject(payload);
        if (!project.id) project.id = uid();
        if (!project.name) project.name = "Imported";
        project.updatedAt = new Date().toISOString();
        if (!project.createdAt) project.createdAt = project.updatedAt;
        saveProjectToStorage(project);
        loadProjectIntoApp(project);
        showToast("IMPORTED");
      } catch (e) {
        console.error(e);
        showToast("INVALID LINK");
      }
    }
    function continueLastProject() {
      const id = localStorage.getItem(LAST_PROJECT_KEY);
      if (!id) { showToast("NO LAST PROJECT"); return; }
      const project = loadProjectFromStorage(id);
      if (!project) { showToast("LOAD FAILED"); return; }
      loadProjectIntoApp(project);
      showToast("CONTINUED");
    }

    function updateSidebarStats() {
      const nodes = ENGINE_STATE.research_nodes?.length || 0;
      const sfn = document.getElementById("sf-nodes"); if (sfn) sfn.textContent = nodes;
      const badge = document.getElementById("nav-nodes-badge");
      if (badge) { badge.textContent = nodes; badge.style.display = nodes > 0 ? "inline" : "none"; }
      const projects = Object.keys(getProjectsIndex()).length;
      const sfp = document.getElementById("sf-projects"); if (sfp) sfp.textContent = projects;
    }
    setInterval(updateSidebarStats, 2000);

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // EXAMPLES
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const EXAMPLES = [
      {
        id: "ex_indiaai",
        name: "IndiaAI: National AI Mission",
        engineState: {
          notes: "Policy node: map each research node to a policy pillar.",
          synthesis: {
            thesis: "India's National AI Mission anchors on pillars: compute, foundation models, datasets, skilling, adoption, startups, responsible AI.",
            topTakeaways: [
              "IndiaAI Mission targets sovereign AI infrastructure through the IndiaAI Compute Platform.",
              "India Datasets Platform aims to make high-quality Indian language data accessible.",
              "Skilling initiatives aim to expand AI talent at scale.",
              "Responsible AI governance includes safety, ethics, fairness, accountability.",
              "Sector adoption focuses on agriculture, health, education, governance."
            ],
            contradictions: "Data sovereignty vs open innovation; centralized compute vs democratized access.",
            implications: "Align procurement, skilling, and startup enablement simultaneously.",
            next: "Research: AI Safety Institute India â€¢ IndiaAI Startup Financing â€¢ DPI",
            recommendation: "Frame every decision through: 'Does this scale to Bharat?'"
          },
          research_nodes: [
            {
              title: "Artificial intelligence in India",
              summary: "India has emerged as a hub for AI development and deployment, driven by talent, startups, and government initiatives. The IndiaAI Mission focuses on compute, datasets and frameworks for adoption.",
              url: "https://en.wikipedia.org/wiki/Artificial_intelligence_in_India",
              thumbnail: null,
              categories: ["AI", "India", "Policy", "Technology"],
              links: [],
              source: "wiki",
              sourceName: "WIKIPEDIA",
              confidence: "High",
              decisionMeta: { decision: "Evaluate IndiaAI Mission strategy", time: "2024-2030", stake: "National AI sovereignty", success: "Self-reliant AI ecosystem", options: "Sovereign compute vs cloud dependency" }
            }
          ]
        }
      },
      {
        id: "ex_stoicism",
        name: "Stoicism â†’ Decision Discipline",
        engineState: {
          notes: "Template: connect each node to the same decision context.",
          synthesis: {
            thesis: "Stoicism is a practical operating system for improving decision quality under uncertainty.",
            topTakeaways: [
              "Separate controllables vs uncontrollables.",
              "Use negative visualization to stress-test downside.",
              "Principles improve consistency.",
              "Review loops compound behavior."
            ],
            contradictions: "Risk: can be misused as emotional suppression.",
            implications: "Define controllables, build pre-mortems, make principles explicit.",
            next: "Read: Epictetus â€¢ Marcus Aurelius",
            recommendation: "In high volatility, stoic routines improve consistency."
          },
          research_nodes: [
            {
              title: "Stoicism",
              summary: "Stoicism teaches self-control and fortitude to overcome destructive emotions and emphasizes virtue, reason, and what is within our control.",
              url: "https://en.wikipedia.org/wiki/Stoicism",
              thumbnail: null,
              categories: ["Philosophy", "Ethics"],
              links: [],
              source: "wiki",
              sourceName: "WIKIPEDIA",
              confidence: "High",
              decisionMeta: { decision: "Build discipline system for better decisions", time: "90 days", stake: "Execution consistency", success: "Higher follow-through", options: "Stoic routines vs ad-hoc motivation" }
            }
          ]
        }
      }
    ];

    function openExample(id) {
      const ex = EXAMPLES.find(x => x.id === id);
      if (!ex) { showToast("NOT FOUND"); return; }
      const p = { id: uid(), name: ex.name, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString(), engineState: ex.engineState };
      saveProjectToStorage(p);
      loadProjectIntoApp(p);
      showToast("EXAMPLE LOADED");
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // PAGES
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderHome() {
      setActiveNav("home");
      const hasLast = !!(localStorage.getItem(LAST_PROJECT_KEY) && loadProjectFromStorage(localStorage.getItem(LAST_PROJECT_KEY)));

      const exHtml = EXAMPLES.map(ex =>
        `<button class="btn btn-muted" style="text-align:left" onclick="openExample('${escapeHTML(ex.id)}')">${escapeHTML(ex.name)}</button>`
      ).join("");

      renderPage(`
        <div class="founder-letter">
          <div class="founder-eyebrow"><span class="pulse-dot"></span>India's Decision Research Engine</div>
          <h2 style="font-size:clamp(1.3rem,3vw,1.8rem);margin-bottom:8px">Built for the billion who decide.</h2>
          <p>Policy-grade decision intelligence â€” aligned with the <strong>IndiaAI Mission</strong>. Research any topic, build decision nodes, and export briefs.</p>
        </div>

        <div class="pill-row">
          <span class="pill pill-s">ğŸ‡®ğŸ‡³ IndiaAI Aligned</span>
          <span class="pill pill-g">ğŸŒ¿ Open Research</span>
          <span class="pill pill-b">ğŸ“‹ Policy Briefs</span>
          <span class="pill pill-w">ğŸ§  Decision AI</span>
        </div>

        <div class="stats-grid">
          <div class="stat-card"><div class="num">1.4B</div><div class="lbl">Indians Deciding Daily</div></div>
          <div class="stat-card"><div class="num">7</div><div class="lbl">IndiaAI Pillars</div></div>
          <div class="stat-card"><div class="num">10K+</div><div class="lbl">GPU Target</div></div>
          <div class="stat-card"><div class="num">âˆ</div><div class="lbl">Decisions to Support</div></div>
        </div>

        <div class="card">
          <div class="card-title">Quick Start</div>
          <p style="font-size:.88rem;color:var(--text-dim);line-height:1.7;">
            <strong style="color:var(--text-main)">Search</strong> any topic â†’ select result â†’ build nodes.<br>
            <strong style="color:var(--text-main)">Synthesis</strong> â†’ capture thesis + takeaways.<br>
            <strong style="color:var(--text-main)">Export</strong> as PDF.<br>
            <strong style="color:var(--text-main)">Share</strong> via link.
          </p>
        </div>

        <div class="card">
          <div class="card-title">Load Example</div>
          <div class="btn-grid" style="grid-template-columns:1fr;gap:10px;margin-top:0">${exHtml}</div>
        </div>

        <div class="btn-grid">
          <button class="btn btn-pro btn-full" onclick="navigateTo('research')">OPEN RESEARCH TOOL</button>
          <button class="btn btn-policy btn-full" onclick="navigateTo('policy')">INDIAAI POLICY â†’</button>
          <button class="btn btn-india btn-full" onclick="navigateTo('founder')">FOUNDER LETTER â†’</button>
          <button class="btn btn-full ${hasLast ? '' : 'btn-muted'}" onclick="continueLastProject()">CONTINUE LAST PROJECT</button>
          <button class="btn" onclick="importShareLinkPrompt()">IMPORT SHARE LINK</button>
          <button class="btn btn-muted" onclick="openProjectPicker()">LOAD SAVED PROJECT</button>
        </div>

        <div class="nav-hint"><span>â˜° Sidebar</span><span>âœ Notes</span></div>
      `, "decide.engine", "INDIAAI", "india");
    }

    function renderSearch() {
      setActiveNav("research");
      const srcHtml = Object.entries(WIKI_ENGINE.sources)
        .map(([k, s]) => `<div class="source-chip ${WIKI_ENGINE.activeSource === k ? 'active' : ''}" onclick="selectSource('${k}')">${s.icon} ${s.name}</div>`)
        .join("");

      renderPage(`
        <h1>Research Tool</h1>
        <p class="primary-question">Search any topic to begin your decision-linked research journey.</p>
        <input id="search-input" class="form-input" type="text" placeholder="e.g. IndiaAI, Stoicism, Food Securityâ€¦" style="font-size:1rem;padding:14px 16px;" />
        <div class="source-row" id="source-row">${srcHtml}</div>
        <div class="btn-grid">
          <button class="btn btn-india btn-full" onclick="handleSearch()">SEARCH â†’</button>
          <button class="btn btn-muted btn-full" onclick="navigateTo('home')">â† HOME</button>
        </div>
      `, "Decision Research", "SEARCH", "");

      setTimeout(() => {
        const inp = document.getElementById("search-input");
        if (inp) {
          inp.focus();
          inp.addEventListener("keydown", (e) => { if (e.key === "Enter") handleSearch(); });
        }
      }, 50);
    }

    function selectSource(key) {
      WIKI_ENGINE.activeSource = key;
      document.querySelectorAll(".source-chip").forEach(el => el.classList.remove("active"));
      // We don't rely on `event` (can be undefined); re-render chips:
      renderSearch();
      showToast(WIKI_ENGINE.sources[key].name + " SELECTED");
    }

    async function handleSearch() {
      const inp = document.getElementById("search-input");
      const q = inp?.value?.trim();
      if (!q) { showToast("TYPE SOMETHING"); return; }
      showToast("SEARCHING...");
      const results = await WIKI_ENGINE.search(q, WIKI_ENGINE.activeSource);
      if (!results?.length) { showToast("NO RESULTS"); return; }
      renderResults(q, results);
    }

    function renderResults(query, results) {
      const src = WIKI_ENGINE.sources[WIKI_ENGINE.activeSource];
      const btnHtml = results.map((r, i) =>
        `<button class="btn btn-muted" style="text-align:left" onclick="openResult('${escapeHTML(r.title)}')">${i + 1}. ${escapeHTML(r.title)}</button>`
      ).join("");

      renderPage(`
        <h1>${escapeHTML(query)}</h1>
        <p class="primary-question">Select a node. Source: <strong style="color:var(--accent-go)">${escapeHTML(src.name)}</strong></p>
        <div class="btn-grid" style="grid-template-columns:1fr;gap:10px;margin-top:0">${btnHtml}</div>
        <div class="btn-grid" style="margin-top:14px">
          <button class="btn btn-muted btn-full" onclick="renderSearch()">â† BACK TO SEARCH</button>
        </div>
      `, escapeHTML(query), src.name, "");
    }

    async function openResult(title) {
      showToast("LOADING...");
      const ctx = await WIKI_ENGINE.getContext(title, WIKI_ENGINE.activeSource);
      if (!ctx) { showToast("FAILED TO LOAD"); return; }
      currentDecisionContext = {
        title: ctx.title, summary: ctx.summary, url: ctx.url, thumbnail: ctx.thumbnail,
        categories: ctx.categories || [], links: ctx.links || [],
        source: ctx.source, sourceName: ctx.sourceName, confidence: ctx.confidence,
        decisionMeta: {}
      };
      renderDecisionMeta(currentDecisionContext);
    }

    function renderDecisionMeta(ctx) {
      renderPage(`
        <h1 style="font-size:1.4rem">Link this node</h1>
        <p class="primary-question">Capture the decision context this research supports (optional).</p>
        <div class="card">
          <div class="card-title">Decision Context</div>
          <input class="form-input" id="meta-decision" placeholder="Decision (e.g. cut sugar, choose phone)">
          <input class="form-input" id="meta-time" placeholder="Time horizon (e.g. 90 days, 5 years)">
          <input class="form-input" id="meta-stake" placeholder="Stake (e.g. health, budget, policy)">
          <input class="form-input" id="meta-success" placeholder="Success metric">
          <input class="form-input" id="meta-options" style="margin-bottom:0" placeholder="Options (e.g. A vs B vs C)">
        </div>
        <div class="btn-grid">
          <button class="btn btn-pro btn-full" onclick="saveDecisionMeta()">SAVE META & RESEARCH</button>
          <button class="btn btn-muted btn-full" onclick="skipDecisionMeta()">SKIP META</button>
        </div>
      `, "Decision Meta", "LINK", "");
    }

    function saveDecisionMeta() {
      if (!currentDecisionContext) return;
      currentDecisionContext.decisionMeta = {
        decision: document.getElementById("meta-decision")?.value?.trim() || "",
        time: document.getElementById("meta-time")?.value?.trim() || "",
        stake: document.getElementById("meta-stake")?.value?.trim() || "",
        success: document.getElementById("meta-success")?.value?.trim() || "",
        options: document.getElementById("meta-options")?.value?.trim() || "",
      };
      ENGINE_STATE.research_nodes = [currentDecisionContext];
      ENGINE_STATE.synthesis = null;
      currentDecisionContext = null;
      buildAndRenderDeck(ENGINE_STATE.research_nodes[0]);
      autosaveIfPossible();
    }
    function skipDecisionMeta() {
      if (!currentDecisionContext) return;
      currentDecisionContext.decisionMeta = { decision: "", time: "", stake: "", success: "", options: "" };
      ENGINE_STATE.research_nodes = [currentDecisionContext];
      ENGINE_STATE.synthesis = null;
      currentDecisionContext = null;
      buildAndRenderDeck(ENGINE_STATE.research_nodes[0]);
      autosaveIfPossible();
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // RESEARCH DECK (simple + stable)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let _currentNodeIdx = 0;
    let _allNodes = [];

    async function buildAndRenderDeck(seedNode) {
      _allNodes = [seedNode];
      _currentNodeIdx = 0;
      ENGINE_STATE.research_nodes = _allNodes;

      showNodePage(seedNode, 0, _allNodes);
      history.pushState({ route: "node", title: seedNode.title }, "", "#node=" + encodeURIComponent(seedNode.title));

      // Load up to 5 linked nodes (best-effort)
      if (seedNode.links?.length) {
        const names = seedNode.links.slice(0, 5).map(l => l.name).filter(Boolean);
        for (const name of names) {
          const ctx = await WIKI_ENGINE.getContext(name, WIKI_ENGINE.activeSource);
          if (!ctx) continue;
          _allNodes.push({
            title: ctx.title, summary: ctx.summary, url: ctx.url, thumbnail: ctx.thumbnail,
            categories: ctx.categories || [], links: ctx.links || [],
            source: ctx.source, sourceName: ctx.sourceName, confidence: ctx.confidence,
            decisionMeta: seedNode.decisionMeta || {}
          });
          ENGINE_STATE.research_nodes = [..._allNodes];
          updateSidebarStats();
          autosaveIfPossible();
        }
      }
    }

    function renderResearchDeck(nodes, synthesis) {
      _allNodes = [...(nodes || [])];
      _currentNodeIdx = 0;
      ENGINE_STATE.research_nodes = _allNodes;
      ENGINE_STATE.synthesis = synthesis || null;
      if (_allNodes.length) showNodePage(_allNodes[0], 0, _allNodes);
      updateSidebarStats();
    }

    function goToNode(idx) {
      if (idx < 0 || idx >= _allNodes.length) return;
      showNodePage(_allNodes[idx], idx, _allNodes);
      if (_allNodes[idx]?.title) history.replaceState({ route: "node", title: _allNodes[idx].title }, "", "#node=" + encodeURIComponent(_allNodes[idx].title));
    }

    function showNodePage(node, idx, all) {
      _currentNodeIdx = idx;
      setActiveNav("research");

      const words = wordCount(node.summary || "");
      const rt = readingTime(words);
      const takeaways = extractTakeaways(node.summary || "", 4);
      const total = all.length;
      updateDepth(idx, total);

      const cats = (node.categories || []).slice(0, 4).map(c => `<span class="pill pill-w">${escapeHTML(c)}</span>`).join("");

      const navHtml = total > 1 ? `
        <div class="btn-grid">
          <button class="btn btn-muted" onclick="goToNode(${idx - 1})" ${idx === 0 ? 'disabled style="opacity:.4"' : ''}>â† PREV</button>
          <button class="btn btn-muted" onclick="goToNode(${idx + 1})" ${idx === total - 1 ? 'disabled style="opacity:.4"' : ''}>NEXT â†’</button>
          <button class="btn btn-muted btn-full" onclick="navigateTo('synthesis')">SYNTHESIS â†’</button>
        </div>
        <div class="nav-hint"><span>NODE ${idx + 1} / ${total}</span><span>â˜° Sidebar</span></div>
      ` : `
        <div class="btn-grid">
          <button class="btn btn-muted btn-full" onclick="navigateTo('synthesis')">SYNTHESIS â†’</button>
        </div>
      `;

      renderPage(`
        <div class="card glow">
          <div style="display:flex;gap:14px;align-items:flex-start">
            <div style="width:64px;height:64px;border-radius:12px;background:var(--bg-deep);border:1px solid var(--border);overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:1.5rem">
              ${node.thumbnail ? `<img src="${escapeHTML(node.thumbnail)}" alt="" style="width:100%;height:100%;object-fit:cover" loading="lazy">` : "ğŸ”"}
            </div>
            <div style="flex:1;min-width:0">
              <div style="font-family:var(--font-mono);font-size:.58rem;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px">
                Research node Â· <span style="color:var(--accent-go)">${escapeHTML(node.confidence || "High")}</span>
              </div>
              <h1 style="font-size:clamp(1.1rem,3vw,1.7rem);margin-bottom:8px">${escapeHTML(node.title || "")}</h1>
              <div class="pill-row" style="margin:0">
                <span class="pill pill-w">${words} words</span>
                <span class="pill pill-g">${rt} min</span>
                <span class="pill pill-s">${escapeHTML(node.sourceName || "LOCAL")}</span>
              </div>
            </div>
          </div>
          <div class="pill-row" style="margin:10px 0 0">${cats}</div>
        </div>

        ${node.decisionMeta?.decision ? `
          <div class="card blue-glow">
            <div class="card-title">Decision Context</div>
            <div style="color:var(--text-dim);line-height:1.7;font-size:.9rem">
              <strong style="color:var(--text-main)">Decision:</strong> ${escapeHTML(node.decisionMeta.decision)}<br>
              <strong style="color:var(--text-main)">Stake:</strong> ${escapeHTML(node.decisionMeta.stake || "â€”")} Â·
              <strong style="color:var(--text-main)">Time:</strong> ${escapeHTML(node.decisionMeta.time || "â€”")}
            </div>
          </div>
        ` : ""}

        <div class="card">
          <div class="card-title">Key Takeaways</div>
          <ul style="padding-left:18px;line-height:1.7;color:var(--text-dim);font-size:.92rem">
            ${(takeaways.length ? takeaways : ["No takeaways available."]).map(t => `<li>${escapeHTML(t)}</li>`).join("")}
          </ul>
        </div>

        <div class="card">
          <div class="card-title">Summary</div>
          <div style="line-height:1.8;color:var(--text-main);font-size:.95rem;user-select:text">
            ${escapeHTML(node.summary || "No summary.")}
          </div>
          <div style="margin-top:10px;font-family:var(--font-mono);font-size:.72rem;color:var(--text-dim);word-break:break-word">
            ${node.url ? `Source: ${escapeHTML(node.url)}` : ""}
          </div>
        </div>

        <div class="btn-grid">
          <button class="btn btn-yt" onclick="openYT('${escapeHTML(node.title || "")}')">â–¶ YouTube</button>
          <button class="btn btn-policy" onclick="openWiki('${escapeHTML(node.title || "")}')">Open Wiki</button>
          <button class="btn btn-muted" onclick="saveCurrentProjectPrompt()">Save Project</button>
          <button class="btn btn-muted" onclick="shareCurrentProject()">Share Link</button>
          <button class="btn btn-india btn-full" onclick="renderSearch()">NEW SEARCH</button>
        </div>

        ${navHtml}
      `, escapeHTML(node.title || "Node"), escapeHTML(node.sourceName || "LOCAL"), "");
    }

    function openYT(topic) {
      window.open(`https://www.youtube.com/results?search_query=${encodeURIComponent(topic + " explained")}`, "_blank");
    }
    function openWiki(title) {
      window.open(`https://en.wikipedia.org/wiki/Special:Search?search=${encodeURIComponent(title)}`, "_blank");
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SYNTHESIS
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderSynthesis() {
      if (!ENGINE_STATE.research_nodes?.length) { showToast("NO NODES YET"); return; }
      setActiveNav("synthesis");

      const all = [];
      ENGINE_STATE.research_nodes.forEach(n => all.push(...extractTakeaways(n.summary || "", 4)));
      const top = all.slice(0, 5);
      const syn = ENGINE_STATE.synthesis || {};

      renderPage(`
        <h1>Synthesis</h1>
        <p class="primary-question">Capture your thesis, takeaways, and decision implications.</p>

        <div class="card">
          <div class="card-title">Working Thesis</div>
          <textarea class="form-textarea" id="syn-thesis" rows="4">${escapeHTML(syn.thesis || "")}</textarea>
        </div>

        <div class="card">
          <div class="card-title">Top Takeaways (one per line)</div>
          <textarea class="form-textarea" id="syn-top" rows="6">${escapeHTML((syn.topTakeaways || top).join("\n"))}</textarea>
        </div>

        <div class="card">
          <div class="card-title">Contradictions / Open Questions</div>
          <textarea class="form-textarea" id="syn-contradictions" rows="3">${escapeHTML(syn.contradictions || "")}</textarea>
        </div>

        <div class="card">
          <div class="card-title">Decision Implications</div>
          <textarea class="form-textarea" id="syn-implications" rows="3">${escapeHTML(syn.implications || "")}</textarea>
        </div>

        <div class="card">
          <div class="card-title">Next Research Nodes</div>
          <textarea class="form-textarea" id="syn-next" rows="3">${escapeHTML(syn.next || "")}</textarea>
        </div>

        <div class="card">
          <div class="card-title">Recommendation Signals</div>
          <textarea class="form-textarea" id="syn-rec" rows="3">${escapeHTML(syn.recommendation || "")}</textarea>
        </div>

        <div class="btn-grid">
          <button class="btn btn-pro btn-full" onclick="saveSynthesis()">SAVE SYNTHESIS</button>
          <button class="btn btn-muted btn-full" onclick="navigateTo('research')">â† BACK</button>
        </div>
      `, "Synthesis", "EDIT", "");
    }

    function saveSynthesis() {
      ENGINE_STATE.synthesis = {
        thesis: document.getElementById("syn-thesis")?.value?.trim() || "",
        topTakeaways: (document.getElementById("syn-top")?.value || "").split("\n").map(s => s.trim()).filter(Boolean),
        contradictions: document.getElementById("syn-contradictions")?.value?.trim() || "",
        implications: document.getElementById("syn-implications")?.value?.trim() || "",
        next: document.getElementById("syn-next")?.value?.trim() || "",
        recommendation: document.getElementById("syn-rec")?.value?.trim() || ""
      };
      showToast("SYNTHESIS SAVED");
      autosaveIfPossible();
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // FOUNDER + POLICY
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderFounder() {
      setActiveNav("founder");
      renderPage(`
        <div class="founder-letter">
          <div class="founder-eyebrow"><span class="pulse-dot"></span>To India â€” From the Builder</div>
          <h2 style="font-size:clamp(1.2rem,3vw,1.7rem);margin-bottom:10px">We built this for the billion who decide.</h2>
          <p>Every day, over a billion Indians make decisions that shape their lives â€” often without structured information or decision scaffolding.</p>
          <p>decide.engine is a decision research layer â€” source-attributed, synthesis-driven, and aligned with IndiaAIâ€™s pillars.</p>
          <p><strong>AI that decides with India, not for India.</strong></p>
          <div style="margin-top:14px;padding-top:14px;border-top:1px solid rgba(255,255,255,.06);font-family:var(--font-display);font-size:.82rem;color:var(--text-dim)">
            <strong style="color:var(--saffron)">â€” The decide.engine team</strong><br>
            <span style="font-size:.76rem">Building for Bharat Â· Aligned with IndiaAI Mission</span>
          </div>
        </div>

        <div class="btn-grid">
          <button class="btn btn-policy btn-full" onclick="navigateTo('policy')">VIEW INDIAAI POLICY â†’</button>
          <button class="btn btn-pro btn-full" onclick="navigateTo('research')">START RESEARCHING</button>
          <button class="btn btn-muted btn-full" onclick="navigateTo('home')">â† HOME</button>
        </div>
      `, "Founder Letter", "INDIA AI", "india");
    }

    function renderPolicy() {
      setActiveNav("policy");
      renderPage(`
        <h1>IndiaAI Alignment</h1>
        <p class="primary-question">How decide.engine maps to India's National AI Mission pillars.</p>

        <div class="card blue-glow">
          <div class="card-title">Pillar â€” Compute</div>
          <p style="color:var(--text-dim);line-height:1.7;font-size:.9rem">
            decide.engine is lightweight and browser-native for end users; can integrate with sovereign inference later.
          </p>
        </div>

        <div class="card green-glow">
          <div class="card-title">Pillar â€” Datasets</div>
          <p style="color:var(--text-dim);line-height:1.7;font-size:.9rem">
            Structured research + attribution supports multilingual expansion and dataset generation workflows.
          </p>
        </div>

        <div class="card glow">
          <div class="card-title">Pillar â€” Responsible AI</div>
          <p style="color:var(--text-dim);line-height:1.7;font-size:.9rem">
            Source-attribution, confidence labels, and human-in-the-loop synthesis.
          </p>
        </div>

        <div class="btn-grid">
          <button class="btn btn-india btn-full" onclick="openExample('ex_indiaai')">LOAD INDIAAI EXAMPLE â†’</button>
          <button class="btn btn-pro btn-full" onclick="navigateTo('research')">START RESEARCH</button>
          <button class="btn btn-muted btn-full" onclick="navigateTo('home')">â† HOME</button>
        </div>
      `, "IndiaAI Policy", "POLICY", "");
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // QUIZ (placeholder route)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function launchQuiz() {
      showToast("Quiz page uses alchemist.html (not included here).");
      // window.open("alchemist.html","_blank");
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ROUTER (FIXED)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const ROUTE_MAP = {
      home:      () => renderHome(),
      research:  () => renderSearch(),
      search:    () => renderSearch(),
      founder:   () => renderFounder(),
      policy:    () => renderPolicy(),
      synthesis: () => renderSynthesis(),
      quiz:      () => launchQuiz(),
    };

    function resolveHash(hash) {
      if (!hash || hash === "#" || hash === "#/" ) return null;
      if (hash.startsWith("#p=")) return "project";
      if (hash.startsWith("#node=")) return "node";
      const key = hash.replace(/^#\/?/, "").toLowerCase().split("?")[0];
      return ROUTE_MAP[key] ? key : null;
    }

    function navigateTo(routeKey) {
      const fn = ROUTE_MAP[routeKey];
      closeSidebar();
      if (fn) {
        fn();
        const current = (location.hash || "").replace(/^#\/?/, "");
        if (current !== routeKey) history.pushState({ route: routeKey }, "", "#" + routeKey);
      } else {
        renderHome();
        history.pushState({ route: "home" }, "", "#home");
      }
    }

    window.addEventListener("popstate", () => {
      const hash = (location.hash || "").trim();
      const key = resolveHash(hash);
      if (!key) { renderHome(); return; }
      if (key === "project") { handleProjectHash(hash); return; }
      if (key === "node") { handleNodeHash(hash); return; }
      ROUTE_MAP[key]?.();
    });

    function handleProjectHash(hash) {
      try {
        const payload = hash.slice(3); // remove "#p="
        const p = deserializeProject(payload);
        if (!p.id) p.id = uid();
        if (!p.name) p.name = "Shared Project";
        p.updatedAt = new Date().toISOString();
        if (!p.createdAt) p.createdAt = p.updatedAt;
        saveProjectToStorage(p);
        loadProjectIntoApp(p);
        showToast("SHARED PROJECT LOADED");
      } catch (e) {
        console.error(e);
        renderHome();
        showToast("INVALID SHARE LINK");
      }
    }

    async function handleNodeHash(hash) {
      try {
        const rawTitle = decodeURIComponent(hash.slice("#node=".length));
        ENGINE_STATE.research_nodes = [];
        ENGINE_STATE.synthesis = null;
        showToast("LOADING NODE...");
        const ctx = await WIKI_ENGINE.getContext(rawTitle, WIKI_ENGINE.activeSource);
        if (!ctx) { renderSearch(); showToast("NODE NOT FOUND"); return; }
        const node = {
          title: ctx.title, summary: ctx.summary, url: ctx.url, thumbnail: ctx.thumbnail,
          categories: ctx.categories || [], links: ctx.links || [],
          source: ctx.source, sourceName: ctx.sourceName, confidence: ctx.confidence,
          decisionMeta: {}
        };
        ENGINE_STATE.research_nodes = [node];
        buildAndRenderDeck(node);
      } catch (e) {
        console.error(e);
        renderSearch();
      }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // BOOT (FIXED)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function boot() {
      setTimeout(() => {
        const ls = document.getElementById("loading-screen");
        if (ls) {
          ls.classList.add("fade-out");
          setTimeout(() => ls.classList.add("hidden"), 600);
        }
      }, 800);

      try {
        const hash = (location.hash || "").trim();
        const key = resolveHash(hash);

        if (key === "project") { handleProjectHash(hash); return; }
        if (key === "node") { handleNodeHash(hash); return; }
        if (key && ROUTE_MAP[key]) { ROUTE_MAP[key](); return; }

        renderHome();
      } catch (e) {
        console.error("[boot] error:", e);
        renderHome();
      }
    }

    // Shortcuts
    document.addEventListener("keydown", (e) => {
      if (e.target?.tagName === "INPUT" || e.target?.tagName === "TEXTAREA") return;
      if (e.key === "/" || e.key === "s") { e.preventDefault(); navigateTo("research"); }
      if (e.key === "Escape") { closeSidebar(); closeNotes(); }
    });

    if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", boot);
    else boot();
  </script>
</body>
</html>
