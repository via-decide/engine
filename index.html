<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Decide - India's Smart Marketplace</title>
<meta name="description" content="India's first commission-free marketplace. Compare products by YOUR priorities. Starting in Gujarat - Gandhidham & Rajkot." />
<meta name="theme-color" content="#ff671f" />

<!-- FAVICON -->
<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
<link rel="icon" type="image/x-icon" href="/favicon.ico" />

<!-- MANIFEST (use the one that exists in your repo; your screenshot shows manifest.json) -->
<link rel="manifest" href="/manifest.json" />

<!-- Supabase (optional - will fallback to localStorage if not configured) -->
<script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- jsPDF (optional later) -->
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --brand-orange:#ff671f;
  --border:rgba(255,255,255,0.15);
  --accent:#00e676;
  --ondc-blue:#1e88e5;
  --font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{margin:0;padding:0;min-height:100%;background:#000;color:#fff;font-family:var(--font);-webkit-font-smoothing:antialiased}
button,input,textarea{font:inherit}
button{background:none;border:none;color:inherit;cursor:pointer}
button:focus{outline:none}
[role="button"],.card,.filter-btn,.payment-option{-webkit-tap-highlight-color:transparent;user-select:none;-webkit-user-select:none}
#app{min-height:100vh;display:flex;flex-direction:column;padding:20px;padding-bottom:calc(80px + var(--safe-bottom))}

/* ===== DEMO LABELS ===== */
.demo-ribbon{
  position:fixed;top:18px;right:-52px;
  background:#ff3b3b;color:#fff;
  padding:10px 78px;
  font-weight:900;font-size:12px;letter-spacing:2px;text-transform:uppercase;
  transform:rotate(45deg);
  z-index:9999;
  box-shadow:0 10px 25px rgba(0,0,0,.35)
}
.demo-pill{
  display:inline-flex;align-items:center;gap:8px;
  padding:6px 10px;border-radius:999px;
  border:1px solid rgba(255,59,59,.45);
  background:rgba(255,59,59,.12);
  color:#ff6b6b;font-weight:900;letter-spacing:1px;font-size:.75rem;text-transform:uppercase
}
.demo-note{
  background:rgba(255,255,255,0.04);
  border:1px solid var(--border);
  border-radius:18px;
  padding:14px 16px;
  margin:0 0 16px;
  color:#bbb;
  line-height:1.65
}
.demo-note b{color:#fff}
.demo-watermark{
  position:fixed;bottom:calc(14px + var(--safe-bottom));left:14px;
  z-index:999;
  opacity:.18;
  pointer-events:none;
  font-weight:900;letter-spacing:6px;text-transform:uppercase;font-size:12px;color:#fff
}

/* HEADER */
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;gap:15px}
.header-badge{
  background:rgba(255,103,31,0.1);
  border:2px solid var(--brand-orange);
  padding:12px 18px;border-radius:12px;
  font-size:.85rem;font-weight:800;letter-spacing:1px;
  color:var(--brand-orange);
  display:flex;align-items:center;gap:10px;flex:1;
}
.status-dot{width:10px;height:10px;background:var(--accent);border-radius:50%;box-shadow:0 0 10px var(--accent);animation:pulse 2s infinite;display:inline-block}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.btn{
  background:transparent;border:2px solid rgba(255,255,255,0.3);
  padding:10px 18px;border-radius:50px;font-size:.85rem;
  font-weight:800;color:#fff;transition:.2s;
}
.btn:hover{background:rgba(255,255,255,0.1);border-color:rgba(255,255,255,0.5)}
.btn:focus-visible,.card:focus-visible,.filter-btn:focus-visible,.payment-option:focus-visible{
  outline:3px solid rgba(255,103,31,.75);outline-offset:3px;
}

/* LAYOUT */
.two-col-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:18px}
.left-col,.right-col{display:flex;flex-direction:column;gap:14px}
.col-header{text-align:center;font-size:.72rem;font-weight:900;letter-spacing:1.5px;color:#888;padding:10px 0;border-bottom:1px solid var(--border);margin-bottom:4px}

/* CARDS */
.card{
  background:rgba(20,20,20,0.6);border:1px solid var(--border);
  border-radius:22px;padding:20px 16px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:10px;cursor:pointer;transition:.2s;min-height:120px;
}
.card:hover{background:rgba(40,40,40,0.8);border-color:rgba(255,255,255,0.3);transform:translateY(-3px)}
.card[aria-disabled="true"]{opacity:.35;cursor:not-allowed;pointer-events:none}
.icon{font-size:2.6rem}
.title{font-size:1rem;font-weight:900;letter-spacing:.5px;text-align:center;margin:0;line-height:1.2}
.tag{font-size:.7rem;font-weight:800;letter-spacing:1.2px;padding:4px 10px;border-radius:8px;text-align:center}
.tag-live{color:var(--accent);background:rgba(0,230,118,0.15)}
.tag-neutral{color:#888;background:rgba(136,136,136,0.15)}
.tag-soon{color:#FFA726;background:rgba(255,167,38,0.15)}
.tag-beta{color:#4CAF50;background:rgba(76,175,80,0.15)}
.tag-city{color:#42A5F5;background:rgba(66,165,245,0.15)}

.action-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:16px}

/* SCREENS */
.wrap{max-width:760px;margin:0 auto;width:100%}
.h1{font-size:1.7rem;font-weight:900;margin:0 0 14px;text-align:center;text-transform:uppercase}
.p{text-align:center;color:#888;margin:0 0 18px;line-height:1.55}

/* FILTERS */
.filter-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:18px}
.filter-btn{
  background:rgba(20,20,20,0.6);border:2px solid var(--border);
  padding:18px;border-radius:16px;text-align:center;font-weight:900;font-size:1rem;
  cursor:pointer;transition:.2s;text-transform:uppercase;
}
.filter-btn:hover{background:rgba(40,40,40,0.8);border-color:rgba(255,255,255,0.3)}
.filter-btn.active{background:var(--brand-orange);color:#000;border-color:var(--brand-orange)}

.action{
  background:var(--brand-orange);color:#000;border:none;padding:16px;border-radius:16px;
  font-weight:900;font-size:1rem;cursor:pointer;width:100%;
  transition:.2s;text-transform:uppercase;
}
.action:hover{background:#ff7d3f;transform:translateY(-2px)}
.secondary{
  background:transparent;color:#fff;border:2px solid var(--border);padding:14px;border-radius:16px;
  font-weight:900;font-size:.95rem;cursor:pointer;width:100%;transition:.2s;text-transform:uppercase;
}
.secondary:hover{background:rgba(255,255,255,0.1);border-color:rgba(255,255,255,0.3)}

/* RESULTS */
.results{max-width:860px;margin:0 auto;padding:8px 0}
.result{
  background:rgba(20,20,20,0.6);border:1px solid var(--border);
  border-radius:18px;padding:18px;margin-bottom:12px;transition:.2s;
}
.result:hover{background:rgba(30,30,30,0.8);border-color:rgba(255,255,255,0.3)}
.row{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
.name{font-size:1.12rem;font-weight:900;margin:0 0 6px}
.seller{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.badge{background:rgba(30,136,229,0.2);color:var(--ondc-blue);padding:4px 10px;border-radius:8px;font-size:.75rem;font-weight:800}
.rating{color:#FFA726;font-size:.85rem}
.price{text-align:right}
.price-main{font-size:1.6rem;font-weight:900;color:var(--brand-orange)}
.details{
  display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:14px 0;padding:14px;
  background:rgba(255,255,255,0.03);border-radius:12px;
}
.label{color:#888;font-size:.85rem}
.value{font-weight:800;font-size:.9rem}
.actions{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.buy{background:var(--brand-orange);color:#000;border:none;padding:12px;border-radius:12px;font-weight:900;cursor:pointer;transition:.2s}
.buy:hover{background:#ff7d3f;transform:translateY(-2px)}
.add{background:transparent;color:#fff;border:1px solid var(--border);padding:12px;border-radius:12px;font-weight:800;cursor:pointer;transition:.2s}
.add:hover{background:rgba(255,255,255,0.1)}

/* Payment */
.payment-box{
  background:rgba(255,255,255,0.03);
  border:1px solid var(--border);
  border-radius:18px;
  padding:18px;
  margin-bottom:14px;
}
.payment-option{
  display:flex;align-items:center;gap:12px;
  padding:14px;border-radius:14px;border:1px solid var(--border);
  margin-bottom:10px;
  cursor:pointer;transition:.2s
}
.payment-option:hover{background:rgba(255,255,255,0.05)}
.payment-option.selected{border-color:var(--brand-orange);background:rgba(255,103,31,0.10)}
.kbd{
  display:inline-flex;align-items:center;justify-content:center;
  padding:6px 10px;border-radius:10px;
  border:1px solid rgba(255,255,255,0.18);
  background:rgba(255,255,255,0.03);
  font-weight:900;font-size:.85rem;
}
input,textarea{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:1px solid var(--border);
  background:rgba(255,255,255,0.05);
  color:#fff;
  outline:none;
}
textarea{min-height:120px;resize:vertical}

/* Tracking */
.tracking-status{background:rgba(255,103,31,0.08);border:1px solid var(--border);border-radius:18px;padding:16px;margin-bottom:14px}
.tracking-timeline{position:relative;padding:10px 0}
.timeline-item{position:relative;padding-left:48px;padding-bottom:22px}
.timeline-item:last-child{padding-bottom:0}
.timeline-dot{position:absolute;left:0;width:30px;height:30px;background:#555;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1rem}
.timeline-item.active .timeline-dot{background:var(--accent);box-shadow:0 0 12px var(--accent)}
.timeline-line{position:absolute;left:15px;top:30px;width:2px;height:calc(100% - 30px);background:#333}
.timeline-item.active .timeline-line{background:var(--accent)}
.timeline-item:last-child .timeline-line{display:none}
.timeline-content{font-weight:900;margin-bottom:4px}
.timeline-time{font-size:.85rem;color:#888}

/* Toast */
.toast{
  position:fixed;bottom:calc(24px + var(--safe-bottom));left:50%;transform:translateX(-50%);
  background:#111;border:1px solid #333;padding:12px 18px;border-radius:999px;
  font-size:.85rem;opacity:0;transition:opacity .2s;z-index:1000;
}
.toast.show{opacity:1}

/* Footer links */
.footer{text-align:center;margin-top:30px;padding-top:20px;border-top:1px solid var(--border);color:#666;font-size:.85rem}
.footer a{color:#888;margin:0 10px;text-decoration:none}
.footer a:hover{color:var(--brand-orange)}

@media (max-width:600px){
  .two-col-grid{grid-template-columns:1fr}
  .details{grid-template-columns:1fr}
  .actions{grid-template-columns:1fr}
}
</style>
</head>

<body>
<div class="demo-ribbon">DEMO</div>
<div class="demo-watermark">DEMO</div>

<div id="app"></div>
<div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true"></div>

<script>
(function(){
  "use strict";

  // ======================
  // SUPABASE CONFIG
  // ======================
  // Leave as-is for DEMO (localStorage fallback).
  // When ready, replace with real values.
  const SUPABASE_URL = "YOUR_SUPABASE_URL";
  const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";

  let supabase = null;

  function initSupabase(){
    try{
      if(window.supabase && window.supabase.createClient){
        if(!SUPABASE_URL || !SUPABASE_ANON_KEY) return null;
        if(String(SUPABASE_URL).includes("YOUR_SUPABASE")) return null;
        if(String(SUPABASE_ANON_KEY).includes("YOUR_SUPABASE")) return null;
        return window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      }
    }catch(e){}
    return null;
  }

  // ---------- helpers ----------
  function $(id){ return document.getElementById(id); }
  function esc(s){
    s = String(s == null ? "" : s);
    return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }
  function toast(msg){
    var t = $("toast"); if(!t) return;
    t.textContent = String(msg || "");
    t.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(function(){ t.classList.remove("show"); }, 2200);
  }
  function safeId(){
    try{ if(window.crypto && crypto.randomUUID) return crypto.randomUUID(); }catch(e){}
    return "dev-" + Math.random().toString(36).slice(2) + "-" + Date.now().toString(36);
  }
  function money(n){ return "‚Çπ" + Number(n||0).toLocaleString("en-IN"); }

  // ---------- device/session ----------
  var DEVICE_ID = localStorage.getItem("decide_device_id");
  if(!DEVICE_ID){ DEVICE_ID = safeId(); localStorage.setItem("decide_device_id", DEVICE_ID); }

  var STATE = {
    domain: null,
    filters: [],
    cart: [],
    orders: [],
    session: "SID-" + Math.random().toString(36).slice(2,6).toUpperCase(),
    selectedRestaurantId: null,
    liveTrackingInterval: null,
    lastEcomCategory: null
  };

  // ---------- demo data ----------
  var ECOMMERCE_DATA = [
    {category:"smartphones",name:"iPhone 15 Pro",price:134900,cam:9,gam:9,bat:7,seller:"Apple Store",rating:4.8,stock:50,delivery:"2 days",warranty:"1 year",city:"Gandhidham"},
    {category:"smartphones",name:"Samsung S24 Ultra",price:129999,cam:10,gam:9,bat:8,seller:"Samsung",rating:4.9,stock:40,delivery:"3 days",warranty:"1 year",city:"Gandhidham"},
    {category:"smartphones",name:"OnePlus 12",price:63999,cam:8,gam:9,bat:9,seller:"OnePlus",rating:4.7,stock:110,delivery:"1 day",warranty:"1 year",city:"Gandhidham"},
    {category:"earbuds",name:"AirPods Pro 2",price:24499,snd:9,anc:10,mic:9,seller:"Apple Store",rating:4.8,stock:150,delivery:"1 day",warranty:"1 year",city:"Gandhidham"},
    {category:"earbuds",name:"Sony WF-1000XM5",price:23990,snd:10,anc:10,mic:8,seller:"Sony",rating:4.8,stock:90,delivery:"1 day",warranty:"1 year",city:"Gandhidham"},
    {category:"laptops",name:"MacBook Air M3",price:113900,perf:9,port:7,scr:9,seller:"Apple Store",rating:4.8,stock:55,delivery:"2 days",warranty:"1 year",city:"Gandhidham"},
    {category:"laptops",name:"Dell XPS 13",price:139990,perf:8,port:6,scr:9,seller:"Dell",rating:4.7,stock:40,delivery:"4 days",warranty:"1 year",city:"Gandhidham"}
  ];

  var FOOD_DATA = {
    restaurants: [
      {
        id: "rajkot-thali-001",
        name: "Unlimited Gujarati Thali",
        brand: "Family Restaurant",
        city: "Rajkot",
        area: "Race Course Road",
        priceHint: 150,
        // ‚úÖ CHANGE THIS LINE for real UPI ID later
        upiId: "6351537770@yapl",
        whatsapp: "https://wa.me/91XXXXXXXXXX",
        hours: "11:00 AM - 3:30 PM, 7:00 PM - 10:30 PM",
        tags: ["veg","family","unlimited"],
        menu: [
          { id:"thali-150", name:"Unlimited Gujarati Thali", price:150, veg:true, desc:"Traditional unlimited thali", prepMins:20 },
          { id:"pavbhaji-120", name:"Pav Bhaji", price:120, veg:true, desc:"Butter pav bhaji", prepMins:20 },
          { id:"chaas-25", name:"Chaas", price:25, veg:true, desc:"Fresh buttermilk", prepMins:5 }
        ]
      }
    ]
  };

  // ---------- memory db ----------
  var DB = { smartphones:{}, earbuds:{}, laptops:{} };
  var RESULTS = [];
  var payMethod = null;

  function loadToMemory(arr){
    DB = { smartphones:{}, earbuds:{}, laptops:{} };
    (arr || []).forEach(function(p){
      if(!p || !p.category || !p.name) return;
      if(!DB[p.category]) DB[p.category] = {};
      if(!DB[p.category][p.name]) DB[p.category][p.name] = [];
      DB[p.category][p.name].push({
        name:p.name,
        price:Number(p.price)||0,
        seller:p.seller||"Seller",
        rating:Number(p.rating)||4.0,
        stock:Number(p.stock)||0,
        delivery:p.delivery||"2-5 days",
        warranty:p.warranty||"6 months",
        city:p.city||"",
        attr:{
          cam:Number(p.cam)||0, gam:Number(p.gam)||0, bat:Number(p.bat)||0,
          snd:Number(p.snd)||0, anc:Number(p.anc)||0, mic:Number(p.mic)||0,
          perf:Number(p.perf)||0, port:Number(p.port)||0, scr:Number(p.scr)||0
        }
      });
    });
  }

  function loadOrders(){
    try{
      var x = JSON.parse(localStorage.getItem("order_history") || "[]");
      STATE.orders = Array.isArray(x) ? x : [];
    }catch(e){ STATE.orders = []; }
  }
  function saveOrders(){
    try{ localStorage.setItem("order_history", JSON.stringify(STATE.orders)); }catch(e){}
  }

  // UTR index (for duplicate detection)
  function loadUtrIndex(){
    try{
      var x = JSON.parse(localStorage.getItem("utr_index") || "{}");
      return (x && typeof x === "object") ? x : {};
    }catch(e){ return {}; }
  }
  function saveUtrIndex(idx){
    try{ localStorage.setItem("utr_index", JSON.stringify(idx || {})); }catch(e){}
  }

  // ---------- live tracking ----------
  function stopLiveTracking(){
    if(STATE.liveTrackingInterval){
      clearInterval(STATE.liveTrackingInterval);
      STATE.liveTrackingInterval = null;
    }
  }

  // ======================
  // SUPABASE: Safe wrappers (fallback to local)
  // ======================
  async function submitFeedbackSupabase(title, message){
    if(!supabase){
      saveFeedbackLocal(title, message);
      toast("Saved locally (demo)");
      return true;
    }
    try{
      const { error } = await supabase.from("feedback").insert([{
        title: title || "Feedback",
        message: message,
        device_id: DEVICE_ID
      }]);
      if(error) throw error;
      toast("‚úÖ Feedback saved!");
      return true;
    }catch(err){
      console.error("Feedback error:", err);
      saveFeedbackLocal(title, message);
      toast("Saved locally (demo)");
      return true;
    }
  }

  function saveFeedbackLocal(title, message){
    try{
      var arr = JSON.parse(localStorage.getItem("feedback_items") || "[]");
      if(!Array.isArray(arr)) arr = [];
      arr.push({ id:safeId(), title:title||"Feedback", message:message, ts:new Date().toISOString(), device:DEVICE_ID });
      localStorage.setItem("feedback_items", JSON.stringify(arr));
    }catch(e){}
  }

  async function submitSellerInterestSupabase(type, businessName, city, phone, idea){
    var payload = {
      category: type,
      business_name: businessName,
      city: city,
      phone: phone,
      idea: idea || null,
      device_id: DEVICE_ID
    };

    if(!supabase){
      saveSellerInterestLocal(type, businessName, city, phone, idea);
      toast("Submitted (local demo)");
      return true;
    }

    try{
      const { error } = await supabase.from("seller_interest").insert([payload]);
      if(error) throw error;
      toast("‚úÖ Submitted!");
      return true;
    }catch(err){
      console.error("Seller interest error:", err);
      saveSellerInterestLocal(type, businessName, city, phone, idea);
      toast("Submitted (local demo)");
      return true;
    }
  }

  function saveSellerInterestLocal(type, businessName, city, phone, idea){
    try{
      var arr = JSON.parse(localStorage.getItem("seller_interest") || "[]");
      if(!Array.isArray(arr)) arr = [];
      arr.push({ id:safeId(), type:type, businessName:businessName, city:city, phone:phone, idea:idea, device:DEVICE_ID, ts:new Date().toISOString() });
      localStorage.setItem("seller_interest", JSON.stringify(arr));
    }catch(e){}
  }

  async function joinWaitlistSupabase(email, phone, city, interest){
    if(!supabase){
      saveWaitlistLocal(email, phone, city, interest);
      toast("Saved locally (demo)");
      return true;
    }

    try{
      // soft duplicate check
      const { data: exists } = await supabase
        .from("waitlist")
        .select("id")
        .ilike("email", email)
        .maybeSingle();

      if(exists && exists.id){
        toast("Already registered!");
        return false;
      }

      const { error } = await supabase.from("waitlist").insert([{
        email: email,
        phone: phone || null,
        city: city || null,
        interest: interest || null,
        source: "website",
        device_id: DEVICE_ID
      }]);

      if(error) throw error;
      toast("‚úÖ Added to waitlist!");
      return true;
    }catch(err){
      console.error("Waitlist error:", err);
      saveWaitlistLocal(email, phone, city, interest);
      toast("Saved locally (demo)");
      return true;
    }
  }

  function saveWaitlistLocal(email, phone, city, interest){
    try{
      var arr = JSON.parse(localStorage.getItem("waitlist_local") || "[]");
      if(!Array.isArray(arr)) arr = [];
      arr.push({ id:safeId(), email:email, phone:phone||"", city:city||"", interest:interest||"", device:DEVICE_ID, ts:new Date().toISOString() });
      localStorage.setItem("waitlist_local", JSON.stringify(arr));
    }catch(e){}
  }

  // ======================
  // LANDING (fixed: no inline onclick)
  // ======================
  function isVisited(){
    return localStorage.getItem("decide_visited") === "true";
  }
  function markVisited(){
    localStorage.setItem("decide_visited","true");
  }

  function renderLanding(){
    stopLiveTracking();
    $("app").innerHTML =
      '<div class="wrap" style="text-align:center;padding-top:26px">' +
        '<div class="header" style="margin-bottom:10px">' +
          '<div class="header-badge">DECIDE INDIA <span class="status-dot" aria-hidden="true"></span> <span class="demo-pill">DEMO</span></div>' +
          '<button class="btn" type="button" data-action="home">HOME</button>' +
        '</div>' +

        '<div class="demo-note">‚ö† <b>Demo build</b> ‚Äî UX testing only. Payments/UTR are demo flows.</div>' +

        '<h1 style="font-size:3rem;margin:10px 0 10px;color:var(--brand-orange);letter-spacing:2px">DECIDE</h1>' +
        '<div class="p" style="font-size:1.05rem;margin-bottom:18px;color:#bbb">India\'s Smart Marketplace (Commission-free)</div>' +

        '<div class="payment-box" style="max-width:760px;margin:0 auto 14px;text-align:left">' +
          '<div style="font-size:1.05rem;font-weight:900;margin-bottom:10px">üéØ What is Decide?</div>' +
          '<div style="color:#ccc;line-height:1.7">' +
            '‚Ä¢ <b>Smart comparison:</b> Compare products by YOUR priorities<br>' +
            '‚Ä¢ <b>Zero commission:</b> No seller commission / no paid rank<br>' +
            '‚Ä¢ <b>Local-first:</b> City-first discovery (starting Gujarat)<br>' +
            '‚Ä¢ <b>Transparent ranking:</b> No algorithm suppression' +
          '</div>' +
        '</div>' +

        '<div class="payment-box" style="max-width:760px;margin:0 auto 14px;text-align:left">' +
          '<div style="font-size:1.05rem;font-weight:900;margin-bottom:10px">üöÄ What\'s Live Now?</div>' +
          '<div style="color:#ccc;line-height:1.7">' +
            '‚úÖ <b>Gandhidham:</b> E-commerce (phones, laptops, audio)<br>' +
            '‚úÖ <b>Rajkot:</b> Food (UPI ‚Üí UTR flow for UX)<br>' +
            '‚è≥ <b>Next:</b> Ahmedabad ‚Üí Surat ‚Üí All India' +
          '</div>' +
        '</div>' +

        '<div class="payment-box" style="max-width:760px;margin:0 auto 18px;text-align:left">' +
          '<div style="font-size:1.05rem;font-weight:900;margin-bottom:10px">üìß Join Waitlist</div>' +
          '<div class="label">Email</div>' +
          '<input id="wl_email" type="email" placeholder="you@gmail.com" style="margin:8px 0 10px" />' +
          '<div class="label">City (optional)</div>' +
          '<input id="wl_city" placeholder="e.g. Rajkot" style="margin:8px 0 10px" />' +
          '<div class="label">I am (optional)</div>' +
          '<input id="wl_interest" placeholder="buyer / seller / developer" style="margin:8px 0 12px" />' +
          '<button class="action" type="button" data-action="waitlistSubmit">GET EARLY ACCESS</button>' +
          '<div style="color:#777;font-size:.85rem;margin-top:10px;line-height:1.6">We store only minimal info. You can request removal anytime.</div>' +
        '</div>' +

        '<button class="secondary" type="button" data-action="lobby">SKIP TO DEMO ‚Üí</button>' +

        '<div class="footer">' +
          '<a href="/privacy.html">Privacy</a> ‚Ä¢ ' +
          '<a href="/terms.html">Terms</a> ‚Ä¢ ' +
          '<a href="/contact.html">Contact</a>' +
        '</div>' +
      '</div>';
  }

  function submitWaitlist(){
    var email = (($("wl_email")||{}).value || "").trim();
    var city = (($("wl_city")||{}).value || "").trim();
    var interest = (($("wl_interest")||{}).value || "").trim();

    if(!email || email.indexOf("@") < 1){
      toast("Enter valid email");
      return;
    }

    joinWaitlistSupabase(email, null, city, interest || "landing")
      .then(function(ok){
        if(ok){
          markVisited();
          setTimeout(function(){ renderLobby(); }, 700);
        }
      });
  }

  // ---------- lobby ----------
  function renderLobby(){
    stopLiveTracking();
    var app = $("app");
    var cartCount = STATE.cart.length;

    app.innerHTML =
      '<div class="header">' +
        '<div class="header-badge">DECIDE INDIA <span class="status-dot" aria-hidden="true"></span> <span class="demo-pill">DEMO</span></div>' +
        '<button class="btn" type="button" data-action="home">HOME</button>' +
      '</div>' +

      '<div class="demo-note">‚ö† <b>Demo build</b> ‚Äî Payments & confirmations are for testing UX. Data saved locally (unless Supabase connected).</div>' +

      '<div class="two-col-grid">' +

        '<div class="left-col">' +
          '<div class="col-header">MAIN CATEGORIES</div>' +

          '<div class="card" role="button" tabindex="0" data-action="seller">' +
            '<div class="icon">üè™</div><div class="title">BECOME A SELLER</div>' +
            '<div class="tag" style="background:var(--brand-orange);color:#000">START</div>' +
          '</div>' +

          '<div class="card" role="button" tabindex="0" data-action="module" data-module="ecommerce">' +
            '<div class="icon">üõçÔ∏è</div><div class="title">E-COMMERCE</div><div class="tag tag-live">GANDHIDHAM</div>' +
          '</div>' +

          '<div class="card" role="button" tabindex="0" data-action="module" data-module="food">' +
            '<div class="icon">üçΩÔ∏è</div><div class="title">FOOD</div><div class="tag tag-live">RAJKOT ‚Ä¢ UPI</div>' +
          '</div>' +

          '<div class="card" role="button" tabindex="0" aria-disabled="true">' +
            '<div class="icon">üëï</div><div class="title">FASHION</div><div class="tag tag-soon">DISABLED</div>' +
          '</div>' +

          '<div class="card" role="button" tabindex="0" aria-disabled="true">' +
            '<div class="icon">üõí</div><div class="title">GROCERIES</div><div class="tag tag-soon">DISABLED</div>' +
          '</div>' +

          '<div class="card" role="button" tabindex="0" aria-disabled="true">' +
            '<div class="icon">üï∂Ô∏è</div><div class="title">ACCESSORIES</div><div class="tag tag-soon">DISABLED</div>' +
          '</div>' +

          '<div class="card" role="button" tabindex="0" data-action="feedback">' +
            '<div class="icon">üí¨</div><div class="title">FEEDBACK CENTER</div><div class="tag tag-beta">OPEN</div>' +
          '</div>' +
        '</div>' +

        '<div class="right-col">' +
          '<div class="col-header">ACTIVE MVP CITIES</div>' +

          '<div class="card" role="button" tabindex="0" data-action="city" data-city="Gandhidham">' +
            '<div class="icon">üèôÔ∏è</div><div class="title">GANDHIDHAM</div><div class="tag tag-city">E-COM LIVE</div>' +
          '</div>' +

          '<div class="card" role="button" tabindex="0" data-action="city" data-city="Rajkot">' +
            '<div class="icon">üèôÔ∏è</div><div class="title">RAJKOT</div><div class="tag tag-city">FOOD LIVE</div>' +
          '</div>' +

          '<div class="card" role="button" tabindex="0" aria-disabled="true">' +
            '<div class="icon">üèôÔ∏è</div><div class="title">AHMEDABAD</div><div class="tag tag-soon">SOON</div>' +
          '</div>' +

          '<div class="card" role="button" tabindex="0" aria-disabled="true">' +
            '<div class="icon">üèôÔ∏è</div><div class="title">SURAT</div><div class="tag tag-soon">SOON</div>' +
          '</div>' +

          '<div class="card" role="button" tabindex="0" aria-disabled="true">' +
            '<div class="icon">üáÆüá≥</div><div class="title">ALL INDIA</div><div class="tag tag-soon">PHASE 2</div>' +
          '</div>' +
        '</div>' +

      '</div>' +

      '<div class="action-grid">' +
        '<div class="card" role="button" tabindex="0" data-action="orders">' +
          '<div class="icon">üì¶</div><div class="title">MY ORDERS</div><div class="tag tag-beta">TRACK</div>' +
        '</div>' +
        '<div class="card" role="button" tabindex="0" data-action="cart" aria-disabled="' + (cartCount? "false":"true") + '">' +
          '<div class="icon">üõí</div><div class="title">CART</div><div class="tag tag-neutral">' + cartCount + ' ITEMS</div>' +
        '</div>' +
      '</div>' +

      '<div style="text-align:center;margin-top:18px;color:#888;font-size:.85rem">Session: ' + esc(STATE.session) + '</div>' +

      '<div class="footer">' +
        '<a href="/privacy.html">Privacy</a> ‚Ä¢ ' +
        '<a href="/terms.html">Terms</a> ‚Ä¢ ' +
        '<a href="/contact.html">Contact</a>' +
      '</div>';
  }

  // ---------- seller onboarding CTA ----------
  function renderSellerCTA(){
    stopLiveTracking();
    $("app").innerHTML =
      '<div class="wrap">' +
        '<div class="h1">Join Decide</div>' +
        '<div class="p">A clean, local-first way to get customers ‚Äî without commission.</div>' +

        '<div class="demo-note"><b>DEMO:</b> Seller interest is saved (Supabase if connected, otherwise local).</div>' +

        '<div class="payment-box">' +
          '<div style="font-weight:900;font-size:1.1rem;margin-bottom:10px">Why join Decide?</div>' +
          '<div style="color:#bbb;line-height:1.7">' +
            '‚Ä¢ <b>No commission</b> like big apps<br />' +
            '‚Ä¢ <b>Direct customer connection</b> (you build trust)<br />' +
            '‚Ä¢ <b>Local-first discovery</b> (city + area matters)<br />' +
            '‚Ä¢ <b>No algorithm suppression</b> (transparent listing)<br />' +
          '</div>' +
        '</div>' +

        '<div class="payment-box">' +
          '<div style="font-weight:900;margin-bottom:10px">I want to join as</div>' +
          '<div class="actions">' +
            '<button class="buy" type="button" data-action="sellerForm" data-type="Food">üçΩÔ∏è Food</button>' +
            '<button class="add" type="button" data-action="sellerForm" data-type="Electronics">üõçÔ∏è Electronics</button>' +
          '</div>' +
          '<div style="height:10px"></div>' +
          '<button class="secondary" type="button" data-action="sellerForm" data-type="Services">üß∞ Services</button>' +
        '</div>' +

        '<button class="secondary" type="button" data-action="home">‚Üê HOME</button>' +
      '</div>';
  }

  function renderSellerForm(type){
    stopLiveTracking();
    $("app").innerHTML =
      '<div class="wrap">' +
        '<div class="h1">Seller Interest</div>' +
        '<div class="p">Fast onboarding. You‚Äôll be manually verified first.</div>' +

        '<div class="payment-box">' +
          '<div class="label">Category</div>' +
          '<div class="value" style="margin:6px 0 12px">' + esc(type) + '</div>' +

          '<div class="label">Business Name</div>' +
          '<input id="s_bname" placeholder="e.g. Rajkot Thali House" />' +
          '<div style="height:10px"></div>' +

          '<div class="label">City</div>' +
          '<input id="s_city" placeholder="e.g. Rajkot" />' +
          '<div style="height:10px"></div>' +

          '<div class="label">Phone (WhatsApp)</div>' +
          '<input id="s_phone" placeholder="e.g. 9XXXXXXXXX" />' +
          '<div style="height:10px"></div>' +

          '<div class="label">Your idea (optional)</div>' +
          '<textarea id="s_idea" placeholder="Tell us what you want Decide to build for you..."></textarea>' +
        '</div>' +

        '<button class="action" type="button" data-action="sellerSubmit" data-type="' + esc(type) + '">SUBMIT INTEREST</button>' +
        '<button class="secondary" type="button" data-action="seller">‚Üê BACK</button>' +
      '</div>';
  }

  function sellerSubmit(type){
    var b = ($("s_bname")||{}).value || "";
    var c = ($("s_city")||{}).value || "";
    var p = ($("s_phone")||{}).value || "";
    var idea = ($("s_idea")||{}).value || "";

    b = b.trim(); c = c.trim(); p = p.trim();

    if(b.length < 2){ toast("Enter business name"); return; }
    if(c.length < 2){ toast("Enter city"); return; }
    if(p.length < 8){ toast("Enter valid phone"); return; }

    submitSellerInterestSupabase(type, b, c, p, idea.trim()).then(function(){
      renderLobby();
    });
  }

  // ---------- feedback center ----------
  function renderFeedbackCenter(){
    stopLiveTracking();
    var list = [];
    try{
      list = JSON.parse(localStorage.getItem("feedback_items") || "[]");
      if(!Array.isArray(list)) list = [];
    }catch(e){ list = []; }

    var itemsHtml = list.slice().reverse().map(function(it){
      return (
        '<div class="result">' +
          '<div class="name" style="font-size:1rem">' + esc(it.title || "Feedback") + '</div>' +
          '<div style="color:#888;font-size:.85rem;margin-top:6px;line-height:1.6">' + esc(it.message || "") + '</div>' +
          '<div style="color:#666;font-size:.8rem;margin-top:10px">Saved: ' + esc(new Date(it.ts).toLocaleString("en-IN")) + '</div>' +
        '</div>'
      );
    }).join("");

    $("app").innerHTML =
      '<div class="wrap">' +
        '<div class="h1">Feedback Center</div>' +
        '<div class="p">Tell your ideas. This builds real UX connection.</div>' +

        '<div class="demo-note"><b>DEMO:</b> Feedback saves to Supabase if configured, otherwise local.</div>' +

        '<div class="payment-box">' +
          '<div class="label">Title</div>' +
          '<input id="fb_title" placeholder="e.g. Add seller rating, Add swipe mode..." />' +
          '<div style="height:10px"></div>' +
          '<div class="label">Message</div>' +
          '<textarea id="fb_msg" placeholder="Write your idea in detail..."></textarea>' +
        '</div>' +

        '<button class="action" type="button" data-action="fbSubmit">SUBMIT FEEDBACK</button>' +
        '<button class="secondary" type="button" data-action="home" style="margin-top:10px">‚Üê HOME</button>' +

        '<div style="height:18px"></div>' +
        '<div class="p" style="margin-bottom:10px">Your saved feedback (local demo)</div>' +
        (itemsHtml || '<div class="p">No feedback yet.</div>') +
      '</div>';
  }

  function fbSubmit(){
    var title = (($("fb_title")||{}).value || "").trim();
    var msg = (($("fb_msg")||{}).value || "").trim();
    if(msg.length < 5){ toast("Write a longer message"); return; }
    submitFeedbackSupabase(title, msg).then(function(){
      renderFeedbackCenter();
    });
  }

  // ---------- city view ----------
  function renderCity(city){
    stopLiveTracking();
    var cards = '';
    if(city === "Gandhidham"){
      cards += cardLink("üõçÔ∏è","E-COMMERCE","LIVE","tag-live","ecommerce");
    }else if(city === "Rajkot"){
      cards += cardLink("üçΩÔ∏è","FOOD","LIVE","tag-live","food");
    }else{
      toast("City coming soon");
      renderLobby();
      return;
    }

    $("app").innerHTML =
      '<div class="wrap">' +
        '<div class="h1">' + esc(city) + '</div>' +
        '<div class="p">Available modules</div>' +
        cards +
        '<button class="secondary" type="button" data-action="home">‚Üê HOME</button>' +
      '</div>';

    function cardLink(icon,title,status,tagClass,action){
      return (
        '<div class="card" role="button" tabindex="0" data-action="' + esc(action) + '" style="margin-bottom:12px">' +
          '<div class="icon">' + icon + '</div><div class="title">' + esc(title) + '</div><div class="tag ' + tagClass + '">' + esc(status) + '</div>' +
        '</div>'
      );
    }
  }

  // ---------- ecommerce ----------
  function renderEcommerce(){
    stopLiveTracking();
    STATE.domain = "ecommerce";
    $("app").innerHTML =
      '<div class="wrap">' +
        '<div class="h1">E-COMMERCE</div>' +
        '<div class="p">Gandhidham MVP ‚Ä¢ Choose category</div>' +

        '<div class="card" role="button" tabindex="0" data-action="category" data-cat="smartphones" style="margin-bottom:12px">' +
          '<div class="icon">üì±</div><div class="title">SMARTPHONES</div><div class="tag tag-live">AVAILABLE</div>' +
        '</div>' +

        '<div class="card" role="button" tabindex="0" data-action="category" data-cat="earbuds" style="margin-bottom:12px">' +
          '<div class="icon">üéß</div><div class="title">AUDIO DEVICES</div><div class="tag tag-live">AVAILABLE</div>' +
        '</div>' +

        '<div class="card" role="button" tabindex="0" data-action="category" data-cat="laptops" style="margin-bottom:12px">' +
          '<div class="icon">üíª</div><div class="title">LAPTOPS</div><div class="tag tag-live">AVAILABLE</div>' +
        '</div>' +

        '<button class="secondary" type="button" data-action="home">‚Üê HOME</button>' +
      '</div>';
  }

  function renderFilters(cat){
    stopLiveTracking();
    STATE.domain = cat;
    STATE.lastEcomCategory = cat;
    STATE.filters = [];

    var filters = {
      smartphones:["cam","gam","bat"],
      earbuds:["snd","anc","mic"],
      laptops:["perf","port","scr"]
    };
    var labels = {
      cam:"CAMERA",gam:"GAMING",bat:"BATTERY",
      snd:"SOUND",anc:"NOISE",mic:"MIC",
      perf:"POWER",port:"TRAVEL",scr:"SCREEN"
    };

    var btns = (filters[cat] || []).map(function(f){
      return '<div class="filter-btn" role="button" tabindex="0" data-action="toggle" data-filter="' + f + '">' + labels[f] + '</div>';
    }).join("");

    $("app").innerHTML =
      '<div class="wrap">' +
        '<div class="h1">' + esc(cat) + '</div>' +
        '<div class="p">Pick priorities (tap)</div>' +
        '<div class="filter-grid">' + btns + '</div>' +
        '<button class="action" type="button" data-action="search">FIND BEST DEALS</button>' +
        '<button class="secondary" type="button" data-action="ecommerce" style="margin-top:10px">‚Üê BACK</button>' +
      '</div>';
  }

  function toggleFilter(key, el){
    var i = STATE.filters.indexOf(key);
    if(i >= 0){ STATE.filters.splice(i, 1); el.classList.remove("active"); }
    else { STATE.filters.push(key); el.classList.add("active"); }
  }

  function search(){
    var cat = STATE.domain;
    var db = DB[cat];
    if(!db || !Object.keys(db).length){ toast("No items"); return; }

    var all = [];
    Object.keys(db).forEach(function(name){
      (db[name] || []).forEach(function(seller){
        var score = 0;
        if(STATE.filters.length){
          STATE.filters.forEach(function(f){ score += (seller.attr && seller.attr[f]) ? seller.attr[f] : 0; });
        }
        all.push({
          type:"ecommerce",
          name:seller.name,
          price:seller.price,
          seller:seller.seller,
          rating:seller.rating,
          stock:seller.stock,
          delivery:seller.delivery,
          warranty:seller.warranty,
          city:seller.city,
          score:score
        });
      });
    });

    all.sort(function(a,b){
      if(b.score !== a.score) return b.score - a.score;
      return a.price - b.price;
    });

    RESULTS = all.slice(0,10);
    renderMarketplace();
  }

  function renderMarketplace(){
    stopLiveTracking();
    if(!RESULTS.length){ toast("No results"); return; }

    var list = RESULTS.map(function(p, idx){
      var discount = Math.floor(Math.random()*20)+5;
      var original = p.price ? Math.floor(p.price/(1-discount/100)) : p.price;
      var stockColor = (p.stock > 50) ? "var(--accent)" : "#FFA726";

      return (
        '<div class="result">' +
          '<div class="row">' +
            '<div>' +
              '<div class="name">' + esc(p.name) + '</div>' +
              '<div class="seller">' +
                '<span class="badge">' + esc(p.seller) + '</span>' +
                '<span class="rating">‚≠ê ' + Number(p.rating||0).toFixed(1) + '</span>' +
                '<span class="badge">' + esc(p.city) + '</span>' +
              '</div>' +
            '</div>' +
            '<div class="price">' +
              '<div class="price-main">' + money(p.price) + '</div>' +
              '<div style="font-size:.9rem;color:#888;text-decoration:line-through;margin-top:5px">' + money(original) + '</div>' +
              '<div style="color:var(--accent);font-size:.85rem;font-weight:800;margin-top:5px">' + discount + '% OFF</div>' +
            '</div>' +
          '</div>' +

          '<div class="details">' +
            '<div><div class="label">Stock</div><div class="value" style="color:' + stockColor + '">' + Number(p.stock||0) + ' units</div></div>' +
            '<div><div class="label">Delivery</div><div class="value">' + esc(p.delivery||"") + '</div></div>' +
            '<div><div class="label">Warranty</div><div class="value">' + esc(p.warranty||"") + '</div></div>' +
            '<div><div class="label">GST</div><div class="value" style="color:var(--accent)">Included ‚úì</div></div>' +
          '</div>' +

          '<div class="actions">' +
            '<button class="buy" type="button" data-action="buy" data-idx="' + idx + '">BUY NOW</button>' +
            '<button class="add" type="button" data-action="add" data-idx="' + idx + '">ADD TO CART</button>' +
          '</div>' +
        '</div>'
      );
    }).join("");

    $("app").innerHTML =
      '<div class="results">' +
        '<div style="text-align:center;margin-bottom:16px">' +
          '<h2 style="margin:0;font-size:1.6rem">BEST DEALS</h2>' +
          '<div class="p" style="margin:8px 0 0">Comparing ' + RESULTS.length + ' options</div>' +
        '</div>' +
        list +
        '<button class="secondary" type="button" data-action="category" data-cat="' + esc(STATE.lastEcomCategory || "smartphones") + '">‚Üê REFINE</button>' +
        '<button class="secondary" type="button" data-action="home" style="margin-top:10px">‚Üê HOME</button>' +
      '</div>';
  }

  // ---------- food ----------
  function renderFood(){
    stopLiveTracking();
    STATE.domain = "food";
    var restaurants = FOOD_DATA.restaurants || [];
    var cards = restaurants.map(function(r){
      return (
        '<div class="result" role="button" tabindex="0" data-action="restaurant" data-rid="' + esc(r.id) + '">' +
          '<div class="row">' +
            '<div>' +
              '<div class="name">' + esc(r.name) + '</div>' +
              '<div class="seller">' +
                '<span class="badge">' + esc(r.city) + '</span>' +
                '<span class="rating">‚≠ê 4.8</span>' +
                '<span class="badge">UPI</span>' +
              '</div>' +
              '<div style="color:#888;margin-top:8px;font-size:.9rem">' + esc(r.brand) + ' ‚Ä¢ From ' + money(r.priceHint) + '</div>' +
              '<div style="color:#888;margin-top:6px;font-size:.85rem">' + esc(r.hours) + '</div>' +
            '</div>' +
            '<div class="price"><div class="price-main">' + money(r.priceHint) + '</div></div>' +
          '</div>' +
        '</div>'
      );
    }).join("");

    $("app").innerHTML =
      '<div class="wrap">' +
        '<div class="h1">FOOD</div>' +
        '<div class="p">Rajkot MVP ‚Ä¢ Pay via UPI ‚Üí submit UTR (demo flow)</div>' +
        '<div class="demo-note"><b>DEMO:</b> UTR is validated & stored locally for now.</div>' +
        cards +
        '<button class="secondary" type="button" data-action="home" style="margin-top:10px">‚Üê HOME</button>' +
      '</div>';
  }

  function getRestaurantById(id){
    var list = FOOD_DATA.restaurants || [];
    for(var i=0;i<list.length;i++){
      if(String(list[i].id) === String(id)) return list[i];
    }
    return null;
  }

  function renderRestaurant(rid){
    stopLiveTracking();
    var r = getRestaurantById(rid);
    if(!r){ toast("Restaurant not found"); renderFood(); return; }
    STATE.selectedRestaurantId = r.id;

    var menu = (r.menu || []).map(function(it){
      return (
        '<div class="result">' +
          '<div class="row">' +
            '<div>' +
              '<div class="name">' + esc(it.name) + '</div>' +
              '<div style="color:#888;font-size:.9rem;margin-top:6px">' + esc(it.desc || "") + '</div>' +
              '<div style="color:#888;font-size:.85rem;margin-top:6px">Prep: ' + Number(it.prepMins||15) + ' mins ‚Ä¢ ' + (it.veg ? "üü¢ Veg" : "üî¥ Non-veg") + '</div>' +
            '</div>' +
            '<div class="price">' +
              '<div class="price-main">' + money(it.price) + '</div>' +
              '<button class="add" type="button" data-action="addFood" data-item="' + esc(it.id) + '" style="margin-top:10px">ADD</button>' +
            '</div>' +
          '</div>' +
        '</div>'
      );
    }).join("");

    $("app").innerHTML =
      '<div class="wrap">' +
        '<div class="h1">' + esc(r.name) + '</div>' +
        '<div class="p">' + esc(r.city) + ' ‚Ä¢ ' + esc(r.brand) + '</div>' +
        '<div class="payment-box">' +
          '<div class="label">UPI ID (demo)</div>' +
          '<div class="value" style="font-size:1.05rem;margin-top:6px;word-break:break-all">' + esc(r.upiId) + '</div>' +
        '</div>' +
        '<div class="h1" style="font-size:1.1rem;margin-bottom:10px">MENU</div>' +
        menu +
        '<button class="action" type="button" data-action="cart">GO TO CART ‚Üí</button>' +
        '<button class="secondary" type="button" data-action="food" style="margin-top:10px">‚Üê BACK</button>' +
      '</div>';
  }

  function addFoodItem(itemId){
    var r = getRestaurantById(STATE.selectedRestaurantId);
    if(!r) return toast("Restaurant missing");

    var item = null;
    for(var i=0;i<(r.menu||[]).length;i++){
      if(String(r.menu[i].id) === String(itemId)){ item = r.menu[i]; break; }
    }
    if(!item) return toast("Item missing");

    STATE.cart.push({
      type: "food",
      restaurantId: r.id,
      seller: r.name,
      name: item.name,
      price: Number(item.price)||0,
      qty: 1,
      upiId: r.upiId
    });

    toast("Added: " + item.name);
  }

  // ---------- cart/checkout ----------
  function add(idx){
    var p = RESULTS[idx]; if(!p) return;
    STATE.cart.push({ type:p.type||"ecommerce", name:p.name, seller:p.seller, price:Number(p.price)||0, qty:1 });
    toast("Added to cart");
  }

  function buy(idx){
    var p = RESULTS[idx]; if(!p) return;
    STATE.cart = [{ type:p.type||"ecommerce", name:p.name, seller:p.seller, price:Number(p.price)||0, qty:1 }];
    renderPayment();
  }

  function remove(idx){
    STATE.cart.splice(idx, 1);
    if(!STATE.cart.length){ toast("Cart empty"); renderLobby(); return; }
    toast("Removed");
    renderCart();
  }

  function renderCart(){
    stopLiveTracking();
    if(!STATE.cart.length){ toast("Cart is empty"); renderLobby(); return; }

    var subtotal = STATE.cart.reduce(function(s,p){ return s + (Number(p.price)||0) * (Number(p.qty)||1); }, 0);
    var taxRate = (STATE.cart[0] && STATE.cart[0].type === "food") ? 0.05 : 0.18;
    var gst = Math.floor(subtotal * taxRate);
    var total = subtotal + gst;

    var items = STATE.cart.map(function(it, idx){
      return (
        '<div style="display:flex;justify-content:space-between;gap:10px;padding:14px;background:rgba(255,255,255,0.03);border-radius:14px;margin-bottom:10px">' +
          '<div>' +
            '<div style="font-weight:900">' + esc(it.name) + '</div>' +
            '<div style="font-size:0.85rem;color:#888;margin-top:6px">' + esc(it.seller || "") + '</div>' +
          '</div>' +
          '<div style="text-align:right;min-width:120px">' +
            '<div style="font-weight:900;color:var(--brand-orange)">' + money(it.price) + '</div>' +
            '<button type="button" data-action="remove" data-idx="' + idx + '" style="margin-top:6px;color:#ff4d4d;font-weight:900">Remove</button>' +
          '</div>' +
        '</div>'
      );
    }).join("");

    $("app").innerHTML =
      '<div class="wrap">' +
        '<div class="h1">CART</div>' +
        '<div class="result">' +
          '<div style="font-weight:900;margin-bottom:12px">Items (' + STATE.cart.length + ')</div>' +
          items +
        '</div>' +
        '<div style="height:12px"></div>' +
        '<div class="result">' +
          '<div class="label">Subtotal</div><div class="value">' + money(subtotal) + '</div>' +
          '<div style="height:8px"></div>' +
          '<div class="label">Tax (' + (taxRate*100) + '%)</div><div class="value">' + money(gst) + '</div>' +
          '<div style="height:12px;border-top:1px solid var(--border);margin-top:12px;padding-top:12px"></div>' +
          '<div class="value" style="color:var(--brand-orange);font-size:1.2rem">Total ' + money(total) + '</div>' +
        '</div>' +
        '<button class="action" type="button" data-action="pay">PROCEED TO PAY</button>' +
        '<button class="secondary" type="button" data-action="home" style="margin-top:10px">‚Üê HOME</button>' +
      '</div>';
  }

  function renderPayment(){
    stopLiveTracking();
    if(!STATE.cart.length){ toast("Cart is empty"); renderLobby(); return; }

    payMethod = null;

    var subtotal = STATE.cart.reduce(function(s,p){ return s + (Number(p.price)||0) * (Number(p.qty)||1); }, 0);
    var isFood = (STATE.cart[0] && STATE.cart[0].type === "food");
    var taxRate = isFood ? 0.05 : 0.18;
    var gst = Math.floor(subtotal * taxRate);
    var total = subtotal + gst;

    if(isFood){
      var upiId = STATE.cart[0].upiId || "6351537770@yapl";
      $("app").innerHTML =
        '<div class="wrap">' +
          '<div class="h1">PAY VIA UPI</div>' +
          '<div class="p">Pay ' + money(total) + ' ‚Üí then submit UTR</div>' +

          '<div class="demo-note"><b>DEMO:</b> UPI open + UTR flow is for testing.</div>' +

          '<div class="payment-box" style="text-align:center">' +
            '<div style="font-size:2.6rem;margin-bottom:10px">üì≤</div>' +
            '<div style="font-weight:900;font-size:1.4rem;color:var(--brand-orange)">' + money(total) + '</div>' +
            '<div style="color:#888;margin-top:8px">UPI ID:</div>' +
            '<div id="upiId" style="margin-top:8px;font-weight:900;word-break:break-all">' + esc(upiId) + '</div>' +
            '<div style="height:12px"></div>' +
            '<button class="secondary" type="button" data-action="copyUpi">üìã COPY UPI ID</button>' +
            '<div style="height:10px"></div>' +
            '<button class="action" type="button" data-action="openUpiApp">OPEN UPI APP</button>' +
            '<div style="height:10px"></div>' +
            '<button class="action" type="button" data-action="submitUtr" style="background:var(--accent)">I HAVE PAID ‚Üí SUBMIT UTR</button>' +
            '<div style="color:#888;font-size:.85rem;margin-top:14px;line-height:1.6">' +
              'Your order is confirmed after seller verifies UTR.' +
            '</div>' +
          '</div>' +

          '<button class="secondary" type="button" data-action="cart">‚Üê BACK</button>' +
        '</div>';
      return;
    }

    // ecommerce demo (non-UPI)
    $("app").innerHTML =
      '<div class="wrap">' +
        '<div class="h1">PAYMENT</div>' +
        '<div class="p">Total: ' + money(total) + '</div>' +
        '<div class="demo-note"><b>DEMO:</b> E-commerce checkout is demo.</div>' +
        '<div class="payment-box">' +
          '<div style="font-weight:900;margin-bottom:12px">Choose Payment</div>' +
          '<div class="payment-option" role="button" tabindex="0" data-action="pm" data-method="upi">' +
            '<div style="font-size:2rem">üì±</div><div><div style="font-weight:900">UPI</div><div style="color:#888;font-size:.85rem">GPay / PhonePe / Paytm</div></div>' +
          '</div>' +
          '<div class="payment-option" role="button" tabindex="0" data-action="pm" data-method="cod">' +
            '<div style="font-size:2rem">üíµ</div><div><div style="font-weight:900">Cash on Delivery</div><div style="color:#888;font-size:.85rem">Demo mode</div></div>' +
          '</div>' +
        '</div>' +
        '<button class="action" type="button" data-action="place">PLACE ORDER</button>' +
        '<button class="secondary" type="button" data-action="cart" style="margin-top:10px">‚Üê BACK</button>' +
      '</div>';
  }

  function copyUpi(){
    var upiId = (STATE.cart[0] && STATE.cart[0].upiId) ? STATE.cart[0].upiId : "6351537770@yapl";
    try{
      if(navigator.clipboard){
        navigator.clipboard.writeText(upiId);
        toast("UPI ID copied!");
      }else{
        var tmp = document.createElement("input");
        tmp.value = upiId;
        document.body.appendChild(tmp);
        tmp.select();
        document.execCommand("copy");
        document.body.removeChild(tmp);
        toast("UPI ID copied!");
      }
    }catch(e){
      toast("Copy failed: " + upiId);
    }
  }

  function openUpiApp(){
    // For demo: use amount including 5% for food
    var subtotal = STATE.cart.reduce(function(s,p){ return s + (Number(p.price)||0) * (Number(p.qty)||1); }, 0);
    var gst = Math.floor(subtotal * 0.05);
    var total = subtotal + gst;

    var upiId = (STATE.cart[0] && STATE.cart[0].upiId) ? STATE.cart[0].upiId : "6351537770@yapl";
    var upiLink = "upi://pay?pa=" + encodeURIComponent(upiId) +
                  "&pn=" + encodeURIComponent("Decide") +
                  "&am=" + encodeURIComponent(String(total)) +
                  "&cu=INR&tn=" + encodeURIComponent("Decide Food Order");

    window.location.href = upiLink;
    toast("Opening UPI app...");
  }

  function submitUtr(){
    stopLiveTracking();
    var subtotal = STATE.cart.reduce(function(s,p){ return s + (Number(p.price)||0) * (Number(p.qty)||1); }, 0);
    var gst = Math.floor(subtotal * 0.05);
    var total = subtotal + gst;

    $("app").innerHTML =
      '<div class="wrap">' +
        '<div class="h1">Submit UTR</div>' +
        '<div class="p">Amount: <span class="kbd">' + money(total) + '</span></div>' +
        '<div class="demo-note"><b>DEMO:</b> We validate 12-digit UTR and detect duplicates (device-level).</div>' +
        '<div class="payment-box">' +
          '<div style="font-weight:900;margin-bottom:10px">Enter 12-digit UTR</div>' +
          '<div style="color:#888;font-size:.85rem;line-height:1.6;margin-bottom:12px">UTR is shown in your UPI transaction details.</div>' +
          '<input id="utrNumber" inputmode="numeric" placeholder="12-digit UTR" maxlength="12" />' +
          '<div style="height:10px"></div>' +
          '<div style="color:#666;font-size:.85rem">Tip: no spaces, digits only.</div>' +
        '</div>' +
        '<button class="action" type="button" data-action="confirmUtr">SUBMIT</button>' +
        '<button class="secondary" type="button" data-action="pay" style="margin-top:10px">‚Üê BACK</button>' +
      '</div>';
  }

  // ‚úÖ hardened UTR validation + ‚úÖ duplicate UTR detection
  function confirmUtr(){
    var el = $("utrNumber");
    var raw = (el && el.value) ? el.value : "";
    var utr = raw.replace(/\s+/g,"").trim();

    // strict numeric 12 digits
    if(!/^\d{12}$/.test(utr)){
      toast("UTR must be exactly 12 digits");
      return;
    }

    // duplicate detection (device-level)
    var idx = loadUtrIndex();
    if(idx[utr]){
      toast("Duplicate UTR detected (already used)");
      return;
    }

    // build order
    var subtotal = STATE.cart.reduce(function(s,p){ return s + (Number(p.price)||0) * (Number(p.qty)||1); }, 0);
    var gst = Math.floor(subtotal * 0.05);
    var total = subtotal + gst;

    var id = "DEC-" + Math.random().toString(36).slice(2,4).toUpperCase() + String(Math.floor(Math.random()*10000)).padStart(4,"0");
    var now = new Date();

    var order = {
      id: id,
      items: STATE.cart.slice(),
      subtotal: subtotal,
      tax: gst,
      total: total,
      payment: "upi",
      utr: utr,
      status: "utr_submitted",
      timestamp: now.toISOString(),
      restaurantId: STATE.cart[0] ? STATE.cart[0].restaurantId : null,
      updates: [
        {status:"placed", time: now.toISOString(), label:"Order Placed", completed:true},
        {status:"utr_submitted", time: now.toISOString(), label:"UTR Submitted - Awaiting Seller Confirmation", completed:true}
      ]
    };

    // save UTR index
    idx[utr] = { orderId: id, ts: now.toISOString() };
    saveUtrIndex(idx);

    // save order
    loadOrders();
    STATE.orders.push(order);
    saveOrders();

    // optional: open WhatsApp with order info (demo)
    var r = getRestaurantById(order.restaurantId);
    if(r && r.whatsapp){
      var msg = "New Order: " + id +
                "%0AAmount: " + total +
                "%0AUTR: " + utr +
                "%0AStatus: Awaiting confirmation.";
      setTimeout(function(){
        try{ window.open(r.whatsapp + "?text=" + msg, "_blank"); }catch(e){}
      }, 300);
    }

    // clear cart
    STATE.cart = [];

    // show next screen
    $("app").innerHTML =
      '<div class="wrap" style="text-align:center;margin-top:24px">' +
        '<div style="font-size:4.2rem;margin-bottom:14px">‚è≥</div>' +
        '<div class="h1" style="color:var(--accent)">UTR SUBMITTED</div>' +
        '<div class="p">Order ID: <span class="kbd">' + esc(id) + '</span></div>' +

        '<div class="demo-note"><b>DEMO:</b> Seller confirmation is simulated for testing.</div>' +

        '<div class="payment-box" style="text-align:left">' +
          '<div style="font-weight:900;margin-bottom:10px">Current status</div>' +
          '<div style="background:rgba(255,103,31,0.10);padding:14px;border-radius:14px">' +
            '<div style="font-weight:900;color:var(--brand-orange)">Awaiting seller confirmation</div>' +
            '<div style="color:#888;font-size:.85rem;margin-top:8px;line-height:1.6">Seller verifies UTR manually. Auto-refresh tracking is available.</div>' +
          '</div>' +
        '</div>' +

        '<button class="action" type="button" data-action="trackLive" data-order="' + esc(id) + '">TRACK (LIVE)</button>' +
        '<button class="secondary" type="button" data-action="simulateConfirm" data-order="' + esc(id) + '" style="margin-top:10px;border-color:var(--accent);color:var(--accent)">SIMULATE SELLER CONFIRM</button>' +
        '<button class="secondary" type="button" data-action="home" style="margin-top:10px">‚Üê HOME</button>' +
      '</div>';

    toast("UTR saved. Waiting for seller.");
  }

  function place(){
    if(!payMethod){ toast("Select payment method"); return; }
    var subtotal = STATE.cart.reduce(function(s,p){ return s + (Number(p.price)||0) * (Number(p.qty)||1); }, 0);
    var gst = Math.floor(subtotal * 0.18);
    var total = subtotal + gst;

    var id = "ORD-" + Math.random().toString(36).slice(2,10).toUpperCase();
    var now = new Date();
    var order = { id:id, items:STATE.cart.slice(), subtotal:subtotal, tax:gst, total:total, payment:payMethod, status:"confirmed", timestamp:now.toISOString(), updates:[
      {status:"placed", time:now.toISOString(), label:"Order Placed", completed:true},
      {status:"confirmed", time:now.toISOString(), label:"Payment Confirmed", completed:true}
    ]};

    loadOrders(); STATE.orders.push(order); saveOrders();
    STATE.cart = []; payMethod = null;

    toast("Order placed!");
    renderOrders();
  }

  // ---------- orders + tracking ----------
  function renderOrders(){
    stopLiveTracking();
    loadOrders();
    if(!STATE.orders.length){ toast("No orders yet"); renderLobby(); return; }

    var list = STATE.orders.slice().reverse().map(function(o){
      var statusColor = (o.status === "delivered") ? "var(--accent)" : (o.status === "confirmed" || o.status === "preparing") ? "var(--brand-orange)" : "#888";
      return (
        '<div class="result" role="button" tabindex="0" data-action="trackLive" data-order="' + esc(o.id) + '" style="cursor:pointer">' +
          '<div class="row">' +
            '<div>' +
              '<div class="name" style="font-size:1.05rem">' + esc(o.id) + '</div>' +
              '<div style="color:#888;font-size:.85rem;margin-top:6px">' + esc(new Date(o.timestamp).toLocaleString("en-IN")) + '</div>' +
            '</div>' +
            '<div style="text-align:right">' +
              '<div style="font-weight:900;color:var(--brand-orange)">' + money(o.total||0) + '</div>' +
              '<div style="margin-top:6px;font-weight:900;color:' + statusColor + ';font-size:.85rem">' + esc(String(o.status||"").toUpperCase()) + '</div>' +
            '</div>' +
          '</div>' +
        '</div>'
      );
    }).join("");

    $("app").innerHTML =
      '<div class="wrap">' +
        '<div class="h1">MY ORDERS</div>' +
        '<div class="p">Tap any order to track live</div>' +
        list +
        '<button class="secondary" type="button" data-action="home">‚Üê HOME</button>' +
      '</div>';
  }

  function simulateSellerConfirmation(orderId){
    loadOrders();
    var order = null;
    for(var i=0;i<STATE.orders.length;i++){
      if(STATE.orders[i].id === orderId){ order = STATE.orders[i]; break; }
    }
    if(!order){ toast("Order not found"); return; }

    var now = new Date();
    order.status = "confirmed";
    order.updates = order.updates || [];
    order.updates.push({status:"confirmed", time: now.toISOString(), label:"Payment Confirmed ‚úì", completed:true});
    order.updates.push({status:"preparing", time: now.toISOString(), label:"Restaurant Preparing", completed:true});
    saveOrders();

    toast("Seller confirmed payment");
    renderLiveTracking(orderId);
  }

  function renderLiveTracking(orderId){
    stopLiveTracking();
    loadOrders();

    var order = null;
    for(var i=0;i<STATE.orders.length;i++){
      if(STATE.orders[i].id === orderId){ order = STATE.orders[i]; break; }
    }
    if(!order){ toast("Order not found"); renderLobby(); return; }

    var allSteps = [
      {status:"placed", label:"Order Placed", icon:"‚úì"},
      {status:"utr_submitted", label:"UTR Submitted", icon:"‚úì"},
      {status:"confirmed", label:"Payment Confirmed", icon:"‚úì"},
      {status:"preparing", label:"Preparing", icon:"‚è≥"},
      {status:"ready", label:"Ready", icon:"üì¶"},
      {status:"delivered", label:"Delivered", icon:"üéâ"}
    ];

    function isDone(st){
      var u = order.updates || [];
      for(var k=0;k<u.length;k++) if(u[k].status === st) return u[k];
      return null;
    }

    var timeline = allSteps.map(function(step){
      var u = isDone(step.status);
      var active = u ? "active" : "";
      var time = u ? new Date(u.time).toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit"}) : "Pending";
      return (
        '<div class="timeline-item ' + active + '">' +
          '<div class="timeline-dot">' + step.icon + '</div>' +
          '<div class="timeline-line"></div>' +
          '<div class="timeline-content">' + esc(step.label) + '</div>' +
          '<div class="timeline-time">' + esc(time) + '</div>' +
        '</div>'
      );
    }).join("");

    var statusLabel =
      (order.status === "delivered") ? "Delivered ‚úì" :
      (order.status === "preparing") ? "Preparing" :
      (order.status === "confirmed") ? "Payment Confirmed" :
      (order.status === "utr_submitted") ? "Awaiting Confirmation" :
      "Placed";

    $("app").innerHTML =
      '<div class="wrap">' +
        '<div class="h1">LIVE TRACKING</div>' +
        '<div class="p">Order: <span class="kbd">' + esc(orderId) + '</span></div>' +

        '<div class="tracking-status" style="text-align:center">' +
          '<div style="font-size:2.2rem">üì¶</div>' +
          '<div style="font-weight:900;font-size:1.15rem;margin-top:8px;color:var(--brand-orange)">' + esc(statusLabel) + '</div>' +
          '<div style="color:#888;font-size:.85rem;margin-top:8px">Auto refresh: 10s</div>' +
        '</div>' +

        '<div class="result">' +
          '<div style="font-weight:900;margin-bottom:14px">Progress</div>' +
          '<div class="tracking-timeline">' + timeline + '</div>' +
        '</div>' +

        (order.status === "utr_submitted"
          ? '<button class="action" type="button" data-action="simulateConfirm" data-order="' + esc(orderId) + '" style="background:var(--accent)">SIMULATE SELLER CONFIRM</button>'
          : '') +

        '<button class="secondary" type="button" data-action="orders" style="margin-top:10px">‚Üê ORDERS</button>' +
        '<button class="secondary" type="button" data-action="home" style="margin-top:10px">‚Üê HOME</button>' +
      '</div>';

    STATE.liveTrackingInterval = setInterval(function(){
      loadOrders();
      var updated = null;
      for(var j=0;j<STATE.orders.length;j++){
        if(STATE.orders[j].id === orderId){ updated = STATE.orders[j]; break; }
      }
      if(updated && JSON.stringify(updated.updates||[]) !== JSON.stringify(order.updates||[])){
        renderLiveTracking(orderId);
      }
    }, 10000);
  }

  // ---------- events ----------
  function goHome(){
    // always re-check visited flag (fix)
    if(isVisited()) renderLobby();
    else renderLanding();
  }

  function handle(el){
    var action = el.getAttribute("data-action");
    if(!action || action === "disabled") return;
    if(el.getAttribute("aria-disabled") === "true") return;

    // global
    if(action === "home"){ goHome(); return; }

    // landing actions
    if(action === "lobby"){ markVisited(); renderLobby(); return; }
    if(action === "waitlistSubmit"){ submitWaitlist(); return; }

    // lobby / city
    if(action === "module"){
      var mod = el.getAttribute("data-module");
      if(mod === "ecommerce") { renderEcommerce(); return; }
      if(mod === "food") { renderFood(); return; }
      toast("Module coming soon");
      return;
    }
    if(action === "city"){ renderCity(el.getAttribute("data-city")); return; }

    // seller funnel
    if(action === "seller"){ renderSellerCTA(); return; }
    if(action === "sellerForm"){ renderSellerForm(el.getAttribute("data-type") || "Seller"); return; }
    if(action === "sellerSubmit"){ sellerSubmit(el.getAttribute("data-type") || "Seller"); return; }

    // feedback
    if(action === "feedback"){ renderFeedbackCenter(); return; }
    if(action === "fbSubmit"){ fbSubmit(); return; }

    // ecommerce
    if(action === "ecommerce"){ renderEcommerce(); return; }
    if(action === "category"){ renderFilters(el.getAttribute("data-cat")); return; }
    if(action === "toggle"){ toggleFilter(el.getAttribute("data-filter"), el); return; }
    if(action === "search"){ search(); return; }
    if(action === "add"){ add(Number(el.getAttribute("data-idx"))); return; }
    if(action === "buy"){ buy(Number(el.getAttribute("data-idx"))); return; }

    // food
    if(action === "food"){ renderFood(); return; }
    if(action === "restaurant"){ renderRestaurant(el.getAttribute("data-rid")); return; }
    if(action === "addFood"){ addFoodItem(el.getAttribute("data-item")); return; }

    // cart/payment
    if(action === "cart"){ renderCart(); return; }
    if(action === "remove"){ remove(Number(el.getAttribute("data-idx"))); return; }
    if(action === "pay"){ renderPayment(); return; }
    if(action === "copyUpi"){ copyUpi(); return; }
    if(action === "openUpiApp"){ openUpiApp(); return; }
    if(action === "submitUtr"){ submitUtr(); return; }
    if(action === "confirmUtr"){ confirmUtr(); return; }

    // ecommerce payment
    if(action === "pm"){
      var method = el.getAttribute("data-method");
      var opts = document.querySelectorAll(".payment-option");
      for(var i=0;i<opts.length;i++) opts[i].classList.remove("selected");
      el.classList.add("selected");
      payMethod = method;
      toast("Selected: " + method.toUpperCase());
      return;
    }
    if(action === "place"){ place(); return; }

    // orders/tracking
    if(action === "orders"){ renderOrders(); return; }
    if(action === "trackLive"){ renderLiveTracking(el.getAttribute("data-order")); return; }
    if(action === "simulateConfirm"){ simulateSellerConfirmation(el.getAttribute("data-order")); return; }
  }

  document.addEventListener("click", function(e){
    var el = e.target.closest("[data-action]");
    if(el) handle(el);
  });

  document.addEventListener("keydown", function(e){
    if(e.key !== "Enter" && e.key !== " ") return;
    var el = e.target.closest("[data-action][role='button']");
    if(!el) return;
    e.preventDefault();
    handle(el);
  });

  // ---------- init ----------
  function init(){
    supabase = initSupabase(); // safe: may be null
    loadOrders();
    loadToMemory(ECOMMERCE_DATA);
    goHome();
  }

  window.addEventListener("beforeunload", stopLiveTracking);

  // ensure supabase lib is loaded first (defer usually ok) - run init on DOM ready
  if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", init, {once:true});
  else init();

})();
</script>
</body>
</html>
