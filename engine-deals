<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>| decide.engine |</title>

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0a0a0a" />
  <meta name="background-color" content="#0a0a0a" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --brand-orange: #ff671f;
      --brand-bg: #0a0a0a;
      --text-main: #f0f0f0;
      --accent-go: #00e676;
      --accent-skip: #ff3333;
      --accent-yt: #FF0000;
      --font-tech: 'Courier New', monospace;
      --font-ui: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    html, body {
      margin: 0; padding: 0; height: 100%; width: 100%;
      background-color: var(--brand-bg);
      color: var(--text-main);
      font-family: var(--font-ui);
      overflow: hidden;
      touch-action: none; user-select: none;
    }

    #master-container { height: 100vh; width: 100vw; position: relative; overflow: hidden; }

    .main-slide {
      height: 100vh; width: 100vw; position: absolute; top: 0; left: 0;
      display: flex; flex-direction: column; background: var(--brand-bg);
      transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
      will-change: transform;
    }

    .main-slide.prev { transform: translateY(-100%); }
    .main-slide.active { transform: translateY(0); z-index: 10; }
    .main-slide.next { transform: translateY(100%); z-index: 20; }

    .slide-header {
      padding: 20px; border-left: 3px solid var(--brand-orange); height: 70px;
      flex-shrink: 0; z-index: 10; display: flex; align-items: center; justify-content: space-between;
      background: var(--brand-bg); position: absolute; top: 0; left: 0; right: 0;
    }

    .header-title {
      font-family: var(--font-tech); font-size: 0.75rem; color: var(--brand-orange);
      letter-spacing: 1px; font-weight: 700; text-transform: uppercase;
    }

    .video-bg {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      object-fit: cover; z-index: -1; opacity: 0.3;
    }

    .winner-container {
      flex-grow: 1; display: flex; flex-direction: column;
      justify-content: flex-end; padding: 30px;
      background: linear-gradient(to top, #000 95%, transparent);
    }

    .carousel-viewport { position: relative; flex-grow: 1; width: 100%; height: 100%; margin-top: 70px; }

    .sub-slide {
      position: absolute; inset: 0; padding: 25px; display: flex; flex-direction: column;
      justify-content: center; opacity: 0; pointer-events: none; transform: translateX(20px);
      transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .sub-slide.opt-active { z-index: 30; opacity: 1; pointer-events: auto; transform: translateX(0); }
    .sub-slide.opt-hidden { z-index: 0; opacity: 0; pointer-events: none; }
    .sub-slide.static { z-index: 30; opacity: 1; pointer-events: auto; transform: none; }

    h1 { font-size: 1.8rem; margin: 0 0 15px 0; line-height: 1; letter-spacing: -1px; color: var(--brand-orange); }
    .primary-question { font-size: 1.1rem; color: #fff; margin-bottom: 25px; line-height: 1.4; font-weight: 600; }
    .wiki-summary { font-size: 0.9rem; color: #aaa; line-height: 1.6; max-height: 180px; overflow-y: auto; margin-bottom: 20px; }

    .resources-section { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #333; }
    .book-btn {
      background: #232f3e; color: #FF9900; border: 1px solid #FF9900;
      padding: 12px; width: 100%; border-radius: 8px; font-weight: bold;
      margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px;
      text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px;
    }
    .support-link {
      text-align: center; font-size: 0.7rem; color: #666; text-decoration: none;
      display: block; margin-top: 10px; font-family: var(--font-tech); opacity: 0.7;
    }
    .pdf-btn { background: #222; color: #fff; border: 1px solid #444; padding: 5px 10px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; }

    .role-label {
      font-family: var(--font-tech); font-size: 0.6rem; color: #000;
      background: var(--accent-go); padding: 4px 8px; border-radius: 4px;
      width: fit-content; margin-bottom: 15px; font-weight: bold;
    }

    .video-chip {
      display: inline-flex; align-items: center; gap: 5px;
      background: rgba(255,0,0,0.15); color: #ff4444; border: 1px solid #ff4444;
      padding: 4px 8px; border-radius: 4px; font-size: 0.6rem;
      font-family: var(--font-tech); cursor: pointer; margin-left: 10px;
      vertical-align: middle;
    }

    .nav-hint {
      margin-top: 20px; padding-top: 15px; border-top: 1px solid #333;
      font-family: var(--font-tech); font-size: 0.7rem; color: #666;
      display: flex; justify-content: space-between;
    }

    .final-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    .btn { background: #222; color: #fff; border: 1px solid #333; padding: 15px; border-radius: 8px; font-weight: 600; text-align: center; font-size: 0.8rem; cursor: pointer; width: 100%; }
    .btn-full { grid-column: span 2; }
    .btn-amazon { background: #232f3e; border: none; color: #ff9900; }
    .btn-zomato { background: #cb202d; border: none; }
    .btn-blinkit { background: var(--accent-blinkit); color: #000; border: none; }
    .btn-wa { background: #25D366; color: #000; border: none; }
    .btn-yt { background: #cc0000; color: #fff; border: none; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-speak { background: #333; color: #aaa; border: 1px solid #444; }

    .lobby-container {
      display: flex; flex-direction: column; gap: 15px; padding: 30px; height: 100%;
      overflow-y: auto; justify-content: flex-start;
      padding-top: 80px; padding-bottom: 120px;
      -webkit-overflow-scrolling: touch;
    }
    .cuisine-btn {
      background: #222; border: 1px solid #444; color: #888; padding: 20px; font-size: 1.1rem;
      font-weight: bold; text-transform: uppercase; border-radius: 12px; transition: all 0.2s; flex-shrink: 0;
    }
    .cuisine-btn.selected { background: var(--brand-orange); color: #000; border-color: var(--brand-orange); }

    .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
    .stat-card { background: #111; padding: 15px; border-radius: 8px; border: 1px solid #333; }
    .stat-val { color: var(--accent-go); font-size: 1.2rem; font-weight: bold; font-family: var(--font-tech); }
    .stat-label { color: #666; font-size: 0.7rem; text-transform: uppercase; margin-top: 5px; }

    #depth-fill { position: fixed; right: 0; top: 0; bottom: 0; width: 4px; background: #333; z-index: 900; height: 0%; transition: height 0.05s linear; }

    iframe { width: 100%; height: 100%; border: none; background: #000; }
    .close-iframe { position: fixed; top: 20px; right: 20px; z-index: 100; background: #000; border: 1px solid #333; color: #fff; padding: 10px 20px; border-radius: 20px; font-family: var(--font-tech); font-weight: bold; }

    .toast-msg { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #222; color: #00e676; padding: 10px 20px; border: 1px solid #00e676; border-radius: 20px; font-size: 0.8rem; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 3000; font-family: var(--font-tech); }
    .toast-msg.visible { opacity: 1; }

    #mic-toggle { position: fixed; bottom: 20px; left: 20px; width: 50px; height: 50px; background: #111; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid #444; z-index: 2000; cursor: pointer; }
    #mic-toggle.listening { border-color: var(--accent-go); box-shadow: 0 0 15px rgba(0,230,118,0.3); }
    #mic-toggle svg { fill: #666; width: 24px; }
  </style>
</head>

<body>
  <div id="master-container"></div>
  <div id="depth-fill"></div>
  <div id="toast" class="toast-msg"></div>

  <div id="mic-toggle" onclick="toggleListenMode()">
    <svg viewBox="0 0 24 24">
      <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"></path>
      <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"></path>
    </svg>
  </div>

  <script>
    /* =========================================
       KUTCH AUTOMATION | UNIVERSAL OS v67.3 (AFFILIATE EDITION)
       ========================================= */

    // ðŸ”´ CONFIGURATION
    const BACKEND_URL = "https://script.google.com/macros/s/AKfycbxxh1ZwNRwqsSW1Lf62eh2wiwaNKzHWX8Icq472NQVj7-yEvOYuTDuiEGmelW_DG2Zs/exec";
    const YOUTUBE_CHANNEL = "https://www.youtube.com/@decide.engine";

    // âœ… UPDATED AFFILIATE TAG
    const AMZN_TAG = "decideengine-21";

    const SUPPORT_URL = "https://www.buymeacoffee.com/kutchautomation";
    const PHONE_REVIEW_URL = "https://youtu.be/_GQkaY9-jto?si=EiNtzvkHtHG8uiT5";
    const EARBUD_REVIEW_URL = "https://youtu.be/ceuEz96MMEY";
    const WINNER_VIDEO = "https://static.videezy.com/system/resources/previews/000/012/628/original/Abstract_Blue_Background.mp4";

    const PHONE_DB = {
      "Poco F7": { attr: { camera: 6.0, gaming: 10.0, battery: 9.0, ui: 4.0 }, tags: ["heavy", "bloatware", "performance"], price: 29999, video: null },
      "iQOO Neo 10R": { attr: { camera: 7.0, gaming: 9.5, battery: 9.0, ui: 6.0 }, tags: ["balanced", "value", "144hz"], price: 30999, video: null },
      "Nothing 3a Pro": { attr: { camera: 8.5, gaming: 7.0, battery: 7.5, ui: 10.0 }, tags: ["clean_ui", "no_charger", "service_king"], price: 27999, video: null },
      "Xiaomi 14 Civi": { attr: { camera: 9.5, gaming: 6.0, battery: 6.5, ui: 6.0 }, tags: ["camera_king", "compact"], price: 32999, video: null },
      "Vivo V60e": { attr: { camera: 10.0, gaming: 5.0, battery: 7.5, ui: 7.0 }, tags: ["camera_king", "aura_light", "weak_chip"], price: 28999, video: null },
      "Samsung A55": { attr: { camera: 8.0, gaming: 4.0, battery: 7.0, ui: 9.5 }, tags: ["trust", "slow_charge", "updates"], price: 33999, video: null },
      "Realme GT 7T": { attr: { camera: 6.0, gaming: 9.0, battery: 10.0, ui: 5.0 }, tags: ["battery_king", "plastic_build", "120w"], price: 31999, video: null },
      "Samsung Galaxy F07": { attr: { camera: 6.0, gaming: 3.0, battery: 9.0, ui: 7.0 }, tags: ["budget", "trust"], price: 7499, video: null },
      "Realme Note 60": { attr: { camera: 5.0, gaming: 4.0, battery: 8.0, ui: 6.0 }, tags: ["budget", "value"], price: 7999, video: null }
    };

    const AUDIO_DB = {
      "Technics AZ100": { attr: { anc: 9.0, sound: 9.9, mic: 9.5, latency: 8.5, battery: 7.0 }, tags: ["audiophile", "multipoint"], price: 22990, video: null },
      "Sony WF-1000XM6": { attr: { anc: 10.0, sound: 9.5, mic: 8.5, latency: 6.0, battery: 7.5 }, tags: ["anc_king", "travel"], price: 24990, video: null },
      "SteelSeries Arctis": { attr: { anc: 7.0, sound: 8.0, mic: 8.0, latency: 10.0, battery: 8.0 }, tags: ["gaming_pro", "dongle"], price: 17999, video: null },
      "Beats Powerbeats 2": { attr: { anc: 7.5, sound: 9.0, mic: 8.0, latency: 7.0, battery: 9.0 }, tags: ["sport", "stable"], price: 21900, video: null },
      "Tribit FlyBuds 3": { attr: { anc: 5.0, sound: 7.0, mic: 6.0, latency: 6.0, battery: 10.0 }, tags: ["battery_king", "powerbank"], price: 3999, video: null },
      "OnePlus Nord Buds 3": { attr: { anc: 9.5, sound: 8.0, mic: 7.5, latency: 7.0, battery: 8.0 }, tags: ["value_anc", "49db"], price: 3299, video: null },
      "GoBoult Z40 Pro": { attr: { anc: 6.0, sound: 7.5, mic: 5.0, latency: 8.5, battery: 7.0 }, tags: ["budget_king", "rgb"], price: 1499, video: null },
      "Shure Aonic 215": { attr: { anc: 8.0, sound: 10.0, mic: 7.0, latency: 7.0, battery: 7.0 }, tags: ["audiophile", "eq_master"], price: 18999, video: null }
    };

    const DEAL_BREAKERS = { "Lightweight": "heavy", "Clean UI": "bloatware" };
    const ECOM_DEEP_LINKS = {
      amazon: {
        app: q => `intent://www.amazon.in/s?k=${q}&tag=${AMZN_TAG}#Intent;scheme=https;package=in.amazon.mShop.android.shopping;end`,
        web: q => `https://www.amazon.in/s?k=${q}&tag=${AMZN_TAG}`
      }
    };

    // âœ… MODULE REGISTRY (RESEARCH REMOVED)
    const MODULES = {
      smartphones: {
        label: "SMARTPHONES",
        database: PHONE_DB,
        init: () => renderEcosystemGate(),
        categories: [
          { label: "CAMERA-FIRST", type: "camera", items: [{"name": "Vivo V60e"}, {"name": "Xiaomi 14 Civi"}, {"name": "Samsung A55"}] },
          { label: "PRO GAMER", type: "gaming", items: [{"name": "Poco F7"}, {"name": "iQOO Neo 10R"}] },
          { label: "CLEAN UI", type: "ui", items: [{"name": "Nothing 3a Pro"}, {"name": "Samsung Galaxy F07"}] },
          { label: "â–¶ DEV REVIEW", type: "external", link: PHONE_REVIEW_URL },
          // NOTE: You had "Samsung Galaxy M07" in original categories but DB uses "Samsung Galaxy F07".
          // Kept the original label intent but corrected item name to avoid mismatches.
          { label: "BATTERY KING", type: "battery", items: [{"name": "Realme GT 7T"}, {"name": "Samsung Galaxy F07"}] },
          { label: "MUST HAVE: FAST CHARGE", type: "fast_charge", items: [] },
          { label: "MUST HAVE: LIGHTWEIGHT", type: "lightweight", items: [] }
        ]
      },
      earbuds: {
        label: "EARBUDS",
        database: AUDIO_DB,
        init: () => { ENGINE_STATE.active_filters = []; renderSubLobby('earbuds'); },
        categories: [
          { label: "AUDIOPHILE (HI-RES)", type: "sound", items: [{"name": "Technics AZ100"}, {"name": "Sony WF-1000XM6"}] },
          { label: "ZERO LATENCY (GAMING)", type: "latency", items: [{"name": "SteelSeries Arctis"}, {"name": "GoBoult Z40 Pro"}] },
          { label: "WORK CALLS (AI MIC)", type: "mic", items: [{"name": "Technics AZ100"}, {"name": "OnePlus Nord Buds 3"}] },
          { label: "â–¶ DEV REVIEW", type: "external", link: EARBUD_REVIEW_URL },
          { label: "SILENCE (ANC >45dB)", type: "anc", items: [{"name": "Sony WF-1000XM6"}, {"name": "OnePlus Nord Buds 3"}] },
          { label: "MARATHON BATTERY", type: "battery", items: [{"name": "Tribit FlyBuds 3"}, {"name": "Beats Powerbeats 2"}] }
        ]
      },
      food: {
        label: "DINING",
        database: null,
        init: () => renderExternalModule("https://via-decide.github.io/food.decider/"),
        categories: []
      },
      review: {
        label: "ENGINE REVIEW â†—",
        database: null,
        init: () => window.open(YOUTUBE_CHANNEL, '_blank'),
        categories: []
      }
    };

    let ENGINE_STATE = {
      currentDomain: null,
      items_detected: {},
      session_weights: {},
      active_filters: [],
      ecosystem: null
    };

    let slideElements = [];
    let currentIdx = 0;

    async function boot() { renderLobby(); initSwipeSystem(); initVoice(); }

    function renderLobby() {
      const container = document.getElementById('master-container');
      container.innerHTML = "";
      const section = document.createElement('section');
      section.className = "main-slide active";

      let html = `<div class="slide-header"><span class="header-title">DECIDE OS v67.3</span></div>
                  <div class="lobby-container"><h1 style="text-align:center">SELECT DOMAIN</h1><div style="display:grid; gap:15px;">`;

      for (let key in MODULES) {
        const isSelected = ENGINE_STATE.currentDomain === key ? "selected" : "";
        html += `<button class="cuisine-btn ${isSelected}" onclick="toggleDomain('${key}', this)">${MODULES[key].label}</button>`;
      }

      html += `</div><button class="btn btn-auto btn-full" style="margin-top:30px" onclick="handleStart()">NEXT &rarr;</button></div>`;
      section.innerHTML = html;
      container.appendChild(section);
      slideElements = [section];
      currentIdx = 0;
    }

    function toggleDomain(id, btn) {
      ENGINE_STATE.currentDomain = id;
      document.querySelectorAll('.cuisine-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      if (id === 'review') MODULES[id].init();
    }

    function handleStart() {
      if (!ENGINE_STATE.currentDomain) return showToast("SELECT DOMAIN");
      MODULES[ENGINE_STATE.currentDomain].init();
    }

    function renderEcosystemGate() {
      const container = document.getElementById('master-container');
      while (container.children.length > 1) container.removeChild(container.lastChild);
      slideElements = [slideElements[0]];

      const section = document.createElement('section');
      section.className = "main-slide next";

      section.innerHTML = `
        <div class="slide-header"><span class="header-title">PHILOSOPHY</span></div>
        <div class="lobby-container">
          <h1 style="text-align:center">WHAT MATTERS?</h1>
          <div style="display:grid; gap:20px;">
            <button class="cuisine-btn" onclick="selectEcosystem('specs')">PURE SPECS<br><span style="font-size:0.7rem; color:#666">Performance, 120W Charge</span></button>
            <button class="cuisine-btn" onclick="selectEcosystem('peace')">PEACE OF MIND<br><span style="font-size:0.7rem; color:#666">Reliability, Cameras</span></button>
          </div>
        </div>`;
      container.appendChild(section);
      slideElements.push(section);
      goToSlide(1);
    }

    function selectEcosystem(type) {
      ENGINE_STATE.ecosystem = type;
      ENGINE_STATE.active_filters = [];
      renderSubLobby('smartphones');
    }

    function renderSubLobby(domain) {
      const container = document.getElementById('master-container');
      const depth = domain === 'smartphones' ? 2 : 1;
      while (container.children.length > depth) container.removeChild(container.lastChild);
      slideElements = slideElements.slice(0, depth);

      const section = document.createElement('section');
      section.className = "main-slide next";
      const module = MODULES[domain];
      const categories = module.categories;

      let html = `<div class="slide-header"><span class="header-title">FILTER</span></div>
                  <div class="lobby-container"><h1 style="text-align:center">PRIORITIES</h1>
                  <div style="display:grid; gap:15px; max-height:60vh; overflow-y:auto">`;

      categories.forEach((cat, idx) => {
        if (cat.type === 'external') {
          html += `<button class="cuisine-btn" style="border-color:#ff4444; color:#ff4444;" onclick="window.open('${cat.link}', '_blank')">${cat.label}</button>`;
        } else {
          html += `<button class="cuisine-btn" id="filter-btn-${idx}" onclick="toggleFilter('${cat.label}', ${idx})">${cat.label}</button>`;
        }
      });

      html += `</div><button class="btn btn-auto btn-full" style="margin-top:30px" onclick="startHunt()">HUNT &rarr;</button></div>`;
      section.innerHTML = html;
      container.appendChild(section);
      slideElements.push(section);
      goToSlide(depth);
    }

    function toggleFilter(label, idx) {
      const btn = document.getElementById(`filter-btn-${idx}`);
      if (ENGINE_STATE.active_filters.includes(label)) {
        ENGINE_STATE.active_filters = ENGINE_STATE.active_filters.filter(x => x !== label);
        btn.classList.remove('selected');
      } else {
        ENGINE_STATE.active_filters.push(label);
        btn.classList.add('selected');
      }
    }

    function startHunt() {
      if (ENGINE_STATE.active_filters.length === 0) return showToast("SELECT AT LEAST ONE");
      ENGINE_STATE.session_weights = { camera:0.1, gaming:0.1, battery:0.1, ui:0.1, anc:0.1, sound:0.1, mic:0.1, latency:0.1 };
      buildDeck();
    }

    function renderExternalModule(url) {
      const container = document.getElementById('master-container');
      container.innerHTML = "";

      const iframe = document.createElement('iframe');
      iframe.src = url;
      iframe.style.cssText = "width:100%; height:100%; border:none; background:#000;";

      const closeBtn = document.createElement('button');
      closeBtn.className = "close-iframe";
      closeBtn.innerText = "EXIT MODULE";
      closeBtn.onclick = () => location.reload();

      container.appendChild(iframe);
      container.appendChild(closeBtn);
    }

    function getMediaLink(itemName) {
      return `https://www.youtube.com/results?search_query=${encodeURIComponent(itemName + " review 2026")}`;
    }

    function buildDeck() {
      const container = document.getElementById('master-container');
      const currentMod = MODULES[ENGINE_STATE.currentDomain];
      const depth = ENGINE_STATE.currentDomain === 'smartphones' ? 3 : 2;

      while (container.children.length > depth) container.removeChild(container.lastChild);
      slideElements = slideElements.slice(0, depth);

      const allCats = currentMod.categories;
      const targetCats = allCats.filter(c => ENGINE_STATE.active_filters.includes(c.label));

      let slides = [];
      targetCats.forEach(cat => {
        if (cat.type !== "fast_charge" && cat.type !== "lightweight") {
          slides.push({ type: 'opt', title: cat.label, items: cat.items });
        }
      });
      slides.push({ type: 'final' });

      slides.forEach((s) => {
        const el = document.createElement('section');
        el.className = `main-slide next`;

        if (s.type === 'final') {
          el.innerHTML = `
            <video class="video-bg" autoplay loop muted playsinline>
              <source src="${WINNER_VIDEO}" type="video/mp4">
            </video>
            <div class="winner-overlay">
              <div class="winner-container">
                <div class="input-group" id="final-list" style="background:transparent; border:none;"></div>
                <div class="final-actions">
                  <button class="btn btn-amazon" onclick="redirect('amazon')">BUY NOW â†—</button>
                  <button class="btn btn-yt" onclick="openReview()">â–¶ REVIEW</button>
                  <button class="btn btn-speak" onclick="triggerVerdictSpeech()">ðŸ”Š VERDICT</button>
                  <button class="btn btn-full" onclick="location.reload()">RESTART</button>
                </div>
              </div>
            </div>`;
        } else {
          let html = `<div class="slide-header"><span class="header-title">${s.title}</span></div><div class="carousel-viewport">`;
          s.items.forEach((item, i) => {
            html += `<div class="sub-slide ${i===0?'opt-active':'opt-hidden'}" data-val="${item.name}">
                      <div class="role-label">OPTION</div>
                      <h1>${item.name} <span class="video-chip" onclick="window.open('${getMediaLink(item.name)}', '_blank')">â–¶ Review</span></h1>
                      <div class="nav-hint"><span>SKIP</span><span style="color:var(--accent-go)">SELECT</span></div>
                    </div>`;
          });
          html += `</div>`;
          el.innerHTML = html;
        }

        container.appendChild(el);
        slideElements.push(el);
      });

      goToSlide(depth);
    }

    function calculateVerdict() {
      const activeModule = MODULES[ENGINE_STATE.currentDomain];
      if (!activeModule.database) return { name: "Error", price: 0 };
      let DB = activeModule.database;
      let scores = [];

      const bannedTags = [];
      if (ENGINE_STATE.active_filters.some(f => f.includes("FAST CHARGE"))) bannedTags.push(DEAL_BREAKERS["Fast Charging"]);
      if (ENGINE_STATE.active_filters.some(f => f.includes("LIGHTWEIGHT"))) bannedTags.push(DEAL_BREAKERS["Lightweight"]);
      if (ENGINE_STATE.active_filters.some(f => f.includes("CLEAN UI"))) bannedTags.push(DEAL_BREAKERS["Clean UI"]);

      for (let name in DB) {
        let item = DB[name];
        const tags = item.tags || [];
        if (tags.some(t => bannedTags.includes(t))) continue;

        let score = 0;
        for (let attr in item.attr) score += item.attr[attr] * 0.1;

        if (ENGINE_STATE.items_detected[name]) score += 10;
        scores.push({ name, score, price: item.price });
      }

      scores.sort((a, b) => b.score - a.score);
      return scores.length > 0 ? scores[0] : { name: "No Perfect Match", price: 0 };
    }

    function updateFinal() {
      const list = document.getElementById('final-list');
      const winner = calculateVerdict();
      list.innerHTML = `
        <div style="text-align:left;">
          <span style="color:var(--accent-go); font-size:0.8rem; font-weight:bold;">THE CHAMPION</span>
          <div style="font-size:2.8rem; font-weight:900; margin:5px 0; color:#fff;">${winner.name}</div>
          <p style="color:#eee;">Est. Price: â‚¹${winner.price}</p>
        </div>`;
      ENGINE_STATE.items_detected = {};
      ENGINE_STATE.items_detected[winner.name] = { qty: 1 };
      setTimeout(() => triggerVerdictSpeech(), 1000);
    }

    let touchStartX = 0, touchStartY = 0;
    function initSwipeSystem() {
      const doc = document;
      doc.addEventListener('touchstart', e => {
        const view = e.target.closest('.carousel-viewport');
        if (!view) return;
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
      }, { passive: true });

      doc.addEventListener('touchmove', e => {
        const view = e.target.closest('.carousel-viewport');
        if (!view) return;
        if (document.querySelector('iframe')) return;

        const dy = e.touches[0].clientY - touchStartY;
        if (Math.abs(dy) > Math.abs(e.touches[0].clientX - touchStartX)) {
          if (e.cancelable) e.preventDefault();
          document.getElementById('depth-fill').style.height = Math.min((Math.abs(dy) / 150) * 100, 100) + '%';
        }
      }, { passive: false });

      doc.addEventListener('touchend', e => {
        const view = e.target.closest('.carousel-viewport');
        if (!view) return;
        if (document.querySelector('iframe')) return;

        const dx = e.changedTouches[0].clientX - touchStartX;
        const dy = e.changedTouches[0].clientY - touchStartY;
        document.getElementById('depth-fill').style.height = '0%';

        // Swipe up => forward
        if (dy < -80) {
          const activeSub = view.querySelector('.sub-slide.opt-active') || view.querySelector('.sub-slide.static');
          if (!activeSub) return;
          const val = activeSub.dataset.val;
          if (val) ENGINE_STATE.items_detected[val] = { qty: 1 };
          goToSlide(currentIdx + 1);
        }
        // Swipe down => back
        else if (dy > 80) {
          goToSlide(currentIdx - 1);
        }
        // Side swipe => next option
        else if (Math.abs(dx) > 60) {
          const slides = Array.from(view.querySelectorAll('.sub-slide'));
          if (slides.length <= 1) return;
          const currIdx = slides.findIndex(s => s.classList.contains('opt-active'));
          if (currIdx === -1) return;
          slides[currIdx].classList.replace('opt-active', 'opt-hidden');
          const nextIdx = (currIdx + (dx < 0 ? 1 : -1) + slides.length) % slides.length;
          slides[nextIdx].classList.replace('opt-hidden', 'opt-active');
        }
      });
    }

    function goToSlide(idx) {
      if (idx < 0) return;
      slideElements[currentIdx].classList.replace('active', idx > currentIdx ? 'prev' : 'next');
      currentIdx = idx;
      slideElements[currentIdx].className = "main-slide active";
      if (slideElements[currentIdx].querySelector('#final-list')) updateFinal();
    }

    // === Minimal stubs for missing functions referenced by UI ===
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('visible');
      setTimeout(() => t.classList.remove('visible'), 900);
    }

    function redirect(type) {
      const winner = calculateVerdict();
      const q = encodeURIComponent(winner.name);
      if (type === 'amazon') {
        // Prefer app deep link on mobile, fallback web
        const link = ECOM_DEEP_LINKS.amazon.app(q);
        window.location.href = link;
        setTimeout(() => window.open(ECOM_DEEP_LINKS.amazon.web(q), '_blank'), 400);
      }
    }

    function openReview() {
      const winner = calculateVerdict();
      window.open(getMediaLink(winner.name), '_blank');
    }

    function triggerVerdictSpeech() {
      const winner = calculateVerdict();
      const text = `Winner is ${winner.name}. Estimated price rupees ${winner.price}.`;
      try {
        const u = new SpeechSynthesisUtterance(text);
        u.rate = 1; u.pitch = 1;
        speechSynthesis.cancel();
        speechSynthesis.speak(u);
      } catch (e) {}
    }

    // Voice placeholders (keep your existing voice wiring if you have it elsewhere)
    function initVoice() { /* keep empty or plug your voice engine */ }
    function toggleListenMode() { showToast("VOICE: N/A"); }

    boot();
  </script>
</body>
</html>
