<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Alchemist Quiz | decide.engine India</title>
  <meta name="theme-color" content="#060c16" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Space+Mono:wght@400;700&family=Noto+Sans:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --saffron: #FF9933;
      --india-green: #138808;
      --brand-bg: #060c16;
      --bg-card: #0d1825;
      --text-main: #e8edf5;
      --text-dim: #7a90a8;
      --accent-go: #00d68f;
      --accent-wrong: #ef4444;
      --border: rgba(255,255,255,0.08);
      --font-display: 'Syne', sans-serif;
      --font-mono: 'Space Mono', monospace;
      --font-body: 'Noto Sans', sans-serif;
    }
    *, *::before, *::after { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; min-height: 100vh; background: var(--brand-bg); color: var(--text-main); font-family: var(--font-body); }
    .tricolor-bar { height: 3px; background: linear-gradient(90deg, #FF9933 33.33%, #FFFFFF 33.33%, #FFFFFF 66.66%, #138808 66.66%); }
    .header {
      padding: 16px 20px; border-left: 3px solid var(--saffron);
      display: flex; align-items: center; justify-content: space-between;
      background: rgba(6,12,22,.96); backdrop-filter: blur(8px);
      position: sticky; top: 3px; z-index: 100;
    }
    .header-title { font-family: var(--font-display); font-size: .78rem; color: var(--saffron); letter-spacing: 2px; font-weight: 700; text-transform: uppercase; }
    .header-badge { font-family: var(--font-mono); font-size: .58rem; color: var(--text-dim); background: var(--bg-card); padding: 4px 10px; border-radius: 20px; border: 1px solid var(--border); }

    .container { max-width: 600px; margin: 0 auto; padding: 24px 20px 60px; }
    h1 { font-family: var(--font-display); font-size: 1.8rem; color: var(--saffron); margin: 0 0 8px; letter-spacing: -.02em; }

    .progress-bar { height: 4px; background: rgba(255,255,255,.08); border-radius: 2px; margin: 16px 0; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--saffron), var(--accent-go)); border-radius: 2px; transition: width .4s ease; }
    .progress-label { font-family: var(--font-mono); font-size: .65rem; color: var(--text-dim); margin-bottom: 4px; }

    .question-card {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 18px; padding: 22px; margin-bottom: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,.4);
    }
    .q-meta { font-family: var(--font-mono); font-size: .62rem; color: var(--text-dim); margin-bottom: 12px; display: flex; gap: 12px; flex-wrap: wrap; }
    .q-text { font-size: 1rem; color: var(--text-main); line-height: 1.65; font-weight: 500; }

    .options { display: grid; gap: 10px; margin-top: 18px; }
    .option-btn {
      background: rgba(255,255,255,.04); border: 1px solid var(--border);
      color: var(--text-main); padding: 14px 16px; border-radius: 12px;
      font-size: .9rem; font-family: var(--font-body); cursor: pointer;
      text-align: left; transition: all .18s;
      -webkit-tap-highlight-color: transparent;
    }
    .option-btn:hover { border-color: rgba(255,153,51,.3); background: rgba(255,153,51,.06); }
    .option-btn.correct { background: rgba(0,214,143,.1); border-color: var(--accent-go); color: var(--accent-go); }
    .option-btn.wrong { background: rgba(239,68,68,.1); border-color: var(--accent-wrong); color: var(--accent-wrong); }
    .option-btn:disabled { cursor: default; }

    .explanation {
      background: rgba(0,214,143,.06); border: 1px solid rgba(0,214,143,.2);
      border-radius: 12px; padding: 14px; margin-top: 12px;
      font-size: .88rem; color: var(--text-dim); line-height: 1.65;
    }
    .explanation strong { color: var(--accent-go); }

    .nav-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 14px; }
    .btn {
      background: var(--bg-card); color: var(--text-main); border: 1px solid var(--border);
      padding: 13px; border-radius: 12px; font-weight: 700; font-size: .82rem;
      cursor: pointer; width: 100%; font-family: var(--font-display); letter-spacing: .5px;
      transition: all .15s;
    }
    .btn:active { transform: scale(.98); }
    .btn-full { grid-column: span 2; }
    .btn-pro { background: rgba(0,214,143,.1); border-color: rgba(0,214,143,.4); color: var(--accent-go); }
    .btn-india { background: rgba(255,153,51,.1); border-color: rgba(255,153,51,.4); color: var(--saffron); }

    .score-card {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 20px; padding: 28px; text-align: center; margin-top: 20px;
    }
    .score-number { font-family: var(--font-display); font-size: 4rem; font-weight: 900; color: var(--saffron); line-height: 1; }
    .score-label { font-family: var(--font-mono); font-size: .7rem; color: var(--text-dim); margin-top: 8px; letter-spacing: 1px; text-transform: uppercase; }
    .score-msg { font-size: 1rem; color: var(--text-main); margin-top: 16px; line-height: 1.6; }

    .empty-state { text-align: center; padding: 60px 20px; }
    .empty-state p { color: var(--text-dim); line-height: 1.7; margin-bottom: 20px; }
  </style>
</head>
<body>
<div class="tricolor-bar"></div>
<div class="header">
  <span class="header-title">ALCHEMIST QUIZ</span>
  <span class="header-badge" id="quiz-badge">LOADING</span>
</div>
<div class="container" id="app"></div>

<script>
const ALCHEMIST_LS_KEY = "ALCHEMIST_INJECTED_DATA";
let questions = [];
let currentQ = 0;
let score = 0;
let answered = false;

function loadQuestions() {
  try {
    const raw = localStorage.getItem(ALCHEMIST_LS_KEY);
    if (!raw) return null;
    return JSON.parse(raw);
  } catch(e) { return null; }
}

function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length-1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function renderEmpty() {
  document.getElementById('quiz-badge').textContent = "NO DATA";
  document.getElementById('app').innerHTML = `
    <div class="empty-state">
      <h1>No Quiz Data</h1>
      <p>Open decide.engine, build some research nodes, then tap <strong>QUIZ (ALCHEMIST)</strong> in the quick panel or on any node slide.</p>
      <button class="btn btn-india" onclick="window.location='index.html'">← BACK TO decide.engine</button>
    </div>
  `;
}

function buildOptions(q) {
  return shuffle([q.Correct_Answer, q.Distractor_1, q.Distractor_2].filter(Boolean));
}

function renderQuestion() {
  answered = false;
  const q = questions[currentQ];
  if (!q) { renderResults(); return; }
  const pct = Math.round((currentQ / questions.length) * 100);
  const options = buildOptions(q);
  document.getElementById('quiz-badge').textContent = `${currentQ+1}/${questions.length}`;

  document.getElementById('app').innerHTML = `
    <h1>Quiz</h1>
    <div class="progress-label">${currentQ+1} of ${questions.length} — ${pct}% complete</div>
    <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
    <div class="question-card">
      <div class="q-meta">
        <span>${q.Domain||"Research"}</span>
        <span>${q.Subdomain||""}</span>
        <span>Difficulty: ${q.Difficulty||"2"}/5</span>
      </div>
      <div class="q-text">${escapeHTML(q.Question_Text||"")}</div>
      <div class="options" id="options-list">
        ${options.map((opt,i) => `<button class="option-btn" data-answer="${escapeHTML(opt)}" onclick="selectAnswer(this, '${escapeHTML(q.Correct_Answer)}', '${escapeHTML(q.Explanation_Short||"")}')">
          ${String.fromCharCode(65+i)}. ${escapeHTML(opt)}
        </button>`).join("")}
      </div>
      <div id="explanation-box"></div>
    </div>
    <div class="nav-actions">
      <button class="btn btn-full btn-pro" id="next-btn" onclick="nextQuestion()" style="display:none">NEXT QUESTION →</button>
      <button class="btn btn-full btn-muted" onclick="if(confirm('Quit quiz?')) renderResults()">QUIT & SEE RESULTS</button>
    </div>
  `;
}

function escapeHTML(str) {
  return (str||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");
}

function selectAnswer(btn, correct, explanation) {
  if (answered) return;
  answered = true;
  const isCorrect = btn.dataset.answer === correct;
  if (isCorrect) { score++; btn.classList.add('correct'); }
  else {
    btn.classList.add('wrong');
    document.querySelectorAll('.option-btn').forEach(b => {
      if (b.dataset.answer === correct) b.classList.add('correct');
    });
  }
  document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
  const expBox = document.getElementById('explanation-box');
  if (expBox) {
    expBox.innerHTML = `<div class="explanation"><strong>${isCorrect ? '✓ Correct!' : '✗ Incorrect.'}</strong> ${escapeHTML(explanation)} The correct answer is: <strong>${escapeHTML(correct)}</strong></div>`;
  }
  const nextBtn = document.getElementById('next-btn');
  if (nextBtn) { nextBtn.style.display = 'block'; nextBtn.style.gridColumn = 'span 2'; }
}

function nextQuestion() {
  currentQ++; renderQuestion();
}

function renderResults() {
  const pct = Math.round((score / questions.length) * 100);
  let msg = "", grade = "";
  if (pct >= 90) { msg = "Outstanding! You've deeply internalized the research nodes."; grade = "A+"; }
  else if (pct >= 75) { msg = "Strong result. You have solid command of the material."; grade = "A"; }
  else if (pct >= 60) { msg = "Good base. Review the nodes you missed and retry."; grade = "B"; }
  else if (pct >= 40) { msg = "Keep building. Return to decide.engine and deepen your research."; grade = "C"; }
  else { msg = "Early days — great. Research more nodes and try again."; grade = "D"; }

  document.getElementById('quiz-badge').textContent = "COMPLETE";
  document.getElementById('app').innerHTML = `
    <h1>Results</h1>
    <div class="score-card">
      <div class="score-number">${score}/${questions.length}</div>
      <div class="score-label">Score — Grade: ${grade}</div>
      <div class="progress-bar" style="margin:14px 0"><div class="progress-fill" style="width:${pct}%"></div></div>
      <div class="score-msg">${escapeHTML(msg)}</div>
    </div>
    <div class="nav-actions" style="margin-top:20px;">
      <button class="btn btn-full btn-pro" onclick="restartQuiz()">RETRY QUIZ</button>
      <button class="btn btn-full btn-india" onclick="window.location='index.html'">← decide.engine</button>
    </div>
  `;
}

function restartQuiz() {
  currentQ = 0; score = 0; answered = false;
  renderQuestion();
}

// Boot
const loaded = loadQuestions();
if (!loaded || !loaded.length) { renderEmpty(); }
else {
  questions = shuffle(loaded);
  renderQuestion();
}
</script>
</body>
</html>
