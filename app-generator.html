<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>App Generator ¬∑ decide.engine</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800;900&family=Space+Mono:wght@400;700&family=Noto+Sans:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --saffron:#FF9933;--green:#138808;--bg:#04080f;--card:#0d1825;
  --text:#e8edf5;--dim:#7a90a8;--go:#00d68f;--blue:#3b82f6;
  --border:rgba(255,255,255,.08);--fn:'Syne',sans-serif;--fm:'Space Mono',monospace;--fb:'Noto Sans',sans-serif;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{min-height:100vh;background:var(--bg);color:var(--text);font-family:var(--fb);overflow-x:hidden}

/* tricolor bar */
.tribar{position:fixed;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#FF9933 33.33%,#fff 33.33%,#fff 66.66%,#138808 66.66%);z-index:999}

/* animated grid bg */
.grid-bg{position:fixed;inset:0;background-image:linear-gradient(rgba(255,153,51,.02) 1px,transparent 1px),linear-gradient(90deg,rgba(255,153,51,.02) 1px,transparent 1px);background-size:48px 48px;pointer-events:none;z-index:0}
.orb{position:fixed;border-radius:50%;filter:blur(90px);pointer-events:none;z-index:0;animation:float 10s ease-in-out infinite}
@keyframes float{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-24px) scale(1.06)}}

.wrap{position:relative;z-index:1;max-width:760px;margin:0 auto;padding:32px 20px 80px}

/* header */
.topbar{display:flex;align-items:center;gap:14px;margin-bottom:36px;padding-top:10px}
.back-btn{font-family:var(--fm);font-size:.6rem;letter-spacing:1.5px;color:var(--dim);border:1px solid var(--border);background:var(--card);padding:8px 14px;border-radius:999px;text-decoration:none;transition:all .2s;white-space:nowrap}
.back-btn:hover{border-color:rgba(255,153,51,.4);color:var(--saffron)}
.topbar-title{font-family:var(--fn);font-size:.68rem;color:var(--saffron);letter-spacing:2.5px;font-weight:700;text-transform:uppercase}
.badge{font-family:var(--fm);font-size:.55rem;color:var(--go);border:1px solid rgba(0,214,143,.3);background:rgba(0,214,143,.06);padding:4px 10px;border-radius:999px;letter-spacing:1px;margin-left:auto}

/* hero */
.hero{text-align:center;margin-bottom:40px}
.hero-eyebrow{font-family:var(--fm);font-size:.6rem;color:var(--saffron);letter-spacing:3px;text-transform:uppercase;margin-bottom:14px;display:flex;align-items:center;justify-content:center;gap:12px}
.eline{width:40px;height:1px;background:rgba(255,153,51,.3)}
.hero h1{font-family:var(--fn);font-size:clamp(2rem,6vw,3.6rem);font-weight:900;letter-spacing:-.04em;line-height:1;color:#fff;margin-bottom:10px}
.hero h1 span{color:var(--saffron)}
.hero-sub{color:var(--dim);font-size:.95rem;line-height:1.7;max-width:540px;margin:0 auto}

/* form card */
.form-card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:28px 24px;margin-bottom:18px;position:relative;overflow:hidden}
.form-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--saffron),transparent,var(--go));opacity:.5}
.section-label{font-family:var(--fm);font-size:.6rem;color:var(--dim);letter-spacing:2px;text-transform:uppercase;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.section-label::after{content:'';flex:1;height:1px;background:rgba(255,255,255,.06)}

/* subpage selector */
.subpage-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;margin-bottom:6px}
.sp-chip{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:10px 10px 8px;cursor:pointer;transition:all .18s;text-align:left;-webkit-tap-highlight-color:transparent}
.sp-chip:hover{border-color:rgba(255,153,51,.35);background:rgba(255,153,51,.04)}
.sp-chip.selected{border-color:var(--saffron);background:rgba(255,153,51,.1);box-shadow:0 0 16px rgba(255,153,51,.1)}
.sp-chip .ic{font-size:1rem;margin-bottom:4px}
.sp-chip .lb{font-family:var(--fn);font-size:.72rem;font-weight:800;color:var(--text);line-height:1.2}
.sp-chip .ds{font-family:var(--fm);font-size:.55rem;color:var(--dim);margin-top:2px}

/* text inputs */
.field{margin-bottom:16px}
.field label{font-family:var(--fm);font-size:.6rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--dim);display:block;margin-bottom:8px}
.field input,.field textarea,.field select{width:100%;background:rgba(4,8,15,.8);border:1px solid var(--border);color:var(--text);padding:12px 14px;border-radius:10px;font-size:.92rem;font-family:var(--fb);outline:none;transition:border-color .2s;resize:vertical}
.field input:focus,.field textarea:focus,.field select:focus{border-color:rgba(255,153,51,.45)}
.field select option{background:#0d1825}
.field textarea{min-height:90px;line-height:1.6}

/* feature toggles */
.feat-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px;margin-bottom:6px}
.feat-toggle{display:flex;align-items:center;gap:8px;padding:9px 12px;border:1px solid var(--border);background:var(--bg);border-radius:8px;cursor:pointer;transition:all .18s;-webkit-tap-highlight-color:transparent}
.feat-toggle.on{border-color:rgba(0,214,143,.4);background:rgba(0,214,143,.06)}
.feat-toggle .fchk{width:14px;height:14px;border-radius:3px;border:1px solid var(--dim);flex-shrink:0;transition:all .18s;display:flex;align-items:center;justify-content:center;font-size:.6rem}
.feat-toggle.on .fchk{background:var(--go);border-color:var(--go);color:#000}
.feat-toggle span{font-family:var(--fm);font-size:.6rem;color:var(--dim);letter-spacing:.5px}
.feat-toggle.on span{color:var(--go)}

/* style picker */
.style-row{display:flex;gap:8px;flex-wrap:wrap}
.style-chip{padding:7px 14px;border:1px solid var(--border);border-radius:999px;font-family:var(--fm);font-size:.6rem;color:var(--dim);cursor:pointer;transition:all .18s;background:var(--bg)}
.style-chip.active{border-color:rgba(59,130,246,.5);color:#93c5fd;background:rgba(59,130,246,.08)}

/* generate btn */
.gen-btn{width:100%;padding:17px;background:linear-gradient(135deg,rgba(255,153,51,.2),rgba(0,214,143,.12));border:1px solid rgba(255,153,51,.5);color:var(--saffron);font-family:var(--fn);font-size:1rem;font-weight:900;letter-spacing:.5px;border-radius:14px;cursor:pointer;transition:all .22s;position:relative;overflow:hidden}
.gen-btn:hover:not(:disabled){box-shadow:0 0 32px rgba(255,153,51,.2);transform:translateY(-1px)}
.gen-btn:disabled{opacity:.5;cursor:not-allowed}
.gen-btn .shimmer{position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent);transform:translateX(-100%)}
.gen-btn:hover:not(:disabled) .shimmer{animation:shimmerAnim .8s ease infinite}
@keyframes shimmerAnim{to{transform:translateX(100%)}}

/* status / output */
.status-box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:22px;margin-top:18px;min-height:80px;display:none}
.status-box.visible{display:block}
.status-label{font-family:var(--fm);font-size:.6rem;color:var(--dim);letter-spacing:2px;text-transform:uppercase;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.pulse-dot{display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--go);animation:pulse 1.4s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(1.5)}}
.status-text{font-size:.88rem;color:var(--text);line-height:1.7}
.status-text .thinking{color:var(--dim);font-style:italic}

/* preview iframe */
.preview-wrap{margin-top:18px;border:1px solid var(--border);border-radius:16px;overflow:hidden;display:none}
.preview-wrap.visible{display:block}
.preview-header{background:var(--card);padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
.preview-header-title{font-family:var(--fm);font-size:.6rem;color:var(--saffron);letter-spacing:1.5px}
.preview-actions{display:flex;gap:8px}
.preview-btn{font-family:var(--fm);font-size:.58rem;letter-spacing:1px;padding:6px 13px;border-radius:999px;border:1px solid var(--border);background:var(--bg);color:var(--dim);cursor:pointer;transition:all .18s}
.preview-btn:hover{border-color:rgba(255,153,51,.4);color:var(--saffron)}
.preview-btn.dl{border-color:rgba(0,214,143,.4);color:var(--go);background:rgba(0,214,143,.06)}
.preview-btn.dl:hover{background:rgba(0,214,143,.12)}
iframe#preview-frame{width:100%;height:480px;border:none;display:block;background:#fff}

/* token counter */
.token-bar{display:flex;justify-content:space-between;align-items:center;margin-top:10px;font-family:var(--fm);font-size:.58rem;color:#3a4a5c}

/* error */
.err-box{background:rgba(248,113,113,.06);border:1px solid rgba(248,113,113,.25);border-radius:12px;padding:14px 16px;margin-top:14px;color:#f87171;font-size:.85rem;line-height:1.6;display:none}
.err-box.visible{display:block}

/* history */
.history-section{margin-top:30px}
.hist-item{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px 16px;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;gap:12px}
.hist-meta{flex:1;min-width:0}
.hist-title{font-family:var(--fn);font-size:.82rem;font-weight:800;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.hist-sub{font-family:var(--fm);font-size:.58rem;color:var(--dim);margin-top:3px}
.hist-dl{font-family:var(--fm);font-size:.58rem;padding:7px 13px;border:1px solid rgba(0,214,143,.35);border-radius:999px;color:var(--go);background:rgba(0,214,143,.06);cursor:pointer;white-space:nowrap;transition:all .18s}
.hist-dl:hover{background:rgba(0,214,143,.12)}
.empty-hist{font-family:var(--fm);font-size:.65rem;color:#3a4a5c;text-align:center;padding:20px}

@media(max-width:480px){
  .subpage-grid{grid-template-columns:repeat(2,1fr)}
  .feat-row{grid-template-columns:1fr 1fr}
  iframe#preview-frame{height:340px}
}
</style>
</head>
<body>
<div class="tribar"></div>
<div class="grid-bg"></div>
<div class="orb" style="width:500px;height:400px;background:rgba(255,153,51,.05);top:10%;left:30%"></div>
<div class="orb" style="width:400px;height:300px;background:rgba(0,214,143,.04);bottom:15%;right:10%;animation-delay:-4s"></div>

<div class="wrap">

  <!-- topbar -->
  <div class="topbar">
    <a class="back-btn" href="javascript:history.back()">‚Üê BACK</a>
    <span class="topbar-title">decide.engine</span>
    <span class="badge">APP GENERATOR</span>
  </div>

  <!-- hero -->
  <div class="hero">
    <div class="hero-eyebrow"><span class="eline"></span>UNIVERSAL TOOL BUILDER<span class="eline"></span></div>
    <h1>Generate a <span>mini app</span><br>from any input</h1>
    <p class="hero-sub">Describe what you need. Select a subpage context. Download a fully functional HTML app ‚Äî instantly.</p>
  </div>

  <!-- STEP 1: Subpage context -->
  <div class="form-card">
    <div class="section-label">Step 1 ‚Äî Subpage Context</div>
    <div class="subpage-grid" id="sp-grid"></div>
  </div>

  <!-- STEP 2: User intent -->
  <div class="form-card">
    <div class="section-label">Step 2 ‚Äî What should this app do?</div>
    <div class="field">
      <label>App purpose / user goal</label>
      <textarea id="inp-purpose" placeholder="e.g. Track my daily protein intake and show a weekly chart&#10;e.g. Let students quiz themselves on Stoicism concepts&#10;e.g. Calculate cashback earned from ONDC purchases"></textarea>
    </div>
    <div class="field">
      <label>Target user (optional)</label>
      <input type="text" id="inp-user" placeholder="e.g. Farmer, Student, Policy analyst, Startup founder...">
    </div>
    <div class="field">
      <label>Key data inputs this app should accept</label>
      <input type="text" id="inp-fields" placeholder="e.g. Date, Amount, Category, Notes ‚Äî or leave blank to auto-decide">
    </div>
    <div class="field">
      <label>Output / result the app should show</label>
      <input type="text" id="inp-output" placeholder="e.g. Score out of 10, Downloadable summary, Chart, Decision recommendation...">
    </div>
  </div>

  <!-- STEP 3: App style -->
  <div class="form-card">
    <div class="section-label">Step 3 ‚Äî Style & Features</div>
    <div class="field">
      <label>Visual style</label>
      <div class="style-row" id="style-row">
        <div class="style-chip active" data-s="dark-india">üáÆüá≥ Dark India</div>
        <div class="style-chip" data-s="minimal-light">‚¨ú Minimal Light</div>
        <div class="style-chip" data-s="retro-terminal">üñ• Retro Terminal</div>
        <div class="style-chip" data-s="policy-grade">üèõ Policy Grade</div>
        <div class="style-chip" data-s="playful-bharat">üé® Playful Bharat</div>
      </div>
    </div>
    <div class="field" style="margin-top:14px">
      <label>Include features</label>
      <div class="feat-row" id="feat-row"></div>
    </div>
    <div class="field">
      <label>Language / locale</label>
      <select id="inp-lang">
        <option value="English">English</option>
        <option value="Hindi">Hindi (‡§π‡§ø‡§Ç‡§¶‡•Ä)</option>
        <option value="Tamil">Tamil (‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç)</option>
        <option value="Bengali">Bengali (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ)</option>
        <option value="Marathi">Marathi (‡§Æ‡§∞‡§æ‡§†‡•Ä)</option>
        <option value="Telugu">Telugu (‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å)</option>
        <option value="Bilingual (English + Hindi)">Bilingual (English + Hindi)</option>
      </select>
    </div>
    <div class="field">
      <label>Extra instructions (optional)</label>
      <input type="text" id="inp-extra" placeholder="e.g. Add a print button, Use saffron/green colors, Include a share link...">
    </div>
  </div>

  <!-- Generate -->
  <button class="gen-btn" id="gen-btn" onclick="generate()">
    <div class="shimmer"></div>
    ‚ö° GENERATE HTML APP ‚Üí
  </button>
  <div class="token-bar"><span id="token-hint">Powered by Claude ¬∑ decide.engine √ó IndiaAI</span><span id="token-count"></span></div>

  <!-- Error -->
  <div class="err-box" id="err-box"></div>

  <!-- Status -->
  <div class="status-box" id="status-box">
    <div class="status-label"><span class="pulse-dot"></span><span id="status-label-text">GENERATING</span></div>
    <div class="status-text" id="status-text"></div>
  </div>

  <!-- Preview -->
  <div class="preview-wrap" id="preview-wrap">
    <div class="preview-header">
      <span class="preview-header-title" id="preview-title">GENERATED APP</span>
      <div class="preview-actions">
        <button class="preview-btn" onclick="refreshPreview()">‚Ü∫ REFRESH</button>
        <button class="preview-btn dl" id="dl-btn" onclick="downloadApp()">‚¨á DOWNLOAD HTML</button>
      </div>
    </div>
    <iframe id="preview-frame" sandbox="allow-scripts allow-forms allow-same-origin"></iframe>
  </div>

  <!-- History -->
  <div class="history-section" id="history-section">
    <div class="section-label" style="margin-bottom:12px">Recent Generations</div>
    <div id="history-list"></div>
  </div>

</div>

<script>
/* ‚îÄ‚îÄ Subpage definitions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const SUBPAGES = [
  { id:'alchemist',      icon:'üß™', label:'Alchemist',       desc:'Quiz engine' },
  { id:'cashback',       icon:'üí∞', label:'Cashback',        desc:'Rewards tracker' },
  { id:'ondc',           icon:'üõí', label:'ONDC Demo',       desc:'Commerce tool' },
  { id:'student',        icon:'üéì', label:'Student Research',desc:'Academic tool' },
  { id:'prompt',         icon:'‚ú®', label:'PromptAlchemy',   desc:'Prompt builder' },
  { id:'brief',          icon:'üìÑ', label:'Decision Brief',  desc:'Policy brief' },
  { id:'swipe',          icon:'üì±', label:'SwipeOS',         desc:'OS interface' },
  { id:'deals',          icon:'ü§ù', label:'Engine Deals',    desc:'Deal tracker' },
  { id:'license',        icon:'üîë', label:'License',         desc:'License gen' },
  { id:'contact',        icon:'üì¨', label:'Contact',         desc:'Contact form' },
  { id:'custom',         icon:'üõ†Ô∏è', label:'Custom',          desc:'Free-form' },
];

const FEATURES = [
  { id:'charts',   label:'Charts / Graphs' },
  { id:'export',   label:'Export / Download' },
  { id:'local',    label:'Save to Device' },
  { id:'share',    label:'Share Link' },
  { id:'print',    label:'Print / PDF' },
  { id:'dark',     label:'Dark Mode Toggle' },
  { id:'timer',    label:'Timer / Countdown' },
  { id:'score',    label:'Score / Progress' },
  { id:'table',    label:'Data Table' },
  { id:'map',      label:'Location / Map' },
];

const STYLE_PROMPTS = {
  'dark-india':    'Dark background (#04080f), saffron (#FF9933) and green (#138808) accents, Syne font display, Space Mono for data, India tricolor decorative bar at top, professional and policy-grade.',
  'minimal-light': 'Clean white background, black text, single accent color, generous whitespace, modern sans-serif (Outfit or DM Sans), ultra-minimal with no decoration.',
  'retro-terminal':'Black background, green (#00ff41) monospace text, terminal-style borders with ASCII art, Space Mono font throughout, blinking cursor effects, CRT scanline overlay.',
  'policy-grade':  'Navy/dark blue tones, gold accents, serif headers (Playfair Display), formal government document aesthetic, structured columns, official-looking seals/badges.',
  'playful-bharat':'Warm saffron/turmeric background, bold and energetic, Baloo 2 or Yatra One font, hand-drawn borders, bright accent colors, celebratory and community feel.',
};

const SUBPAGE_CONTEXT_PROMPTS = {
  alchemist:  'quiz and skill assessment application',
  cashback:   'cashback calculation and rewards tracking application',
  ondc:       'ONDC open commerce order and product management application',
  student:    'student research notes, citation, and study tool',
  prompt:     'AI prompt builder and alchemy workshop',
  brief:      'policy decision brief generator',
  swipe:      'swipe-based OS interface or flashcard tool',
  deals:      'business deal tracker and pipeline manager',
  license:    'software/engine license generator and checker',
  contact:    'contact form and message manager',
  custom:     'custom application',
};

let selectedSubpage = null;
let selectedStyle = 'dark-india';
let selectedFeatures = new Set();
let generatedHTML = null;
let history = JSON.parse(localStorage.getItem('app_gen_history') || '[]');

/* ‚îÄ‚îÄ Build UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function buildSubpageGrid() {
  const grid = document.getElementById('sp-grid');
  SUBPAGES.forEach(sp => {
    const el = document.createElement('div');
    el.className = 'sp-chip';
    el.dataset.id = sp.id;
    el.innerHTML = `<div class="ic">${sp.icon}</div><div class="lb">${sp.label}</div><div class="ds">${sp.desc}</div>`;
    el.addEventListener('click', () => {
      document.querySelectorAll('.sp-chip').forEach(c => c.classList.remove('selected'));
      el.classList.add('selected');
      selectedSubpage = sp.id;
    });
    grid.appendChild(el);
  });
}

function buildFeatures() {
  const row = document.getElementById('feat-row');
  FEATURES.forEach(f => {
    const el = document.createElement('div');
    el.className = 'feat-toggle';
    el.innerHTML = `<div class="fchk"></div><span>${f.label}</span>`;
    el.addEventListener('click', () => {
      if (selectedFeatures.has(f.id)) {
        selectedFeatures.delete(f.id);
        el.classList.remove('on');
        el.querySelector('.fchk').textContent = '';
      } else {
        selectedFeatures.add(f.id);
        el.classList.add('on');
        el.querySelector('.fchk').textContent = '‚úì';
      }
    });
    row.appendChild(el);
  });
}

function buildStylePicker() {
  document.querySelectorAll('.style-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      document.querySelectorAll('.style-chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      selectedStyle = chip.dataset.s;
    });
  });
}

/* ‚îÄ‚îÄ Build prompt ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function buildPrompt() {
  const purpose  = document.getElementById('inp-purpose').value.trim();
  const user     = document.getElementById('inp-user').value.trim();
  const fields   = document.getElementById('inp-fields').value.trim();
  const output   = document.getElementById('inp-output').value.trim();
  const lang     = document.getElementById('inp-lang').value;
  const extra    = document.getElementById('inp-extra').value.trim();
  const spCtx    = SUBPAGE_CONTEXT_PROMPTS[selectedSubpage] || 'general purpose application';
  const stylePrm = STYLE_PROMPTS[selectedStyle] || STYLE_PROMPTS['dark-india'];
  const feats    = [...selectedFeatures].join(', ') || 'none specified';

  return `You are an expert frontend developer building a mini HTML app for viadecide.com ‚Äî India's decision engine, aligned with the IndiaAI Mission.

TASK: Generate a COMPLETE, SELF-CONTAINED single-file HTML application. No external dependencies except Google Fonts (allowed). No frameworks. Pure HTML + CSS + JS in one file.

SUBPAGE CONTEXT: This app is for the "${spCtx}" section of decide.engine.

APP PURPOSE:
${purpose || 'A general utility app for the subpage context above.'}

TARGET USER: ${user || 'Indian citizen / decide.engine user'}

KEY INPUT FIELDS: ${fields || 'Auto-determine appropriate fields for the purpose'}

DESIRED OUTPUT / RESULT: ${output || 'Auto-determine appropriate output for the purpose'}

LANGUAGE / LOCALE: ${lang}

FEATURES TO INCLUDE: ${feats}

EXTRA INSTRUCTIONS: ${extra || 'None'}

VISUAL STYLE REQUIREMENTS:
${stylePrm}

MANDATORY REQUIREMENTS:
1. The entire app MUST be in a single HTML file ‚Äî inline all CSS and JS.
2. Fully functional with no broken features.
3. Mobile-first responsive design.
4. Include a header with the viadecide.com branding (subtle ‚Äî small logo text "decide.engine" and a tricolor bar).
5. Include an "About this app" footer noting it was generated by decide.engine √ó IndiaAI.
6. All form inputs must be validated with helpful error messages.
7. Any data should be saved to localStorage where applicable.
8. Include a prominent, working "‚¨á Download / Export" or equivalent action button.
9. Use semantic HTML5 and ARIA labels for accessibility.
10. App must work completely OFFLINE (no API calls unless the user explicitly asked for them).

OUTPUT FORMAT:
Return ONLY the complete HTML file content. Start with <!DOCTYPE html> and end with </html>.
Do NOT include any explanation, markdown code fences, or commentary ‚Äî just the raw HTML.`;
}

/* ‚îÄ‚îÄ Generate ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function generate() {
  // Validate
  const purpose = document.getElementById('inp-purpose').value.trim();
  if (!selectedSubpage) return showErr('Please select a subpage context first.');
  if (!purpose) return showErr('Please describe what the app should do.');

  // Reset UI
  clearErr();
  document.getElementById('gen-btn').disabled = true;
  document.getElementById('preview-wrap').classList.remove('visible');
  showStatus('BUILDING', 'ü§î Analyzing your requirements‚Ä¶');

  const prompt = buildPrompt();
  generatedHTML = null;

  try {
    const messages = [{ role: 'user', content: prompt }];
    let fullText = '';
    let tokensIn = 0, tokensOut = 0;

    showStatus('GENERATING', '‚ö° Generating your HTML app‚Ä¶');

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 8000,
        messages,
      })
    });

    if (!response.ok) {
      const err = await response.json().catch(() => ({}));
      throw new Error(err?.error?.message || `API error ${response.status}`);
    }

    const data = await response.json();
    fullText = (data.content || []).map(b => b.type === 'text' ? b.text : '').join('');
    tokensIn  = data.usage?.input_tokens  || 0;
    tokensOut = data.usage?.output_tokens || 0;

    // Strip markdown fences if present
    fullText = fullText.replace(/^```html\s*/i, '').replace(/^```\s*/i, '').replace(/\s*```$/, '').trim();

    if (!fullText.includes('<html') && !fullText.includes('<!DOCTYPE')) {
      throw new Error('Model returned non-HTML output. Please try again or refine your description.');
    }

    generatedHTML = fullText;

    // Save to history
    const sp = SUBPAGES.find(s => s.id === selectedSubpage);
    const entry = {
      id: Date.now(),
      subpage: sp?.label || selectedSubpage,
      purpose: purpose.slice(0, 60) + (purpose.length > 60 ? '‚Ä¶' : ''),
      style: selectedStyle,
      ts: new Date().toLocaleString('en-IN', { dateStyle:'medium', timeStyle:'short', timeZone:'Asia/Kolkata' }),
      html: generatedHTML,
    };
    history.unshift(entry);
    if (history.length > 10) history = history.slice(0, 10);
    localStorage.setItem('app_gen_history', JSON.stringify(history));

    // Update UI
    document.getElementById('token-count').textContent = `‚Üë${tokensIn} ‚Üì${tokensOut} tokens`;
    showStatus('DONE', `‚úÖ App generated! ${tokensOut} tokens ¬∑ ${(generatedHTML.length / 1024).toFixed(1)} KB`);
    document.getElementById('status-label-text').textContent = 'COMPLETE';
    document.querySelector('.pulse-dot').style.background = 'var(--go)';
    document.querySelector('.pulse-dot').style.animation = 'none';

    renderPreview(generatedHTML, sp?.label || 'Generated App');
    renderHistory();

  } catch(e) {
    console.error(e);
    showErr('Generation failed: ' + (e.message || String(e)));
    document.getElementById('status-box').classList.remove('visible');
  } finally {
    document.getElementById('gen-btn').disabled = false;
  }
}

/* ‚îÄ‚îÄ Preview ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function renderPreview(html, title) {
  const wrap  = document.getElementById('preview-wrap');
  const frame = document.getElementById('preview-frame');
  const ptitle = document.getElementById('preview-title');

  ptitle.textContent = (title || 'GENERATED APP').toUpperCase();
  wrap.classList.add('visible');

  // Write HTML into iframe
  const doc = frame.contentDocument || frame.contentWindow.document;
  doc.open();
  doc.write(html);
  doc.close();

  // Scroll to preview
  setTimeout(() => wrap.scrollIntoView({ behavior:'smooth', block:'start' }), 100);
}

function refreshPreview() {
  if (generatedHTML) renderPreview(generatedHTML);
}

/* ‚îÄ‚îÄ Download ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function downloadApp() {
  if (!generatedHTML) return;
  const sp   = SUBPAGES.find(s => s.id === selectedSubpage);
  const name = (sp?.label || 'app').toLowerCase().replace(/\s+/g, '-');
  const date = new Date().toISOString().slice(0,10);
  const filename = `decide-${name}-${date}.html`;

  const blob = new Blob([generatedHTML], { type: 'text/html' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function downloadFromHistory(html, label) {
  const name = label.toLowerCase().replace(/\s+/g,'-');
  const filename = `decide-${name}-${Date.now()}.html`;
  const blob = new Blob([html], { type:'text/html' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href=url; a.download=filename;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/* ‚îÄ‚îÄ History ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function renderHistory() {
  const list = document.getElementById('history-list');
  if (!history.length) {
    list.innerHTML = '<div class="empty-hist">No generations yet</div>';
    return;
  }
  list.innerHTML = history.map(h => `
    <div class="hist-item">
      <div class="hist-meta">
        <div class="hist-title">${escH(h.subpage)} ‚Äî ${escH(h.purpose)}</div>
        <div class="hist-sub">${escH(h.style)} ¬∑ ${escH(h.ts)}</div>
      </div>
      <button class="hist-dl" onclick="downloadFromHistory(history[${history.indexOf(h)}].html,'${escH(h.subpage)}')">‚¨á DL</button>
    </div>
  `).join('');
}

/* ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function showStatus(label, text) {
  const box = document.getElementById('status-box');
  box.classList.add('visible');
  document.getElementById('status-label-text').textContent = label;
  document.getElementById('status-text').innerHTML = text;
}
function showErr(msg) {
  const b = document.getElementById('err-box');
  b.textContent = '‚ö† ' + msg;
  b.classList.add('visible');
  b.scrollIntoView({ behavior:'smooth', block:'nearest' });
}
function clearErr() { document.getElementById('err-box').classList.remove('visible'); }
function escH(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

/* ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
buildSubpageGrid();
buildFeatures();
buildStylePicker();
renderHistory();

// Pre-select first subpage
document.querySelector('.sp-chip').click();

// Allow Enter in purpose field to trigger generate
document.getElementById('inp-purpose').addEventListener('keydown', e => {
  if (e.key === 'Enter' && e.ctrlKey) generate();
});
</script>
</body>
</html>
